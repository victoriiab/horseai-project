{% extends 'frontend/base.html' %}

{% block title %}–ê–Ω–∞–ª–∏–∑ #{{ analysis_id }} - HorseAI{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg-dark: #121826;
        --bg-card: #1e2436;
        --border: #2a3246;
        --text-primary: #e4e8f0;
        --text-secondary: #a0abc0;
        --text-tertiary: #6b7280;
        --accent: #d97706;
        --accent-hover: #f59e0b;
        --success: #10b981;
        --error: #ef4444;
        --radius: 8px;
    }

    .analysis-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .analysis-header {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid var(--border);
    }

    .analysis-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .analysis-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .meta-label {
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
    }

    .meta-value {
        color: var(--text-primary);
        font-size: 16px;
        font-weight: 600;
        word-break: break-word;
    }

    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-badge.lame {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
    }

    /* –ú–µ—Ç—Ä–∏–∫–∏ - 3 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–º–µ—Å—Ç–æ 4 */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid var(--border);
    }

    .metric-title {
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .metric-value {
        color: var(--text-primary);
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .metric-description {
        color: var(--text-tertiary);
        font-size: 13px;
        line-height: 1.4;
    }

    .progress-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-healthy {
        background: linear-gradient(90deg, #10b981, #34d399);
    }

    .progress-lame {
        background: linear-gradient(90deg, #ef4444, #fca5a5);
    }

    /* –í–∏–¥–µ–æ –±–ª–æ–∫–∏ */
    .video-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    @media (max-width: 768px) {
        .video-grid {
            grid-template-columns: 1fr;
        }
    }

    .video-card {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
    }

    .video-header {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .video-header h3 {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
        margin: 0;
    }

    .video-container {
        position: relative;
        background: #000;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .video-player {
        width: 100%;
        height: auto;
        max-height: 250px;
        object-fit: contain;
        display: block;
    }

    .video-placeholder {
        color: var(--text-tertiary);
        text-align: center;
        padding: 30px 20px;
    }

    .video-info {
        padding: 15px;
    }

    .video-filename {
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 10px;
        word-break: break-all;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
        max-height: 2.8em;
    }

    .video-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }

    .video-status {
        color: var(--text-secondary);
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-tertiary);
    }

    .status-dot.available {
        background: var(--success);
    }

    .btn-download {
        padding: 6px 12px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-primary);
        border-radius: var(--radius);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .btn-download:hover:not(:disabled) {
        border-color: var(--accent);
        background: rgba(217, 119, 6, 0.1);
    }

    .btn-download:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* –û—Ç—á–µ—Ç—ã */
    .reports-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 30px;
    }

    .report-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 15px;
        overflow-x: auto;
    }

    .report-tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border-radius: var(--radius);
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .report-tab:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    .report-tab.active {
        background: var(--accent);
        color: white;
    }

    .report-content {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 20px;
    }

    .text-report {
        color: var(--text-primary);
        line-height: 1.6;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 14px;
        word-break: break-word;
    }

    .graphic-report {
        width: 100%;
        height: auto;
        border-radius: 8px;
        display: block;
        margin: 0 auto;
        max-width: 100%;
    }

    .report-not-found {
        color: var(--text-tertiary);
        text-align: center;
        padding: 40px 20px;
        font-style: italic;
    }

    /* –î–µ–π—Å—Ç–≤–∏—è */
    .actions-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .action-button {
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: transparent;
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        text-align: center;
    }

    .action-button:hover {
        border-color: var(--accent);
        background: rgba(217, 119, 6, 0.1);
    }

    .action-button.delete:hover {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        color: #fca5a5;
    }

    .action-icon {
        font-size: 24px;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(217, 119, 6, 0.3);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 9998;
        animation: slideIn 0.3s ease;
        max-width: 350px;
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .toast-success {
        color: #34d399;
        border-color: rgba(16, 185, 129, 0.3);
    }

    .toast-error {
        color: #fca5a5;
        border-color: rgba(239, 68, 68, 0.3);
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .analysis-container {
            padding: 15px;
        }

        .analysis-header,
        .video-section,
        .reports-section,
        .metric-card,
        .actions-section {
            padding: 15px;
        }

        .analysis-meta {
            grid-template-columns: 1fr;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .report-tabs {
            overflow-x: auto;
        }

        .actions-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- –®–∞–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
    <div class="analysis-header">
        <h1 class="analysis-title">
            <span>üîç</span>
            –ê–Ω–∞–ª–∏–∑ –ø–æ—Ö–æ–¥–∫–∏
        </h1>
        
        <div class="analysis-meta">
            <div class="meta-item">
                <span class="meta-label">ID –∞–Ω–∞–ª–∏–∑–∞</span>
                <span class="meta-value" id="analysisId">#17</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">–°—Ç–∞—Ç—É—Å</span>
                <span class="meta-value" id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞</span>
                <span class="meta-value" id="analysisDate">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">–õ–æ—à–∞–¥—å</span>
                <span class="meta-value" id="animalName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    </div>

    <!-- –ú–µ—Ç—Ä–∏–∫–∏ (3 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–º–µ—Å—Ç–æ 4) -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-title">
                <span>üéØ</span>
                –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã
            </div>
            <div class="metric-value" id="lamenessProbability">0%</div>
            <div class="progress-bar">
                <div class="progress-fill progress-healthy" id="probabilityBar" style="width: 0%"></div>
            </div>
            <div class="metric-description" id="probabilityDescription">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span>üìä</span>
                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞
            </div>
            <div class="metric-value" id="analysisConfidence">0%</div>
            <div class="metric-description" id="confidenceDescription">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span>‚öôÔ∏è</span>
                –ú–æ–¥–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞
            </div>
            <div class="metric-value" id="modelName">SuperAnimal</div>
            <div class="metric-description">
                Quadruped HRNet W32
            </div>
        </div>
    </div>

    <!-- –í–∏–¥–µ–æ -->
    <div class="video-section">
        <h2 class="section-title">
            <span>üé¨</span>
            –í–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
        </h2>

        <div class="video-grid">
            <!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="video-card">
                <div class="video-header">
                    <h3>
                        <span>üé•</span>
                        –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                    </h3>
                </div>
                <div class="video-container" id="originalVideoContainer">
                    <div class="video-placeholder" id="originalVideoPlaceholder">
                        <div style="margin-bottom: 10px;">‚è≥</div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...
                    </div>
                </div>
                <div class="video-info">
                    <div class="video-filename" id="originalFilename" title="–ó–∞–≥—Ä—É–∑–∫–∞...">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <div class="video-actions">
                        <div class="video-status">
                            <span class="status-dot" id="originalStatusDot"></span>
                            <span id="originalStatusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                        <button class="btn-download" id="downloadOriginalBtn" disabled>
                            <span>‚¨áÔ∏è</span>
                            –°–∫–∞—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="video-card">
                <div class="video-header">
                    <h3>
                        <span>üéØ</span>
                        –í–∏–¥–µ–æ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π ML
                    </h3>
                </div>
                <div class="video-container" id="annotatedVideoContainer">
                    <div class="video-placeholder" id="annotatedVideoPlaceholder">
                        <div style="margin-bottom: 10px;">‚è≥</span>
                        –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...
                    </div>
                </div>
                <div class="video-info">
                    <div class="video-filename" id="annotatedFilename" title="–ó–∞–≥—Ä—É–∑–∫–∞...">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <div class="video-actions">
                        <div class="video-status">
                            <span class="status-dot" id="annotatedStatusDot"></span>
                            <span id="annotatedStatusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                        <button class="btn-download" id="downloadAnnotatedBtn" disabled>
                            <span>‚¨áÔ∏è</span>
                            –°–∫–∞—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Ç—á–µ—Ç—ã -->
    <div class="reports-section">
        <h2 class="section-title">
            <span>üìã</span>
            –û—Ç—á–µ—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
        </h2>

        <div class="report-tabs">
            <button class="report-tab active" onclick="switchReport('text')" id="textTabBtn">
                –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
            </button>
            <button class="report-tab" onclick="switchReport('graphic')" id="graphicTabBtn">
                –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
            </button>
            <button class="report-tab" onclick="switchReport('data')" id="dataTabBtn">
                –î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
            </button>
        </div>

        <div class="report-content">
            <div id="textReport" class="text-report">
                –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞...
            </div>
            <div id="graphicReport" style="display: none;">
                <div class="report-not-found" id="graphicReportPlaceholder">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞...
                </div>
            </div>
            <div id="dataReport" class="text-report" style="display: none;">
                <div class="report-not-found" id="dataReportPlaceholder">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞...
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn-download" onclick="downloadReport('text')" id="downloadTextBtn" disabled>
                <span>üìÑ</span>
                –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
            </button>
            <button class="btn-download" onclick="downloadReport('graphic')" id="downloadGraphicBtn" disabled>
                <span>üìä</span>
                –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
            </button>
            <button class="btn-download" onclick="downloadReport('data')" id="downloadDataBtn" disabled>
                <span>üìä</span>
                –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (H5)
            </button>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="actions-section">
        <h2 class="section-title">
            <span>‚ö°</span>
            –î–µ–π—Å—Ç–≤–∏—è
        </h2>
        <div class="actions-grid">
            <button class="action-button" onclick="goBack()">
                <span class="action-icon">‚Üê</span>
                –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            </button>
            <button class="action-button" onclick="calculateRation()">
                <span class="action-icon">ü•ï</span>
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω
            </button>
            <button class="action-button" onclick="newAnalysis()">
                <span class="action-icon">üîç</span>
                –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            </button>
            <button class="action-button delete" onclick="deleteAnalysis()">
                <span class="action-icon">üóëÔ∏è</span>
                –£–¥–∞–ª–∏—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
        </div>
    </div>
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let analysisData = null;
let analysisId = null;
let filePaths = {};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showToast(message, type = 'success') {
    const oldToast = document.querySelector('.toast');
    if (oldToast) oldToast.remove();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const icon = type === 'success' ? '‚úÖ' : '‚ùå';
    toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;

    document.body.appendChild(toast);

    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }
    }, 3000);
}

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function truncateFilename(filename, maxLength = 25) {
    if (!filename) return '';
    if (filename.length <= maxLength) return filename;
    
    const parts = filename.split('.');
    const extension = parts.length > 1 ? '.' + parts.pop() : '';
    const nameWithoutExt = parts.join('.');
    const truncated = nameWithoutExt.substring(0, maxLength - extension.length - 3);
    
    return truncated + '...' + extension;
}

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function switchReport(type) {
    document.querySelectorAll('.report-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    if (type === 'text') {
        document.getElementById('textTabBtn').classList.add('active');
    } else if (type === 'graphic') {
        document.getElementById('graphicTabBtn').classList.add('active');
    } else if (type === 'data') {
        document.getElementById('dataTabBtn').classList.add('active');
    }

    document.getElementById('textReport').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('graphicReport').style.display = type === 'graphic' ? 'block' : 'none';
    document.getElementById('dataReport').style.display = type === 'data' ? 'block' : 'none';
}

// –ü–û–õ–£–ß–ï–ù–ò–ï –¢–ï–ö–£–©–ï–ì–û ID –ò–ó URL
function getCurrentAnalysisId() {
    const path = window.location.pathname;
    const match = path.match(/\/analysis\/(\d+)\//);
    return match ? match[1] : null;
}

// –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ê–ù–ê–õ–ò–ó–ê
async function loadAnalysisData() {
    try {
        showLoading();
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID –∏–∑ URL
        analysisId = getCurrentAnalysisId();
        if (!analysisId) {
            throw new Error('ID –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL');
        }

        console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ ID: ${analysisId}`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const response = await fetch(`/api/analysis/${analysisId}/detail/`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ API:', data);
        
        analysisData = data.analysis || data;
        
        if (!analysisData) {
            throw new Error('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã');
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        renderAnalysisData();
        
        // –ò—â–µ–º —Ñ–∞–π–ª—ã
        await findFiles();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ
        await loadVideos();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã
        await loadReports();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        showToast(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
        renderError(error);
    } finally {
        hideLoading();
    }
}

// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–ù–ù–´–•
function renderAnalysisData() {
    if (!analysisData) return;
    
    console.log('–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö:', analysisData);
    
    // ID –∞–Ω–∞–ª–∏–∑–∞
    document.getElementById('analysisId').textContent = `#${analysisId}`;
    
    // –°—Ç–∞—Ç—É—Å - –±–µ—Ä–µ–º –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    const lamenessProb = analysisData.lameness_probability || analysisData.probability || 0;
    const isLame = analysisData.lameness_detected || lamenessProb > 50;
    
    document.getElementById('statusText').textContent = isLame ? '–•—Ä–æ–º–æ—Ç–∞' : '–ó–¥–æ—Ä–æ–≤';
    document.getElementById('statusText').className = isLame ? 'status-badge lame' : 'status-badge';
    
    // –î–∞—Ç–∞
    const date = analysisData.created_at || analysisData.analysis_date;
    if (date) {
        const dateObj = new Date(date);
        document.getElementById('analysisDate').textContent = 
            dateObj.toLocaleDateString('ru-RU') + ' ' + 
            dateObj.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    
    // –õ–æ—à–∞–¥—å
    document.getElementById('animalName').textContent = analysisData.animal_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    
    // –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã
    document.getElementById('lamenessProbability').textContent = `${lamenessProb.toFixed(1)}%`;
    document.getElementById('probabilityBar').style.width = `${lamenessProb}%`;
    
    let probDesc = '–ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    if (lamenessProb > 70) probDesc = '–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    else if (lamenessProb > 30) probDesc = '–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    document.getElementById('probabilityDescription').textContent = probDesc;
    
    // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
    const confidence = analysisData.lameness_confidence || analysisData.confidence || 0;
    document.getElementById('analysisConfidence').textContent = `${confidence.toFixed(1)}%`;
    
    let confDesc = '–í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    if (confidence < 40) confDesc = '–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    else if (confidence < 70) confDesc = '–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    document.getElementById('confidenceDescription').textContent = confDesc;
}

// –ü–û–ò–°–ö –§–ê–ô–õ–û–í
async function findFiles() {
    if (!analysisData) return;
    
    const videoFilename = analysisData.video_filename || 
                         analysisData.video?.filename || 
                         'unknown';
    
    console.log('–ò—â–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –≤–∏–¥–µ–æ:', videoFilename);
    
    // –ë–∞–∑–æ–≤–æ–µ –∏–º—è –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    const baseName = videoFilename.replace(/\.[^/.]+$/, "");
    
    // –í–ê–†–ò–ê–ù–¢–´ –ò–ú–ï–ù –§–ê–ô–õ–û–í (–∏–∑ –ª–æ–≥–æ–≤)
    const fileVariants = {
        originalVideo: [
            `/media/videos/${videoFilename}`,
            `/media/uploads/${videoFilename}`,
            `/media/videos/${baseName}.MP4`,
            `/media/videos/${baseName}.mp4`,
            `/media/videos/${baseName}.avi`
        ],
        annotatedVideo: [
            `/media/results/${baseName}_superanimal_quadruped_hrnet_w32_ssdlite__labeled_before_adapt.mp4`,
            `/media/results/${baseName}_labeled.mp4`,
            `/media/results/${baseName}_annotated.mp4`
        ],
        textReport: [
            `/media/results/results/${baseName}_result.txt`,
            `/media/results/${baseName}_result.txt`,
            `/media/results/results/result_${analysisId}.txt`
        ],
        graphicReport: [
            `/media/results/results/${baseName}_result.png`,
            `/media/results/${baseName}_result.png`,
            `/media/results/results/result_${analysisId}.png`
        ],
        poseData: [
            `/media/results/${baseName}_superanimal_quadruped_hrnet_w32_ssdlite_.h5`,
            `/media/results/${baseName}.h5`
        ]
    };
    
    filePaths = {};
    
    // –ò—â–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
    for (const [fileType, variants] of Object.entries(fileVariants)) {
        for (const path of variants) {
            try {
                console.log(`–ü—Ä–æ–≤–µ—Ä—è–µ–º ${fileType}: ${path}`);
                const response = await fetch(path, { method: 'HEAD' });
                
                if (response.ok) {
                    filePaths[fileType] = path;
                    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω ${fileType}: ${path}`);
                    break;
                }
            } catch (error) {
                continue;
            }
        }
        
        if (!filePaths[fileType]) {
            console.log(`‚ùå ${fileType} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
        }
    }
    
    console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:', filePaths);
}

// –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û
async function loadVideos() {
    // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
    if (filePaths.originalVideo) {
        await setupVideo('original', filePaths.originalVideo, analysisData.video_filename || 'video.mp4');
    } else {
        showVideoError('original', '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
    }
    
    // –†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
    if (filePaths.annotatedVideo) {
        await setupVideo('annotated', filePaths.annotatedVideo, 
                       `${analysisData.video_filename?.replace(/\.[^/.]+$/, '') || 'video'}_labeled.mp4`);
    } else {
        showVideoError('annotated', '–†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ');
    }
}

async function setupVideo(type, path, filename) {
    const containerId = `${type}VideoContainer`;
    const placeholderId = `${type}VideoPlaceholder`;
    const filenameId = `${type}Filename`;
    const statusDotId = `${type}StatusDot`;
    const statusTextId = `${type}StatusText`;
    const downloadBtnId = `download${type.charAt(0).toUpperCase() + type.slice(1)}Btn`;
    
    try {
        console.log(`–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ${type} –≤–∏–¥–µ–æ: ${path}`);
        
        // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
        const video = document.createElement('video');
        video.className = 'video-player';
        video.controls = true;
        video.preload = 'metadata';
        video.style.width = '100%';
        video.style.maxHeight = '250px';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
        const source = document.createElement('source');
        source.src = path;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME type –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
        if (path.toLowerCase().endsWith('.mp4')) {
            source.type = 'video/mp4';
        } else if (path.toLowerCase().endsWith('.avi')) {
            source.type = 'video/x-msvideo';
        } else if (path.toLowerCase().endsWith('.mov')) {
            source.type = 'video/quicktime';
        } else if (path.toLowerCase().endsWith('.webm')) {
            source.type = 'video/webm';
        } else {
            source.type = 'video/*';
        }
        
        video.appendChild(source);
        
        // –î–æ–±–∞–≤–ª—è–µ–º fallback —Ç–µ–∫—Å—Ç
        video.innerHTML += '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.';
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        video.onloadeddata = () => {
            console.log(`${type} –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`);
        };
        
        video.onerror = (e) => {
            console.error(`–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ ${type}:`, e);
            document.getElementById(placeholderId).innerHTML = 
                `<div style="margin-bottom: 10px;">‚ùå</div>` +
                `<div>–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</div>` +
                `<div style="font-size: 11px; margin-top: 5px; color: var(--text-tertiary);">${path.split('/').pop()}</div>`;
        };
        
        // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        container.appendChild(video);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        const displayName = filename;
        document.getElementById(filenameId).textContent = truncateFilename(displayName);
        document.getElementById(filenameId).title = displayName;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById(statusDotId).className = 'status-dot available';
        document.getElementById(statusTextId).textContent = '–î–æ—Å—Ç—É–ø–Ω–æ';
        document.getElementById(statusTextId).style.color = 'var(--success)';
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const btn = document.getElementById(downloadBtnId);
        btn.disabled = false;
        btn.onclick = () => downloadFile(path, filename);
        
        console.log(`${type} –≤–∏–¥–µ–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ`);
        
    } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ${type} –≤–∏–¥–µ–æ:`, error);
        showVideoError(type, `–û—à–∏–±–∫–∞: ${error.message}`);
    }
}

function showVideoError(type, message) {
    const placeholderId = `${type}VideoPlaceholder`;
    const statusTextId = `${type}StatusText`;
    const statusDotId = `${type}StatusDot`;
    
    document.getElementById(placeholderId).innerHTML = 
        `<div style="margin-bottom: 10px;">‚ùå</div>` +
        `<div>${message}</div>`;
    
    document.getElementById(statusDotId).className = 'status-dot';
    document.getElementById(statusTextId).textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
    document.getElementById(statusTextId).style.color = 'var(--error)';
}

// –ó–ê–ì–†–£–ó–ö–ê –û–¢–ß–ï–¢–û–í
async function loadReports() {
    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
    if (filePaths.textReport) {
        try {
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç:', filePaths.textReport);
            const response = await fetch(filePaths.textReport);
            
            if (response.ok) {
                const text = await response.text();
                document.getElementById('textReport').textContent = text;
                document.getElementById('downloadTextBtn').disabled = false;
                console.log('–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞:', error);
            document.getElementById('textReport').textContent = 
                `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ${error.message}\n\n` +
                `–ü—É—Ç—å: ${filePaths.textReport}\n\n` +
                generateReportFromData();
        }
    } else {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('textReport').textContent = generateReportFromData();
    }
    
    // –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
    if (filePaths.graphicReport) {
        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç:', filePaths.graphicReport);
        const img = document.createElement('img');
        img.className = 'graphic-report';
        img.src = filePaths.graphicReport;
        img.alt = '–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –∞–Ω–∞–ª–∏–∑–∞';
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        
        img.onload = () => {
            console.log('–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
            document.getElementById('graphicReport').innerHTML = '';
            document.getElementById('graphicReport').appendChild(img);
            document.getElementById('downloadGraphicBtn').disabled = false;
        };
        
        img.onerror = () => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞');
            document.getElementById('graphicReportPlaceholder').innerHTML = 
                `<div style="margin-bottom: 10px;">‚ùå</div>` +
                `<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>` +
                `<div style="font-size: 11px; margin-top: 5px; color: var(--text-tertiary);">${filePaths.graphicReport.split('/').pop()}</div>`;
        };
        
        // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('graphicReport').innerHTML = '';
        document.getElementById('graphicReport').appendChild(img);
    }
    
    // –î–∞–Ω–Ω—ã–µ –ø–æ–∑
    if (filePaths.poseData) {
        const fileName = filePaths.poseData.split('/').pop();
        document.getElementById('dataReportPlaceholder').innerHTML = 
            `<strong>üìä –î–∞–Ω–Ω—ã–µ –ø–æ–∑ (HDF5 —Ñ–æ—Ä–º–∞—Ç)</strong><br><br>` +
            `<strong>–§–∞–π–ª:</strong> ${fileName}<br>` +
            `<strong>–†–∞–∑–º–µ—Ä:</strong> H5 —Ñ–∞–π–ª —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫<br>` +
            `<strong>–°–æ–¥–µ—Ä–∂–∏—Ç:</strong> –ü–æ–∑–∏—Ü–∏–∏ —Å—É—Å—Ç–∞–≤–æ–≤ –ª–æ—à–∞–¥–∏ –≤ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ<br>` +
            `<strong>–ú–æ–¥–µ–ª—å:</strong> SuperAnimal Quadruped HRNet W32<br><br>` +
            `<em>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ —Ö—Ä–æ–º–æ—Ç—ã.</em>`;
        
        document.getElementById('downloadDataBtn').disabled = false;
        document.getElementById('downloadDataBtn').onclick = () => 
            downloadFile(filePaths.poseData, `pose_data_${analysisId}.h5`);
    }
}

function generateReportFromData() {
    if (!analysisData) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞';
    
    const lamenessProb = analysisData.lameness_probability || analysisData.probability || 0;
    const confidence = analysisData.lameness_confidence || analysisData.confidence || 0;
    const isLame = analysisData.lameness_detected || lamenessProb > 50;
    
    return `=== –û–¢–ß–ï–¢ –û–ë –ê–ù–ê–õ–ò–ó–ï –ü–û–•–û–î–ö–ò ===

–ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
ID –∞–Ω–∞–ª–∏–∑–∞: #${analysisId}
–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: ${analysisData.created_at ? new Date(analysisData.created_at).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
–õ–æ—à–∞–¥—å: ${analysisData.animal_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
–í–∏–¥–µ–æ: ${analysisData.video_filename || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}

–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–°—Ç–∞—Ç—É—Å: ${isLame ? '‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–ê –•–†–û–ú–û–¢–ê' : '‚úÖ –ó–î–û–†–û–í–ê–Ø –ü–û–•–û–î–ö–ê'}
–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã: ${lamenessProb.toFixed(1)}%
–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞: ${confidence.toFixed(1)}%

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ê–ù–ù–´–ï
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ú–æ–¥–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞: ${analysisData.model_used || 'SuperAnimal Quadruped HRNet W32'}
–î–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${new Date().toLocaleString('ru-RU')}

–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${isLame ? 
'1. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∞\n2. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –∂–∏–≤–æ—Ç–Ω–æ–µ\n3. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏' : 
'1. –ü–æ—Ö–æ–¥–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã\n2. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–ª–∞–Ω–æ–≤—ã–π –æ—Å–º–æ—Ç—Ä —á–µ—Ä–µ–∑ 6 –º–µ—Å—è—Ü–µ–≤\n3. –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥'}

=== –ö–û–ù–ï–¶ –û–¢–ß–ï–¢–ê ===
–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
HorseAI System`;
}

// –°–ö–ê–ß–ò–í–ê–ù–ò–ï –§–ê–ô–õ–û–í
function downloadFile(path, filename) {
    if (!path) {
        showToast('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
    }
    
    showLoading();
    
    fetch(path)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ "${filename}" –Ω–∞—á–∞–ª–æ—Å—å`, 'success');
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
        })
        .finally(() => {
            hideLoading();
        });
}

function downloadReport(type) {
    let path, filename;
    
    if (type === 'text') {
        path = filePaths.textReport;
        filename = `analysis_${analysisId}_report.txt`;
        
        // –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        if (!path) {
            const report = generateReportFromData();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showToast('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è', 'success');
            return;
        }
    } else if (type === 'graphic') {
        path = filePaths.graphicReport;
        filename = `analysis_${analysisId}_graphic.png`;
    } else if (type === 'data') {
        path = filePaths.poseData;
        filename = `analysis_${analysisId}_pose_data.h5`;
    }
    
    if (path) {
        downloadFile(path, filename);
    } else {
        showToast('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
    }
}

// –î–ï–ô–°–¢–í–ò–Ø
function goBack() {
    window.location.href = '/analysis/results/';
}

function calculateRation() {
    if (analysisData && analysisData.animal_id) {
        window.location.href = `/ration/?animal=${analysisData.animal_id}&analysis=${analysisId}`;
    } else {
        window.location.href = '/ration/';
    }
}

function newAnalysis() {
    window.location.href = '/video-upload/';
}

async function deleteAnalysis() {
    if (!analysisId || !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }

    try {
        showLoading();
        
        const response = await fetch(`/api/analysis/${analysisId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        });

        const data = await response.json();
        
        if (data.success || data.status === 'success') {
            showToast('–ê–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω', 'success');
            setTimeout(() => {
                window.location.href = '/analysis/results/';
            }, 1000);
        } else {
            showToast(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    } finally {
        hideLoading();
    }
}

function renderError(error) {
    const container = document.querySelector('.analysis-container');
    container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
            <h2 style="color: var(--text-primary); margin-bottom: 15px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h2>
            <p style="color: var(--text-secondary); margin-bottom: 10px;">${error.message}</p>
            <p style="color: var(--text-tertiary); margin-bottom: 30px; font-size: 14px;">
                Analysis ID: ${analysisId || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}<br>
                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π (F12 ‚Üí Console)
            </p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="goBack()" style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                </button>
                <button onclick="location.reload()" style="padding: 12px 24px; background: var(--border); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
                <button onclick="loadAnalysisData()" style="padding: 12px 24px; background: transparent; color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                    üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                </button>
            </div>
        </div>
    `;
}

// –û–¢–õ–ê–î–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
const originalFetch = window.fetch;
window.fetch = function(...args) {
    console.log('Fetch –∑–∞–ø—Ä–æ—Å:', args[0]);
    return originalFetch.apply(this, args).then(response => {
        console.log('Fetch –æ—Ç–≤–µ—Ç:', args[0], response.status);
        return response;
    }).catch(error => {
        console.error('Fetch –æ—à–∏–±–∫–∞:', args[0], error);
        throw error;
    });
};

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ –ê–ù–ê–õ–ò–ó–ê ===');
    console.log('URL:', window.location.href);
    console.log('Analysis ID –∏–∑ URL:', getCurrentAnalysisId());
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–∞–º
    fetch('/media/test.txt', { method: 'HEAD' })
        .then(res => console.log('–î–æ—Å—Ç—É–ø –∫ /media/:', res.status))
        .catch(err => console.log('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ /media/'));
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    setTimeout(() => {
        loadAnalysisData();
    }, 100);
});
</script>
