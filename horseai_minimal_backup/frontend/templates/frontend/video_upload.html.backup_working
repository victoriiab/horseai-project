{% extends "frontend/base.html" %}
{% load static %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ - HorseAI{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 40px auto; padding: 0 20px;">
    <div class="card" style="background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 40px;">
        <h1 style="font-size: 32px; color: #2c3e50; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;">
            <span>üé•</span>
            –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        </h1>
        
        <p style="color: #7f8c8d; font-size: 18px; margin-bottom: 30px;">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ö—Ä–æ–º–æ—Ç—ã
        </p>
        
        <form id="uploadForm" enctype="multipart/form-data" style="margin-bottom: 30px;">
            {% csrf_token %}
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 16px;">
                    <span>üê¥</span> –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å
                </label>
                <select id="animalSelect" name="animal_id" required style="width: 100%; padding: 12px 16px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 16px; background: #f8f9fa;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å --</option>
                    {% for animal in animals %}
                    <option value="{{ animal.animal_id }}">{{ animal.name }}</option>
                    {% endfor %}
                </select>
                {% if not animals %}
                <div style="margin-top: 10px; padding: 12px; background: #ffeaa7; border-radius: 8px; color: #d35400;">
                    <strong>‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ—Ç –ª–æ—à–∞–¥–µ–π.</strong>
                    <a href="{% url 'animals' %}" style="color: #e74c3c; font-weight: bold;"> –î–æ–±–∞–≤—å—Ç–µ –ª–æ—à–∞–¥—å —Å–Ω–∞—á–∞–ª–∞</a>
                </div>
                {% endif %}
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 16px;">
                    <span>üìπ</span> –í–∏–¥–µ–æ—Ñ–∞–π–ª
                </label>
                
                <div id="dropZone" style="border: 3px dashed #3498db; border-radius: 15px; padding: 40px 20px; text-align: center; background: #f8fbfe; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 48px; margin-bottom: 20px; color: #3498db;">üìÅ</div>
                    <h3 style="font-size: 20px; color: #2c3e50; margin-bottom: 10px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Å—é–¥–∞</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                    <button type="button" onclick="document.getElementById('videoFile').click()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                    </button>
                </div>
                
                <input type="file" id="videoFile" name="video_file" accept=".mp4,.avi,.mov,.mkv,.webm" required style="display: none;">
                
                <div id="fileInfo" style="margin-top: 15px; padding: 15px; background: #e8f4fc; border-radius: 10px; display: none;">
                    <div style="font-weight: 600; color: #2c3e50;" id="fileName"></div>
                    <div style="color: #7f8c8d; font-size: 14px;" id="fileSize"></div>
                </div>
                
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    <strong>–§–æ—Ä–º–∞—Ç—ã:</strong> MP4, AVI, MOV, MKV, WebM
                    <br>
                    <strong>–ú–∞–∫—Å–∏–º—É–º:</strong> 500 MB
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 16px;">
                    <span>üìù</span> –ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                </label>
                <input type="text" id="videoTitle" name="title" style="width: 100%; padding: 12px 16px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 16px;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–æ—à–∞–¥—å –Ω–∞ –ø—Ä–æ–≥—É–ª–∫–µ">
            </div>
            
            <div style="background: #fff8e1; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <h4 style="color: #f39c12; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>üí°</span> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                </h4>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="padding: 5px 0; color: #7f8c8d;">‚Ä¢ –°–Ω–∏–º–∞–π—Ç–µ –ª–æ—à–∞–¥—å —Å–±–æ–∫—É, –Ω–∞ —Ä–æ–≤–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏</li>
                    <li style="padding: 5px 0; color: #7f8c8d;">‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–æ—à–∞–¥—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –∫–∞–¥—Ä–µ</li>
                    <li style="padding: 5px 0; color: #7f8c8d;">‚Ä¢ –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ —É–ª—É—á—à–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å</li>
                    <li style="padding: 5px 0; color: #7f8c8d;">‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 10-30 —Å–µ–∫—É–Ω–¥</li>
                </ul>
            </div>
            
            <div id="progressContainer" style="margin-bottom: 20px; display: none;">
                <div style="height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                    <div id="progressFill" style="height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%;"></div>
                </div>
                <div id="progressText" style="text-align: center; color: #7f8c8d; margin-top: 10px;">–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏...</div>
            </div>
            
            <button type="submit" id="uploadBtn" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px;">
                <span>üöÄ</span>
                –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑ —Ö—Ä–æ–º–æ—Ç—ã
            </button>
        </form>
        
        <div style="text-align: center; color: #7f8c8d; font-size: 14px;">
            <p>–ê–Ω–∞–ª–∏–∑ –∑–∞–Ω–∏–º–∞–µ—Ç 1-3 –º–∏–Ω—É—Ç—ã. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('videoFile');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
    dropZone.addEventListener('click', () => fileInput.click());
    
    ['dragover', 'dragenter'].forEach(event => {
        dropZone.addEventListener(event, (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#2980b9';
            dropZone.style.background = '#e8f4fc';
        });
    });
    
    ['dragleave', 'dragend', 'drop'].forEach(event => {
        dropZone.addEventListener(event, () => {
            dropZone.style.borderColor = '#3498db';
            dropZone.style.background = '#f8fbfe';
        });
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            updateFileInfo();
        }
    });
    
    fileInput.addEventListener('change', updateFileInfo);
    
    function updateFileInfo() {
        if (fileInput.files.length) {
            const file = fileInput.files[0];
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            fileName.textContent = file.name;
            fileSize.textContent = `–†–∞–∑–º–µ—Ä: ${sizeMB} MB`;
            fileInfo.style.display = 'block';
        } else {
            fileInfo.style.display = 'none';
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const animalId = document.getElementById('animalSelect').value;
        const videoFile = fileInput.files[0];
        
        if (!animalId) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å');
            return;
        }
        
        if (!videoFile) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
        if (videoFile.size > 500 * 1024 * 1024) {
            alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 500MB');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span>‚è≥</span> –ó–∞–≥—Ä—É–∑–∫–∞...';
        progressContainer.style.display = 'block';
        progressText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...';
        
        // –°–æ–∑–¥–∞–µ–º FormData
        const formData = new FormData();
        formData.append('animal_id', animalId);
        formData.append('video_file', videoFile);
        formData.append('title', document.getElementById('videoTitle').value);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/upload/real/', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // –£—Å–ø–µ—Ö
                progressFill.style.width = '100%';
                progressText.textContent = '‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!';
                
                alert('üéâ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! –ê–Ω–∞–ª–∏–∑ –Ω–∞—á–∞—Ç.');
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.href = '{% url "analysis_results" %}';
                }, 2000);
            } else {
                // –û—à–∏–±–∫–∞
                progressText.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + result.error;
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<span>üîÑ</span> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
            }
        } catch (error) {
            // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏
            progressText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span>üîÑ</span> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        }
    });
});
</script>
{% endblock %}
