{% extends 'frontend/base.html' %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤ - HorseAI{% endblock %}

{% block extra_css %}
<style>
    .results-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .page-header { margin-bottom: 40px; }
    .page-title { font-size: 2.5rem; color: #2c3e50; margin-bottom: 10px; }
    .page-subtitle { color: #7f8c8d; font-size: 1.1rem; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); text-align: center; }
    .stat-value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
    .stat-label { color: #7f8c8d; font-size: 1rem; }
    .stat-healthy { border-top: 4px solid #4CAF50; }
    .stat-lame { border-top: 4px solid #f44336; }
    .stat-total { border-top: 4px solid #3498db; }
    
    .latest-analysis { background: white; border-radius: 15px; padding: 30px; margin-bottom: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .section-title { font-size: 1.8rem; color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #f1f1f1; padding-bottom: 15px; }
    
    .analysis-result { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .result-item { padding: 20px; background: #f8f9fa; border-radius: 8px; }
    .result-label { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px; }
    .result-value { font-size: 1.3rem; font-weight: bold; color: #2c3e50; }
    .result-value.lame { color: #f44336; }
    .result-value.healthy { color: #4CAF50; }
    
    .recommendations { background: #e8f5e9; padding: 25px; border-radius: 10px; border-left: 4px solid #4CAF50; margin-top: 30px; }
    .recommendations h4 { color: #2c3e50; margin-bottom: 15px; }
    .recommendations ul { margin: 0; padding-left: 20px; }
    .recommendations li { margin-bottom: 10px; color: #2c3e50; }
    
    .history-table { width: 100%; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .history-table th { background: #2c3e50; color: white; padding: 15px; text-align: left; }
    .history-table td { padding: 15px; border-bottom: 1px solid #f1f1f1; }
    .history-table tr:hover { background: #f8f9fa; }
    .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
    .status-healthy { background: #d4edda; color: #155724; }
    .status-lame { background: #f8d7da; color: #721c24; }
    
    .action-buttons { display: flex; gap: 15px; margin-top: 30px; }
    .action-btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    .btn-primary { background: #3498db; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    
    @media (max-width: 768px) {
        .stats-grid { grid-template-columns: 1fr; }
        .analysis-result { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
    <div class="page-header">
        <h1 class="page-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤</h1>
        <p class="page-subtitle">–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –∂–∏–≤–æ—Ç–Ω—ã—Ö</p>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card stat-total">
            <div class="stat-value">{{ total_count }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∞–Ω–∞–ª–∏–∑–æ–≤</div>
        </div>
        <div class="stat-card stat-healthy">
            <div class="stat-value">{{ healthy_count }}</div>
            <div class="stat-label">–ó–¥–æ—Ä–æ–≤—ã—Ö</div>
        </div>
        <div class="stat-card stat-lame">
            <div class="stat-value">{{ lame_count }}</div>
            <div class="stat-label">–° –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ —Ö—Ä–æ–º–æ—Ç—ã</div>
        </div>
    </div>
    
    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–π –∞–Ω–∞–ª–∏–∑ -->
    {% if analyses|length > 0 %}
    <div class="latest-analysis">
        <h2 class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∞–Ω–∞–ª–∏–∑</h2>
        
        {% with last_analysis=analyses.0 %}
        <div class="analysis-result">
            <div class="result-item">
                <div class="result-label">–ñ–∏–≤–æ—Ç–Ω–æ–µ</div>
                <div class="result-value">{{ last_analysis.video.animal.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</div>
            </div>
            <div class="result-item">
                <div class="result-label">–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞</div>
                <div class="result-value">{{ last_analysis.analysis_date|date:"d.m.Y H:i" }}</div>
            </div>
            <div class="result-item">
                <div class="result-label">–î–∏–∞–≥–Ω–æ–∑</div>
                <div class="result-value">{{ last_analysis.diagnosis|default:"–ù–æ—Ä–º–∞" }}</div>
            </div>
            <div class="result-item">
                <div class="result-label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã</div>
                <div class="result-value {% if last_analysis.is_lame %}lame{% else %}healthy{% endif %}">
                    {{ last_analysis.lameness_probability|default:0 }}%
                </div>
            </div>
            <div class="result-item">
                <div class="result-label">–•—Ä–æ–º–æ—Ç–∞</div>
                <div class="result-value {% if last_analysis.is_lame %}lame{% else %}healthy{% endif %}">
                    {% if last_analysis.is_lame %}–î–ê ‚ö†Ô∏è{% else %}–ù–ï–¢ ‚úÖ{% endif %}
                </div>
            </div>
            <div class="result-item">
                <div class="result-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞</div>
                <div class="result-value">{{ last_analysis.confidence_score|default:0|floatformat:2 }}</div>
            </div>
        </div>
        
        {% if last_analysis.diagnosis_note %}
        <div class="recommendations">
            <h4>üìù –ó–∞–º–µ—Ç–∫–∏ –ø–æ –∞–Ω–∞–ª–∏–∑—É:</h4>
            <p>{{ last_analysis.diagnosis_note }}</p>
        </div>
        {% endif %}
        
        <div class="action-buttons">
            <button class="action-btn btn-primary" onclick="window.location.href='/video-upload/'">
                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ
            </button>
            <button class="action-btn btn-success" onclick="window.location.href='/ration/'">
                üçé –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω
            </button>
        </div>
        {% endwith %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px; margin-bottom: 40px;">
        <div style="font-size: 4rem; margin-bottom: 20px;">üìä</div>
        <h2 style="color: #2c3e50; margin-bottom: 15px;">–ê–Ω–∞–ª–∏–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
        <p style="color: #7f8c8d; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏ –ª–æ—à–∞–¥–∏.
        </p>
        <button onclick="window.location.href='/video-upload/'" 
                style="background: #4CAF50; color: white; border: none; padding: 15px 30px; 
                       font-size: 18px; border-radius: 8px; cursor: pointer; font-weight: bold;">
            üé¨ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ
        </button>
    </div>
    {% endif %}
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ -->
    {% if analyses|length > 1 %}
    <div style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <h2 class="section-title">–ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤</h2>
        
        <div class="history-table-container" style="overflow-x: auto;">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ñ–∏–≤–æ—Ç–Ω–æ–µ</th>
                        <th>–î–∏–∞–≥–Ω–æ–∑</th>
                        <th>–•—Ä–æ–º–æ—Ç–∞</th>
                        <th>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</th>
                        <th>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for analysis in analyses|slice:"1:11" %}
                    <tr>
                        <td>{{ analysis.analysis_date|date:"d.m.Y H:i" }}</td>
                        <td>{{ analysis.video.animal.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</td>
                        <td>{{ analysis.diagnosis|default:"–ù–æ—Ä–º–∞" }}</td>
                        <td>
                            <span class="status-badge {% if analysis.is_lame %}status-lame{% else %}status-healthy{% endif %}">
                                {% if analysis.is_lame %}–•—Ä–æ–º–æ—Ç–∞{% else %}–ù–æ—Ä–º–∞{% endif %}
                            </span>
                        </td>
                        <td>{{ analysis.lameness_probability|default:0 }}%</td>
                        <td>{{ analysis.confidence_score|default:0|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if analyses|length > 11 %}
        <div style="text-align: center; margin-top: 20px;">
            <p style="color: #7f8c8d;">–ü–æ–∫–∞–∑–∞–Ω–æ 10 –∏–∑ {{ analyses|length }} –∞–Ω–∞–ª–∏–∑–æ–≤</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
    <div style="background: #e3f2fd; padding: 25px; border-radius: 10px; border-left: 4px solid #2196f3;">
        <h3 style="color: #1565c0; margin-bottom: 15px;">‚ÑπÔ∏è –ö–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div>
                <h4 style="color: #1976d2; margin-bottom: 10px;">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã</h4>
                <ul style="color: #2c3e50;">
                    <li><strong>0-20%:</strong> –ù–æ—Ä–º–∞, –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ö—Ä–æ–º–æ—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</li>
                    <li><strong>21-50%:</strong> –ü–æ–≥—Ä–∞–Ω–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ</li>
                    <li><strong>51-80%:</strong> –£–º–µ—Ä–µ–Ω–Ω–∞—è —Ö—Ä–æ–º–æ—Ç–∞, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∞</li>
                    <li><strong>81-100%:</strong> –í—ã—Ä–∞–∂–µ–Ω–Ω–∞—è —Ö—Ä–æ–º–æ—Ç–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–µ—á–µ–Ω–∏–µ</li>
                </ul>
            </div>
            <div>
                <h4 style="color: #1976d2; margin-bottom: 10px;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
                <ul style="color: #2c3e50;">
                    <li>–ü—Ä–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ >50% –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä—É</li>
                    <li>–°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –∞–Ω–∞–ª–∏–∑–∞–º–∏</li>
                    <li>–†–µ–≥—É–ª—è—Ä–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –¥–∏–Ω–∞–º–∏–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞—Å—á–µ—Ç —Ä–∞—Ü–∏–æ–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ REAL ML –∞–Ω–∞–ª–∏–∑–∞
function runRealMlAnalysis(videoId, analysisId) {
    if(!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å REAL ML –∞–Ω–∞–ª–∏–∑? –≠—Ç–æ –∑–∞–π–º–µ—Ç 5-10 –º–∏–Ω—É—Ç.')) return;
    
    fetch(`/api/ml/analyze/${videoId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            alert('‚úÖ REAL ML –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω! –ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            setTimeout(() => location.reload(), 5000);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
