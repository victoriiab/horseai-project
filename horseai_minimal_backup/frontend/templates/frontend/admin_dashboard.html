{% extends 'frontend/base.html' %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - HorseAI{% endblock %}

{% block extra_css %}
<style>
    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */
    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--bg-card), var(--bg-hover));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--earth));
    }

    .stat-card:hover {
        border-color: var(--accent);
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg), var(--glow);
    }

    .stat-number-lg {
        font-size: 40px;
        font-weight: 800;
        color: var(--accent-light);
        display: block;
        margin-bottom: 10px;
        line-height: 1;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 5px;
    }

    .stat-change {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 10px;
        display: inline-block;
    }

    .stat-change.positive {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
    }

    .stat-change.negative {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }

    .dashboard-section {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 30px;
        border: 1px solid var(--border);
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title::before {
        font-size: 20px;
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 25px 15px;
        background: var(--bg-hover);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.3s ease;
        text-align: center;
    }

    .quick-action:hover {
        background: var(--bg-card);
        border-color: var(--accent);
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }

    .quick-action-icon {
        font-size: 32px;
        margin-bottom: 15px;
    }

    .quick-action-text {
        font-size: 14px;
        font-weight: 500;
        line-height: 1.4;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .data-table th {
        text-align: left;
        padding: 12px 15px;
        background: var(--bg-hover);
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 13px;
        border-bottom: 1px solid var(--border);
    }

    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-light);
        color: var(--text-primary);
        font-size: 14px;
    }

    .data-table tr:hover {
        background: var(--bg-hover);
    }

    .user-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--bg-dark);
        border-radius: 12px;
        font-size: 12px;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-success {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
    }

    .status-warning {
        background: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
    }

    .status-error {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }

    .status-info {
        background: rgba(59, 130, 246, 0.2);
        color: #93c5fd;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    /* –¶–≤–µ—Ç–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stat-card-users::before { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
    .stat-card-animals::before { background: linear-gradient(90deg, var(--sage), #4d7c0f); }
    .stat-card-videos::before { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
    .stat-card-analyses::before { background: linear-gradient(90deg, var(--accent), var(--earth)); }

    @media (max-width: 768px) {
        .stat-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-actions-grid {
            grid-template-columns: 1fr;
        }
        
        .dashboard-section {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
    <div class="dashboard-section" style="border-left: 4px solid var(--accent);">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 style="font-size: 28px; font-weight: 800; color: var(--text-primary); margin-bottom: 5px;">
                    üõ°Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å HorseAI
                </h1>
                <p style="color: var(--text-secondary);">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π ‚Ä¢ {{ user.username }}
                    {% if user.is_superuser %} ‚Ä¢ üöÄ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %}
                </p>
            </div>
            <div class="flex gap-3">
                <a href="/admin/" class="nav-btn btn-primary" target="_blank">
                    <span>‚öôÔ∏è</span>
                    Django –ê–¥–º–∏–Ω–∫–∞
                </a>
                <a href="/" class="nav-btn" style="background: var(--bg-hover);">
                    <span>üè†</span>
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
        </div>
        
        <!-- –í—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å -->
        <div style="background: var(--bg-hover); padding: 15px; border-radius: var(--radius);">
            <div class="flex justify-between items-center">
                <div>
                    <span style="color: var(--text-secondary);">–°–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:</span>
                    <span style="color: var(--text-primary); font-weight: 500; margin-left: 10px;" id="serverTime">
                        {% now "H:i" %}
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 8px; height: 8px; background: var(--sage); border-radius: 50%;"></div>
                    <span style="color: var(--text-secondary);">–°—Ç–∞—Ç—É—Å: </span>
                    <span style="color: var(--sage); font-weight: 500;">–ê–∫—Ç–∏–≤–µ–Ω</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã -->
    <div class="dashboard-section">
        <h2 class="section-title">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        
        <div class="stat-grid">
            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            <div class="stat-card stat-card-users">
                <div class="stat-number-lg">{{ users_count|default:"0" }}</div>
                <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <div class="stat-change positive">+{{ new_animals_week|default:"0" }} –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
            
            <!-- –ñ–∏–≤–æ—Ç–Ω—ã–µ -->
            <div class="stat-card stat-card-animals">
                <div class="stat-number-lg">{{ animals_count|default:"0" }}</div>
                <div class="stat-label">–ñ–∏–≤–æ—Ç–Ω—ã—Ö</div>
                <div class="stat-change positive">+{{ new_animals_week|default:"0" }} –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
            
            <!-- –í–∏–¥–µ–æ -->
            <div class="stat-card stat-card-videos">
                <div class="stat-number-lg">{{ videos_count|default:"0" }}</div>
                <div class="stat-label">–í–∏–¥–µ–æ–∑–∞–ø–∏—Å–µ–π</div>
                <div class="stat-change positive">+{{ new_videos_week|default:"0" }} –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
            
            <!-- –ê–Ω–∞–ª–∏–∑—ã -->
            <div class="stat-card stat-card-analyses">
                <div class="stat-number-lg">{{ analyses_count|default:"0" }}</div>
                <div class="stat-label">–ê–Ω–∞–ª–∏–∑–æ–≤</div>
                <div class="stat-change positive">+{{ new_analyses_week|default:"0" }} –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="dashboard-section">
        <h2 class="section-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        
        <div class="quick-actions-grid">
            <a href="/admin/database/animal/" class="quick-action">
                <span class="quick-action-icon">üê¥</span>
                <span class="quick-action-text">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–º–∏</span>
            </a>
            
            <a href="/admin/database/video/" class="quick-action">
                <span class="quick-action-icon">üìπ</span>
                <span class="quick-action-text">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ</span>
            </a>
            
            <a href="/admin/database/analysis/" class="quick-action">
                <span class="quick-action-icon">üîç</span>
                <span class="quick-action-text">–ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∞–ª–∏–∑–æ–≤</span>
            </a>
            
            <a href="/admin/database/user/" class="quick-action">
                <span class="quick-action-icon">üë•</span>
                <span class="quick-action-text">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</span>
            </a>
            
            <a href="/admin/auth/user/" class="quick-action">
                <span class="quick-action-icon">üîê</span>
                <span class="quick-action-text">Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            </a>
            
            <a href="/admin/" class="quick-action">
                <span class="quick-action-icon">‚öôÔ∏è</span>
                <span class="quick-action-text">–ü–æ–ª–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞ Django</span>
            </a>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –¥–≤—É—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–µ -->
        <div class="dashboard-section">
            <h2 class="section-title">üÜï –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–µ</h2>
            
            {% if latest_animals %}
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th>–í–æ–∑—Ä–∞—Å—Ç</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for animal in latest_animals %}
                        <tr>
                            <td>
                                <strong>{{ animal.name|default:"–ë–µ–∑ –∏–º–µ–Ω–∏" }}</strong>
                                {% if animal.sex %}
                                <span style="color: var(--text-tertiary); font-size: 12px; margin-left: 5px;">
                                    {{ animal.sex }}
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="user-badge">
                                    <div style="width: 16px; height: 16px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 10px; color: white;">
                                        {{ animal.user.login|first|upper }}
                                    </div>
                                    {{ animal.user.login|truncatechars:12 }}
                                </div>
                            </td>
                            <td>
                                {% if animal.age %}
                                    {{ animal.age }} –ª–µ—Ç
                                {% else %}
                                    <span style="color: var(--text-tertiary);">‚Äî</span>
                                {% endif %}
                            </td>
                            <td style="color: var(--text-tertiary); font-size: 13px;">
                                {{ animal.created_at|date:"d.m.Y" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üê¥</div>
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö</p>
                <p style="font-size: 13px; margin-top: 10px;">–ñ–∏–≤–æ—Ç–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</p>
            </div>
            {% endif %}
        </div>
        
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏–∑—ã -->
        <div class="dashboard-section">
            <h2 class="section-title">üìà –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏–∑—ã</h2>
            
            {% if latest_analyses %}
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ê–Ω–∞–ª–∏–∑ ID</th>
                            <th>–•—Ä–æ–º–æ—Ç–∞</th>
                            <th>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analysis in latest_analyses %}
                        <tr>
                            <td>
                                <strong>#{{ analysis.analysis_id }}</strong>
                                {% if analysis.video.animal %}
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">
                                    {{ analysis.video.animal.name|default:"–ñ–∏–≤–æ—Ç–Ω–æ–µ" }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if analysis.is_lame %}
                                <span class="status-badge status-error">–î–∞</span>
                                {% else %}
                                <span class="status-badge status-success">–ù–µ—Ç</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if analysis.confidence_score %}
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 60px; height: 6px; background: var(--bg-hover); border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; width: {{ analysis.confidence_score|floatformat:2 }}%; background: var(--sage);"></div>
                                    </div>
                                    <span style="font-size: 12px; color: var(--text-secondary);">
                                        {{ analysis.confidence_score|floatformat:2 }}
                                    </span>
                                </div>
                                {% else %}
                                <span style="color: var(--text-tertiary);">‚Äî</span>
                                {% endif %}
                            </td>
                            <td style="color: var(--text-tertiary); font-size: 13px;">
                                {{ analysis.analysis_date|date:"d.m.Y"|default:"‚Äî" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–Ω–∞–ª–∏–∑–∞—Ö</p>
                <p style="font-size: 13px; margin-top: 10px;">–ê–Ω–∞–ª–∏–∑—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
function updateServerTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('serverTime').textContent = timeString;
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
updateServerTime();
setInterval(updateServerTime, 1000);

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
document.addEventListener('DOMContentLoaded', function() {
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    fetch('/api/system-stats/')
        .then(response => response.json())
        .then(data => {
            console.log('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', data);
            // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞–∫–∏–µ-—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        })
        .catch(error => console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error));
});
</script>
{% endblock %}
