{% extends 'frontend/base.html' %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ - HorseAI{% endblock %}

{% block extra_css %}
<style>
    .results-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .results-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .results-title {
        font-size: 36px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 10px;
        background: linear-gradient(135deg, var(--accent), var(--earth));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .results-subtitle {
        color: var(--text-secondary);
        font-size: 18px;
        line-height: 1.6;
        max-width: 800px;
        margin: 0 auto;
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: linear-gradient(145deg, var(--bg-card), var(--bg-dark));
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .stat-number {
        font-size: 42px;
        font-weight: 800;
        color: var(--accent-light);
        display: block;
        margin-bottom: 8px;
        line-height: 1;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ */
    .analyses-table {
        width: 100%;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        margin-bottom: 40px;
    }

    .table-header {
        background: linear-gradient(135deg, var(--accent), var(--earth));
        color: white;
        padding: 20px;
        font-weight: 600;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .table-body {
        max-height: 600px;
        overflow-y: auto;
    }

    .analysis-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
        gap: 15px;
        padding: 20px;
        border-bottom: 1px solid var(--border);
        align-items: center;
        transition: all 0.3s ease;
    }

    .analysis-row:hover {
        background: var(--bg-hover);
    }

    .analysis-row:last-child {
        border-bottom: none;
    }

    .column-header {
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-dark);
    }

    .animal-name {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 16px;
    }

    .date-cell {
        color: var(--text-secondary);
        font-size: 14px;
    }

    .status-cell {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        text-align: center;
    }

    .status-healthy {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-lame {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .probability-cell {
        font-weight: 600;
        font-size: 16px;
    }

    .action-cell {
        text-align: right;
    }

    .btn-view {
        padding: 8px 16px;
        background: var(--bg-hover);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-view:hover {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
        transform: translateY(-2px);
    }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
        text-align: center;
        padding: 80px 40px;
        background: linear-gradient(145deg, var(--bg-card), var(--bg-dark));
        border-radius: var(--radius-2xl);
        border: 3px dashed var(--border);
        margin: 40px 0;
    }

    .empty-icon {
        font-size: 80px;
        margin-bottom: 24px;
        opacity: 0.3;
    }

    .empty-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-secondary);
        margin-bottom: 16px;
    }

    .empty-description {
        color: var(--text-tertiary);
        font-size: 16px;
        max-width: 400px;
        margin: 0 auto 32px;
        line-height: 1.6;
    }

    /* –§–∏–ª—å—Ç—Ä—ã */
    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 12px 18px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text-primary);
        font-size: 15px;
        min-width: 200px;
        cursor: pointer;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1024px) {
        .analysis-row {
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .column-header {
            display: none;
        }
        
        .analysis-row::before {
            content: attr(data-label);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
    }

    @media (max-width: 768px) {
        .results-title {
            font-size: 28px;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .analysis-row {
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 15px;
        }
        
        .filters {
            flex-direction: column;
        }
        
        .filter-select {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
    <div class="results-header">
        <h1 class="results-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h1>
        <p class="results-subtitle">
            –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ –ø–æ—Ö–æ–¥–∫–∏ –≤–∞—à–∏—Ö –ª–æ—à–∞–¥–µ–π. 
            –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –¥–∏–Ω–∞–º–∏–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã.
        </p>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters">
        <select id="animalFilter" class="filter-select">
            <option value="">–í—Å–µ –ª–æ—à–∞–¥–∏</option>
            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
        </select>
        
        <select id="statusFilter" class="filter-select">
            <option value="">–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</option>
            <option value="healthy">–ó–¥–æ—Ä–æ–≤—ã–µ</option>
            <option value="lame">–° —Ö—Ä–æ–º–æ—Ç–æ–π</option>
        </select>
        
        <select id="dateFilter" class="filter-select">
            <option value="">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
            <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
            <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
            <option value="year">–ó–∞ –≥–æ–¥</option>
        </select>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number" id="totalAnalyses">0</span>
            <span class="stat-label">–í—Å–µ–≥–æ –∞–Ω–∞–ª–∏–∑–æ–≤</span>
        </div>
        
        <div class="stat-card">
            <span class="stat-number" id="healthyAnalyses">0</span>
            <span class="stat-label">–ó–¥–æ—Ä–æ–≤—ã–µ</span>
        </div>
        
        <div class="stat-card">
            <span class="stat-number" id="lameAnalyses">0</span>
            <span class="stat-label">–° —Ö—Ä–æ–º–æ—Ç–æ–π</span>
        </div>
        
        <div class="stat-card">
            <span class="stat-number" id="avgProbability">0%</span>
            <span class="stat-label">–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</span>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ -->
    <div class="analyses-table">
        <div class="table-header">
            <span>üìã</span>
            –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤
        </div>
        
        <div class="table-body">
            <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ -->
            <div class="analysis-row column-header" style="border-bottom: 1px solid var(--border); background: var(--bg-dark);">
                <div>–õ–æ—à–∞–¥—å</div>
                <div>–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞</div>
                <div>–°—Ç–∞—Ç—É—Å</div>
                <div>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</div>
                <div>–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å</div>
                <div>–î–µ–π—Å—Ç–≤–∏—è</div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ -->
            <div id="analysesList">
                <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
            </div>
        </div>
    </div>

    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-icon">üìä</div>
        <h3 class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
        <p class="empty-description">
            –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏.
        </p>
        <a href="/video-upload/" class="btn-upload" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: linear-gradient(135deg, var(--accent), var(--earth)); color: white; border-radius: var(--radius); text-decoration: none; font-weight: 600; font-size: 16px;">
            <span>üé¨</span>
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let allAnalyses = [];
let allAnimals = [];

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async function loadAnimals() {
    try {
        const response = await fetch('/api/simple-v2/animals/');
        const data = await response.json();
        
        if (data.success) {
            allAnimals = data.animals;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∂–∏–≤–æ—Ç–Ω—ã—Ö
            const animalFilter = document.getElementById('animalFilter');
            animalFilter.innerHTML = '<option value="">–í—Å–µ –ª–æ—à–∞–¥–∏</option>';
            
            allAnimals.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.animal_id;
                option.textContent = animal.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                animalFilter.appendChild(option);
            });
            
            return true;
        }
        return false;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö:', error);
        return false;
    }
}

async function loadAnalyses() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑—ã –¥–ª—è –≤—Å–µ—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö
        let allAnalysesData = [];
        
        for (const animal of allAnimals) {
            const response = await fetch(`/api/ml/animal/${animal.animal_id}/analyses/`);
            const data = await response.json();
            
            if (data.success && data.analyses) {
                data.analyses.forEach(analysis => {
                    analysis.animal_name = animal.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                    analysis.animal_id = animal.animal_id;
                    allAnalysesData.push(analysis);
                });
            }
        }
        
        allAnalyses = allAnalysesData.sort((a, b) => {
            return new Date(b.analysis_date || b.upload_date || 0) - new Date(a.analysis_date || a.upload_date || 0);
        });
        
        updateStatistics();
        renderAnalyses();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–æ–≤:', error);
        showEmptyState();
    }
}

function updateStatistics() {
    const total = allAnalyses.length;
    const healthy = allAnalyses.filter(a => !a.is_lame).length;
    const lame = allAnalyses.filter(a => a.is_lame).length;
    
    let avgProbability = 0;
    if (total > 0) {
        const sum = allAnalyses.reduce((acc, a) => acc + (a.lameness_probability || 0), 0);
        avgProbability = (sum / total).toFixed(1);
    }
    
    document.getElementById('totalAnalyses').textContent = total;
    document.getElementById('healthyAnalyses').textContent = healthy;
    document.getElementById('lameAnalyses').textContent = lame;
    document.getElementById('avgProbability').textContent = `${avgProbability}%`;
}

function renderAnalyses() {
    const analysesList = document.getElementById('analysesList');
    const emptyState = document.getElementById('emptyState');
    
    if (allAnalyses.length === 0) {
        analysesList.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    const animalFilter = document.getElementById('animalFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    let filteredAnalyses = allAnalyses;
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –∂–∏–≤–æ—Ç–Ω–æ–º—É
    if (animalFilter) {
        filteredAnalyses = filteredAnalyses.filter(a => a.animal_id == animalFilter);
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (statusFilter === 'healthy') {
        filteredAnalyses = filteredAnalyses.filter(a => !a.is_lame);
    } else if (statusFilter === 'lame') {
        filteredAnalyses = filteredAnalyses.filter(a => a.is_lame);
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
    if (dateFilter) {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (dateFilter) {
            case 'week':
                cutoffDate.setDate(now.getDate() - 7);
                break;
            case 'month':
                cutoffDate.setMonth(now.getMonth() - 1);
                break;
            case 'year':
                cutoffDate.setFullYear(now.getFullYear() - 1);
                break;
        }
        
        filteredAnalyses = filteredAnalyses.filter(a => {
            const analysisDate = new Date(a.analysis_date || a.upload_date || 0);
            return analysisDate >= cutoffDate;
        });
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–º
    let html = '';
    
    filteredAnalyses.forEach((analysis, index) => {
        const date = new Date(analysis.analysis_date || analysis.upload_date || Date.now());
        const dateStr = date.toLocaleDateString('ru-RU');
        const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        
        const probability = analysis.lameness_probability || 0;
        const confidence = analysis.confidence_score || analysis.lameness_confidence || 0;
        
        html += `
            <div class="analysis-row" data-label="–ê–Ω–∞–ª–∏–∑ #${index + 1}">
                <div class="animal-name">${analysis.animal_name}</div>
                <div class="date-cell">${dateStr} ${timeStr}</div>
                <div>
                    <span class="status-cell ${analysis.is_lame ? 'status-lame' : 'status-healthy'}">
                        ${analysis.is_lame ? '–•—Ä–æ–º–æ—Ç–∞' : '–ó–¥–æ—Ä–æ–≤–∞'}
                    </span>
                </div>
                <div class="probability-cell">${probability.toFixed(1)}%</div>
                <div class="probability-cell">${confidence.toFixed(1)}%</div>
                <div class="action-cell">
                    <button class="btn-view" onclick="viewAnalysisDetail(${analysis.analysis_id})">
                        <span>üëÅÔ∏è</span>
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                </div>
            </div>
        `;
    });
    
    analysesList.innerHTML = html || '<div class="analysis-row" style="text-align: center; padding: 40px; color: var(--text-secondary);">–ù–µ—Ç –∞–Ω–∞–ª–∏–∑–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º</div>';
}

function viewAnalysisDetail(analysisId) {
    window.location.href = `/analysis/${analysisId}/`;
}

function showEmptyState() {
    document.getElementById('analysesList').innerHTML = '';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('totalAnalyses').textContent = '0';
    document.getElementById('healthyAnalyses').textContent = '0';
    document.getElementById('lameAnalyses').textContent = '0';
    document.getElementById('avgProbability').textContent = '0%';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', async function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await loadAnimals();
    await loadAnalyses();
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    document.getElementById('animalFilter').addEventListener('change', renderAnalyses);
    document.getElementById('statusFilter').addEventListener('change', renderAnalyses);
    document.getElementById('dateFilter').addEventListener('change', renderAnalyses);
    
    console.log('Results page initialized');
});
</script>
{% endblock %}
