{% extends 'frontend/base.html' %}

{% block title %}–î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ - HorseAI{% endblock %}

{% block extra_css %}
<style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .analysis-detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* –®–∞–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ */
    .analysis-header {
        background: linear-gradient(135deg, var(--bg-card), #1e2436);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 40px;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
    }

    .analysis-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--accent), var(--accent-hover));
    }

    .analysis-title-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .analysis-title {
        font-size: 32px;
        font-weight: 800;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .analysis-meta {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .meta-label {
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .meta-value {
        color: var(--text-primary);
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* –°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑ */
    .analysis-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 24px;
        border-radius: 15px;
        font-size: 16px;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .status-healthy {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .status-lame {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    /* –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    @media (max-width: 768px) {
        .analysis-grid {
            grid-template-columns: 1fr;
        }
    }

    /* –ë–ª–æ–∫ –≤–∏–¥–µ–æ */
    .video-section {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 25px;
        border: 1px solid var(--border);
    }

    .section-title {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .video-container {
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        background: var(--bg-dark);
        margin-bottom: 20px;
    }

    .video-player {
        width: 100%;
        height: 400px;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
    }

    .video-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        margin-top: 15px;
    }

    .video-info-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .video-info-label {
        color: var(--text-secondary);
        font-size: 13px;
    }

    .video-info-value {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 15px;
    }

    .btn-download {
        padding: 10px 20px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-download:hover {
        background: var(--accent-hover);
        transform: translateY(-2px);
    }

    /* –ë–ª–æ–∫ –æ—Ç—á–µ—Ç–æ–≤ */
    .reports-section {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 25px;
        border: 1px solid var(--border);
    }

    .report-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 15px;
    }

    .report-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .report-tab:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    .report-tab.active {
        background: var(--accent);
        color: white;
    }

    .report-content {
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .text-report {
        color: var(--text-primary);
        line-height: 1.6;
        white-space: pre-wrap;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 14px;
    }

    .graphic-report {
        width: 100%;
        height: auto;
        border-radius: 10px;
        background: white;
    }

    /* –ë–ª–æ–∫ –º–µ—Ç—Ä–∏–∫ */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .metric-card {
        background: var(--bg-card);
        border-radius: 18px;
        padding: 25px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
    }

    .metric-card:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .metric-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .metric-value {
        font-size: 36px;
        font-weight: 800;
        color: var(--accent-light);
        margin-bottom: 10px;
        line-height: 1;
    }

    .metric-description {
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.5;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—ã */
    .progress-bar {
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
        margin: 15px 0;
    }

    .progress-fill {
        height: 100%;
        border-radius: 5px;
        transition: width 0.6s ease;
    }

    .progress-healthy {
        background: linear-gradient(90deg, #10b981, #34d399);
    }

    .progress-lame {
        background: linear-gradient(90deg, #ef4444, #fca5a5);
    }

    .confidence-indicator {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 10px;
    }

    .confidence-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .confidence-high { background: #10b981; }
    .confidence-medium { background: #f59e0b; }
    .confidence-low { background: #ef4444; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
    .actions-section {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 30px;
        border: 1px solid var(--border);
        margin-top: 40px;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .action-button {
        padding: 20px;
        border: 2px solid var(--border);
        border-radius: 15px;
        background: transparent;
        color: var(--text-primary);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        text-align: center;
    }

    .action-button:hover {
        border-color: var(--accent);
        background: rgba(217, 119, 6, 0.1);
        transform: translateY(-3px);
    }

    .action-button.delete:hover {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        color: #fca5a5;
    }

    .action-icon {
        font-size: 32px;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1024px) {
        .analysis-grid {
            grid-template-columns: 1fr;
        }
        
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .actions-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .analysis-title {
            font-size: 24px;
        }
        
        .analysis-meta {
            flex-direction: column;
            gap: 15px;
        }
        
        .video-player {
            height: 300px;
        }
        
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .report-tabs {
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: 10px;
        }
        
        .report-tab {
            white-space: nowrap;
        }
    }

    @media (max-width: 480px) {
        .analysis-detail-container {
            padding: 0 15px;
        }
        
        .analysis-header,
        .video-section,
        .reports-section,
        .metric-card,
        .actions-section {
            padding: 20px;
        }
        
        .video-player {
            height: 250px;
        }
        
        .video-info {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-detail-container">
    <!-- –®–∞–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
    <div class="analysis-header">
        <div class="analysis-title-section">
            <div>
                <h1 class="analysis-title">
                    <span>üîç</span>
                    –ê–Ω–∞–ª–∏–∑ –ø–æ—Ö–æ–¥–∫–∏
                </h1>
                <div class="analysis-meta" id="analysisMeta">
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
                </div>
            </div>
            <div id="analysisStatus" class="analysis-status">
                <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
            </div>
        </div>
    </div>

    <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <h3 class="metric-title">
                    <span>üéØ</span>
                    –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã
                </h3>
            </div>
            <div class="metric-value" id="lamenessProbability">0%</div>
            <div class="progress-bar">
                <div class="progress-fill progress-lame" id="probabilityBar" style="width: 0%"></div>
            </div>
            <div class="metric-description" id="probabilityDescription">
                –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞–ª–∏—á–∏—è —Ö—Ä–æ–º–æ—Ç—ã —É –ª–æ—à–∞–¥–∏
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <h3 class="metric-title">
                    <span>üìä</span>
                    –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞
                </h3>
            </div>
            <div class="metric-value" id="analysisConfidence">0%</div>
            <div class="confidence-indicator">
                <div class="confidence-dot confidence-high" id="confidenceDot"></div>
                <div class="metric-description" id="confidenceDescription">
                    –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
                </div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <h3 class="metric-title">
                    <span>‚öôÔ∏è</span>
                    –î–µ—Ç–∞–ª–∏ –º–æ–¥–µ–ª–∏
                </h3>
            </div>
            <div class="metric-value" id="modelInfo">SuperAnimal</div>
            <div class="metric-description">
                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è ML –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <h3 class="metric-title">
                    <span>‚è±Ô∏è</span>
                    –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                </h3>
            </div>
            <div class="metric-value" id="processingTime">0 —Å–µ–∫</div>
            <div class="metric-description">
                –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ –º–æ–¥–µ–ª—å—é
            </div>
        </div>
    </div>

    <!-- –í–∏–¥–µ–æ –∏ –æ—Ç—á–µ—Ç—ã -->
    <div class="analysis-grid">
        <!-- –ë–ª–æ–∫ –≤–∏–¥–µ–æ -->
        <div class="video-section">
            <h2 class="section-title">
                <span>üé¨</span>
                –í–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </h2>
            
            <!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="video-block">
                <h3 style="font-size: 16px; color: var(--text-secondary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <span>üé•</span>
                    –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                </h3>
                <div class="video-container">
                    <div class="video-player" id="originalVideoPlayer">
                        <!-- –í–∏–¥–µ–æ –ø–æ—è–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
                <div class="video-info">
                    <div class="video-info-item">
                        <span class="video-info-label">–§–æ—Ä–º–∞—Ç</span>
                        <span class="video-info-value" id="originalFormat">MP4</span>
                    </div>
                    <div class="video-info-item">
                        <span class="video-info-label">–†–∞–∑–º–µ—Ä</span>
                        <span class="video-info-value" id="originalSize">0 MB</span>
                    </div>
                    <button class="btn-download" onclick="downloadFile('original')">
                        <span>‚¨áÔ∏è</span>
                        –°–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
                    </button>
                </div>
            </div>

            <!-- –†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="video-block" style="margin-top: 30px;">
                <h3 style="font-size: 16px; color: var(--text-secondary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <span>üéØ</span>
                    –í–∏–¥–µ–æ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π ML
                </h3>
                <div class="video-container">
                    <div class="video-player" id="annotatedVideoPlayer">
                        <!-- –í–∏–¥–µ–æ –ø–æ—è–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
                <div class="video-info">
                    <div class="video-info-item">
                        <span class="video-info-label">–¢–∏–ø —Ä–∞–∑–º–µ—Ç–∫–∏</span>
                        <span class="video-info-value">–ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏</span>
                    </div>
                    <div class="video-info-item">
                        <span class="video-info-label">–ú–æ–¥–µ–ª—å</span>
                        <span class="video-info-value">SuperAnimal Quadruped</span>
                    </div>
                    <button class="btn-download" onclick="downloadFile('annotated')">
                        <span>‚¨áÔ∏è</span>
                        –°–∫–∞—á–∞—Ç—å —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π
                    </button>
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –æ—Ç—á–µ—Ç–æ–≤ -->
        <div class="reports-section">
            <h2 class="section-title">
                <span>üìã</span>
                –û—Ç—á–µ—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
            </h2>
            
            <div class="report-tabs">
                <button class="report-tab active" onclick="switchReport('text')">
                    –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
                </button>
                <button class="report-tab" onclick="switchReport('graphic')">
                    –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
                </button>
                <button class="report-tab" onclick="switchReport('data')">
                    –î–∞–Ω–Ω—ã–µ –ø–æ–∑
                </button>
            </div>
            
            <div class="report-content">
                <div id="textReport" class="text-report">
                    <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div id="graphicReport" class="report-content" style="display: none;">
                    <img id="graphicReportImage" class="graphic-report" src="" alt="–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç">
                </div>
                <div id="dataReport" class="text-report" style="display: none;">
                    <!-- –î–∞–Ω–Ω—ã–µ –ø–æ–∑ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn-download" onclick="downloadReport('text')">
                    <span>üìÑ</span>
                    –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
                </button>
                <button class="btn-download" onclick="downloadReport('graphic')">
                    <span>üìä</span>
                    –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫—É
                </button>
                <button class="btn-download" onclick="downloadReport('data')">
                    <span>üìä</span>
                    –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–∑
                </button>
            </div>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="actions-section">
        <h2 class="section-title">
            <span>‚ö°</span>
            –î–µ–π—Å—Ç–≤–∏—è
        </h2>
        <div class="actions-grid">
            <button class="action-button" onclick="window.history.back()">
                <span class="action-icon">‚Üê</span>
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
            </button>
            <button class="action-button" onclick="shareAnalysis()">
                <span class="action-icon">üì§</span>
                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            </button>
            <button class="action-button" onclick="printReport()">
                <span class="action-icon">üñ®Ô∏è</span>
                –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –æ—Ç—á–µ—Ç
            </button>
            <button class="action-button delete" onclick="deleteAnalysis()">
                <span class="action-icon">üóëÔ∏è</span>
                –£–¥–∞–ª–∏—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let analysisData = null;
let analysisId = null;

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getCSRFToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfInput ? csrfInput.value : '';
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const icon = type === 'success' ? '‚úÖ' : '‚ùå';
    toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
    
    const oldToast = document.querySelector('.toast');
    if (oldToast) oldToast.remove();
    
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞
async function loadAnalysisData() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ URL
        const path = window.location.pathname;
        const match = path.match(/\/analysis\/(\d+)\//);
        if (!match) {
            throw new Error('ID –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL');
        }
        
        analysisId = match[1];
        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑ ID: ${analysisId}`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
        const response = await fetch(`/api/analysis/${analysisId}/detail/`);
        if (!response.ok) {
            throw new Error(`HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞:', data);
        
        if (data.success && data.analysis) {
            analysisData = data.analysis;
            renderAnalysis();
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞', 'error');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        document.querySelector('.analysis-detail-container').innerHTML = `
            <div style="text-align: center; padding: 100px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                <h2 style="color: var(--text-primary); margin-bottom: 15px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">${error.message}</p>
                <button onclick="window.history.back()" style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
                </button>
            </div>
        `;
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞
function renderAnalysis() {
    if (!analysisData) return;
    
    // –®–∞–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
    document.getElementById('analysisMeta').innerHTML = `
        <div class="meta-item">
            <span class="meta-label">–õ–æ—à–∞–¥—å</span>
            <span class="meta-value">
                <span>üê¥</span>
                ${analysisData.animal_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
            </span>
        </div>
        <div class="meta-item">
            <span class="meta-label">–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞</span>
            <span class="meta-value">
                <span>üìÖ</span>
                ${new Date(analysisData.analysis_date || analysisData.created_at).toLocaleDateString('ru-RU')}
            </span>
        </div>
        <div class="meta-item">
            <span class="meta-label">–í–∏–¥–µ–æ</span>
            <span class="meta-value">
                <span>üé•</span>
                ${analysisData.video_filename || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
            </span>
        </div>
    `;
    
    // –°—Ç–∞—Ç—É—Å
    const statusElement = document.getElementById('analysisStatus');
    if (analysisData.is_lame) {
        statusElement.className = 'analysis-status status-lame';
        statusElement.innerHTML = '<span>‚ö†Ô∏è</span> –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ö—Ä–æ–º–æ—Ç–∞';
    } else {
        statusElement.className = 'analysis-status status-healthy';
        statusElement.innerHTML = '<span>‚úÖ</span> –ó–¥–æ—Ä–æ–≤–∞—è –ø–æ—Ö–æ–¥–∫–∞';
    }
    
    // –ú–µ—Ç—Ä–∏–∫–∏
    const probability = analysisData.lameness_probability || 0;
    const confidence = analysisData.lameness_confidence || analysisData.confidence_score || 0;
    
    document.getElementById('lamenessProbability').textContent = `${probability.toFixed(1)}%`;
    document.getElementById('probabilityBar').style.width = `${probability}%`;
    
    let probabilityDescription = '–ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    if (probability > 70) probabilityDescription = '–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    else if (probability > 30) probabilityDescription = '–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    document.getElementById('probabilityDescription').textContent = probabilityDescription;
    
    document.getElementById('analysisConfidence').textContent = `${confidence.toFixed(1)}%`;
    
    const confidenceDot = document.getElementById('confidenceDot');
    if (confidence > 70) {
        confidenceDot.className = 'confidence-dot confidence-high';
    } else if (confidence > 40) {
        confidenceDot.className = 'confidence-dot confidence-medium';
    } else {
        confidenceDot.className = 'confidence-dot confidence-low';
    }
    
    let confidenceDescription = '–í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    if (confidence < 40) confidenceDescription = '–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    else if (confidence < 70) confidenceDescription = '–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    document.getElementById('confidenceDescription').textContent = confidenceDescription;
    
    // –í–∏–¥–µ–æ
    if (analysisData.video_path) {
        document.getElementById('originalVideoPlayer').innerHTML = `
            <video controls style="width: 100%; height: 100%; object-fit: contain;">
                <source src="${analysisData.video_path}" type="video/mp4">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
            </video>
        `;
    }
    
    if (analysisData.annotated_video_path) {
        document.getElementById('annotatedVideoPlayer').innerHTML = `
            <video controls style="width: 100%; height: 100%; object-fit: contain;">
                <source src="${analysisData.annotated_video_path}" type="video/mp4">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
            </video>
        `;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã
    loadReports();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
async function loadReports() {
    try {
        // –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
        if (analysisData.text_report_path) {
            const response = await fetch(analysisData.text_report_path);
            if (response.ok) {
                const text = await response.text();
                document.getElementById('textReport').textContent = text;
            }
        }
        
        // –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
        if (analysisData.graphic_report_path) {
            document.getElementById('graphicReportImage').src = analysisData.graphic_report_path;
        }
        
        // –î–∞–Ω–Ω—ã–µ –ø–æ–∑ (H5 —Ñ–∞–π–ª - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)
        if (analysisData.pose_data_path) {
            document.getElementById('dataReport').textContent = 
                `–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑: ${analysisData.pose_data_path}\n\n` +
                `–†–∞–∑–º–µ—Ä: ${analysisData.pose_data_size || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n` +
                `–¢–∏–ø: HDF5 (H5)\n` +
                `–ú–æ–¥–µ–ª—å: SuperAnimal Quadruped HRNet W32\n` +
                `–°–æ–¥–µ—Ä–∂–∏—Ç: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏`;
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:', error);
        document.getElementById('textReport').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞';
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –æ—Ç—á–µ—Ç–∞–º–∏
function switchReport(type) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∞–±—ã
    document.querySelectorAll('.report-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    document.getElementById('textReport').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('graphicReport').style.display = type === 'graphic' ? 'block' : 'none';
    document.getElementById('dataReport').style.display = type === 'data' ? 'block' : 'none';
}

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
function downloadFile(type) {
    if (!analysisData) return;
    
    let url;
    let filename;
    
    if (type === 'original') {
        url = analysisData.video_path;
        filename = analysisData.video_filename || 'original_video.mp4';
    } else if (type === 'annotated') {
        url = analysisData.annotated_video_path;
        filename = (analysisData.video_filename || 'video') + '_annotated.mp4';
    }
    
    if (url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        showToast('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
    }
}

function downloadReport(type) {
    if (!analysisData) return;
    
    let url;
    let filename;
    
    if (type === 'text') {
        url = analysisData.text_report_path;
        filename = (analysisData.video_filename || 'analysis') + '_report.txt';
    } else if (type === 'graphic') {
        url = analysisData.graphic_report_path;
        filename = (analysisData.video_filename || 'analysis') + '_graphic.png';
    } else if (type === 'data') {
        url = analysisData.pose_data_path;
        filename = (analysisData.video_filename || 'analysis') + '_pose_data.h5';
    }
    
    if (url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        showToast('–û—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞
async function deleteAnalysis() {
    if (!analysisData || !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/analysis/${analysisId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('–ê–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω', 'success');
            setTimeout(() => {
                window.location.href = '/analysis/results/';
            }, 1000);
        } else {
            showToast(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function shareAnalysis() {
    if (navigator.share) {
        navigator.share({
            title: `–ê–Ω–∞–ª–∏–∑ –ø–æ—Ö–æ–¥–∫–∏: ${analysisData.animal_name || '–õ–æ—à–∞–¥—å'}`,
            text: `–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã: ${analysisData.lameness_probability || 0}%`,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href);
        showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
    }
}

function printReport() {
    window.print();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', loadAnalysisData);
</script>
{% endblock %}
