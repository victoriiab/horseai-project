{% extends 'frontend/base.html' %}

{% block title %}–ê–Ω–∞–ª–∏–∑ #{{ analysis_id }} - HorseAI{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg-dark: #121826;
        --bg-card: #1e2436;
        --border: #2a3246;
        --text-primary: #e4e8f0;
        --text-secondary: #a0abc0;
        --text-tertiary: #6b7280;
        --accent: #d97706;
        --accent-hover: #f59e0b;
        --success: #10b981;
        --error: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --radius: 8px;
    }

    .analysis-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* –®–∞–ø–∫–∞ */
    .analysis-header {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid var(--border);
    }

    .analysis-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .analysis-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .meta-label {
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
    }

    .meta-value {
        color: var(--text-primary);
        font-size: 16px;
        font-weight: 600;
        word-break: break-word;
    }

    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
    }

    .status-badge.healthy {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-badge.lame {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* –ú–µ—Ç—Ä–∏–∫–∏ */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid var(--border);
    }

    .metric-title {
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .metric-value {
        color: var(--text-primary);
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .metric-description {
        color: var(--text-tertiary);
        font-size: 13px;
        line-height: 1.4;
    }

    .progress-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-healthy {
        background: linear-gradient(90deg, #10b981, #34d399);
    }

    .progress-lame {
        background: linear-gradient(90deg, #ef4444, #fca5a5);
    }

    /* –í–∏–¥–µ–æ */
    .video-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    @media (max-width: 768px) {
        .video-grid {
            grid-template-columns: 1fr;
        }
    }

    .video-card {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
    }

    .video-header {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .video-header h3 {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
        margin: 0;
    }

    .video-container {
        position: relative;
        background: #000;
        min-height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .video-player {
        width: 100%;
        max-width: 100%;
        height: auto;
        max-height: 300px;
        object-fit: contain;
        display: block;
    }

    .video-placeholder {
        color: var(--text-tertiary);
        text-align: center;
        padding: 40px 20px;
        width: 100%;
    }

    .video-placeholder-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .video-info {
        padding: 15px;
    }

    .video-filename {
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 10px;
        word-break: break-all;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
        max-height: 2.8em;
        cursor: help;
    }

    .video-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }

    .video-status {
        color: var(--text-secondary);
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-available {
        background: var(--success);
    }

    .status-warning {
        background: var(--warning);
    }

    .status-error {
        background: var(--error);
    }

    .status-info {
        background: var(--info);
    }

    .btn-download {
        padding: 6px 12px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-primary);
        border-radius: var(--radius);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .btn-download:hover:not(:disabled) {
        border-color: var(--accent);
        background: rgba(217, 119, 6, 0.1);
    }

    .btn-download:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* –û—Ç—á–µ—Ç—ã */
    .reports-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 30px;
    }

    .report-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 15px;
        overflow-x: auto;
    }

    .report-tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border-radius: var(--radius);
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .report-tab:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    .report-tab.active {
        background: var(--accent);
        color: white;
    }

    .report-content {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 20px;
    }

    .text-report {
        color: var(--text-primary);
        line-height: 1.6;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 14px;
        word-break: break-word;
    }

    .graphic-report {
        width: 100%;
        height: auto;
        border-radius: 8px;
        display: block;
        margin: 0 auto;
        max-width: 100%;
    }

    .report-not-found {
        color: var(--text-tertiary);
        text-align: center;
        padding: 40px 20px;
        font-style: italic;
    }

    /* –î–µ–π—Å—Ç–≤–∏—è */
    .actions-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .action-button {
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: transparent;
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        text-align: center;
    }

    .action-button:hover {
        border-color: var(--accent);
        background: rgba(217, 119, 6, 0.1);
    }

    .action-button.delete:hover {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        color: #fca5a5;
    }

    .action-icon {
        font-size: 24px;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(217, 119, 6, 0.3);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 9998;
        animation: slideIn 0.3s ease;
        max-width: 350px;
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .toast-success {
        color: #34d399;
        border-color: rgba(16, 185, 129, 0.3);
    }

    .toast-error {
        color: #fca5a5;
        border-color: rgba(239, 68, 68, 0.3);
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .analysis-container {
            padding: 15px;
        }

        .analysis-header,
        .video-section,
        .reports-section,
        .metric-card,
        .actions-section {
            padding: 15px;
        }

        .analysis-meta {
            grid-template-columns: 1fr;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .report-tabs {
            overflow-x: auto;
        }

        .actions-grid {
            grid-template-columns: 1fr;
        }

        .video-player {
            max-height: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- –®–∞–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
    <div class="analysis-header">
        <h1 class="analysis-title">
            <span>üîç</span>
            –ê–Ω–∞–ª–∏–∑ –ø–æ—Ö–æ–¥–∫–∏
        </h1>

        <div class="analysis-meta">
            <div class="meta-item">
                <span class="meta-label">ID –∞–Ω–∞–ª–∏–∑–∞</span>
                <span class="meta-value" id="analysisId">#{{ analysis_id }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">–°—Ç–∞—Ç—É—Å</span>
                <span class="meta-value" id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞</span>
                <span class="meta-value" id="analysisDate">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">–õ–æ—à–∞–¥—å</span>
                <span class="meta-value" id="animalName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    </div>

    <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-title">
                <span>üéØ</span>
                –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã
            </div>
            <div class="metric-value" id="lamenessProbability">0%</div>
            <div class="progress-bar">
                <div class="progress-fill progress-healthy" id="probabilityBar" style="width: 0%"></div>
            </div>
            <div class="metric-description" id="probabilityDescription">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span>üìä</span>
                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞
            </div>
            <div class="metric-value" id="analysisConfidence">0%</div>
            <div class="progress-description" id="confidenceDescription">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">
                <span>‚öôÔ∏è</span>
                –ú–æ–¥–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞
            </div>
            <div class="metric-value" id="modelName">SuperAnimal</div>
            <div class="metric-description">
                Quadruped HRNet W32
            </div>
        </div>
    </div>

    <!-- –í–∏–¥–µ–æ -->
    <div class="video-section">
        <h2 class="section-title">
            <span>üé¨</span>
            –í–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
        </h2>

        <div class="video-grid">
            <!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="video-card">
                <div class="video-header">
                    <h3>
                        <span>üé•</span>
                        –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                    </h3>
                </div>
                <div class="video-container" id="originalVideoContainer">
                    <div class="video-placeholder" id="originalVideoPlaceholder">
                        <div class="video-placeholder-icon">üé•</div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...
                    </div>
                    <video class="video-player" id="originalVideoPlayer" controls preload="metadata" style="display: none;">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                    </video>
                </div>
                <div class="video-info">
                    <div class="video-filename" id="originalFilename" title="–ó–∞–≥—Ä—É–∑–∫–∞...">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <div class="video-actions">
                        <div class="video-status">
                            <span class="status-dot" id="originalStatusDot"></span>
                            <span id="originalStatusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <button class="btn-download" id="downloadOriginalBtn" onclick="downloadOriginalVideo()" disabled>
                            <span>‚¨áÔ∏è</span>
                            –°–∫–∞—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="video-card">
                <div class="video-header">
                    <h3>
                        <span>üéØ</span>
                        –í–∏–¥–µ–æ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π ML
                    </h3>
                </div>
                <div class="video-container" id="annotatedVideoContainer">
                    <div class="video-placeholder" id="annotatedVideoPlaceholder">
                        <div class="video-placeholder-icon">üîÑ</div>
                        –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...
                    </div>
                    <video class="video-player" id="annotatedVideoPlayer" controls preload="metadata" style="display: none;">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                    </video>
                </div>
                <div class="video-info">
                    <div class="video-filename" id="annotatedFilename" title="–ó–∞–≥—Ä—É–∑–∫–∞...">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <div class="video-actions">
                        <div class="video-status">
                            <span class="status-dot" id="annotatedStatusDot"></span>
                            <span id="annotatedStatusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                        <button class="btn-download" id="downloadAnnotatedBtn" onclick="downloadAnnotatedVideo()" disabled>
                            <span>‚¨áÔ∏è</span>
                            –°–∫–∞—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Ç—á–µ—Ç—ã -->
    <div class="reports-section">
        <h2 class="section-title">
            <span>üìã</span>
            –û—Ç—á–µ—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
        </h2>

        <div class="report-tabs">
            <button class="report-tab active" data-tab="text" onclick="switchReport('text')">
                –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
            </button>
            <button class="report-tab" data-tab="graphic" onclick="switchReport('graphic')">
                –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
            </button>
            <button class="report-tab" data-tab="data" onclick="switchReport('data')">
                –î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
            </button>
        </div>

        <div class="report-content">
            <div id="textReportContent" class="text-report">
                –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞...
            </div>
            <div id="graphicReportContent" style="display: none;">
                <div class="report-not-found" id="graphicReportPlaceholder">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞...
                </div>
            </div>
            <div id="dataReportContent" class="text-report" style="display: none;">
                <div class="report-not-found" id="dataReportPlaceholder">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞...
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn-download" onclick="downloadTextReport()" id="downloadTextBtn" disabled>
                <span>üìÑ</span>
                –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
            </button>
            <button class="btn-download" onclick="downloadGraphicReport()" id="downloadGraphicBtn" disabled>
                <span>üìä</span>
                –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
            </button>
            <button class="btn-download" onclick="downloadData()" id="downloadDataBtn" disabled>
                <span>üìä</span>
                –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (H5)
            </button>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="actions-section">
        <h2 class="section-title">
            <span>‚ö°</span>
            –î–µ–π—Å—Ç–≤–∏—è
        </h2>
        <div class="actions-grid">
            <button class="action-button" onclick="goBack()">
                <span class="action-icon">‚Üê</span>
                –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            </button>
            <button class="action-button" onclick="calculateRation()" id="calculateRationBtn">
                <span class="action-icon">ü•ï</span>
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω
            </button>
            <button class="action-button" onclick="newAnalysis()">
                <span class="action-icon">üîç</span>
                –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            </button>
            <button class="action-button delete" onclick="deleteAnalysis()" id="deleteBtn">
                <span class="action-icon">üóëÔ∏è</span>
                –£–¥–∞–ª–∏—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
        </div>
    </div>
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================
// –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î –° –†–ê–ë–û–ß–ò–ú –í–ò–î–ï–û –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–û–ú
// ============================================

let currentAnalysisId = {{ analysis_id|default:"null" }};
let analysisData = null;
let videoPaths = {};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showToast(message, type = 'success') {
    const oldToast = document.querySelector('.toast');
    if (oldToast) oldToast.remove();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const icon = type === 'success' ? '‚úÖ' : '‚ùå';
    toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;

    document.body.appendChild(toast);

    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }
    }, 3000);
}

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function updateVideoStatus(elementId, status, message) {
    const statusDot = document.getElementById(`${elementId}StatusDot`);
(venv) root@aislab56:/home/ais/shared/horseAI/frontend/templates/frontend# cd /home/ais/shared/horseAI/media/detector_results
(venv) root@aislab56:/home/ais/shared/horseAI/media/detector_results# ls -la
–∏—Ç–æ–≥–æ 76
drwxr-xr-x 19 root root 4096 –¥–µ–∫ 24 11:32 .
drwxr-xr-x 14 root root 4096 –¥–µ–∫ 24 11:32 ..
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 13 07:37 a53303b6
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 13 07:46 d2950995
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 13 07:42 e9d860d9
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 13 07:33 fb7d22b2
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 23 23:14 vid_36
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 23 23:33 vid_39
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 23 23:37 vid_40
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 23 23:45 vid_41
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 23 23:53 vid_42
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 23 23:57 vid_43
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 24 00:06 vid_44
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 24 09:25 vid_45
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 24 09:28 vid_46
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 24 09:31 vid_47
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 24 09:42 vid_48
drwxr-xr-x  2 root root 4096 –¥–µ–∫ 24 10:17 vid_49
drwxr-xr-x  3 root root 4096 –¥–µ–∫ 24 11:46 vid_50
(venv) root@aislab56:/home/ais/shared/horseAI/media/detector_results# cd vid_50
(venv) root@aislab56:/home/ais/shared/horseAI/media/detector_results/vid_50# ls -la
–∏—Ç–æ–≥–æ 8496
drwxr-xr-x  3 root root    4096 –¥–µ–∫ 24 11:46 .
drwxr-xr-x 19 root root    4096 –¥–µ–∫ 24 11:32 ..
drwxr-xr-x  2 root root    4096 –¥–µ–∫ 24 11:46 20251224_093208_dbfd2cae_IMG_3451
-rw-r--r--  1 root root  438885 –¥–µ–∫ 24 11:46 20251224_093208_dbfd2cae_IMG_3    const statusText = document.getElementById(`${elementId}StatusText`);
    
    if (statusDot) {
        statusDot.className = 'status-dot';
        statusDot.classList.add(`status-${status}`);
    }
    
    if (statusText) {
        statusText.textContent = message;
        
        const colors = {
            available: '#10b981',
            warning: '#f59e0b',
            error: '#ef4444',
            info: '#3b82f6'
        };
        statusText.style.color = colors[status] || colors.info;
    }
}

// ============================================
// –û–°–ù–û–í–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
// ============================================

async function loadAnalysisData() {
    try {
        showLoading();
        
        if (!currentAnalysisId || currentAnalysisId === "null") {
            const path = window.location.pathname;
            const match = path.match(/\/analysis\/(\d+)\//);
            currentAnalysisId = match ? parseInt(match[1]) : null;
        }

        if (!currentAnalysisId) {
            throw new Error('ID –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        document.getElementById('analysisId').textContent = `#${currentAnalysisId}`;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
        const response = await fetch(`/api/analysis/${currentAnalysisId}/detail/`);
        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }

        const data = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞:', data);
        
        analysisData = data.analysis || data;
        
        if (!analysisData) {
            throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞ –≤ –æ—Ç–≤–µ—Ç–µ');
        }

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        renderAnalysisData();
        
        // –ò—â–µ–º —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ API
        await findFilesThroughAPI();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
        await setupVideos();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã
        await loadReports();

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

function renderAnalysisData() {
    if (!analysisData) return;

    const lamenessProb = analysisData.lameness_probability || analysisData.probability || 0;
    const isLame = analysisData.lameness_detected || analysisData.is_lame || lamenessProb > 50;

    const statusEl = document.getElementById('statusText');
    statusEl.textContent = isLame ? '–•—Ä–æ–º–æ—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞' : '–ó–¥–æ—Ä–æ–≤–∞—è –ø–æ—Ö–æ–¥–∫–∞';
    statusEl.className = isLame ? 'status-badge lame' : 'status-badge healthy';

    const dateEl = document.getElementById('analysisDate');
    const date = analysisData.created_at || analysisData.analysis_date || analysisData.date;
    dateEl.textContent = date ? new Date(date).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

    const animalEl = document.getElementById('animalName');
    animalEl.textContent = analysisData.animal_name || analysisData.animal?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

    const probEl = document.getElementById('lamenessProbability');
    const probBar = document.getElementById('probabilityBar');
    const probDesc = document.getElementById('probabilityDescription');

    probEl.textContent = `${lamenessProb.toFixed(1)}%`;
    probBar.style.width = `${Math.min(lamenessProb, 100)}%`;
    probBar.className = lamenessProb > 50 ? 'progress-fill progress-lame' : 'progress-fill progress-healthy';

    let description = '–ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    if (lamenessProb > 70) description = '–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    else if (lamenessProb > 30) description = '–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã';
    probDesc.textContent = description;

    const confEl = document.getElementById('analysisConfidence');
    const confDesc = document.getElementById('confidenceDescription');

    const confidence = analysisData.lameness_confidence || analysisData.confidence || 0;
    confEl.textContent = `${confidence.toFixed(1)}%`;

    let confDescription = '–í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    if (confidence < 40) confDescription = '–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    else if (confidence < 70) confDescription = '–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    confDesc.textContent = confDescription;
}

// ============================================
// –ü–û–ò–°–ö –§–ê–ô–õ–û–í –ß–ï–†–ï–ó API
// ============================================

async function findFilesThroughAPI() {
    if (!currentAnalysisId) return;

    try {
        // –ò—â–µ–º —á–µ—Ä–µ–∑ API endpoint
        const response = await fetch(`/api/analysis/${currentAnalysisId}/files/`);
        if (!response.ok) {
            console.warn('API files endpoint –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
            return await findFilesManually();
        }

        const data = await response.json();
        console.log('API files response:', data);

        if (data.success && data.files) {
            videoPaths = data.files;
            console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ API:', videoPaths);
        } else {
            await findFilesManually();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ API:', error);
        await findFilesManually();
    }
}

async function findFilesManually() {
    if (!analysisData) return;

    const videoFilename = analysisData.video_filename || analysisData.video?.filename || '';
    console.log('–ò—â–µ–º —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é –¥–ª—è:', videoFilename);

    if (!videoFilename) {
        console.warn('–ù–µ—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞');
        return;
    }

    const baseName = videoFilename.replace(/\.[^/.]+$/, "");

    const searchPaths = [
        // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
        `/media/videos/${videoFilename}`,
        `/media/uploads/${videoFilename}`,
        analysisData.video_path,
        `/media/${videoFilename}`,

        // –†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
        `/media/results/${baseName}_labeled.mp4`,
        `/media/results/${baseName}_annotated.mp4`,
        `/media/results/${baseName}_superanimal_quadruped_hrnet_w32_ssdlite__labeled_before_adapt.mp4`,
        analysisData.annotated_video_path,
        `/media/detector_results/${baseName}_labeled.mp4`,
    ];

    videoPaths = {};

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø—É—Ç—å
    for (const path of searchPaths) {
        if (!path) continue;

        try {
            const response = await fetch(path, { method: 'HEAD' });
            if (response.ok) {
                const filename = path.split('/').pop();
                if (path.includes('_labeled') || path.includes('_annotated')) {
                    videoPaths.annotated = path;
                    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ: ${filename}`);
                } else if (path.includes('video') || path.includes('upload') || 
                          path === `/media/${videoFilename}`) {
                    videoPaths.original = path;
                    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ: ${filename}`);
                }
            }
        } catch (error) {
            continue;
        }
    }

    console.log('–†—É—á–Ω–æ–π –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω:', videoPaths);
}

