{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}–ú–æ–∏ –ª–æ—à–∞–¥–∏ - HorseAI{% endblock %}

{% block content %}
<div class="main-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #2d3448;">
        <h1 style="font-size: 32px; color: #fbbf24; display: flex; align-items: center; gap: 15px;">
            <span>üê¥</span>
            –ú–æ–∏ –ª–æ—à–∞–¥–∏
            <span id="animalsCount" style="font-size: 20px; color: #94a3b8;">({{ animals|length }})</span>
        </h1>
        
        <button id="addAnimalBtn" 
                style="background: linear-gradient(135deg, #65a30d, #4d7c0f); 
                       color: white; border: none; padding: 12px 24px; 
                       border-radius: 8px; font-size: 16px; font-weight: 600; 
                       cursor: pointer; display: flex; align-items: center; gap: 8px;">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ª–æ—à–∞–¥—å
        </button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö -->
    <div id="animals-container">
        {% if animals %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;">
                {% for animal in animals %}
                <div style="background: #222736; border: 1px solid #2d3448; border-radius: 12px; padding: 25px; transition: all 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="font-size: 22px; color: #e2e8f0; margin: 0;">{{ animal.name }}</h3>
                        {% if animal.sex %}
                        <span style="background: rgba(217, 119, 6, 0.2); color: #d97706; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            {% if animal.sex == 'M' or animal.sex == '–∂–µ—Ä–µ–±–µ—Ü' %}‚ôÇÔ∏è –ñ–µ—Ä–µ–±–µ—Ü
                            {% elif animal.sex == 'F' or animal.sex == '–∫–æ–±—ã–ª–∞' %}‚ôÄÔ∏è –ö–æ–±—ã–ª–∞
                            {% else %}{{ animal.sex }}{% endif %}
                        </span>
                        {% endif %}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        {% if animal.age %}
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: #94a3b8;">–í–æ–∑—Ä–∞—Å—Ç:</span>
                            <span style="color: #e2e8f0; font-weight: 500;">{{ animal.age }} –ª–µ—Ç</span>
                        </div>
                        {% endif %}
                        
                        {% if animal.estimated_weight %}
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: #94a3b8;">–í–µ—Å:</span>
                            <span style="color: #e2e8f0; font-weight: 500;">{{ animal.estimated_weight }} –∫–≥</span>
                        </div>
                        {% endif %}
                        
                        {% if animal.created_at %}
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: #94a3b8;">–î–æ–±–∞–≤–ª–µ–Ω:</span>
                            <span style="color: #e2e8f0; font-weight: 500;">{{ animal.created_at|date:"d.m.Y" }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="editAnimal({{ animal.animal_id }})" 
                                style="flex: 1; padding: 10px; background: #2a3042; border: 1px solid #2d3448; border-radius: 6px; color: #e2e8f0; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button onclick="deleteAnimal({{ animal.animal_id }}, '{{ animal.name }}')" 
                                style="flex: 1; padding: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #fca5a5; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 60px 20px; background: #222736; border-radius: 12px; border: 2px dashed #2d3448;">
                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">üê¥</div>
                <h2 style="font-size: 22px; color: #94a3b8; margin-bottom: 10px;">–ù–µ—Ç –ª–æ—à–∞–¥–µ–π</h2>
                <p style="color: #64748b; margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto;">
                    –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ª–æ—à–∞–¥—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑
                </p>
                <button id="addAnimalEmptyBtn" 
                        style="background: linear-gradient(135deg, #65a30d, #4d7c0f); 
                               color: white; border: none; padding: 12px 24px; 
                               border-radius: 8px; font-size: 16px; font-weight: 600; 
                               cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –ª–æ—à–∞–¥—å
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="animalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    <div style="background: #222736; border-radius: 12px; padding: 30px; width: 90%; max-width: 500px; border: 1px solid #2d3448; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #2d3448;">
            <h2 style="font-size: 24px; color: #e2e8f0; margin: 0; display: flex; align-items: center; gap: 10px;">
                <span>üê¥</span>
                <span id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ª–æ—à–∞–¥—å</span>
            </h2>
            <button onclick="closeModal()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                √ó
            </button>
        </div>
        
        <form id="animalForm" onsubmit="saveAnimal(event)">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <input type="hidden" id="animalId" name="animal_id">
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #94a3b8; font-size: 14px; font-weight: 500; margin-bottom: 8px;">–ò–º—è –ª–æ—à–∞–¥–∏ *</label>
                <input type="text" id="animalName" name="name" required 
                       style="width: 100%; padding: 12px 16px; background: #1a1f2b; border: 1px solid #2d3448; border-radius: 8px; color: #e2e8f0; font-size: 15px;"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—É—Ä–∞–Ω">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #94a3b8; font-size: 14px; font-weight: 500; margin-bottom: 8px;">–ü–æ–ª</label>
                <select id="animalSex" name="sex" 
                        style="width: 100%; padding: 12px 16px; background: #1a1f2b; border: 1px solid #2d3448; border-radius: 8px; color: #e2e8f0; font-size: 15px;">
                    <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                    <option value="–∂–µ—Ä–µ–±–µ—Ü">‚ôÇÔ∏è –ñ–µ—Ä–µ–±–µ—Ü</option>
                    <option value="–∫–æ–±—ã–ª–∞">‚ôÄÔ∏è –ö–æ–±—ã–ª–∞</option>
                    <option value="–º–µ—Ä–∏–Ω">üê¥ –ú–µ—Ä–∏–Ω</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #94a3b8; font-size: 14px; font-weight: 500; margin-bottom: 8px;">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)</label>
                <input type="number" id="animalAge" name="age" 
                       style="width: 100%; padding: 12px 16px; background: #1a1f2b; border: 1px solid #2d3448; border-radius: 8px; color: #e2e8f0; font-size: 15px;"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5" min="0" max="40">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #94a3b8; font-size: 14px; font-weight: 500; margin-bottom: 8px;">–í–µ—Å (–∫–≥)</label>
                <input type="number" id="animalWeight" name="weight" 
                       style="width: 100%; padding: 12px 16px; background: #1a1f2b; border: 1px solid #2d3448; border-radius: 8px; color: #e2e8f0; font-size: 15px;"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 450" min="100" max="1000" step="0.1">
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #2d3448;">
                <button type="button" onclick="closeModal()" 
                        style="flex: 1; padding: 14px; background: #2a3042; color: #e2e8f0; border: 1px solid #2d3448; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" id="modalSubmitBtn" 
                        style="flex: 1; padding: 14px; background: linear-gradient(135deg, #d97706, #a16207); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// üöÄ –ü–†–û–°–¢–û–ô –ò –†–ê–ë–û–ß–ò–ô JavaScript
console.log('üê¥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∂–∏–≤–æ—Ç–Ω—ã—Ö...');

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function openAddModal() {
    console.log('‚úÖ –û—Ç–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
    document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ª–æ—à–∞–¥—å';
    document.getElementById('animalId').value = '';
    document.getElementById('animalForm').reset();
    document.getElementById('modalSubmitBtn').textContent = '–î–æ–±–∞–≤–∏—Ç—å';
    
    const modal = document.getElementById('animalModal');
    modal.style.display = 'flex';
    console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ');
}

function closeModal() {
    console.log('–ó–∞–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
    document.getElementById('animalModal').style.display = 'none';
    document.getElementById('animalForm').reset();
}

function editAnimal(animalId) {
    console.log('–†–µ–¥–∞–∫—Ç–∏—Ä—É—é –∂–∏–≤–æ—Ç–Ω–æ–µ:', animalId);
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    openAddModal();
    
    // –ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
    document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ—à–∞–¥—å';
    document.getElementById('animalId').value = animalId;
    document.getElementById('modalSubmitBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
}

function deleteAnimal(animalId, animalName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ª–æ—à–∞–¥—å "${animalName}"?`)) return;
    
    console.log('–£–¥–∞–ª—è—é –∂–∏–≤–æ—Ç–Ω–æ–µ:', animalId);
    
    fetch(`/api/animals/${animalId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ª–æ—à–∞–¥—å');
    });
}

function saveAnimal(event) {
    event.preventDefault();
    console.log('–°–æ—Ö—Ä–∞–Ω—è—é –∂–∏–≤–æ—Ç–Ω–æ–µ...');
    
    const animalId = document.getElementById('animalId').value;
    const url = animalId ? `/api/animals/${animalId}/update/` : '/api/animals/add/';
    
    const formData = {
        name: document.getElementById('animalName').value.trim(),
        sex: document.getElementById('animalSex').value,
        age: document.getElementById('animalAge').value || null,
        weight: document.getElementById('animalWeight').value || null
    };
    
    if (!formData.name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–æ—à–∞–¥–∏');
        return;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
    const submitBtn = document.getElementById('modalSubmitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    submitBtn.disabled = true;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        
        if (data.success) {
            alert('‚úÖ ' + data.message);
            closeModal();
            location.reload();
        } else {
            alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
        }
    })
    .catch(error => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ—à–∞–¥—å');
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–∫–∞–º
    document.getElementById('addAnimalBtn')?.addEventListener('click', openAddModal);
    document.getElementById('addAnimalEmptyBtn')?.addEventListener('click', openAddModal);
    
    // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–Ω–æ–ø–∫–∏
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.style.transition = 'all 0.3s';
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    console.log('üéØ –í—Å–µ –≥–æ—Ç–æ–≤–æ! –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç!');
});

// –°–¥–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è inline –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
window.openAddModal = openAddModal;
window.closeModal = closeModal;
window.editAnimal = editAnimal;
window.deleteAnimal = deleteAnimal;
window.saveAnimal = saveAnimal;
</script>
{% endblock %}
