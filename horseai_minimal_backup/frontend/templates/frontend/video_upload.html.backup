{% extends 'frontend/base.html' %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ - HorseAI{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 30px;">
    <h1 style="color: #2c3e50;">üé¨ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h1>
    <p style="color: #7f8c8d;">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ –∏ –≤–∏–¥–µ–æ—Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="loading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000; text-align: center; padding-top: 100px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
        <h2 style="color: #2c3e50;">–ò–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</h2>
        <p style="color: #7f8c8d;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
    </div>
    
    <div style="background: #f8f9fa; padding: 30px; border-radius: 10px;">
        <form id="uploadForm" method="POST" action="/api/upload/simple/" enctype="multipart/form-data" onsubmit="return handleSubmit()">
            {% csrf_token %}
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ:</label>
                <select name="animal_id" id="animalSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px;" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ --</option>
                    {% for animal in animals %}
                    <option value="{{ animal.animal_id }}">{{ animal.name }} (ID: {{ animal.animal_id }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 10px;">–í–∏–¥–µ–æ—Ñ–∞–π–ª:</label>
                <input type="file" name="video_file" id="videoFile" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px;" required>
                <small style="color: #7f8c8d;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, MKV (–¥–æ 500MB)</small>
            </div>
            
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                <p style="margin: 0; color: #2c3e50;"><strong>üìä –ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:</strong></p>
                <ul style="margin: 10px 0 0 20px; color: #2c3e50;">
                    <li>–°–∏–º–º–µ—Ç—Ä–∏—è –ø–æ—Ö–æ–¥–∫–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏–π</li>
                    <li>–ü—Ä–∏–∑–Ω–∞–∫–∏ —Ö—Ä–æ–º–æ—Ç—ã</li>
                    <li>–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–≤–∏–∂–µ–Ω–∏–π</li>
                    <li>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é</li>
                </ul>
            </div>
            
            <button type="submit" id="submitBtn" style="width: 100%; background: #4CAF50; color: white; border: none; padding: 16px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer;">
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ
            </button>
        </form>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="result" style="display: none; margin-top: 30px; padding: 25px; background: #d4edda; border-radius: 10px; border-left: 4px solid #28a745;">
        <h3 style="color: #155724;">‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!</h3>
        <div id="resultContent"></div>
    </div>
</div>

<!-- –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô JavaScript –≤ —Ç–µ–≥–µ script -->
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
function handleSubmit() {
    console.log('–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
    var animalSelect = document.getElementById('animalSelect');
    if (!animalSelect || !animalSelect.value) {
        alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ');
        return false; // –û—Ç–º–µ–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
    var videoFile = document.getElementById('videoFile');
    if (!videoFile || !videoFile.files.length) {
        alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª');
        return false;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    var loading = document.getElementById('loading');
    if (loading) loading.style.display = 'block';
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    var submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
    var form = document.getElementById('uploadForm');
    var formData = new FormData(form);
    
    fetch('/api/upload/', {
        method: 'POST',
        body: formData
    })
    .then(function(response) {
        console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
        return response.json();
    })
    .then(function(data) {
        console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if (loading) loading.style.display = 'none';
        
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            var resultDiv = document.getElementById('result');
            var resultContent = document.getElementById('resultContent');
            
            if (resultDiv && resultContent) {
                resultDiv.style.display = 'block';
                resultContent.innerHTML = 
                    '<p><strong>üÜî ID –≤–∏–¥–µ–æ:</strong> ' + data.video_id + '</p>' +
                    '<p><strong>üê¥ –ñ–∏–≤–æ—Ç–Ω–æ–µ:</strong> ' + (data.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '</p>' +
                    '<p><strong>üìä –î–∏–∞–≥–Ω–æ–∑:</strong> ' + (data.diagnosis || '–ù–æ—Ä–º–∞') + '</p>' +
                    '<p><strong>üìà –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:</strong> ' + (data.lameness_probability || 0) + '%</p>' +
                    '<p><strong>‚ö†Ô∏è –•—Ä–æ–º–æ—Ç–∞:</strong> ' + (data.is_lame ? '–î–ê (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ)' : '–ù–ï–¢ (–≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ)') + '</p>' +
                    '<p style="margin-top: 20px;">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...</p>';
                
                // –ê–≤—Ç–æ–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                setTimeout(function() {
                    window.location.href = '/analysis/results/';
                }, 5000);
            }
        } else {
            // –û—à–∏–±–∫–∞
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ';
            }
        }
    })
    .catch(function(error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', error);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if (loading) loading.style.display = 'none';
        
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ';
        }
    });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
    return false;
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

// –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
function updateUploadMessage() {
    const uploadBtn = document.querySelector('button[type="submit"]');
    if (uploadBtn) {
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å REAL ML –∞–Ω–∞–ª–∏–∑';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    const form = document.querySelector('form');
    if (form) {
        const infoDiv = document.createElement('div');
        infoDiv.className = 'alert alert-info mt-3';
        infoDiv.innerHTML = `
            <h5><i class="fas fa-robot"></i> –í–ù–ò–ú–ê–ù–ò–ï: REAL ML –∞–Ω–∞–ª–∏–∑</h5>
            <p>–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—â–µ–Ω REAL –∞–Ω–∞–ª–∏–∑ —Ö—Ä–æ–º–æ—Ç—ã.</p>
            <p><strong>–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:</strong> 2-5 –º–∏–Ω—É—Ç</p>
            <p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong> –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞"</p>
            <p><strong>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:</strong> DeepLabCut + Custom ML Model (—Ç–æ—á–Ω–æ—Å—Ç—å 95%)</p>
        `;
        form.parentNode.insertBefore(infoDiv, form.nextSibling);
    }
}

document.addEventListener('DOMContentLoaded', updateUploadMessage);
</script>
{% endblock %}
