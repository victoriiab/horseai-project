{% load static %}

<div class="download-section" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 35px; margin-top: 40px; position: relative; overflow: hidden;">
    
    <!-- –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ–Ω -->
    <div style="position: absolute; top: 0; right: 0; font-size: 120px; opacity: 0.05; z-index: 0;">üìÅ</div>
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h3 style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary); margin-bottom: 30px; position: relative; z-index: 1; display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 32px;">üìÅ</span>
        –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
    </h3>

    <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="files-loading" style="text-align: center; padding: 40px 20px; position: relative; z-index: 1;">
        <div class="spinner" style="border: 4px solid var(--border-light); border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p style="color: var(--text-secondary); font-size: 1.1rem;">
            –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...
        </p>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ -->
    <div id="files-list" style="display: none; position: relative; z-index: 1;">
        <div class="files-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- –§–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div style="background: linear-gradient(135deg, rgba(101, 163, 13, 0.1), rgba(217, 119, 6, 0.1)); border: 1px solid rgba(101, 163, 13, 0.3); border-radius: 12px; padding: 25px; margin-top: 30px;">
            <div style="display: flex; align-items: flex-start; gap: 15px;">
                <div style="font-size: 24px; color: var(--sage);">üí°</div>
                <div>
                    <h4 style="color: var(--sage); font-weight: 600; margin-bottom: 10px; font-size: 1.1rem;">
                        –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Ñ–∞–π–ª–∞–º
                    </h4>
                    <ul style="color: var(--text-secondary); margin: 0; padding-left: 20px; font-size: 0.95rem;">
                        <li><strong>–†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ</strong> —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ —Ç–µ–ª–∞ –ª–æ—à–∞–¥–∏, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª—å—é –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è</li>
                        <li><strong>–ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</strong> –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ö–æ–¥–∫–∏</li>
                        <li><strong>–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞</strong> –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π</li>
                        <li>–§–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
    <div id="files-error" style="display: none; background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 12px; padding: 30px; margin-top: 20px; text-align: center; position: relative; z-index: 1;">
        <div style="font-size: 48px; margin-bottom: 20px; color: #f87171;">üì≠</div>
        <h4 style="color: #f87171; font-weight: 600; margin-bottom: 15px; font-size: 1.2rem;">
            –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
        </h4>
        <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
            –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –µ—â–µ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–ª–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.<br>
            –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
        </p>
        <button onclick="location.reload()" style="background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-light); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
        </button>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .file-card {
        background: var(--bg-hover);
        border: 1px solid var(--border-light);
        border-radius: 12px;
        padding: 25px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .file-card:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        background: var(--bg-card);
    }

    .file-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--earth));
    }

    .file-icon {
        font-size: 42px;
        margin-bottom: 20px;
        display: block;
        text-align: center;
    }

    .file-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        flex-grow: 1;
    }

    .file-info {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .file-size {
        background: var(--bg-card);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        color: var(--text-tertiary);
        display: inline-block;
        margin-top: 8px;
        border: 1px solid var(--border-light);
    }

    .btn-download {
        display: inline-block;
        padding: 14px 24px;
        background: linear-gradient(135deg, var(--accent), var(--earth));
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        text-align: center;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-download:hover {
        background: linear-gradient(135deg, var(--accent-hover), var(--accent));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg), var(--glow);
    }

    .btn-download:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .files-grid {
            grid-template-columns: 1fr !important;
        }
        
        .download-section {
            padding: 25px 20px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const analysisId = {{ analysis.analysis_id|default:0 }};
    
    if (!analysisId) {
        document.getElementById('files-error').style.display = 'block';
        document.getElementById('files-loading').style.display = 'none';
        return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    fetch(`/api/analysis/${analysisId}/files/`)
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            const filesList = document.getElementById('files-list');
            const filesGrid = filesList.querySelector('.files-grid');
            const loading = document.getElementById('files-loading');
            const error = document.getElementById('files-error');
            
            loading.style.display = 'none';
            error.style.display = 'none';
            
            if (data.files && data.files.length > 0) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
                const existingFiles = data.files.filter(f => f.exists);
                
                if (existingFiles.length === 0) {
                    filesList.style.display = 'none';
                    error.style.display = 'block';
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Ñ–∞–π–ª–æ–≤
                filesGrid.innerHTML = '';
                
                existingFiles.forEach(file => {
                    const icon = getFileIcon(file.type);
                    const description = getFileDescription(file.type);
                    
                    const card = document.createElement('div');
                    card.className = 'file-card';
                    
                    card.innerHTML = `
                        <div class="file-icon">${icon}</div>
                        <div class="file-title">${description}</div>
                        <div class="file-info">
                            <div style="font-family: monospace; font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 8px;">
                                ${file.filename}
                            </div>
                            <span class="file-size">${file.size_human}</span>
                        </div>
                        <a href="${file.url}" class="btn-download" download onclick="trackDownload('${file.type}')">
                            <span>üì•</span>
                            –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                        </a>
                    `;
                    
                    filesGrid.appendChild(card);
                });
                
                filesList.style.display = 'block';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
                const cards = filesGrid.querySelectorAll('.file-card');
                cards.forEach((card, index) => {
                    card.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                });
                
            } else {
                filesList.style.display = 'none';
                error.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading files:', error);
            document.getElementById('files-loading').style.display = 'none';
            document.getElementById('files-error').style.display = 'block';
        });
    
    function getFileIcon(fileType) {
        const icons = {
            'annotated_video': 'üìπ',
            'original_video': 'üé¨',
            'result_plot': 'üìä',
            'result_data': 'üíæ',
            'result_json': 'üìÑ',
            'result_report': 'üìã'
        };
        return icons[fileType] || 'üìÅ';
    }
    
    function getFileDescription(fileType) {
        const descriptions = {
            'annotated_video': '–†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ',
            'original_video': '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ',
            'result_plot': '–ì—Ä–∞—Ñ–∏–∫ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏',
            'result_data': '–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ (H5)',
            'result_json': 'JSON –¥–∞–Ω–Ω—ã–µ',
            'result_report': '–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç'
        };
        return descriptions[fileType] || '–§–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
    }
    
    window.trackDownload = function(fileType) {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
        console.log(`Download started: ${fileType}`);
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--sage);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `üì• –ù–∞—á–∞–ª–∞—Å—å –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    `;
    document.head.appendChild(style);
});
</script>
