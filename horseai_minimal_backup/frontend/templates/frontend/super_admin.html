
{% extends 'frontend/base.html' %}

{% block title %}Super Admin - HorseAI{% endblock %}

{% block extra_css %}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è Super Admin */
    .super-admin-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .super-admin-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }

    .super-admin-title {
        font-size: 2.5em;
        background: linear-gradient(135deg, var(--accent-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .super-admin-subtitle {
        color: var(--text-secondary);
        font-size: 1.1em;
    }

    /* –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .quick-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 25px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg), var(--glow);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--earth));
    }

    .stat-icon {
        font-size: 2em;
        margin-bottom: 15px;
        opacity: 0.9;
    }

    .stat-number {
        font-size: 2.8em;
        font-weight: 700;
        margin: 10px 0;
        color: var(--accent-light);
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.95em;
        margin-bottom: 5px;
    }

    .stat-detail {
        color: var(--text-tertiary);
        font-size: 0.85em;
    }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º */
    .tabs-container {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: 30px;
        overflow: hidden;
    }

    .tabs-nav {
        display: flex;
        background: var(--bg-darker);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
    }

    .tab-btn {
        padding: 15px 25px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }

    .tab-btn.active {
        color: var(--accent-light);
        border-bottom-color: var(--accent);
        background: var(--bg-hover);
    }

    .tab-content {
        padding: 25px;
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* –¢–∞–±–ª–∏—Ü—ã */
    .admin-table-container {
        overflow-x: auto;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--bg-card);
        margin-bottom: 20px;
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    .admin-table th {
        background: var(--bg-darker);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border);
        white-space: nowrap;
    }

    .admin-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border);
        color: var(--text-secondary);
        vertical-align: middle;
    }

    .admin-table tr:hover {
        background: var(--bg-hover);
    }

    .admin-table tr:last-child td {
        border-bottom: none;
    }

    /* –ë–µ–π–¥–∂–∏ */
    .role-badge, .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-block;
    }

    .role-admin { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .role-superadmin { background: rgba(217, 119, 6, 0.2); color: #fcd34d; }
    .role-user { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }
    
    .status-completed { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .status-processing { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
    .status-failed { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .status-pending { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }

    /* –•—Ä–æ–º–æ—Ç–∞ */
    .lameness-indicator {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .lameness-yes { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .lameness-no { background: rgba(34, 197, 94, 0.2); color: #86efac; }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: var(--radius);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
    }

    .action-btn-edit {
        background: rgba(59, 130, 246, 0.2);
        color: #93c5fd;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .action-btn-edit:hover {
        background: rgba(59, 130, 246, 0.3);
        color: #60a5fa;
        transform: translateY(-2px);
    }

    .action-btn-delete {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .action-btn-delete:hover {
        background: rgba(239, 68, 68, 0.3);
        color: #f87171;
        transform: translateY(-2px);
    }

    .action-btn-view {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .action-btn-view:hover {
        background: rgba(34, 197, 94, 0.3);
        color: #4ade80;
        transform: translateY(-2px);
    }

    .action-btn-block {
        background: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .action-btn-block:hover {
        background: rgba(245, 158, 11, 0.3);
        color: #fbbf24;
        transform: translateY(-2px);
    }

    /* –§–∏–ª—å—Ç—Ä—ã */
    .filters-bar {
        background: var(--bg-darker);
        padding: 20px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        border: 1px solid var(--border);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-input {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 10px 15px;
        border-radius: var(--radius);
        font-size: 14px;
        min-width: 200px;
    }

    .filter-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
    }

    /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .page-btn {
        padding: 8px 15px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 40px;
        text-align: center;
    }

    .page-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .page-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 30px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
    }

    .modal-title {
        font-size: 1.5em;
        color: var(--accent-light);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5em;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-close:hover {
        color: var(--text-primary);
    }

    /* –ì—Ä–∞—Ñ–∏–∫–∏ */
    .chart-container {
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }

    /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã */
    .service-status {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-block;
    }

    .status-ok { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .status-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
    .status-error { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .quick-stats-grid {
            grid-template-columns: 1fr;
        }

        .tabs-nav {
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-input {
            min-width: 100%;
        }

        .action-buttons {
            flex-direction: column;
        }
        
        .admin-table {
            font-size: 0.9em;
        }
        
        .admin-table th,
        .admin-table td {
            padding: 8px 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="super-admin-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="super-admin-header">
        <h1 class="super-admin-title">‚ö° Super Admin Panel</h1>
        <p class="super-admin-subtitle">–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∏—Å—Ç–µ–º–æ–π HorseAI</p>
    </div>

    <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="quick-stats-grid" id="quick-stats">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-number" id="stat-total-users">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            <div class="stat-detail" id="stat-active-users-detail">–ê–∫—Ç–∏–≤–Ω—ã—Ö: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üêé</div>
            <div class="stat-number" id="stat-total-animals">0</div>
            <div class="stat-label">–ñ–∏–≤–æ—Ç–Ω—ã—Ö</div>
            <div class="stat-detail">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üé•</div>
            <div class="stat-number" id="stat-total-videos">0</div>
            <div class="stat-label">–í–∏–¥–µ–æ</div>
            <div class="stat-detail" id="stat-processed-videos-detail">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-number" id="stat-total-analyses">0</div>
            <div class="stat-label">–ê–Ω–∞–ª–∏–∑–æ–≤</div>
            <div class="stat-detail" id="stat-lame-percentage-detail">–•—Ä–æ–º–æ—Ç–∞: 0%</div>
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="users">
                <span>üë•</span>
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            </button>
            <button class="tab-btn" data-tab="animals">
                <span>üêé</span>
                <span>–ñ–∏–≤–æ—Ç–Ω—ã–µ</span>
            </button>
            <button class="tab-btn" data-tab="videos">
                <span>üé•</span>
                <span>–í–∏–¥–µ–æ</span>
            </button>
            <button class="tab-btn" data-tab="analyses">
                <span>üìä</span>
                <span>–ê–Ω–∞–ª–∏–∑—ã</span>
            </button>
<button class="tab-btn" data-tab="rations">
    <span>üçé</span>
    <span>–†–∞—Ü–∏–æ–Ω—ã</span>
</button>
            <button class="tab-btn" data-tab="system">
                <span>‚öôÔ∏è</span>
                <span>–°–∏—Å—Ç–µ–º–∞</span>
            </button>
        </div>

        <!-- –¢–∞–±: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div id="tab-users" class="tab-content active">
            <div class="filters-bar">
                <input type="text" class="filter-input" id="search-users" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
                <select class="filter-input" id="filter-role">
                    <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                    <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                </select>
                <button class="action-btn action-btn-view" onclick="loadUsers()">
                    <span>üîÑ</span>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                </button>
                <button class="action-btn action-btn-edit" onclick="showAddUserModal()">
                    <span>‚ûï</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                </button>
                <button class="action-btn action-btn-block" onclick="exportData('users')">
                    <span>üì•</span>
                    <span>–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
                </button>
            </div>

            <div class="admin-table-container">
                <table class="admin-table" id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–õ–æ–≥–∏–Ω</th>
                            <th>Email</th>
                            <th>–ò–º—è</th>
                            <th>–†–æ–ª—å</th>
                            <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                            <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr><td colspan="8" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="users-pagination"></div>
        </div>

        <!-- –¢–∞–±: –ñ–∏–≤–æ—Ç–Ω—ã–µ -->
        <div id="tab-animals" class="tab-content">

<!-- –í —Å–µ–∫—Ü–∏–∏ filters-bar –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –¥–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É: -->
<div class="filters-bar">
    <input type="text" class="filter-input" id="search-animals" placeholder="–ü–æ–∏—Å–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö...">
    <button class="action-btn action-btn-view" onclick="loadAllAnimals()">
        <span>üîÑ</span>
        <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
    </button>
    <button class="action-btn action-btn-edit" onclick="showAddAnimalModal()">
        <span>‚ûï</span>
        <span>–î–æ–±–∞–≤–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ</span>
    </button>
    <button class="action-btn action-btn-block" onclick="exportData('animals')">
        <span>üì•</span>
        <span>–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
    </button>
</div>

            <div class="admin-table-container">
                <table class="admin-table" id="animals-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th>–ü–æ–ª</th>
                            <th>–í–æ–∑—Ä–∞—Å—Ç</th>
                            <th>–í–µ—Å (–∫–≥)</th>
                            <th>–ê–Ω–∞–ª–∏–∑–æ–≤</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="animals-table-body">
                        <tr><td colspan="8" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="animals-pagination"></div>
        </div>

        <!-- –¢–∞–±: –í–∏–¥–µ–æ -->
        <div id="tab-videos" class="tab-content">
            <div class="filters-bar">
                <input type="text" class="filter-input" id="search-videos" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ...">
                <select class="filter-input" id="filter-video-status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                    <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                    <option value="failed">–û—à–∏–±–∫–∞</option>
                    <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                </select>
                <button class="action-btn action-btn-view" onclick="loadVideos()">
                    <span>üîÑ</span>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                </button>
                <button class="action-btn action-btn-block" onclick="exportData('videos')">
                    <span>üì•</span>
                    <span>–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
                </button>
            </div>

            <div class="admin-table-container">
                <table class="admin-table" id="videos-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–§–∞–π–ª</th>
                            <th>–ñ–∏–≤–æ—Ç–Ω–æ–µ</th>
                            <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="videos-table-body">
                        <tr><td colspan="7" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="videos-pagination"></div>
        </div>

        <!-- –¢–∞–±: –ê–Ω–∞–ª–∏–∑—ã -->
        <div id="tab-analyses" class="tab-content">
            <div class="filters-bar">
                <input type="text" class="filter-input" id="search-analyses" placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–∏–∞–≥–Ω–æ–∑—É...">
                <select class="filter-input" id="filter-status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                    <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                    <option value="failed">–û—à–∏–±–∫–∞</option>
                </select>
                <select class="filter-input" id="filter-lameness">
                    <option value="">–•—Ä–æ–º–æ—Ç–∞</option>
                    <option value="true">–° —Ö—Ä–æ–º–æ—Ç–æ–π</option>
                    <option value="false">–ë–µ–∑ —Ö—Ä–æ–º–æ—Ç—ã</option>
                </select>
                <button class="action-btn action-btn-view" onclick="loadAnalyses(1)">
                    <span>üîç</span>
                    <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
                </button>
                <button class="action-btn action-btn-block" onclick="exportData('analyses')">
                    <span>üì•</span>
                    <span>–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
                </button>
                <button class="action-btn action-btn-edit" onclick="resetFilters()">
                    <span>üîÑ</span>
                    <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
                </button>
            </div>

            <div class="admin-table-container">
                <table class="admin-table" id="analyses-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ñ–∏–≤–æ—Ç–Ω–æ–µ</th>
                            <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th>–î–∏–∞–≥–Ω–æ–∑</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–•—Ä–æ–º–æ—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="analyses-table-body">
                        <tr><td colspan="8" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="analyses-pagination"></div>
        </div>
<!-- –¢–∞–±: –†–∞—Ü–∏–æ–Ω—ã -->
<div id="tab-rations" class="tab-content">
    <div class="filters-bar">
        <input type="text" class="filter-input" id="search-rations" placeholder="–ü–æ–∏—Å–∫ —Ä–∞—Ü–∏–æ–Ω–æ–≤...">
        <select class="filter-input" id="filter-ration-animal">
            <option value="">–í—Å–µ –∂–∏–≤–æ—Ç–Ω—ã–µ</option>
            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </select>
        <button class="action-btn action-btn-view" onclick="loadRations()">
            <span>üîÑ</span>
            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
        </button>
        <button class="action-btn action-btn-block" onclick="exportData('rations')">
            <span>üì•</span>
            <span>–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
        </button>
    </div>

    <div class="admin-table-container">
        <table class="admin-table" id="rations-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–î–∞—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞</th>
                    <th>–ñ–∏–≤–æ—Ç–Ω–æ–µ</th>
                    <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                    <th>–í–µ—Å –∂–∏–≤–æ—Ç–Ω–æ–≥–æ</th>
                    <th>–°—É—Ç–æ—á–Ω–∞—è –Ω–æ—Ä–º–∞</th>
                    <th>–≠–Ω–µ—Ä–≥–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="rations-table-body">
                <tr><td colspan="8" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="pagination" id="rations-pagination"></div>
</div>
        <!-- –¢–∞–±: –°–∏—Å—Ç–µ–º–∞ -->
        <div id="tab-system" class="tab-content">
            <div class="chart-container">
                <h3 style="margin-top: 0; margin-bottom: 20px;">üìà –°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">–ó–∞–≥—Ä—É–∑–∫–∞ CPU</div>
                        <div class="stat-number" id="cpu-load">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM</div>
                        <div class="stat-number" id="ram-usage">0 MB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ</div>
                        <div class="stat-number" id="disk-free">0 GB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                        <div class="stat-number" id="db-size">0 MB</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4>–°—Ç–∞—Ç—É—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤:</h4>
                        <div style="background: var(--bg-darker); padding: 15px; border-radius: var(--radius);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</span>
                                <span class="service-status" id="db-status">OK</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>–ö—ç—à:</span>
                                <span class="service-status" id="cache-status">OK</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>–ú–µ–¥–∏–∞ –ø–∞–ø–∫–∞:</span>
                                <span class="service-status" id="media-status">OK</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</h4>
                        <div style="background: var(--bg-darker); padding: 15px; border-radius: var(--radius);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</span>
                                <span id="app-users">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>–ñ–∏–≤–æ—Ç–Ω—ã—Ö:</span>
                                <span id="app-animals">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>–í–∏–¥–µ–æ:</span>
                                <span id="app-videos">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>–ê–Ω–∞–ª–∏–∑–æ–≤:</span>
                                <span id="app-analyses">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ:</span>
                                <span id="app-processing">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filters-bar" style="margin-top: 20px;">
                <button class="action-btn action-btn-view" onclick="loadSystemHealth()">
                    <span>üîÑ</span>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</span>
                </button>
                <button class="action-btn action-btn-delete" onclick="clearCache()">
                    <span>üóëÔ∏è</span>
                    <span>–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div class="modal-overlay" id="userModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
        </div>
        <div>
            <form id="addUserForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">–õ–æ–≥–∏–Ω:</label>
                    <input type="text" name="username" required class="filter-input" style="width: 100%;" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" name="password" required class="filter-input" style="width: 100%;" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">Email:</label>
                    <input type="email" name="email" class="filter-input" style="width: 100%;" placeholder="email@example.com">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
                    <input type="text" name="full_name" class="filter-input" style="width: 100%;" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">–†–æ–ª—å:</label>
                    <select name="role" class="filter-input" style="width: 100%;">
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <button type="submit" class="action-btn action-btn-edit" style="width: 100%;">
                    <span>‚ûï</span>
                    <span>–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                </button>
            </form>
        </div>
    </div>
</div>

<div class="modal-overlay" id="analysisModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞</h3>
            <button class="modal-close" onclick="closeModal('analysisModal')">&times;</button>
        </div>
        <div id="analysis-modal-content">
            <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
</div>

<div class="modal-overlay" id="videoModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–î–µ—Ç–∞–ª–∏ –≤–∏–¥–µ–æ</h3>
            <button class="modal-close" onclick="closeModal('videoModal')">&times;</button>
        </div>
        <div id="video-modal-content">
            <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
</div>

<div class="modal-overlay" id="editUserModal">
    <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentTab = 'users';
let currentUsersPage = 1;
let currentAnimalsPage = 1;
let currentVideosPage = 1;
let currentAnalysesPage = 1;
const perPage = 10;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    loadSuperAdminStats();
    loadUsers();
    loadSystemHealth();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            switchTab(tabName);
        });
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º
    setupSearchInput('search-users', loadUsers);
    setupSearchInput('search-animals', loadAllAnimals);
    setupSearchInput('search-videos', loadVideos);
    setupSearchInput('search-analyses', loadAnalyses);
    setupSearchInput('search-rations', loadRations);
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    setInterval(loadSuperAdminStats, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    setInterval(loadSystemHealth, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addUser();
    });
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ —Å debounce
function setupSearchInput(inputId, callback) {
    const input = document.getElementById(inputId);
    if (input) {
        let timeout;
        input.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                callback(1); // –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
            }, 500);
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
function switchTab(tabName) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
    const tabElement = document.getElementById(`tab-${tabName}`);
    if (tabElement) {
        tabElement.classList.add('active');
    }

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    const btnElement = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if (btnElement) {
        btnElement.classList.add('active');
    }

    currentTab = tabName;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞
    switch(tabName) {
        case 'users':
            loadUsers();
            break;
        case 'animals':
            loadAllAnimals();
            break;
        case 'videos':
            loadVideos();
            break;
        case 'analyses':
            loadAnalyses(1);
            break;
        case 'system':
            loadSystemHealth();
            break;
case 'rations':
    loadRations();
    break;
    }
}

// ========== –û–°–ù–û–í–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
function loadSuperAdminStats() {
    fetch('/super-admin/stats/')
        .then(response => {
            if (!response.ok) {
                if (response.status === 403) {
                    showNotification('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'error');
                }
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –±—ã—Å—Ç—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStatElement('stat-total-users', data.total_users || 0);
                updateStatElement('stat-active-users-detail', `–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${data.active_users || 0}`);
                updateStatElement('stat-total-animals', data.total_animals || 0);
                updateStatElement('stat-total-videos', data.total_videos || 0);
                
                // –ü—Ä–æ—Ü–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ
                const completedVideos = data.video_statuses?.completed || 0;
                const totalVideos = data.total_videos || 1;
                const processedPercentage = Math.round((completedVideos / totalVideos) * 100);
                updateStatElement('stat-processed-videos-detail', `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processedPercentage}%`);
                
                updateStatElement('stat-total-analyses', data.total_analyses || 0);
                updateStatElement('stat-lame-percentage-detail', `–•—Ä–æ–º–æ—Ç–∞: ${data.lame_percentage || 0}%`);
                
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data.error);
                showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
        });
}

// ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ==========
function loadUsers(page = 1) {
    const search = document.getElementById('search-users').value;
    const role = document.getElementById('filter-role').value;

    let url = `/super-admin/users/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (role) url += `&role=${role}`;

    showLoading('users-table-body');

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                renderUsersTable(data.users || []);
                renderPagination('users-pagination', data.total_pages || 1, page, loadUsers);
                currentUsersPage = page;
            } else {
                showError('users-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        })
        .catch(error => {
            showError('users-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderUsersTable(users) {
    const tbody = document.getElementById('users-table-body');

    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    let html = '';
    users.forEach(user => {
        const registrationDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        
        html += `
            <tr>
                <td>${user.user_id}</td>
                <td><strong>${user.login || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong></td>
                <td>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                <td><span class="role-badge role-${user.role_id || 'user'}">${user.role_id || 'user'}</span></td>
                <td>${user.is_active ? '‚úÖ' : '‚ùå'}</td>
                <td>${registrationDate}</td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewUserDetails(${user.user_id})" class="action-btn action-btn-view">
                            <span>üëÅÔ∏è</span>
                            <span>–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </button>
                        <button onclick="editUser(${user.user_id})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="toggleUserStatus(${user.user_id}, ${user.is_active})" class="action-btn ${user.is_active ? 'action-btn-block' : 'action-btn-view'}">
                            <span>${user.is_active ? 'üö´' : '‚úÖ'}</span>
                            <span>${user.is_active ? '–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}</span>
                        </button>
                        <button onclick="deleteUser(${user.user_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function showAddUserModal() {
    document.getElementById('userModal').classList.add('active');
}

function addUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);

    fetch('/super-admin/users/add/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!', 'success');
            closeModal('userModal');
            loadUsers();
            loadSuperAdminStats();
            form.reset();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

function viewUserDetails(userId) {
    fetch(`/super-admin/users/${userId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                const modalContent = `
                    <h3>–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #${user.user_id}</h3>
                    <div style="margin-bottom: 20px;">
                        <p><strong>–õ–æ–≥–∏–Ω:</strong> ${user.login}</p>
                        <p><strong>Email:</strong> ${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–ü–æ–ª–Ω–æ–µ –∏–º—è:</strong> ${user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–†–æ–ª—å:</strong> <span class="role-badge role-${user.role_id}">${user.role_id}</span></p>
                        <p><strong>–ê–∫—Ç–∏–≤–µ–Ω:</strong> ${user.is_active ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${user.created_at ? new Date(user.created_at).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</strong> ${user.last_login ? new Date(user.last_login).toLocaleString() : '–ù–∏–∫–æ–≥–¥–∞'}</p>
                    </div>
                    
                    <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 10px; background: var(--bg-darker); border-radius: var(--radius);">
                            <div style="font-size: 1.5em; font-weight: bold;">${user.animals?.length || 0}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">–ñ–∏–≤–æ—Ç–Ω—ã—Ö</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-darker); border-radius: var(--radius);">
                            <div style="font-size: 1.5em; font-weight: bold;">${user.videos?.length || 0}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">–í–∏–¥–µ–æ</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-darker); border-radius: var(--radius);">
                            <div style="font-size: 1.5em; font-weight: bold;">${user.analyses?.length || 0}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">–ê–Ω–∞–ª–∏–∑–æ–≤</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="editUser(${userId})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="deleteUser(${userId})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                `;
                
                showCustomModal('–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', modalContent);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
}

function editUser(userId) {
    fetch(`/super-admin/users/${userId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                const modalContent = `
                    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #${user.user_id}</h3>
                    <form id="editUserForm" onsubmit="saveUserChanges(${userId}); return false;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–õ–æ–≥–∏–Ω:</label>
                            <input type="text" value="${user.login}" class="filter-input" style="width: 100%;" disabled>
                            <small style="color: var(--text-tertiary);">–õ–æ–≥–∏–Ω –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</small>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Email:</label>
                            <input type="email" name="email" value="${user.email || ''}" class="filter-input" style="width: 100%;" required>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
                            <input type="text" name="full_name" value="${user.full_name || ''}" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–†–æ–ª—å:</label>
                            <select name="role_id" class="filter-input" style="width: 100%;">
                                <option value="user" ${user.role_id === 'user' ? 'selected' : ''}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                <option value="admin" ${user.role_id === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" name="is_active" ${user.is_active ? 'checked' : ''}>
                                <span style="color: var(--text-secondary);">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            </label>
                        </div>
                        <button type="submit" class="action-btn action-btn-edit" style="width: 100%;">
                            <span>üíæ</span>
                            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                        </button>
                    </form>
                `;
                
                showCustomModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', modalContent);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
        });
}

function saveUserChanges(userId) {
    const form = document.getElementById('editUserForm');
    const formData = new FormData(form);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é
    const data = {
        email: form.querySelector('input[name="email"]').value,
        full_name: form.querySelector('input[name="full_name"]').value,
        role_id: form.querySelector('select[name="role_id"]').value,
        is_active: form.querySelector('input[name="is_active"]').checked
    };

    fetch(`/super-admin/users/${userId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
            closeAllModals();
            loadUsers(currentUsersPage);
            loadSuperAdminStats();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'block' : 'activate';
    const message = isActive ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?';
    
    if (!confirm(message)) return;

    fetch(`/super-admin/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${isActive ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}!`, 'success');
            loadUsers(currentUsersPage);
            loadSuperAdminStats();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

function deleteUser(userId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID ${userId}? –í—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (–∂–∏–≤–æ—Ç–Ω—ã–µ, –≤–∏–¥–µ–æ, –∞–Ω–∞–ª–∏–∑—ã) —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

    fetch(`/super-admin/users/${userId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!', 'success');
            loadUsers(currentUsersPage);
            loadSuperAdminStats();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}
// ========== –ñ–ò–í–û–¢–ù–´–ï ==========
function loadAllAnimals(page = 1) {
    const search = document.getElementById('search-animals').value;

    let url = `/super-admin/animals/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    showLoading('animals-table-body');

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                renderAllAnimalsTable(data.animals || []);
                renderPagination('animals-pagination', data.total_pages || 1, page, loadAllAnimals);
                currentAnimalsPage = page;
            } else {
                showError('animals-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö');
            }
        })
        .catch(error => {
            showError('animals-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderAllAnimalsTable(animals) {
    const tbody = document.getElementById('animals-table-body');

    if (!animals || animals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    let html = '';
    animals.forEach(animal => {
        const createdAt = animal.created_at ? new Date(animal.created_at).toLocaleDateString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        const sexDisplay = animal.sex === 'M' ? '–°–∞–º–µ—Ü' : animal.sex === 'F' ? '–°–∞–º–∫–∞' : '-';
        const ageDisplay = animal.age ? `${animal.age} –ª–µ—Ç` : '-';
        const weightDisplay = animal.estimated_weight ? `${animal.estimated_weight} –∫–≥` : '-';

        html += `
            <tr>
                <td>${animal.animal_id}</td>
                <td><strong>${animal.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</strong></td>
                <td>${animal.owner_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${sexDisplay}</td>
                <td>${ageDisplay}</td>
                <td>${weightDisplay}</td>
                <td><span class="status-badge status-completed">${animal.analyses_count || 0}</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewAnimalDetails(${animal.animal_id})" class="action-btn action-btn-view">
                            <span>üëÅÔ∏è</span>
                            <span>–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </button>
                        <button onclick="editAnimal(${animal.animal_id})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="deleteAnimal(${animal.animal_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function viewAnimalDetails(animalId) {
    fetch(`/super-admin/animals/${animalId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const animal = data.animal;
                const createdAt = animal.created_at ? new Date(animal.created_at).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                const sexDisplay = animal.sex === 'M' ? '–°–∞–º–µ—Ü' : animal.sex === 'F' ? '–°–∞–º–∫–∞' : '–ù–µ —É–∫–∞–∑–∞–Ω';
                
                let modalContent = `
                    <h3>–î–µ—Ç–∞–ª–∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ #${animal.animal_id}</h3>
                    <div style="margin-bottom: 20px;">
                        <p><strong>–ò–º—è:</strong> ${animal.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–ü–æ–ª:</strong> ${sexDisplay}</p>
                        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${animal.age || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å:</strong> ${animal.estimated_weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥</p>
                        <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${createdAt}</p>
                `;

                if (animal.owner) {
                    modalContent += `
                        <h4 style="margin-top: 20px;">–í–ª–∞–¥–µ–ª–µ—Ü:</h4>
                        <p><strong>–ò–º—è:</strong> ${animal.owner.full_name}</p>
                        <p><strong>–õ–æ–≥–∏–Ω:</strong> ${animal.owner.login}</p>
                        <p><strong>Email:</strong> ${animal.owner.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    `;
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                modalContent += `
                    <h4 style="margin-top: 20px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 10px; background: var(--bg-darker); border-radius: var(--radius);">
                            <div style="font-size: 1.5em; font-weight: bold;">${animal.videos_count || 0}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">–í–∏–¥–µ–æ</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-darker); border-radius: var(--radius);">
                            <div style="font-size: 1.5em; font-weight: bold;">${animal.analyses_count || 0}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">–ê–Ω–∞–ª–∏–∑–æ–≤</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-darker); border-radius: var(--radius);">
                            <div style="font-size: 1.5em; font-weight: bold;">${animal.rations_count || 0}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">–†–∞—Ü–∏–æ–Ω–æ–≤</div>
                        </div>
                    </div>
                `;

                // –°–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ
                if (animal.videos && animal.videos.length > 0) {
                    modalContent += `
                        <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∏–¥–µ–æ:</h4>
                        <div style="background: var(--bg-darker); padding: 10px; border-radius: var(--radius); margin-bottom: 15px; max-height: 150px; overflow-y: auto;">
                    `;
                    
                    animal.videos.forEach(video => {
                        const fileName = video.file_path ? video.file_path.split('/').pop() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        const statusClass = `status-${video.analysis_status || 'pending'}`;
                        modalContent += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border);">
                                <span>${fileName}</span>
                                <span class="status-badge ${statusClass}">${video.analysis_status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                            </div>
                        `;
                    });
                    
                    modalContent += `</div>`;
                }

                modalContent += `
                    </div>
                    <div class="action-buttons">
                        <button onclick="editAnimal(${animal.animal_id})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="deleteAnimal(${animal.animal_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                `;

                showCustomModal('–î–µ—Ç–∞–ª–∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ', modalContent);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
}

function editAnimal(animalId) {
    fetch(`/super-admin/animals/${animalId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const animal = data.animal;
                
                const modalContent = `
                    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ #${animal.animal_id}</h3>
                    <form id="editAnimalForm" onsubmit="saveAnimalChanges(${animal.animal_id}); return false;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–ò–º—è:</label>
                                <input type="text" name="name" value="${animal.name || ''}" class="filter-input" style="width: 100%;" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–ü–æ–ª:</label>
                                <select name="sex" class="filter-input" style="width: 100%;">
                                    <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                                    <option value="M" ${animal.sex === 'M' ? 'selected' : ''}>–°–∞–º–µ—Ü</option>
                                    <option value="F" ${animal.sex === 'F' ? 'selected' : ''}>–°–∞–º–∫–∞</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                                <input type="number" name="age" value="${animal.age || ''}" class="filter-input" style="width: 100%;" min="0" step="0.5">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–í–µ—Å (–∫–≥):</label>
                                <input type="number" name="estimated_weight" value="${animal.estimated_weight || ''}" class="filter-input" style="width: 100%;" min="0" step="0.1">
                            </div>
                        </div>
                        
                        <button type="submit" class="action-btn action-btn-edit" style="width: 100%;">
                            <span>üíæ</span>
                            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                        </button>
                    </form>
                `;

                showCustomModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ', modalContent);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
        });
}

function saveAnimalChanges(animalId) {
    const form = document.getElementById('editAnimalForm');
    const formData = new FormData(form);

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º FormData –≤ –æ–±—ä–µ–∫—Ç
    const data = {};
    formData.forEach((value, key) => {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
        if (key === 'age' || key === 'estimated_weight') {
            data[key] = value ? parseFloat(value) : null;
        } else if (key === 'sex' && value === '') {
            data[key] = null;
        } else {
            data[key] = value;
        }
    });

    fetch(`/super-admin/animals/${animalId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ñ–∏–≤–æ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
            closeAllModals();
            loadAllAnimals(currentAnimalsPage);
            loadSuperAdminStats();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

function deleteAnimal(animalId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ ID ${animalId}? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ, –∞–Ω–∞–ª–∏–∑—ã –∏ —Ä–∞—Ü–∏–æ–Ω—ã —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

    fetch(`/super-admin/animals/${animalId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ñ–∏–≤–æ—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–æ!', 'success');
            loadAllAnimals(currentAnimalsPage);
            loadSuperAdminStats();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
function showAddAnimalModal() {
    const modalContent = `
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ</h3>
        <form id="addAnimalForm" onsubmit="addAnimal(); return false;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–ò–º—è:</label>
                    <input type="text" name="name" class="filter-input" style="width: 100%;" required>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–ü–æ–ª:</label>
                    <select name="sex" class="filter-input" style="width: 100%;">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                        <option value="M">–°–∞–º–µ—Ü</option>
                        <option value="F">–°–∞–º–∫–∞</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                    <input type="number" name="age" class="filter-input" style="width: 100%;" min="0" step="0.5">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–í–µ—Å (–∫–≥):</label>
                    <input type="number" name="estimated_weight" class="filter-input" style="width: 100%;" min="0" step="0.1">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–í–ª–∞–¥–µ–ª–µ—Ü (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):</label>
                <input type="number" name="owner_id" class="filter-input" style="width: 100%;" required>
            </div>
            
            <button type="submit" class="action-btn action-btn-edit" style="width: 100%;">
                <span>‚ûï</span>
                <span>–î–æ–±–∞–≤–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ</span>
            </button>
        </form>
    `;

    showCustomModal('–î–æ–±–∞–≤–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ', modalContent);
}

function addAnimal() {
    const form = document.getElementById('addAnimalForm');
    const formData = new FormData(form);

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º FormData –≤ –æ–±—ä–µ–∫—Ç
    const data = {};
    formData.forEach((value, key) => {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
        if (key === 'age' || key === 'estimated_weight' || key === 'owner_id') {
            data[key] = value ? parseFloat(value) : null;
        } else if (key === 'sex' && value === '') {
            data[key] = null;
        } else {
            data[key] = value;
        }
    });

    fetch('/super-admin/animals/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ñ–∏–≤–æ—Ç–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
            closeAllModals();
            loadAllAnimals();
            loadSuperAdminStats();
            form.reset();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}


// ========== –í–ò–î–ï–û ==========
function loadVideos(page = 1) {
    const search = document.getElementById('search-videos').value;
    const status = document.getElementById('filter-video-status').value;

    let url = `/super-admin/videos/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (status) url += `&status=${status}`;

    showLoading('videos-table-body');

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                renderVideosTable(data.videos || []);
                renderPagination('videos-pagination', data.total_pages || 1, page, loadVideos);
                currentVideosPage = page;
            } else {
                showError('videos-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
            }
        })
        .catch(error => {
            showError('videos-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderVideosTable(videos) {
    const tbody = document.getElementById('videos-table-body');

    if (!videos || videos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">–ù–µ—Ç –≤–∏–¥–µ–æ</td></tr>';
        return;
    }

    let html = '';
    videos.forEach(video => {
        const uploadDate = video.upload_date ? new Date(video.upload_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        const fileName = video.file_path ? video.file_path.split('/').pop() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const statusClass = `status-${video.analysis_status || 'pending'}`;
        
        html += `
            <tr>
                <td>${video.video_id}</td>
                <td>
                    <strong>${fileName}</strong>
                    ${video.resolution ? `<br><small style="color: var(--text-tertiary);">${video.resolution}</small>` : ''}
                </td>
                <td>${video.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                <td>${video.owner_login || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${uploadDate}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${video.analysis_status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewVideoDetails(${video.video_id})" class="action-btn action-btn-view">
                            <span>üëÅÔ∏è</span>
                            <span>–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </button>
                        <button onclick="deleteVideo(${video.video_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function viewVideoDetails(videoId) {
    fetch(`/super-admin/videos/${videoId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const video = data.video;
                let modalContent = `
                    <h3>–î–µ—Ç–∞–ª–∏ –≤–∏–¥–µ–æ #${video.video_id}</h3>
                    <div style="margin-bottom: 20px;">
                        <p><strong>–§–∞–π–ª:</strong> ${video.file_path}</p>
                        <p><strong>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</strong> ${video.upload_date ? new Date(video.upload_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${video.duration || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} —Å–µ–∫.</p>
                        <p><strong>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</strong> ${video.resolution || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge status-${video.analysis_status}">${video.analysis_status}</span></p>
                `;
                
                if (video.animal) {
                    modalContent += `
                        <p><strong>–ñ–∏–≤–æ—Ç–Ω–æ–µ:</strong> ${video.animal.name} (ID: ${video.animal.animal_id})</p>
                        <p><strong>–ü–æ–ª:</strong> ${video.animal.sex || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${video.animal.age || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–í–µ—Å:</strong> ${video.animal.estimated_weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥</p>
                    `;
                }
                
                if (video.owner) {
                    modalContent += `
                        <p><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${video.owner.full_name} (${video.owner.login})</p>
                        <p><strong>Email –≤–ª–∞–¥–µ–ª—å—Ü–∞:</strong> ${video.owner.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    `;
                }
                
                if (video.analysis) {
                    modalContent += `
                        <h4 style="margin-top: 20px;">–ê–Ω–∞–ª–∏–∑:</h4>
                        <p><strong>–î–∏–∞–≥–Ω–æ–∑:</strong> ${video.analysis.diagnosis || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> ${video.analysis.diagnosis_note || '–ù–µ—Ç'}</p>
                        <p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${video.analysis.confidence_score ? Math.round(video.analysis.confidence_score * 100) + '%' : '-'}</p>
                        <p><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:</strong> ${video.analysis.lameness_probability || 0}%</p>
                    `;
                }
                
                modalContent += `
                    </div>
                    <div class="action-buttons">
                        <button onclick="playVideo('${video.file_path}')" class="action-btn action-btn-view">
                            <span>‚ñ∂Ô∏è</span>
                            <span>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</span>
                        </button>
                        <button onclick="deleteVideo(${video.video_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                `;
                
                showCustomModal('–î–µ—Ç–∞–ª–∏ –≤–∏–¥–µ–æ', modalContent);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
}

function playVideo(filePath) {
    // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –≤–∏–¥–µ–æ —Ñ–∞–π–ª–∞
    const videoUrl = `/media/${filePath}`;
    
    const modalContent = `
        <h3>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ</h3>
        <video controls style="width: 100%; max-height: 60vh; background: #000;">
            <source src="${videoUrl}" type="video/mp4">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ.
        </video>
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="closeAllModals()" class="action-btn action-btn-view">
                <span>‚úï</span>
                <span>–ó–∞–∫—Ä—ã—Ç—å</span>
            </button>
        </div>
    `;
    
    showCustomModal('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ', modalContent);
}

function deleteVideo(videoId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ ID ${videoId}? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

    fetch(`/super-admin/videos/${videoId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –í–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω–æ!', 'success');
            loadVideos(currentVideosPage);
            loadSuperAdminStats();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

// ========== –ê–ù–ê–õ–ò–ó–´ ==========
function loadAnalyses(page = 1) {
    const search = document.getElementById('search-analyses').value;
    const status = document.getElementById('filter-status').value;
    const lameness = document.getElementById('filter-lameness').value;

    let url = `/super-admin/analyses/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (status) url += `&status=${status}`;
    if (lameness) url += `&lameness=${lameness}`;

    showLoading('analyses-table-body');

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                renderAnalysesTable(data.analyses || []);
                renderPagination('analyses-pagination', data.total_pages || 1, page, loadAnalyses);
                currentAnalysesPage = page;
            } else {
                showError('analyses-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–æ–≤');
            }
        })
        .catch(error => {
            showError('analyses-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderAnalysesTable(analyses) {
    const tbody = document.getElementById('analyses-table-body');

    if (!analyses || analyses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    let html = '';
    analyses.forEach(analysis => {
        const analysisDate = analysis.analysis_date ? new Date(analysis.analysis_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        const isLame = analysis.diagnosis?.toLowerCase().includes('—Ö—Ä–æ–º') || 
                      analysis.diagnosis?.toLowerCase().includes('lame') ||
                      (analysis.lameness_probability || 0) > 50;
        
        html += `
            <tr>
                <td>${analysis.analysis_id}</td>
                <td>${analysisDate}</td>
                <td>${analysis.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                <td>${analysis.owner_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>
                    <strong>${analysis.diagnosis || '–ù–µ—Ç –¥–∏–∞–≥–Ω–æ–∑–∞'}</strong>
                    ${analysis.diagnosis_note ? `<br><small style="color: var(--text-tertiary);">${analysis.diagnosis_note}</small>` : ''}
                </td>
                <td><span class="status-badge status-${analysis.video_status || 'completed'}">${analysis.video_status || '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'}</span></td>
                <td>
                    <span class="lameness-indicator ${isLame ? 'lameness-yes' : 'lameness-no'}">
                        ${isLame ? '–•—Ä–æ–º–æ—Ç–∞' : '–ù–æ—Ä–º–∞'}
                        ${analysis.lameness_probability ? ` (${analysis.lameness_probability}%)` : ''}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewAnalysisDetails(${analysis.analysis_id})" class="action-btn action-btn-view">
                            <span>üëÅÔ∏è</span>
                            <span>–î–µ—Ç–∞–ª–∏</span>
                        </button>
                        <button onclick="deleteAnalysis(${analysis.analysis_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function viewAnalysisDetails(analysisId) {
    fetch(`/super-admin/analyses/${analysisId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const analysis = data.analysis;
                const isLame = analysis.diagnosis?.toLowerCase().includes('—Ö—Ä–æ–º') || 
                              analysis.diagnosis?.toLowerCase().includes('lame') ||
                              (analysis.lameness_probability || 0) > 50;
                
                let modalContent = `
                    <h3>–î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ #${analysis.analysis_id}</h3>
                    <div style="margin-bottom: 20px;">
                        <p><strong>–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:</strong> ${analysis.analysis_date ? new Date(analysis.analysis_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–î–∏–∞–≥–Ω–æ–∑:</strong> ${analysis.diagnosis || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–•—Ä–æ–º–æ—Ç–∞:</strong> <span class="${isLame ? 'lameness-yes' : 'lameness-no'}">${isLame ? '–î–ê' : '–ù–ï–¢'}</span></p>
                        <p><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:</strong> ${analysis.lameness_probability || 0}%</p>
                        <p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${analysis.confidence_score ? Math.round(analysis.confidence_score * 100) + '%' : '-'}</p>
                        <p><strong>–ü–æ—Ö–æ–¥–∫–∞:</strong> ${analysis.gait_quality || '–ù–µ –æ—Ü–µ–Ω–µ–Ω–∞'}</p>
                        <p><strong>–û—Å–∞–Ω–∫–∞:</strong> ${analysis.posture || '–ù–µ –æ—Ü–µ–Ω–µ–Ω–∞'}</p>
                        <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞–∑–º–µ—Ä–∞:</strong> ${analysis.size_category || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}</p>
                        <p><strong>–ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å:</strong> ${analysis.estimated_weight || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'} –∫–≥</p>
                `;
                
                if (analysis.video) {
                    modalContent += `
                        <h4 style="margin-top: 20px;">–í–∏–¥–µ–æ:</h4>
                        <p><strong>–§–∞–π–ª:</strong> ${analysis.video.file_path}</p>
                        <p><strong>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</strong> ${analysis.video.upload_date ? new Date(analysis.video.upload_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${analysis.video.analysis_status}</p>
                    `;
                }
                
                if (analysis.animal) {
                    modalContent += `
                        <h4 style="margin-top: 20px;">–ñ–∏–≤–æ—Ç–Ω–æ–µ:</h4>
                        <p><strong>–ò–º—è:</strong> ${analysis.animal.name}</p>
                        <p><strong>–ü–æ–ª:</strong> ${analysis.animal.sex || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${analysis.animal.age || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–í–µ—Å:</strong> ${analysis.animal.estimated_weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥</p>
                    `;
                }
                
                if (analysis.owner) {
                    modalContent += `
                        <h4 style="margin-top: 20px;">–í–ª–∞–¥–µ–ª–µ—Ü:</h4>
                        <p><strong>–ò–º—è:</strong> ${analysis.owner.full_name}</p>
                        <p><strong>–õ–æ–≥–∏–Ω:</strong> ${analysis.owner.login}</p>
                        <p><strong>Email:</strong> ${analysis.owner.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    `;
                }
                
                modalContent += `
                    </div>
                `;
                
                showCustomModal('–î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞', modalContent);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
}

function editAnalysis(analysisId) {
    showNotification('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

function deleteAnalysis(analysisId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–Ω–∞–ª–∏–∑ ID ${analysisId}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

    fetch(`/super-admin/analyses/${analysisId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ê–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω!', 'success');
            closeAllModals();
            loadAnalyses(currentAnalysesPage);
            loadSuperAdminStats();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

function exportAnalysisPDF(analysisId) {
    showNotification('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

function resetFilters() {
    document.getElementById('search-analyses').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-lameness').value = '';
    loadAnalyses(1);
}

// ========== –°–ò–°–¢–ï–ú–ê ==========
function loadSystemHealth() {
    fetch('/super-admin/system-health/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStatElement('cpu-load', data.system.cpu_percent + '%');
                updateStatElement('ram-usage', data.system.memory_used_mb + ' MB');
                updateStatElement('disk-free', data.system.disk_free_gb + ' GB');
                updateStatElement('db-size', data.services.database_size_mb + ' MB');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤
                updateServiceStatus('db-status', data.services.database);
                updateServiceStatus('cache-status', data.services.cache);
                updateServiceStatus('media-status', data.services.media_folder);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                updateStatElement('app-users', data.app.total_users);
                updateStatElement('app-animals', data.app.total_animals);
                updateStatElement('app-videos', data.app.total_videos);
                updateStatElement('app-analyses', data.app.total_analyses);
                updateStatElement('app-processing', data.app.processing_videos);
                
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è:', data.error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
        });
}

function updateServiceStatus(elementId, status) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = status;
        element.className = 'service-status';
        
        if (typeof status === 'string') {
            if (status.includes('OK')) {
                element.classList.add('status-ok');
            } else if (status.includes('WARNING')) {
                element.classList.add('status-warning');
            } else if (status.includes('ERROR')) {
                element.classList.add('status-error');
            }
        }
    }
}

function backupDatabase() {
    showNotification('–§—É–Ω–∫—Ü–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ë–î –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

function clearCache() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —Å–∏—Å—Ç–µ–º—ã? –≠—Ç–æ –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.')) {
        showNotification('–ö—ç—à –æ—á–∏—â–µ–Ω', 'success');
    }
}

function testMLModel() {
    showNotification('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ML –º–æ–¥–µ–ª–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

// ========== –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• ==========
function exportData(type) {
    console.log(`–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞: ${type}`);
    
    fetch('/super-admin/export/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type: type })
    })
    .then(response => {
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
        
        if (response.ok) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, CSV –ª–∏ —ç—Ç–æ
            const contentType = response.headers.get('content-type');
            console.log('Content-Type:', contentType);
            
            if (contentType && contentType.includes('csv')) {
                return response.blob();
            } else {
                return response.json();
            }
        } else {
            return response.json().then(data => {
                throw new Error(data.error || `–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            });
        }
    })
    .then(data => {
        if (data instanceof Blob) {
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
            const url = window.URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showNotification(`‚úÖ –≠–∫—Å–ø–æ—Ä—Ç ${type} –∑–∞–≤–µ—Ä—à–µ–Ω! –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...`, 'success');
        } else if (data && data.error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        } else {
            showNotification('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ', 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message, 'error');
    });
}

// ========== –£–¢–ò–õ–ò–¢–´ ==========
function updateStatElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    }
}

function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;"><div style="display: flex; justify-content: center; align-items: center; gap: 10px;"><span>üåÄ</span><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span></div></td></tr>';
    }
}

function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px; color: #fca5a5;">${message}</td></tr>`;
    }
}

function renderPagination(containerId, totalPages, currentPage, callback) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    if (currentPage > 1) {
        html += `<button class="page-btn" onclick="${callback.name}(${currentPage - 1})">&laquo;</button>`;
    }
    
    // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<button class="page-btn active">${i}</button>`;
        } else {
            html += `<button class="page-btn" onclick="${callback.name}(${i})">${i}</button>`;
        }
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
    if (currentPage < totalPages) {
        html += `<button class="page-btn" onclick="${callback.name}(${currentPage + 1})">&raquo;</button>`;
    }
    
    container.innerHTML = html;
}

function getCSRFToken() {
    const csrfCookie = document.cookie.match(/csrftoken=([^;]+)/);
    return csrfCookie ? csrfCookie[1] : '';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.remove('active');
    });
}

function showCustomModal(title, content) {
    const modalId = 'customModal_' + Date.now();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = modalId;
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${title}</h3>
                <button class="modal-close" onclick="closeModal('${modalId}')">&times;</button>
            </div>
            <div>${content}</div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal(modalId);
        }
    });
}

function showNotification(message, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: var(--radius);
        color: white;
        font-weight: 600;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 400px;
        box-shadow: var(--shadow-lg);
    `;
    
    if (type === 'success') {
        notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    } else if (type === 'error') {
        notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    } else if (type === 'warning') {
        notification.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
    } else {
        notification.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
    }
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 5000);
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
window.onclick = function(event) {
    if (event.target.classList.contains('modal-overlay')) {
        event.target.classList.remove('active');
    }
};
// ========== –†–ê–¶–ò–û–ù–´ ==========
function loadRations(page = 1) {
    const search = document.getElementById('search-rations').value;
    const animalId = document.getElementById('filter-ration-animal').value;

    let url = `/super-admin/rations/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (animalId) url += `&animal_id=${animalId}`;

    showLoading('rations-table-body');

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                renderRationsTable(data.rations || []);
                renderPagination('rations-pagination', data.total_pages || 1, page, loadRations);
                loadAnimalsForFilter(data.animals || []);
            } else {
                showError('rations-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Ü–∏–æ–Ω–æ–≤');
            }
        })
        .catch(error => {
            showError('rations-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderRationsTable(rations) {
    const tbody = document.getElementById('rations-table-body');

    if (!rations || rations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç —Ä–∞—Ü–∏–æ–Ω–æ–≤</td></tr>';
        return;
    }

    let html = '';
    rations.forEach(ration => {
        const calcDate = ration.calculation_date ? new Date(ration.calculation_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        const totalDmi = ration.total_dmi ? `${ration.total_dmi.toFixed(2)} –∫–≥/–¥–µ–Ω—å` : '–ù–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ';
        const energy = ration.energy_content ? `${ration.energy_content.toFixed(0)} –∫–∫–∞–ª/–¥–µ–Ω—å` : '-';
        const animalWeight = ration.animal_weight ? `${ration.animal_weight} –∫–≥` : '-';

        html += `
            <tr>
                <td>${ration.ration_id}</td>
                <td>${calcDate}</td>
                <td>
                    <strong>${ration.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</strong>
                    ${ration.animal_id ? `<br><small style="color: var(--text-tertiary);">ID: ${ration.animal_id}</small>` : ''}
                </td>
                <td>${ration.owner_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${animalWeight}</td>
                <td>${totalDmi}</td>
                <td>${energy}</td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewRationDetails(${ration.ration_id})" class="action-btn action-btn-view">
                            <span>üëÅÔ∏è</span>
                            <span>–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </button>
                        <button onclick="deleteRation(${ration.ration_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function loadAnimalsForFilter(animals) {
    const select = document.getElementById('filter-ration-animal');
    if (!select) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const currentValue = select.value;
    
    // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
    while (select.options.length > 1) {
        select.remove(1);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∂–∏–≤–æ—Ç–Ω—ã—Ö
    animals.forEach(animal => {
        const option = document.createElement('option');
        option.value = animal.animal_id;
        option.textContent = `${animal.name} (ID: ${animal.animal_id})`;
        select.appendChild(option);
    });

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    select.value = currentValue;
}



function viewRationDetails(rationId) {
    fetch(`/super-admin/rations/${rationId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ration = data.ration;
                const calcDate = ration.calculation_date ? new Date(ration.calculation_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                
                let modalContent = `
                    <h3>–î–µ—Ç–∞–ª–∏ —Ä–∞—Ü–∏–æ–Ω–∞ #${ration.ration_id}</h3>
                    <div style="margin-bottom: 20px;">
                        <p><strong>–î–∞—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞:</strong> ${calcDate}</p>
                        <p><strong>–ñ–∏–≤–æ—Ç–Ω–æ–µ:</strong> ${ration.animal_name} (ID: ${ration.animal_id})</p>
                        <p><strong>–í–µ—Å –∂–∏–≤–æ—Ç–Ω–æ–≥–æ:</strong> ${ration.animal_weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥</p>
                        <p><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${ration.owner_name} (${ration.owner_login})</p>
                        <p><strong>–°—É—Ç–æ—á–Ω–∞—è –Ω–æ—Ä–º–∞:</strong> ${ration.total_dmi ? ration.total_dmi.toFixed(2) + ' –∫–≥/–¥–µ–Ω—å' : '–ù–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ'}</p>
                        <p><strong>–≠–Ω–µ—Ä–≥–∏—è:</strong> ${ration.energy_content ? ration.energy_content.toFixed(0) + ' –∫–∫–∞–ª/–¥–µ–Ω—å' : '-'}</p>
                `;

                // –°–æ—Å—Ç–∞–≤ —Ä–∞—Ü–∏–æ–Ω–∞
                if (ration.composition && Object.keys(ration.composition).length > 0) {
                    modalContent += `
                        <h4 style="margin-top: 20px;">–°–æ—Å—Ç–∞–≤ —Ä–∞—Ü–∏–æ–Ω–∞:</h4>
                        <div style="background: var(--bg-darker); padding: 15px; border-radius: var(--radius); margin-bottom: 15px;">
                    `;

                    const composition = ration.composition;
                    if (composition.hay_amount) {
                        modalContent += `<p>–°–µ–Ω–æ: <strong>${composition.hay_amount} –∫–≥/–¥–µ–Ω—å</strong></p>`;
                    }
                    if (composition.grain_amount) {
                        modalContent += `<p>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã: <strong>${composition.grain_amount} –∫–≥/–¥–µ–Ω—å</strong></p>`;
                    }
                    if (composition.supplement_amount) {
                        modalContent += `<p>–î–æ–±–∞–≤–∫–∏: <strong>${composition.supplement_amount} –∫–≥/–¥–µ–Ω—å</strong></p>`;
                    }
                    if (composition.total_month_cost) {
                        modalContent += `<p>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–µ—Å—è—Ü: <strong>${composition.total_month_cost} —Ä—É–±</strong></p>`;
                    }

                    modalContent += `</div>`;
                }

                modalContent += `
                    </div>
                    <div class="action-buttons">
                        <button onclick="deleteRation(${ration.ration_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å —Ä–∞—Ü–∏–æ–Ω</span>
                        </button>
                    </div>
                `;

                showCustomModal('–î–µ—Ç–∞–ª–∏ —Ä–∞—Ü–∏–æ–Ω–∞', modalContent);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
}

function deleteRation(rationId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞—Ü–∏–æ–Ω ID ${rationId}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

    fetch(`/super-admin/rations/${rationId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –†–∞—Ü–∏–æ–Ω —É–¥–∞–ª–µ–Ω!', 'success');
            loadRations();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

function recalculateRation(rationId) {
    if (!confirm(`–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω ID ${rationId}? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`)) return;

    fetch(`/super-admin/rations/${rationId}/recalculate/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –†–∞—Ü–∏–æ–Ω –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω!', 'success');
            viewRationDetails(rationId); // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            loadRations();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

function printRation(rationId) {
    window.open(`/ration/print/${rationId}/`, '_blank');
}

</script>
{% endblock %}
