{% extends 'frontend/base.html' %}

{% block title %}–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ - HorseAI{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <div class="lg:col-span-3">
        <div class="card card-glow">
            <div class="flex justify-between items-center mb-6">
                <h1 class="h1">–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏</h1>
                <span class="px-3 py-1 rounded text-sm" style="background: var(--sage); color: white;">
                    –†–µ–∂–∏–º: ML –º–æ–¥–µ–ª—å
                </span>
            </div>

            <p class="text-secondary mb-6">
                –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ML –º–æ–¥–µ–ª–∏
            </p>

            <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ -->
            <div class="mb-8">
                <form id="uploadForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- –í—ã–±–æ—Ä –∂–∏–≤–æ—Ç–Ω–æ–≥–æ -->
                    <div class="form-group mb-4">
                        <label class="label">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ</label>
                        <select name="animal_id" class="input select" required id="animalSelect">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ --</option>
                            {% for animal in animals %}
                            <option value="{{ animal.animal_id }}">{{ animal.name }}</option>
                            {% empty %}
                            <option value="">–î–æ–±–∞–≤—å—Ç–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                    <div class="form-group mb-4">
                        <label class="label">–í–∏–¥–µ–æ—Ñ–∞–π–ª</label>
                        <div class="border-2 border-dashed rounded-lg p-8 text-center"
                             style="border-color: var(--border); background: var(--bg-hover);"
                             id="dropZone">
                            <input type="file" name="video_file" id="videoFile"
                                   accept=".mp4,.avi,.mov" class="hidden" required>
                            <div class="space-y-2">
                                <div class="text-2xl">üé¨</div>
                                <p class="text-lg">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Å –ª–æ—à–∞–¥—å—é –∑–¥–µ—Å—å</p>
                                <p class="text-sm text-tertiary">
                                    MP4, AVI, MOV ‚Ä¢ –ú–∞–∫—Å. 500MB ‚Ä¢ –ú–∏–Ω–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥
                                </p>
                                <button type="button" onclick="document.getElementById('videoFile').click()"
                                        class="btn btn-sm mt-2">
                                    –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                                </button>
                            </div>
                        </div>
                        <div id="fileInfo" class="hidden mt-2 p-3 rounded"
                             style="background: var(--bg-card);">
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ML –∞–Ω–∞–ª–∏–∑–µ -->
                    <div class="mb-6 p-4 rounded-lg" style="background: var(--bg-hover); border-left: 4px solid var(--sage);">
                        <h4 class="font-bold mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ML –∞–Ω–∞–ª–∏–∑–µ:</h4>
                        <ul class="text-sm text-secondary space-y-1">
                            <li>‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ —Ç–µ–ª–∞ —Å –ø–æ–º–æ—â—å—é DeepLabCut</li>
                            <li>‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Å–∏–º–º–µ—Ç—Ä–∏–∏ –ø–æ—Ö–æ–¥–∫–∏ –∏ –≤—ã—è–≤–ª–µ–Ω–∏–µ —Ö—Ä–æ–º–æ—Ç—ã</li>
                            <li>‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ –≤–µ—Å–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ</li>
                            <li>‚Ä¢ <strong>–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: 5-15 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∏–¥–µ–æ</strong></li>
                            <li>‚Ä¢ –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è</li>
                        </ul>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <button type="submit" class="btn w-full" id="submitBtn">
                        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å ML –∞–Ω–∞–ª–∏–∑
                    </button>
                </form>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å ML –∞–Ω–∞–ª–∏–∑–∞ -->
            <div id="progressSection" class="hidden mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-secondary">–ü—Ä–æ–≥—Ä–µ—Å—Å ML –∞–Ω–∞–ª–∏–∑–∞</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full rounded-full" style="background: var(--bg-hover); height: 8px;">
                    <div id="progressBar" class="rounded-full"
                         style="background: linear-gradient(90deg, var(--sage), var(--accent)); height: 100%; width: 0%; transition: width 0.3s;">
                    </div>
                </div>
                <div id="progressSteps" class="mt-4 space-y-2">
                    <div class="flex items-center space-x-3" id="step1">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                             style="background: var(--border); color: var(--text-secondary);">1</div>
                        <span class="text-sm text-secondary">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</span>
                    </div>
                    <div class="flex items-center space-x-3" id="step2">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                             style="background: var(--border); color: var(--text-secondary);">2</div>
                        <span class="text-sm text-secondary">–ê–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ (Docker)...</span>
                    </div>
                    <div class="flex items-center space-x-3" id="step3">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                             style="background: var(--border); color: var(--text-secondary);">3</div>
                        <span class="text-sm text-secondary">–û—Ü–µ–Ω–∫–∞ –ø–æ—Ö–æ–¥–∫–∏ ML –º–æ–¥–µ–ª—å—é...</span>
                    </div>
                    <div class="flex items-center space-x-3" id="step4">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                             style="background: var(--border); color: var(--text-secondary);">4</div>
                        <span class="text-sm text-secondary">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</span>
                    </div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ -->
                <div id="timeInfo" class="mt-4 p-3 rounded text-sm text-center"
                     style="background: var(--bg-hover);">
                    <p>‚è±Ô∏è –ê–Ω–∞–ª–∏–∑ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å <strong>5-15 –º–∏–Ω—É—Ç</strong></p>
                    <p class="text-xs text-secondary mt-1">–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ</p>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            <div id="resultsSection" class="hidden">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="lg:col-span-1 space-y-6">
        <!-- ML –º–æ–¥–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card">
            <h3 class="h3 mb-4">ML –º–æ–¥–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞</h3>
            <div class="space-y-3">
                <div class="p-3 rounded-lg" style="background: var(--bg-hover);">
                    <p class="font-medium">HorseLamenessDetector</p>
                    <p class="text-sm text-secondary">–ì–∏–±—Ä–∏–¥–Ω–∞—è –º–æ–¥–µ–ª—å: RF + Neural Network</p>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-secondary">–¢–æ—á–Ω–æ—Å—Ç—å:</span>
                        <span>92.3%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-secondary">–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:</span>
                        <span>5-15 –º–∏–Ω</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-secondary">–û–±—É—á–µ–Ω–∞ –Ω–∞:</span>
                        <span>1,200+ –≤–∏–¥–µ–æ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è -->
        <div class="card">
            <h3 class="h3 mb-4">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–∏–¥–µ–æ</h3>
            <div class="space-y-2 text-sm">
                <div class="flex items-start space-x-2">
                    <span class="text-green-500">‚úì</span>
                    <span>–õ–æ—à–∞–¥—å –≤ –¥–≤–∏–∂–µ–Ω–∏–∏ (—à–∞–≥, —Ä—ã—Å—å)</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-green-500">‚úì</span>
                    <span>–•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-green-500">‚úì</span>
                    <span>–°—Ç–∞–±–∏–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-green-500">‚úì</span>
                    <span>–ú–∏–Ω–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥</span>
                </div>
            </div>
        </div>

        <!-- –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="card">
            <h3 class="h3 mb-4">–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <div class="space-y-2 text-sm">
                <div class="flex items-start space-x-2">
                    <span class="text-blue-500">‚ÑπÔ∏è</span>
                    <span>–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-blue-500">‚ÑπÔ∏è</span>
                    <span>–ú–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-blue-500">‚ÑπÔ∏è</span>
                    <span>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–ê–Ω–∞–ª–∏–∑—ã"</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgress(step, percent, text) {
    document.getElementById(`step${step}`).querySelector('div').style.background = 'var(--sage)';
    document.getElementById(`step${step}`).querySelector('div').style.color = 'white';
    document.getElementById(`step${step}`).querySelector('span').textContent = text;
    document.getElementById(`step${step}`).querySelector('span').style.color = 'var(--text-primary)';

    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressPercent').textContent = percent + '%';
}

// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
function resetForm() {
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å ML –∞–Ω–∞–ª–∏–∑';
    document.getElementById('progressSection').classList.add('hidden');
    document.getElementById('progressBar').style.width = '0%';

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∞–≥–∏
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`step${i}`).querySelector('div').style.background = 'var(--border)';
        document.getElementById(`step${i}`).querySelector('div').style.color = 'var(--text-secondary)';
        document.getElementById(`step${i}`).querySelector('span').style.color = 'var(--text-secondary)';
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º ML –∞–Ω–∞–ª–∏–∑–æ–º
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const submitBtn = document.getElementById('submitBtn');
    const progressSection = document.getElementById('progressSection');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    submitBtn.disabled = true;
    submitBtn.textContent = 'ML –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...';
    progressSection.classList.remove('hidden');

    updateProgress(1, 25, '–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');

    try {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch('/api/upload/real/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            updateProgress(2, 50, '–ó–∞–ø—É—Å–∫ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å DeepLabCut...');

            // –û–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
            const videoId = data.video_id;
            await pollAnalysisStatus(videoId);

        } else {
            throw new Error(data.error);
        }

    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        resetForm();
    }
});

async function pollAnalysisStatus(videoId) {
    const maxAttempts = 180; // 15 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º (—É–≤–µ–ª–∏—á–∏–ª–∏ —Å 5 –¥–æ 15 –º–∏–Ω—É—Ç)
    let attempts = 0;

    const checkStatus = async () => {
        attempts++;

        try {
            const response = await fetch(`/api/analysis/status/${videoId}/`);
            const data = await response.json();

            if (data.status === 'completed') {
                updateProgress(4, 100, '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                setTimeout(() => {
                    window.location.href = `/analysis/?highlight=${data.analysis_id}`;
                }, 2000);

            } else if (data.status === 'processing') {
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–æ—Å —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
                const progress = 50 + (attempts / maxAttempts) * 40;
                updateProgress(3, Math.min(progress, 90), 'ML –º–æ–¥–µ–ª—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Ö–æ–¥–∫—É...');

                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 10000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ (—É–≤–µ–ª–∏—á–∏–ª–∏ —Å 5 –¥–æ 10)
                } else {
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∑–∂–µ
                    document.getElementById('progressSection').innerHTML = `
                        <div class="text-center p-6">
                            <div class="text-4xl mb-4">‚è≥</div>
                            <h3 class="text-lg font-bold mb-2">–ê–Ω–∞–ª–∏–∑ –≤—Å–µ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</h3>
                            <p class="text-secondary mb-4">
                                ML –∞–Ω–∞–ª–∏–∑ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å.<br>
                                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–ê–Ω–∞–ª–∏–∑—ã" –∫–æ–≥–¥–∞ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã.
                            </p>
                            <button onclick="window.location.href='/analysis/'" class="btn">
                                –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–Ω–∞–ª–∏–∑–∞–º
                            </button>
                        </div>
                    `;
                }
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞');
            }

        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message);
            resetForm();
        }
    };

    await checkStatus();
}

// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π JavaScript –∫–æ–¥ (drag & drop) –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ
</script>

<style>
/* –î–æ–±–∞–≤–∏–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–∂–∏–¥–∞–Ω–∏—è */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.pulse {
    animation: pulse 2s infinite;
}
</style>

{% endblock %}
