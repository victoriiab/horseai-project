<!DOCTYPE html>
<html>
<head>
    <title>–ê–Ω–∞–ª–∏–∑ —Ö—Ä–æ–º–æ—Ç—ã –ª–æ—à–∞–¥–µ–π</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        .upload-box { border: 2px dashed #4CAF50; padding: 40px; text-align: center; margin: 20px 0; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        .result { margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status-processing { background: #fff3cd; border: 1px solid #ffeaa7; }
        .status-completed { background: #d4edda; border: 1px solid #c3e6cb; }
        .status-failed { background: #f8d7da; border: 1px solid #f5c6cb; }
        .result-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; }
        .badge-healthy { background: green; }
        .badge-lame { background: red; }
    </style>
</head>
<body>
    <h1>üê¥ –ê–Ω–∞–ª–∏–∑ —Ö—Ä–æ–º–æ—Ç—ã –ª–æ—à–∞–¥–µ–π</h1>
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ö—Ä–æ–º–æ—Ç—ã —Å –ø–æ–º–æ—â—å—é –ò–ò</p>
    
    <div class="upload-box">
        <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏</h3>
        <input type="file" id="videoInput" accept="video/*">
        <button onclick="uploadVideo()" id="uploadBtn">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–æ–º–æ—Ç—É</button>
    </div>
    
    <div id="progress" style="display: none;">
        <h3>–°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞:</h3>
        <div class="status status-processing" id="statusBox">
            <div id="statusText">–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑...</div>
        </div>
    </div>
    
    <div id="result" class="result" style="display: none;">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:</h3>
        <div id="resultContent"></div>
    </div>
    
    <hr>
    
    <div>
        <h3>–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç:</h3>
        <button onclick="runTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ</button>
        <div id="testResult" style="margin-top: 20px;"></div>
    </div>

    <script>
    let currentVideoId = null;
    
    async function uploadVideo() {
        const fileInput = document.getElementById('videoInput');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª');
            return;
        }
        
        const formData = new FormData();
        formData.append('video', file);
        
        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('progress').style.display = 'block';
        document.getElementById('statusText').textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ...';
        document.getElementById('result').style.display = 'none';
        
        try {
            const response = await fetch('/api/lameness/analyze/', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
            currentVideoId = data.video_id;
            document.getElementById('statusText').textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...';
            
            // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å
            checkAnalysisStatus();
            
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
            resetUI();
        }
    }
    
    async function checkAnalysisStatus() {
        if (!currentVideoId) return;
        
        try {
            const response = await fetch(`/api/lameness/status/${currentVideoId}/`);
            const data = await response.json();
            
            const statusBox = document.getElementById('statusBox');
            const statusText = document.getElementById('statusText');
            
            if (data.status === 'processing') {
                statusBox.className = 'status status-processing';
                const elapsed = data.elapsed_seconds || 0;
                statusText.textContent = `–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è... (${Math.round(elapsed)} —Å–µ–∫)`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(checkAnalysisStatus, 3000);
                
            } else if (data.status === 'completed') {
                statusBox.className = 'status status-completed';
                statusText.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!';
                
                showResults(data.result);
                resetUI();
                
            } else if (data.status === 'failed' || data.status === 'timeout') {
                statusBox.className = 'status status-failed';
                statusText.textContent = `–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                    resetUI();
                }, 3000);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }
    
    function showResults(result) {
        const resultDiv = document.getElementById('resultContent');
        const resultContainer = document.getElementById('result');
        
        if (!result.success) {
            resultDiv.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞: ${result.error}</div>`;
            resultContainer.style.display = 'block';
            return;
        }
        
        const isLame = result.is_lame ? '–î–ê' : '–ù–ï–¢';
        const badgeClass = result.is_lame ? 'badge-lame' : 'badge-healthy';
        
        let html = `
            <div style="margin-bottom: 20px;">
                <div class="result-badge ${badgeClass}">
                    –•—Ä–æ–º–æ—Ç–∞: ${isLame}
                </div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:</strong></td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${result.lameness_probability}%</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:</strong></td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${result.confidence}%</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>–î–∏–∞–≥–Ω–æ–∑:</strong></td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${result.diagnosis}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong></td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${result.diagnosis_note}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:</strong></td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${result.processing_time_seconds} —Å–µ–∫</td>
                </tr>
            </table>
            
            <h4 style="margin-top: 20px;">–ë–∏–æ–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
        `;
        
        if (result.features) {
            for (const [key, value] of Object.entries(result.features)) {
                const featureName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `
                    <tr>
                        <td style="padding: 6px; border-bottom: 1px solid #eee;">${featureName}:</td>
                        <td style="padding: 6px; border-bottom: 1px solid #eee;">${typeof value === 'number' ? value.toFixed(6) : value}</td>
                    </tr>
                `;
            }
        }
        
        html += `</table>`;
        
        resultDiv.innerHTML = html;
        resultContainer.style.display = 'block';
        document.getElementById('progress').style.display = 'none';
    }
    
    async function runTest() {
        document.getElementById('testResult').innerHTML = '<div style="color: blue;">–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç...</div>';
        document.getElementById('result').style.display = 'none';
        
        try {
            const response = await fetch('/api/lameness/test/');
            const data = await response.json();
            
            if (data.success) {
                showResults(data.test_result);
                document.getElementById('testResult').innerHTML = '<div style="color: green;">‚úÖ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</div>';
            } else {
                document.getElementById('testResult').innerHTML = `<div style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
            }
        } catch (error) {
            document.getElementById('testResult').innerHTML = `<div style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
    }
    
    function resetUI() {
        document.getElementById('uploadBtn').disabled = false;
        currentVideoId = null;
    }
    </script>
</body>
</html>
