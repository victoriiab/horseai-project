{% extends 'frontend/base.html' %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ - HorseAI{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <h1 style="color: #333; margin-bottom: 10px;">üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h1>
    <p style="color: #666; margin-bottom: 30px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏</p>
    
    <div style="background: white; border: 1px solid #ddd; border-radius: 10px; padding: 30px; margin-bottom: 20px;">
        <h2 style="color: #333; margin-bottom: 25px;">–§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
        
        <form id="uploadForm" enctype="multipart/form-data" style="margin-bottom: 20px;">
            {% csrf_token %}
            
            <!-- –í—ã–±–æ—Ä –∂–∏–≤–æ—Ç–Ω–æ–≥–æ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #555; margin-bottom: 8px; font-weight: 500;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ:
                </label>
                <select name="animal_id" id="animalSelect" 
                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ --</option>
                    {% for animal in animals %}
                    <option value="{{ animal.animal_id }}">{{ animal.name }} (ID: {{ animal.animal_id }})</option>
                    {% empty %}
                    <option value="1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–∞—è –ª–æ—à–∞–¥—å</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #555; margin-bottom: 8px; font-weight: 500;">
                    –í–∏–¥–µ–æ—Ñ–∞–π–ª:
                </label>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" id="fileSelectBtn" 
                            style="background: #4CAF50; color: white; border: none; padding: 15px 30px; 
                                   border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">
                        üìÅ –í–´–ë–†–ê–¢–¨ –§–ê–ô–õ
                    </button>
                    <input type="file" name="video_file" id="videoFile" 
                           style="display: none;" accept=".mp4,.avi,.mov,.mkv,.txt,.jpg,.png" required>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ -->
                <div id="fileInfo" style="display: none; margin-top: 20px; padding: 15px; 
                                          background: #f0f9ff; border: 1px solid #b3e0ff; border-radius: 5px;">
                    <h4 style="margin-top: 0; color: #0066cc;">üìÑ –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:</h4>
                    <p style="margin: 5px 0;"><strong>–ò–º—è:</strong> <span id="fileName"></span></p>
                    <p style="margin: 5px 0;"><strong>–†–∞–∑–º–µ—Ä:</strong> <span id="fileSize"></span></p>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">
                        <em>–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.</em>
                    </p>
                </div>
                
                <!-- –ü—Ä–æ—Å—Ç–æ–π drag & drop -->
                <div id="dropZone" style="border: 2px dashed #4CAF50; border-radius: 10px; padding: 30px; 
                                          text-align: center; margin: 20px 0; background: #f9f9f9; cursor: pointer;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚¨ÜÔ∏è</div>
                    <p style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #4CAF50;">
                        –ò–õ–ò –ü–ï–†–ï–¢–ê–©–ò–¢–ï –§–ê–ô–õ –°–Æ–î–ê
                    </p>
                    <p style="color: #666; font-size: 14px;">
                        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, MKV<br>
                        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 500MB
                    </p>
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div style="background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 15px; 
                        border-radius: 5px; margin: 20px 0;">
                <p style="margin: 0 0 10px 0; font-weight: bold;">üìä –ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:</p>
                <ul style="margin: 0 0 0 20px; padding: 0;">
                    <li>–°–∏–º–º–µ—Ç—Ä–∏—è –ø–æ—Ö–æ–¥–∫–∏ –ª–æ—à–∞–¥–∏</li>
                    <li>–ü—Ä–∏–∑–Ω–∞–∫–∏ —Ö—Ä–æ–º–æ—Ç—ã –∏ –∞–Ω–æ–º–∞–ª–∏–π –¥–≤–∏–∂–µ–Ω–∏–π</li>
                    <li>–ö–∞—á–µ—Å—Ç–≤–æ –¥–≤–∏–∂–µ–Ω–∏–π –∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π</li>
                    <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞</li>
                </ul>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <button type="submit" id="submitBtn" 
                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #4CAF50, #2E7D32); 
                           color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; 
                           cursor: pointer; margin-top: 20px; transition: all 0.3s;">
                üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –ê–ù–ê–õ–ò–ó –í–ò–î–ï–û
            </button>
        </form>
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div id="progressSection" style="display: none; margin-top: 30px; padding: 20px; 
                                         background: #f5f5f5; border-radius: 10px;">
            <h3 style="margin-bottom: 15px; color: #333;">‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞:</h3>
            <div style="height: 12px; background: #ddd; border-radius: 6px; overflow: hidden; margin: 20px 0;">
                <div id="progressFill" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #2E7D32); 
                                             width: 0%; transition: width 0.5s;"></div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 10px; color: #666; font-weight: 500;">
                –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...
            </p>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="resultSection" style="display: none; margin-top: 30px; padding: 25px; 
                                       background: #e8f5e9; border-radius: 10px; border: 2px solid #4CAF50;">
            <h3 style="color: #2E7D32; margin-bottom: 15px;">‚úÖ –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù!</h3>
            <div id="resultContent" style="line-height: 1.6;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="window.location.href='/analysis/results/'" 
                        style="background: #2E7D32; color: white; border: none; padding: 12px 25px; 
                               border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;">
                    üìã –ü–ï–†–ï–ô–¢–ò –ö –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú
                </button>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    <em>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...</em>
                </p>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px;">
        <p style="margin: 0 0 10px 0; font-weight: bold;">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</p>
        <ul style="margin: 0 0 0 20px; padding: 0;">
            <li>–î–ª—è —Ç–µ—Å—Ç–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π —Ñ–∞–π–ª (–¥–∞–∂–µ .txt)</li>
            <li>–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç –∂–∏–≤–æ—Ç–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç</li>
            <li>–í—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–æ–≤</li>
            <li>–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω –∫–æ—Ä–º–ª–µ–Ω–∏—è</li>
        </ul>
    </div>
</div>

<script>
// ========== –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('videoFile');
    const fileSelectBtn = document.getElementById('fileSelectBtn');
    const dropZone = document.getElementById('dropZone');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('submitBtn');
    const progressSection = document.getElementById('progressSection');
    const resultSection = document.getElementById('resultSection');
    
    // ========== –í–´–ë–û–† –§–ê–ô–õ–ê ==========
    
    // 1. –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    fileSelectBtn.addEventListener('click', function() {
        console.log('–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞');
        fileInput.click();
    });
    
    // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    fileInput.addEventListener('change', function() {
        console.log('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω —á–µ—Ä–µ–∑ input');
        if (this.files.length > 0) {
            handleFileSelection(this.files[0]);
        }
    });
    
    // 3. Drag & Drop
    dropZone.addEventListener('click', function() {
        console.log('–ù–∞–∂–∞—Ç–∞ –∑–æ–Ω–∞ drag&drop');
        fileInput.click();
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, function(e) {
            e.preventDefault();
            this.style.background = '#e8f5e9';
            this.style.borderColor = '#2E7D32';
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, function(e) {
            e.preventDefault();
            this.style.background = '#f9f9f9';
            this.style.borderColor = '#4CAF50';
            
            if (eventName === 'drop' && e.dataTransfer.files.length > 0) {
                console.log('–§–∞–π–ª –ø–µ—Ä–µ—Ç–∞—â–µ–Ω –≤ –∑–æ–Ω—É');
                handleFileSelection(e.dataTransfer.files[0]);
                fileInput.files = e.dataTransfer.files;
            }
        }, false);
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    function handleFileSelection(file) {
        console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞:', file.name);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
        if (file.size > 500 * 1024 * 1024) {
            alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 500MB');
            fileInput.value = '';
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = sizeMB + ' MB';
        fileInfo.style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–Ω—É drag&drop –º–µ–Ω—å—à–µ
        dropZone.style.padding = '15px';
        dropZone.innerHTML = '<p style="color: #4CAF50; font-weight: bold;">‚úÖ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω</p>' +
                            '<p style="color: #666; font-size: 14px;">–ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</p>';
        
        console.log('‚úÖ –§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ:', file.name);
    }
    
    // ========== –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ ==========
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('üì§ –ù–∞—á–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
        const animalSelect = document.getElementById('animalSelect');
        if (!animalSelect.value) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ –∏–∑ —Å–ø–∏—Å–∫–∞');
            animalSelect.focus();
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
        if (!fileInput.files.length) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
            fileSelectBtn.focus();
            return;
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º UI
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ –ó–ê–ì–†–£–ó–ö–ê...';
        submitBtn.style.background = '#ccc';
        
        progressSection.style.display = 'block';
        document.getElementById('progressFill').style.width = '25%';
        document.getElementById('progressText').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...';
        
        try {
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const formData = new FormData(this);
            
            // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
            function getCSRFToken() {
                const name = 'csrftoken';
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCSRFToken();
            console.log('CSRF —Ç–æ–∫–µ–Ω:', csrftoken ? '–ø–æ–ª—É—á–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/upload/simple/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'
            });
            
            console.log('üì® –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (response.status === 401 || response.status === 403) {
                throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
            }
            
            // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
            const data = await response.json();
            console.log('üìä –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
            
            if (data.success) {
                // –£–°–ü–ï–•
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                resultSection.style.display = 'block';
                document.getElementById('resultContent').innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:</strong></p>
                        <p>üìπ <strong>–í–∏–¥–µ–æ ID:</strong> ${data.video_id}</p>
                        <p>üê¥ <strong>–ñ–∏–≤–æ—Ç–Ω–æ–µ:</strong> ${data.animal_name}</p>
                        <p>üìã <strong>–î–∏–∞–≥–Ω–æ–∑:</strong> ${data.diagnosis || '–ù–æ—Ä–º–∞'}</p>
                        <p>üìà <strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:</strong> ${data.lameness_probability || 0}%</p>
                        <p>‚ö†Ô∏è <strong>–•—Ä–æ–º–æ—Ç–∞:</strong> ${data.is_lame ? '–î–ê (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ)' : '–ù–ï–¢ (–≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ)'}</p>
                        ${data.message ? `<p>üí¨ <strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${data.message}</p>` : ''}
                    </div>
                `;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                setTimeout(() => {
                    console.log('üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
                    window.location.href = '/analysis/results/';
                }, 5000);
                
            } else {
                // –û–®–ò–ë–ö–ê –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –ê–ù–ê–õ–ò–ó –í–ò–î–ï–û';
            submitBtn.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
            
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            let errorMessage = error.message;
            if (errorMessage.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è') || errorMessage.includes('401') || errorMessage.includes('403')) {
                errorMessage = 'üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞...';
                setTimeout(() => {
                    window.location.href = '/login/';
                }, 2000);
            }
            
            alert('‚ùå –û–®–ò–ë–ö–ê:\n' + errorMessage);
        }
    });
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
    console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    
    // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    fetch('/api/system-stats/', { credentials: 'same-origin' })
        .then(response => {
            if (response.ok) {
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            } else {
                console.log('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            }
        })
        .catch(err => console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é:', err));
});
</script>
{% endblock %}
