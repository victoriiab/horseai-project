{% extends 'frontend/base.html' %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ - HorseAI{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 30px 20px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px;">üé¨ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h1>
    <p style="color: #7f8c8d; margin-bottom: 30px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏</p>
    
    <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <form id="uploadForm" enctype="multipart/form-data" style="margin-bottom: 20px;">
            {% csrf_token %}
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #34495e;">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ:</label>
                <select name="animal_id" id="animalSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ --</option>
                    {% for animal in animals %}
                    <option value="{{ animal.animal_id }}">{{ animal.name }} (ID: {{ animal.animal_id }})</option>
                    {% empty %}
                    <option value="1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–∞—è –ª–æ—à–∞–¥—å</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #34495e;">–í–∏–¥–µ–æ—Ñ–∞–π–ª:</label>
                <div id="fileDropZone" style="border: 3px dashed #3498db; border-radius: 10px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 48px; color: #3498db; margin-bottom: 15px;">üìÅ</div>
                    <p style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                    <input type="file" name="video_file" id="videoFile" style="display: none;" accept=".mp4,.avi,.mov,.mkv" required>
                    <button type="button" id="browseBtn" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                    </button>
                </div>
                <div id="fileInfo" style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745; display: none;">
                    <strong>–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:</strong> <span id="fileName"></span> (<span id="fileSize"></span> MB)
                </div>
            </div>
            
            <div style="background: #e8f4fc; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #3498db;">
                <p style="margin: 0; color: #2c3e50;"><strong>üìä –ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:</strong></p>
                <ul style="margin: 10px 0 0 20px; color: #2c3e50;">
                    <li>–°–∏–º–º–µ—Ç—Ä–∏—è –ø–æ—Ö–æ–¥–∫–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏–π</li>
                    <li>–ü—Ä–∏–∑–Ω–∞–∫–∏ —Ö—Ä–æ–º–æ—Ç—ã</li>
                    <li>–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–≤–∏–∂–µ–Ω–∏–π</li>
                    <li>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é</li>
                </ul>
            </div>
            
            <button type="submit" id="submitBtn" style="width: 100%; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; padding: 16px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ
            </button>
        </form>
        
        <div id="progressSection" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #ddd;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="font-weight: bold; color: #2c3e50;">–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                <span id="progressPercent" style="font-weight: bold; color: #4CAF50;">0%</span>
            </div>
            <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #2E7D32); width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 15px; color: #6c757d;">–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏...</p>
        </div>
        
        <div id="resultSection" style="display: none; margin-top: 30px; padding: 25px; background: #d4edda; border-radius: 10px; border-left: 4px solid #28a745;">
            <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!</h3>
            <div id="resultContent" style="margin-bottom: 20px;"></div>
            <button onclick="window.location.href='/analysis/results/'" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            </button>
        </div>
    </div>
</div>

<script>
// –ü–†–û–°–¢–û–ô –ò –†–ê–ë–û–ß–ò–ô JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º...');
    
    const form = document.getElementById('uploadForm');
    const videoFile = document.getElementById('videoFile');
    const browseBtn = document.getElementById('browseBtn');
    const submitBtn = document.getElementById('submitBtn');
    const fileDropZone = document.getElementById('fileDropZone');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressText = document.getElementById('progressText');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    
    // 1. –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    browseBtn.addEventListener('click', function() {
        console.log('–ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –Ω–∞–∂–∞—Ç–∞');
        videoFile.click();
    });
    
    // 2. –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
    fileDropZone.addEventListener('click', function() {
        console.log('–ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∂–∞—Ç–∞');
        videoFile.click();
    });
    
    // 3. –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    videoFile.addEventListener('change', function() {
        console.log('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω:', this.files.length);
        if (this.files.length > 0) {
            const file = this.files[0];
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = sizeMB;
            if (fileInfo) fileInfo.style.display = 'block';
            
            console.log('–§–∞–π–ª:', file.name, sizeMB, 'MB');
        }
    });
    
    // 4. Drag & Drop (–ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
    fileDropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.background = '#e3f2fd';
        this.style.borderColor = '#2196f3';
    });
    
    fileDropZone.addEventListener('dragleave', function() {
        this.style.background = '#f8f9fa';
        this.style.borderColor = '#3498db';
    });
    
    fileDropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.background = '#f8f9fa';
        this.style.borderColor = '#3498db';
        
        if (e.dataTransfer.files.length > 0) {
            videoFile.files = e.dataTransfer.files;
            videoFile.dispatchEvent(new Event('change'));
        }
    });
    
    // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
        const animalSelect = document.getElementById('animalSelect');
        if (!animalSelect || !animalSelect.value) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
        if (!videoFile.files.length) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª');
            return;
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            submitBtn.style.background = '#6c757d';
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        if (progressSection) {
            progressSection.style.display = 'block';
            progressBar.style.width = '25%';
            progressPercent.textContent = '25%';
            progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...';
        }
        
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/upload/simple/');
            
            // –°–æ–∑–¥–∞–µ–º FormData
            const formData = new FormData(this);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/upload/simple/', {
                method: 'POST',
                body: formData
            });
            
            console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
            const data = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            if (data.success) {
                // –£—Å–ø–µ—Ö - –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                if (progressSection) {
                    progressBar.style.width = '100%';
                    progressPercent.textContent = '100%';
                    progressText.textContent = '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (resultSection && resultContent) {
                    resultSection.style.display = 'block';
                    resultContent.innerHTML = `
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <p><strong>üÜî ID –≤–∏–¥–µ–æ:</strong> ${data.video_id}</p>
                            <p><strong>üê¥ –ñ–∏–≤–æ—Ç–Ω–æ–µ:</strong> ${data.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>üìä –î–∏–∞–≥–Ω–æ–∑:</strong> ${data.diagnosis || '–ù–æ—Ä–º–∞'}</p>
                            <p><strong>üìà –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:</strong> ${data.lameness_probability || 0}%</p>
                            <p><strong>‚ö†Ô∏è –•—Ä–æ–º–æ—Ç–∞:</strong> ${data.is_lame ? '–î–ê (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ)' : '–ù–ï–¢ (–≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ)'}</p>
                        </div>
                        <p style="color: #0c5460;">–ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>
                    `;
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    window.location.href = '/analysis/results/';
                }, 5000);
                
            } else {
                // –û—à–∏–±–∫–∞
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ';
                submitBtn.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
            }
            
            if (progressSection) {
                progressSection.style.display = 'none';
            }
            
            if (resultSection) {
                resultSection.style.display = 'none';
            }
        }
    });
    
    console.log('JavaScript —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
});
</script>
{% endblock %}
