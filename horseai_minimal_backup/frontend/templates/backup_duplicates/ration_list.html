{% extends 'frontend/base.html' %}

{% block title %}–ú–æ–∏ —Ä–∞—Ü–∏–æ–Ω—ã - HorseAI{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>üìã –ú–æ–∏ —Ä–∞—Ü–∏–æ–Ω—ã</h1>
        <p>–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ä–∞—Ü–∏–æ–Ω–æ–≤</p>
    </div>

    <div class="actions-bar" style="margin-bottom: 30px;">
        <a href="/ration/" class="btn btn-primary">
            <span>‚ûï</span>
            –ù–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
        </a>
    </div>

    <div id="rationsList">
        <div style="text-align: center; padding: 50px 20px;">
            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">üìã</div>
            <p style="color: var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Ü–∏–æ–Ω–æ–≤...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadRations();
});

function loadRations() {
    fetch('/api/rations/', {
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('–ü–æ–ª—É—á–µ–Ω—ã —Ä–∞—Ü–∏–æ–Ω—ã:', data);
        renderRations(data);
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Ü–∏–æ–Ω–æ–≤:', error);
        document.getElementById('rationsList').innerHTML = `
            <div style="text-align: center; padding: 50px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">‚ùå</div>
                <h3 style="color: var(--text-secondary); margin-bottom: 15px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Ü–∏–æ–Ω–æ–≤</h3>
                <p style="color: var(--text-tertiary);">${error.message}</p>
            </div>
        `;
    });
}

function renderRations(rations) {
    if (!rations || rations.length === 0) {
        document.getElementById('rationsList').innerHTML = `
            <div style="text-align: center; padding: 50px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">ü•ó</div>
                <h3 style="color: var(--text-secondary); margin-bottom: 15px;">–£ –≤–∞—Å –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Ü–∏–æ–Ω–æ–≤</h3>
                <a href="/ration/" class="btn btn-primary" style="display: inline-flex;">
                    <span>‚ûï</span>
                    –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ä–∞—Ü–∏–æ–Ω
                </a>
            </div>
        `;
        return;
    }

    const html = rations.map(ration => `
        <div class="ration-card" style="background: var(--bg-card); border-radius: var(--radius); padding: 25px; margin-bottom: 20px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div>
                    <h3 style="margin: 0 0 10px; color: var(--text-primary);">
                        üê¥ ${ration.animal_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}
                    </h3>
                    <div style="color: var(--text-secondary); font-size: 14px;">
                        –í–µ—Å: ${ration.composition?.weight || 0} –∫–≥ ‚Ä¢ 
                        –î–∞—Ç–∞: ${ration.formatted_date}
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, var(--accent), var(--earth)); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px;">
                    ${ration.composition?.total_cost || '0 —Ä—É–±/–º–µ—Å—è—Ü'}
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: var(--bg-hover); padding: 15px; border-radius: var(--radius);">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                        ${ration.total_dmi?.toFixed(2) || 0}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 13px;">–°—É—Ö–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞ (–∫–≥/–¥–µ–Ω—å)</div>
                </div>
                
                <div style="background: var(--bg-hover); padding: 15px; border-radius: var(--radius);">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                        ${ration.energy_content?.toFixed(1) || 0}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 13px;">–≠–Ω–µ—Ä–≥–∏—è (–ú–∫–∞–ª/–¥–µ–Ω—å)</div>
                </div>
                
                <div style="background: var(--bg-hover); padding: 15px; border-radius: var(--radius);">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                        ${ration.composition?.hay || '0 –∫–≥/–¥–µ–Ω—å'}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 13px;">–°–µ–Ω–æ</div>
                </div>
            </div>

            <div style="color: var(--text-secondary); font-size: 14px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                <strong>–•—Ä–æ–º–æ—Ç–∞:</strong> ${ration.composition?.lameness === 'none' ? '–ù–µ—Ç' : ration.composition?.lameness}
                ${ration.composition?.lameness !== 'none' ? ` (${ration.composition?.lameness_duration || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'})` : ''}
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="viewRation(${ration.ration_id})" class="btn" style="padding: 8px 16px;">
                    üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </button>
                <button onclick="deleteRation(${ration.ration_id})" class="btn" style="padding: 8px 16px; background: var(--bg-hover);">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    `).join('');

    document.getElementById('rationsList').innerHTML = html;
}

function viewRation(rationId) {
    window.location.href = `/ration/${rationId}/`;
}

function deleteRation(rationId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Ü–∏–æ–Ω?')) {
        fetch(`/api/rations/${rationId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                alert('–†–∞—Ü–∏–æ–Ω —É–¥–∞–ª–µ–Ω');
                loadRations(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞—Ü–∏–æ–Ω–∞');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞—Ü–∏–æ–Ω–∞');
        });
    }
}
</script>
{% endblock %}
