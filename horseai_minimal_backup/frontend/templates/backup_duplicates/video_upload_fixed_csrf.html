{% extends 'frontend/base.html' %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ - HorseAI{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
    }

    .upload-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .upload-title {
        font-size: 32px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .upload-subtitle {
        color: var(--text-secondary);
        font-size: 16px;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
    }

    /* –§–æ—Ä–º–∞ */
    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        color: var(--text-secondary);
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .form-select {
        width: 100%;
        padding: 14px 18px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text-primary);
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
    }

    /* Dropzone */
    .dropzone {
        border: 3px dashed var(--border);
        border-radius: var(--radius-lg);
        padding: 60px 40px;
        text-align: center;
        margin: 30px 0;
        transition: all 0.3s ease;
        cursor: pointer;
        background: var(--bg-hover);
        position: relative;
        overflow: hidden;
    }

    .dropzone:hover {
        border-color: var(--accent);
        background: rgba(217, 119, 6, 0.05);
    }

    .dropzone.dragover {
        border-color: var(--accent);
        background: rgba(217, 119, 6, 0.1);
        transform: scale(1.02);
    }

    .dropzone-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.7;
        transition: all 0.3s ease;
    }

    .dropzone:hover .dropzone-icon {
        opacity: 1;
        transform: translateY(-5px);
    }

    .dropzone-text {
        color: var(--text-secondary);
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .dropzone-hint {
        color: var(--text-tertiary);
        font-size: 14px;
        margin-top: 10px;
    }

    .dropzone-file-info {
        margin-top: 20px;
        padding: 15px;
        background: var(--bg-dark);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        display: none;
    }

    .file-name {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 5px;
        word-break: break-all;
    }

    .file-size {
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .upload-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .btn-upload {
        flex: 1;
        padding: 16px;
        background: linear-gradient(135deg, var(--accent), var(--earth));
        color: white;
        border: none;
        border-radius: var(--radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-upload:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg), var(--glow);
        background: linear-gradient(135deg, var(--accent-hover), var(--accent));
    }

    .btn-upload:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: var(--bg-hover);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--border);
        border-color: var(--accent);
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
    .progress-container {
        margin-top: 30px;
        display: none;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .progress-title {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .progress-percent {
        color: var(--accent);
        font-weight: 700;
        font-size: 20px;
    }

    .progress-bar {
        height: 12px;
        background: var(--bg-hover);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--earth));
        border-radius: 6px;
        width: 0%;
        transition: width 0.5s ease;
    }

    .progress-status {
        color: var(--text-secondary);
        font-size: 14px;
        text-align: center;
        min-height: 20px;
        font-style: italic;
    }

    /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
    .result-container {
        margin-top: 30px;
        padding: 30px;
        background: linear-gradient(145deg, var(--bg-card), var(--bg-dark));
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        display: none;
    }

    .result-header {
        text-align: center;
        margin-bottom: 25px;
    }

    .result-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    .result-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 10px;
    }

    .result-subtitle {
        color: var(--text-secondary);
        font-size: 16px;
        line-height: 1.6;
    }

    .result-details {
        margin-top: 25px;
        padding: 20px;
        background: var(--bg-dark);
        border-radius: var(--radius);
        border: 1px solid var(--border);
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-label {
        color: var(--text-secondary);
        font-size: 15px;
    }

    .detail-value {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 16px;
    }

    .result-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .message {
        padding: 15px 20px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        display: none;
        animation: slideIn 0.3s ease;
    }

    .message-success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: #10b981;
    }

    .message-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }

    .message-info {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #3b82f6;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- –°–∫—Ä—ã—Ç—ã–π CSRF —Ç–æ–∫–µ–Ω -->
<input type="hidden" id="csrf_token" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="upload-container">
    <div class="upload-header">
        <h1 class="upload-title">
            <span>üé¨</span>
            –ê–Ω–∞–ª–∏–∑ –ø–æ—Ö–æ–¥–∫–∏ –ª–æ—à–∞–¥–∏
        </h1>
        <p class="upload-subtitle">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏ –≤ –¥–≤–∏–∂–µ–Ω–∏–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ö—Ä–æ–º–æ—Ç—ã.
            –°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ —Ç–µ–ª–∞ –∏ –æ—Ü–µ–Ω–∏—Ç —Å–∏–º–º–µ—Ç—Ä–∏—é –¥–≤–∏–∂–µ–Ω–∏–π.
        </p>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message" class="message"></div>

    <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="uploadForm">
        <div class="form-group">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
            <select id="animalSelect" class="form-select" required>
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å --</option>
                {% for animal in animals %}
                <option value="{{ animal.animal_id }}">{{ animal.name|default:"–ë–µ–∑ –∏–º–µ–Ω–∏" }}</option>
                {% empty %}
                <option value="" disabled>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–æ—à–∞–¥–µ–π</option>
                {% endfor %}
            </select>
            {% if not animals %}
            <p style="color: var(--accent); margin-top: 10px; font-size: 14px;">
                ‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ—Ç –ª–æ—à–∞–¥–µ–π. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ª–æ—à–∞–¥—å –≤ —Ä–∞–∑–¥–µ–ª–µ 
                <a href="/animals/" style="color: var(--accent-light); text-decoration: underline;">–ú–æ–∏ –ª–æ—à–∞–¥–∏</a>.
            </p>
            {% endif %}
        </div>

        <!-- Dropzone -->
        <div id="dropzone" class="dropzone">
            <div class="dropzone-icon">üìÅ</div>
            <div class="dropzone-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª —Å—é–¥–∞</div>
            <div class="dropzone-hint">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</div>
            
            <input type="file" id="videoFile" accept="video/*" style="display: none;">
            
            <div id="fileInfo" class="dropzone-file-info">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="upload-buttons">
            <button type="button" class="btn-upload btn-secondary" onclick="window.history.back()">
                <span>‚Üê</span>
                –ù–∞–∑–∞–¥
            </button>
            <button id="uploadBtn" class="btn-upload" onclick="uploadVideo()" disabled>
                <span>üöÄ</span>
                –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
            <button id="testBtn" class="btn-upload btn-secondary" onclick="testMLModel()">
                <span>üîß</span>
                –¢–µ—Å—Ç ML
            </button>
        </div>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div id="progressContainer" class="progress-container">
        <div class="progress-header">
            <div class="progress-title">
                <span id="progressIcon">‚è≥</span>
                –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ
            </div>
            <div class="progress-percent" id="progressPercent">0%</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="progress-status" id="progressStatus">
            –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–Ω–∞–ª–∏–∑—É...
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div id="resultContainer" class="result-container">
        <div class="result-header">
            <div class="result-icon" id="resultIcon">‚úÖ</div>
            <h2 class="result-title" id="resultTitle">–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω</h2>
            <p class="result-subtitle" id="resultSubtitle"></p>
        </div>
        
        <div class="result-details" id="resultDetails">
            <!-- –î–µ—Ç–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <div class="result-actions">
            <button class="btn-upload btn-secondary" onclick="resetForm()">
                <span>üîÑ</span>
                –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            </button>
            <button class="btn-upload" onclick="viewResults()">
                <span>üìä</span>
                –°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞–Ω–∞–ª–∏–∑—ã
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    // –°–ø–æ—Å–æ–± 1: –ò—â–µ–º —Å–∫—Ä—ã—Ç—ã–π input
    const csrfInput = document.getElementById('csrf_token');
    if (csrfInput) return csrfInput.value;
    
    // –°–ø–æ—Å–æ–± 2: –ò—â–µ–º –≤ cookies
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue || '';
}

function showMessage(text, type = 'info') {
    const messageEl = document.getElementById('message');
    if (!messageEl) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç message –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    messageEl.textContent = text;
    messageEl.className = `message message-${type}`;
    messageEl.style.display = 'block';
    
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            if (messageEl) messageEl.style.display = 'none';
        }, 5000);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let selectedFile = null;
let currentTaskId = null;
let checkInterval = null;

// –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
function getElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.error(`–≠–ª–µ–º–µ–Ω—Ç ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
        throw new Error(`–≠–ª–µ–º–µ–Ω—Ç ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
    }
    return element;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    try {
        const dropzone = getElement('dropzone');
        const fileInput = getElement('videoFile');
        const uploadBtn = getElement('uploadBtn');
        const animalSelect = getElement('animalSelect');
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ –∫–ª–∏–∫
        dropzone.addEventListener('click', () => {
            fileInput.click();
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        function checkUploadButton() {
            const isAnimalSelected = animalSelect.value !== '';
            const isFileSelected = selectedFile !== null;
            uploadBtn.disabled = !(isAnimalSelected && isFileSelected);
        }
        
        animalSelect.addEventListener('change', checkUploadButton);
        
        // –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        checkUploadButton();
        
        console.log('–§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã:', error);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã: ' + error.message, 'error');
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
function handleFileSelect(file) {
    try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        const allowedTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo', 'video/webm'];
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp4|avi|mov|mkv|webm)$/i)) {
            showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª (MP4, AVI, MOV, MKV, WebM)', 'error');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å 500MB)
        const maxSize = 500 * 1024 * 1024;
        if (file.size > maxSize) {
            showMessage('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 500MB', 'error');
            return;
        }
        
        selectedFile = file;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        getElement('fileName').textContent = file.name;
        getElement('fileSize').textContent = formatFileSize(file.size);
        getElement('fileInfo').style.display = 'block';
        
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –∂–∏–≤–æ—Ç–Ω–æ–µ –≤—ã–±—Ä–∞–Ω–æ
        const animalSelect = getElement('animalSelect');
        const uploadBtn = getElement('uploadBtn');
        uploadBtn.disabled = animalSelect.value === '';
        
        showMessage(`–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name} (${formatFileSize(file.size)})`, 'success');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞:', error);
        showMessage('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
    }
}

// –¢–µ—Å—Ç ML –º–æ–¥–µ–ª–∏
async function testMLModel() {
    try {
        showMessage('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ML –º–æ–¥–µ–ª–∏...', 'info');
        
        const response = await fetch('/api/ml/test/');
        const data = await response.json();
        
        if (data.success) {
            showMessage(`‚úÖ ML –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞: ${data.message}`, 'success');
            console.log('ML —Ç–µ—Å—Ç:', data);
        } else {
            showMessage(`‚ùå –û—à–∏–±–∫–∞ ML –º–æ–¥–µ–ª–∏: ${data.error}`, 'error');
        }
    } catch (error) {
        showMessage(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
async function uploadVideo() {
    try {
        if (!selectedFile) {
            showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª', 'error');
            return;
        }
        
        const animalId = getElement('animalSelect').value;
        if (!animalId) {
            showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å', 'error');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        getElement('uploadForm').style.display = 'none';
        getElement('progressContainer').style.display = 'block';
        updateProgress(10, '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
        
        const formData = new FormData();
        formData.append('animal_id', animalId);
        formData.append('video_file', selectedFile);
        
        const response = await fetch('/api/ml/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑...', 'success');
            currentTaskId = data.task_id;
            updateProgress(30, '–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ...');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
            startCheckingStatus(data.task_id);
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        showMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        resetToForm();
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–Ω–∞–ª–∏–∑–∞
async function startCheckingStatus(taskId) {
    checkInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/ml/status/${taskId}/`);
            const data = await response.json();
            
            if (data.success) {
                const progress = data.progress || 0;
                updateProgress(30 + progress * 0.7, data.message || '–û–±—Ä–∞–±–æ—Ç–∫–∞...');
                
                if (data.status === 'completed') {
                    clearInterval(checkInterval);
                    await handleCompletedAnalysis(data);
                } else if (data.status === 'failed') {
                    clearInterval(checkInterval);
                    showMessage(`‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                    resetToForm();
                }
            } else {
                clearInterval(checkInterval);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                resetToForm();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }, 2000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
async function handleCompletedAnalysis(data) {
    try {
        updateProgress(100, '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ë–î
        const saveResponse = await fetch('/api/ml/save-result/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                task_id: currentTaskId,
                video_id: data.result?.video_id || 0
            })
        });
        
        const saveData = await saveResponse.json();
        
        if (saveData.success) {
            showResult(saveData, data.result);
        } else {
            throw new Error(saveData.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        showMessage(`‚ö†Ô∏è –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
        showResult({}, data.result);
    }
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
function showResult(saveData, mlResult) {
    try {
        getElement('progressContainer').style.display = 'none';
        getElement('resultContainer').style.display = 'block';
        
        const isLame = mlResult?.is_lame || saveData.is_lame || false;
        const probability = mlResult?.lameness_probability || saveData.lameness_probability || 0;
        const diagnosis = mlResult?.diagnosis || saveData.diagnosis || '–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞';
        const confidence = mlResult?.confidence || saveData.confidence || 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const resultIcon = getElement('resultIcon');
        const resultTitle = getElement('resultTitle');
        
        if (isLame) {
            resultIcon.textContent = '‚ö†Ô∏è';
            resultTitle.textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ö—Ä–æ–º–æ—Ç–∞';
            resultTitle.style.color = 'var(--accent)';
        } else {
            resultIcon.textContent = '‚úÖ';
            resultTitle.textContent = '–•—Ä–æ–º–æ—Ç–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞';
            resultTitle.style.color = 'var(--success)';
        }
        
        getElement('resultSubtitle').textContent = diagnosis;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏
        const detailsHtml = `
            <div class="detail-item">
                <span class="detail-label">–†–µ–∑—É–ª—å—Ç–∞—Ç:</span>
                <span class="detail-value">${isLame ? '–•—Ä–æ–º–æ—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞' : '–ù–æ—Ä–º–∞'}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:</span>
                <span class="detail-value">${probability.toFixed(1)}%</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å:</span>
                <span class="detail-value">${confidence.toFixed(1)}%</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</span>
                <span class="detail-value">${isLame ? '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∞' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ'}</span>
            </div>
        `;
        
        getElement('resultDetails').innerHTML = detailsHtml;
        
        showMessage('‚úÖ –ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
        showMessage('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞', 'error');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgress(percent, message) {
    try {
        getElement('progressPercent').textContent = `${Math.round(percent)}%`;
        getElement('progressFill').style.width = `${percent}%`;
        getElement('progressStatus').textContent = message;
        
        const iconEl = getElement('progressIcon');
        if (percent < 30) iconEl.textContent = '‚è≥';
        else if (percent < 70) iconEl.textContent = 'üîç';
        else if (percent < 100) iconEl.textContent = 'üìä';
        else iconEl.textContent = '‚úÖ';
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
    }
}

// –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
function resetForm() {
    try {
        selectedFile = null;
        currentTaskId = null;
        
        getElement('uploadForm').style.display = 'block';
        getElement('progressContainer').style.display = 'none';
        getElement('resultContainer').style.display = 'none';
        
        getElement('animalSelect').value = '';
        getElement('videoFile').value = '';
        getElement('fileInfo').style.display = 'none';
        getElement('uploadBtn').disabled = true;
        getElement('message').style.display = 'none';
        
        if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã:', error);
    }
}

function resetToForm() {
    try {
        getElement('uploadForm').style.display = 'block';
        getElement('progressContainer').style.display = 'none';
        getElement('resultContainer').style.display = 'none';
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ resetToForm:', error);
    }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
function viewResults() {
    window.location.href = '/analysis/results/';
}
</script>
{% endblock %}
