<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ - HorseAI</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial; padding: 20px; }
        .box { border: 2px solid #4CAF50; padding: 20px; margin: 20px 0; border-radius: 10px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        .result { background: #f0f0f0; padding: 15px; margin-top: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üê¥ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h1>
    
    <div class="box">
        <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</h2>
        <button onclick="checkAuth()">üîê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
        <div id="authResult" class="result"></div>
    </div>
    
    <div class="box">
        <h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ:</h2>
        <form id="testForm">
            <input type="file" id="testFile" accept=".mp4,.txt">
            <input type="text" id="animalId" value="1" placeholder="ID –∂–∏–≤–æ—Ç–Ω–æ–≥–æ">
            <button type="button" onclick="testUpload()">üì§ –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</button>
        </form>
        <div id="uploadResult" class="result"></div>
    </div>
    
    <div class="box">
        <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
        <ol>
            <li>–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É: <a href="/login/" target="_blank">/login/</a></li>
            <li>–õ–æ–≥–∏–Ω: <code>demo</code>, –ü–∞—Ä–æ–ª—å: <code>demo123</code></li>
            <li>–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∫–Ω–æ–ø–∫–æ–π –≤—ã—à–µ</li>
            <li>–ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—Å—Ç—å - –ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É</li>
        </ol>
    </div>
    
    <script>
    async function checkAuth() {
        const resultDiv = document.getElementById('authResult');
        resultDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        
        try {
            const response = await fetch('/api/system-stats/');
            const data = await response.json();
            
            if (data.status === 'success') {
                resultDiv.innerHTML = `‚úÖ –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫: ${data.is_admin ? '–ê–¥–º–∏–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`;
                resultDiv.style.background = '#d4edda';
            } else {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}`;
                resultDiv.style.background = '#f8d7da';
            }
        } catch (error) {
            resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`;
            resultDiv.style.background = '#f8d7da';
        }
    }
    
    async function testUpload() {
        const fileInput = document.getElementById('testFile');
        const animalId = document.getElementById('animalId').value;
        const resultDiv = document.getElementById('uploadResult');
        
        if (!fileInput.files.length) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
            return;
        }
        
        resultDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        resultDiv.style.background = '#fff3cd';
        
        try {
            const formData = new FormData();
            formData.append('video_file', fileInput.files[0]);
            formData.append('animal_id', animalId);
            
            // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
            function getCSRFToken() {
                const name = 'csrftoken';
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCSRFToken();
            
            const response = await fetch('/api/upload/simple/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultDiv.innerHTML = `
                    ‚úÖ <strong>–£—Å–ø–µ—Ö!</strong><br>
                    –°–æ–æ–±—â–µ–Ω–∏–µ: ${data.message}<br>
                    ID –≤–∏–¥–µ–æ: ${data.video_id}<br>
                    –ñ–∏–≤–æ—Ç–Ω–æ–µ: ${data.animal_name}<br>
                    –î–∏–∞–≥–Ω–æ–∑: ${data.diagnosis || '–ù–æ—Ä–º–∞'}
                `;
                resultDiv.style.background = '#d4edda';
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.href = '/analysis/results/';
                }, 3000);
                
            } else {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                resultDiv.style.background = '#f8d7da';
                
                if (data.error.includes('–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è') || response.status === 401) {
                    resultDiv.innerHTML += '<br><br>‚ö†Ô∏è <a href="/login/">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É</a>';
                }
            }
            
        } catch (error) {
            resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            resultDiv.style.background = '#f8d7da';
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', () => {
        checkAuth();
    });
    </script>
</body>
</html>
