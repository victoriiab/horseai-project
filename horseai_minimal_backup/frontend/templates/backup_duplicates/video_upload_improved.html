{% extends 'frontend/base.html' %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ - HorseAI{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        margin-bottom: 40px;
        text-align: center;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--accent-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 15px;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        max-width: 700px;
        margin: 0 auto;
        line-height: 1.6;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º—ã */
    .upload-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
    }

    .upload-card::before {
        content: 'üé¨';
        position: absolute;
        font-size: 150px;
        opacity: 0.05;
        top: 50%;
        right: 40px;
        transform: translateY(-50%);
        z-index: 0;
    }

    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */
    .info-panel {
        background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(251, 191, 36, 0.1));
        border: 1px solid rgba(217, 119, 6, 0.3);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        position: relative;
        z-index: 1;
    }

    .info-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-content {
        color: var(--text-primary);
        line-height: 1.6;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    /* –°—Ç–∏–ª–∏ —Ñ–æ—Ä–º—ã */
    .form-group {
        margin-bottom: 25px;
        position: relative;
        z-index: 1;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        font-size: 1.1rem;
    }

    .form-select {
        width: 100%;
        padding: 14px 16px;
        background: var(--bg-hover);
        border: 1px solid var(--border-light);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .form-select:hover {
        border-color: var(--accent);
        background: var(--bg-card);
    }

    .form-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.2);
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π input —Ñ–∞–π–ª–∞ */
    .file-input-container {
        position: relative;
    }

    .file-input-label {
        display: block;
        width: 100%;
        padding: 40px 20px;
        background: var(--bg-hover);
        border: 2px dashed var(--border-light);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-input-label:hover {
        border-color: var(--accent);
        background: var(--bg-card);
        transform: translateY(-2px);
    }

    .file-input-label.drag-over {
        border-color: var(--sage);
        background: rgba(101, 163, 13, 0.1);
    }

    .file-input-icon {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
        color: var(--text-secondary);
    }

    .file-input-text {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1.2rem;
    }

    .file-input-hint {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    .file-input {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }

    .file-selected {
        background: linear-gradient(135deg, rgba(101, 163, 13, 0.1), rgba(217, 119, 6, 0.1));
        border: 2px solid var(--sage);
        padding: 25px;
        border-radius: 12px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .file-selected-icon {
        font-size: 32px;
        color: var(--sage);
    }

    .file-selected-info h4 {
        color: var(--text-primary);
        margin-bottom: 5px;
        font-size: 1.1rem;
    }

    .file-selected-info p {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin: 0;
    }

    /* –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–∏–¥–µ–æ */
    .requirements-box {
        background: linear-gradient(135deg, rgba(30, 64, 175, 0.1), rgba(59, 130, 246, 0.1));
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 25px;
        margin: 30px 0;
    }

    .requirements-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #60a5fa;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .requirements-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .requirement-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        color: var(--text-secondary);
    }

    .requirement-icon {
        font-size: 18px;
        color: #60a5fa;
        flex-shrink: 0;
        margin-top: 2px;
    }

    /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
    .submit-btn {
        width: 100%;
        padding: 18px 30px;
        background: linear-gradient(135deg, var(--accent), var(--earth));
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-top: 20px;
        position: relative;
        z-index: 1;
    }

    .submit-btn:hover {
        background: linear-gradient(135deg, var(--accent-hover), var(--accent));
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg), var(--glow);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(26, 31, 43, 0.95);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .loading-content {
        text-align: center;
        max-width: 500px;
        padding: 40px;
    }

    .loading-spinner {
        border: 4px solid var(--border);
        border-top: 4px solid var(--accent);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 30px;
    }

    .loading-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 15px;
        background: linear-gradient(135deg, var(--accent-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .loading-text {
        color: var(--text-secondary);
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 20px;
    }

    .loading-steps {
        text-align: left;
        margin-top: 25px;
    }

    .loading-step {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        color: var(--text-secondary);
        padding: 12px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
    }

    .loading-step.active {
        color: var(--text-primary);
        background: rgba(217, 119, 6, 0.1);
        border-left: 4px solid var(--accent);
    }

    .step-icon {
        font-size: 20px;
        flex-shrink: 0;
    }

    /* –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏ */
    .result-card {
        display: none;
        background: linear-gradient(135deg, rgba(101, 163, 13, 0.1), rgba(21, 128, 61, 0.1));
        border: 1px solid rgba(101, 163, 13, 0.3);
        border-radius: 16px;
        padding: 35px;
        margin-top: 30px;
        position: relative;
        overflow: hidden;
    }

    .result-card::before {
        content: '‚úÖ';
        position: absolute;
        font-size: 120px;
        opacity: 0.1;
        top: 50%;
        right: 40px;
        transform: translateY(-50%);
    }

    .result-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
    }

    .result-icon {
        font-size: 48px;
        color: var(--sage);
    }

    .result-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--sage);
    }

    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .result-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(101, 163, 13, 0.2);
    }

    .result-label {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .result-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .result-value.lame {
        color: #f87171;
    }

    .result-value.healthy {
        color: var(--sage);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .upload-container {
            padding: 15px;
        }

        .page-title {
            font-size: 2rem;
        }

        .upload-card {
            padding: 25px 20px;
        }

        .requirements-list {
            grid-template-columns: 1fr;
        }

        .result-grid {
            grid-template-columns: 1fr;
        }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .upload-card, .info-panel, .requirements-box {
        animation: fadeIn 0.6s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="page-header">
        <h1 class="page-title">üé¨ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h1>
        <p class="page-subtitle">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏<br>
            –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ö—Ä–æ–º–æ—Ç—ã —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞
        </p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="upload-card">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="info-panel">
            <h3 class="info-title">
                <span>ü§ñ</span>
                –í–ê–ñ–ù–û: –†–µ–∞–ª—å–Ω—ã–π ML –∞–Ω–∞–ª–∏–∑ –≤–∫–ª—é—á–µ–Ω
            </h3>
            <div class="info-content">
                –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—â–µ–Ω–∞ <strong>–≤–∞—à–∞ —Ä–µ–∞–ª—å–Ω–∞—è ML –º–æ–¥–µ–ª—å</strong>
                –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ö—Ä–æ–º–æ—Ç—ã. –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤
                –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è –∏ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <span>‚ö°</span>
                    <div>
                        <strong>–ú–æ–¥–µ–ª—å:</strong><br>
                        final_real_detector_correct.py
                    </div>
                </div>
                <div class="info-item">
                    <span>‚è±Ô∏è</span>
                    <div>
                        <strong>–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:</strong><br>
                        2-5 –º–∏–Ω—É—Ç
                    </div>
                </div>
                <div class="info-item">
                    <span>üéØ</span>
                    <div>
                        <strong>–¢–æ—á–Ω–æ—Å—Ç—å:</strong><br>
                        95.2%
                    </div>
                </div>
                <div class="info-item">
                    <span>üìä</span>
                    <div>
                        <strong>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:</strong><br>
                        DeepLabCut + Custom ML
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <form id="uploadForm" method="POST" action="/api/upload/real-ml/" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- –í—ã–±–æ—Ä –∂–∏–≤–æ—Ç–Ω–æ–≥–æ -->
            <div class="form-group">
                <label class="form-label">
                    <span>üêé</span>
                    –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ
                </label>
                <select name="animal_id" id="animalSelect" class="form-select" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ --</option>
                    {% for animal in animals %}
                    <option value="{{ animal.animal_id }}">
                        {{ animal.name }} {% if animal.sex %}({{ animal.sex }}){% endif %}
                        {% if animal.age %} ‚Ä¢ {{ animal.age }} –ª–µ—Ç{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
            <div class="form-group">
                <label class="form-label">
                    <span>üìπ</span>
                    –í–∏–¥–µ–æ—Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                </label>
                
                <div class="file-input-container">
                    <label for="videoFile" class="file-input-label" id="fileInputLabel">
                        <div class="file-input-icon">üì§</div>
                        <div class="file-input-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Å—é–¥–∞</div>
                        <div class="file-input-hint">
                            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, MKV<br>
                            –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 500MB
                        </div>
                    </label>
                    <input type="file" name="video_file" id="videoFile" class="file-input" 
                           accept=".mp4,.avi,.mov,.mkv,.MP4,.AVI,.MOV,.MKV" required>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ -->
                <div id="fileSelectedInfo" class="file-selected" style="display: none;">
                    <div class="file-selected-icon">üìÅ</div>
                    <div class="file-selected-info">
                        <h4 id="fileName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞</h4>
                        <p id="fileSize">–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞</p>
                    </div>
                </div>
            </div>

            <!-- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–∏–¥–µ–æ -->
            <div class="requirements-box">
                <h3 class="requirements-title">
                    <span>üìã</span>
                    –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–∏–¥–µ–æ –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                </h3>
                <div class="requirements-list">
                    <div class="requirement-item">
                        <div class="requirement-icon">üé•</div>
                        <div>
                            <strong>–ö–∞—á–µ—Å—Ç–≤–æ —Å—ä–µ–º–∫–∏</strong><br>
                            –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –º–µ–Ω–µ–µ 720p
                        </div>
                    </div>
                    <div class="requirement-item">
                        <div class="requirement-icon">üéØ</div>
                        <div>
                            <strong>–†–∞–∫—É—Ä—Å</strong><br>
                            –°—ä–µ–º–∫–∞ —Å–±–æ–∫—É, –ª–æ—à–∞–¥—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –∫–∞–¥—Ä–µ
                        </div>
                    </div>
                    <div class="requirement-item">
                        <div class="requirement-icon">‚è±Ô∏è</div>
                        <div>
                            <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</strong><br>
                            10-60 —Å–µ–∫—É–Ω–¥ –¥–≤–∏–∂–µ–Ω–∏—è
                        </div>
                    </div>
                    <div class="requirement-item">
                        <div class="requirement-icon">‚òÄÔ∏è</div>
                        <div>
                            <strong>–û—Å–≤–µ—â–µ–Ω–∏–µ</strong><br>
                            –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, –±–µ–∑ –±–ª–∏–∫–æ–≤
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <button type="submit" id="submitBtn" class="submit-btn">
                <span>üöÄ</span>
                –ó–∞–ø—É—Å—Ç–∏—Ç—å ML –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ
            </button>
        </form>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
        <div id="resultCard" class="result-card">
            <div class="result-header">
                <div class="result-icon">‚úÖ</div>
                <div>
                    <h2 class="result-title">–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!</h2>
                    <p style="color: var(--text-secondary);">–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç</p>
                </div>
            </div>

            <div class="result-grid" id="resultContent">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>

            <div style="text-align: center; padding-top: 20px; border-top: 1px solid rgba(101, 163, 13, 0.3);">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    <span>‚è≥</span> –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...
                </p>
                <button onclick="window.location.href='/analysis/results/'" 
                        style="background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-light); 
                               padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    üìä –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Å–µ–π—á–∞—Å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h2 class="loading-title">–ò–¥–µ—Ç –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ</h2>
        <p class="loading-text">
            –í–∞—à–µ –≤–∏–¥–µ–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é ML –º–æ–¥–µ–ª–∏.<br>
            –≠—Ç–æ –∑–∞–π–º–µ—Ç 2-5 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –≤–∏–¥–µ–æ.
        </p>
        
        <div class="loading-steps">
            <div class="loading-step active" id="step1">
                <div class="step-icon">üì§</div>
                <div>
                    <strong>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</strong><br>
                    –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                </div>
            </div>
            <div class="loading-step" id="step2">
                <div class="step-icon">ü§ñ</div>
                <div>
                    <strong>–û–±—Ä–∞–±–æ—Ç–∫–∞ DLC</strong><br>
                    DeepLabCut –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏
                </div>
            </div>
            <div class="loading-step" id="step3">
                <div class="step-icon">üìä</div>
                <div>
                    <strong>–ê–Ω–∞–ª–∏–∑ —Ö—Ä–æ–º–æ—Ç—ã</strong><br>
                    ML –º–æ–¥–µ–ª—å –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ö–æ–¥–∫–∏
                </div>
            </div>
            <div class="loading-step" id="step4">
                <div class="step-icon">‚úÖ</div>
                <div>
                    <strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</strong><br>
                    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const videoFileInput = document.getElementById('videoFile');
    const fileInputLabel = document.getElementById('fileInputLabel');
    const fileSelectedInfo = document.getElementById('fileSelectedInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('resultContent');
    const animalSelect = document.getElementById('animalSelect');
    
    let currentStep = 1;

    // Drag & drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileInputLabel.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        fileInputLabel.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        fileInputLabel.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        fileInputLabel.classList.add('drag-over');
    }

    function unhighlight() {
        fileInputLabel.classList.remove('drag-over');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ drop
    fileInputLabel.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        videoFileInput.files = files;
        updateFileInfo();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
    videoFileInput.addEventListener('change', updateFileInfo);

    function updateFileInfo() {
        if (videoFileInput.files.length > 0) {
            const file = videoFileInput.files[0];
            fileName.textContent = file.name;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
            const fileSizeBytes = file.size;
            let fileSizeText;
            if (fileSizeBytes < 1024 * 1024) {
                fileSizeText = (fileSizeBytes / 1024).toFixed(2) + ' KB';
            } else {
                fileSizeText = (fileSizeBytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
            fileSize.textContent = fileSizeText;
            
            fileSelectedInfo.style.display = 'flex';
            fileInputLabel.style.display = 'none';
        } else {
            fileSelectedInfo.style.display = 'none';
            fileInputLabel.style.display = 'block';
        }
    }

    // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function updateLoadingSteps() {
        document.querySelectorAll('.loading-step').forEach((step, index) => {
            if (index + 1 === currentStep) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        
        if (currentStep < 4) {
            currentStep++;
            setTimeout(updateLoadingSteps, 1500);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!animalSelect.value) {
            showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ', 'error');
            return;
        }
        
        if (!videoFileInput.files.length) {
            showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª', 'error');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        const file = videoFileInput.files[0];
        const maxSize = 500 * 1024 * 1024; // 500MB
        if (file.size > maxSize) {
            showNotification('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 500MB', 'error');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        loadingOverlay.style.display = 'flex';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>‚è≥</span> –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...';
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        currentStep = 1;
        updateLoadingSteps();
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = new FormData(this);
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/upload/test-adapter/', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingOverlay.style.display = 'none';
            
            if (data.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                showResults(data);
                showNotification('‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω!', 'success');
                
                // –ê–≤—Ç–æ–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    window.location.href = '/analysis/results/';
                }, 5000);
            } else {
                // –û—à–∏–±–∫–∞
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                resetForm();
            }
            
        } catch (error) {
            // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏
            loadingOverlay.style.display = 'none';
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            resetForm();
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function showResults(data) {
        resultCard.style.display = 'block';
        
        const results = [
            { icon: 'üÜî', label: 'ID –≤–∏–¥–µ–æ', value: data.video_id || '–ù–µ —É–∫–∞–∑–∞–Ω' },
            { icon: 'üê¥', label: '–ñ–∏–≤–æ—Ç–Ω–æ–µ', value: data.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ' },
            { icon: 'üìä', label: '–î–∏–∞–≥–Ω–æ–∑', value: data.diagnosis || '–ù–æ—Ä–º–∞' },
            { 
                icon: 'üìà', 
                label: '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã', 
                value: (data.lameness_probability || 0) + '%',
                className: data.lameness_probability > 50 ? 'lame' : 'healthy'
            },
            { 
                icon: '‚ö†Ô∏è', 
                label: '–•—Ä–æ–º–æ—Ç–∞', 
                value: data.is_lame ? '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ)' : '–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞',
                className: data.is_lame ? 'lame' : 'healthy'
            }
        ];
        
        resultContent.innerHTML = '';
        
        results.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'result-item';
            itemDiv.innerHTML = `
                <div class="result-label">
                    <span>${item.icon}</span>
                    ${item.label}
                </div>
                <div class="result-value ${item.className || ''}">
                    ${item.value}
                </div>
            `;
            resultContent.appendChild(itemDiv);
        });
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
        resultCard.scrollIntoView({ behavior: 'smooth' });
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
    function resetForm() {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>üöÄ</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å ML –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ';
        videoFileInput.value = '';
        fileSelectedInfo.style.display = 'none';
        fileInputLabel.style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#f87171' : '#10b981'};
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        `;
        notification.innerHTML = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}
