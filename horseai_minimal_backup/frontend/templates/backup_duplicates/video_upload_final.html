{% extends 'frontend/base.html' %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ - HorseAI{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <h1 style="color: #333;">üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h1>
    <p style="color: #666;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ª–æ—à–∞–¥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–¥–∫–∏</p>
    
    <div style="background: white; border: 2px solid #4CAF50; border-radius: 10px; padding: 30px; margin: 30px 0;">
        
        <!-- –§–û–†–ú–ê -->
        <form method="POST" action="/api/upload/simple/" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            
            <!-- –ñ–∏–≤–æ—Ç–Ω–æ–µ -->
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                    –ñ–∏–≤–æ—Ç–Ω–æ–µ:
                </label>
                <select name="animal_id" id="animalSelect" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    {% for animal in animals %}
                    <option value="{{ animal.animal_id }}">{{ animal.name }}</option>
                    {% empty %}
                    <option value="1">–¢–µ—Å—Ç–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ 1</option>
                    <option value="2">–¢–µ—Å—Ç–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ 2</option>
                    <option value="3">–¢–µ—Å—Ç–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ 3</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- –§–∞–π–ª -->
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                    –í–∏–¥–µ–æ—Ñ–∞–π–ª:
                </label>
                <input type="file" name="video_file" id="videoFile"
                       style="width: 100%; padding: 10px; border: 2px dashed #4CAF50; border-radius: 5px;"
                       accept=".mp4,.avi,.mov,.mkv,.txt,.jpg,.png" required>
                <p style="color: #666; font-size: 14px; margin-top: 5px;">
                    –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ª—é–±–æ–π —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∞
                </p>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ -->
            <button type="submit" id="submitBtn"
                    style="width: 100%; padding: 15px; background: #4CAF50; color: white; 
                           border: none; border-radius: 5px; font-size: 18px; font-weight: bold; 
                           margin-top: 20px; cursor: pointer;">
                üöÄ –ó–ê–ì–†–£–ó–ò–¢–¨ –í–ò–î–ï–û –ò –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨
            </button>
        </form>
        
        <!-- –°—Ç–∞—Ç—É—Å -->
        <div id="status" style="margin-top: 20px; padding: 15px; display: none;"></div>
    </div>
    
    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div style="background: #e8f5e9; padding: 15px; border-radius: 5px;">
        <p><strong>‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç! –¢–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:</strong></p>
        <ul>
            <li>–í–∏–¥–µ–æ ID: <strong>29</strong></li>
            <li>–ê–Ω–∞–ª–∏–∑ ID: <strong>28</strong></li>
            <li>–ñ–∏–≤–æ—Ç–Ω–æ–µ: <strong>–õ–æ—à–∞–¥—å 2</strong></li>
            <li>–î–∏–∞–≥–Ω–æ–∑: <strong>–ù–æ—Ä–º–∞</strong></li>
            <li>–•—Ä–æ–º–æ—Ç–∞: <strong>–ù–ï–¢ ‚úÖ</strong></li>
        </ul>
        <p style="margin-top: 10px;">
            <a href="/analysis/results/" style="color: #4CAF50; font-weight: bold;">üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤</a>
        </p>
    </div>
</div>

<!-- JavaScript –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º—ã -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('status');
    
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
        const animalSelect = document.getElementById('animalSelect');
        if (!animalSelect.value) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ');
            animalSelect.focus();
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
        const fileInput = document.getElementById('videoFile');
        if (!fileInput.files.length) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
            return;
        }
        
        // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ –ó–ê–ì–†–£–ó–ö–ê...';
        submitBtn.style.background = '#ccc';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<p style="color: #4CAF50;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...</p>';
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/upload/simple/', {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            console.log('–û—Ç–≤–µ—Ç:', data);
            
            if (data.success) {
                // –£–°–ü–ï–•
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 5px; border: 1px solid #c3e6cb;">
                        <h3 style="color: #155724; margin-top: 0;">‚úÖ –£–°–ü–ï–®–ù–û!</h3>
                        <p><strong>–í–∏–¥–µ–æ ID:</strong> ${data.video_id}</p>
                        <p><strong>–ê–Ω–∞–ª–∏–∑ ID:</strong> ${data.analysis_id}</p>
                        <p><strong>–ñ–∏–≤–æ—Ç–Ω–æ–µ:</strong> ${data.animal_name}</p>
                        <p><strong>–î–∏–∞–≥–Ω–æ–∑:</strong> ${data.diagnosis}</p>
                        <p><strong>–•—Ä–æ–º–æ—Ç–∞:</strong> ${data.is_lame ? '–î–ê ‚ö†Ô∏è' : '–ù–ï–¢ ‚úÖ'}</p>
                        <p style="margin-top: 10px; font-weight: bold;">
                            –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...
                        </p>
                    </div>
                `;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                setTimeout(() => {
                    window.location.href = '/analysis/results/';
                }, 3000);
                
            } else {
                // –û–®–ò–ë–ö–ê
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
            
        } catch (error) {
            // –û–®–ò–ë–ö–ê
            statusDiv.innerHTML = `
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
                    <h3 style="color: #721c24; margin-top: 0;">‚ùå –û–®–ò–ë–ö–ê</h3>
                    <p>${error.message}</p>
                </div>
            `;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üöÄ –ó–ê–ì–†–£–ó–ò–¢–¨ –í–ò–î–ï–û –ò –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨';
            submitBtn.style.background = '#4CAF50';
        }
    });
    
    console.log('‚úÖ –§–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
});
</script>
{% endblock %}
