{% extends 'frontend/base.html' %}

{% block title %}–ú–æ–∏ –ª–æ—à–∞–¥–∏ - HorseAI{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
    }

    .page-title {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .page-title::before {
        content: 'üê¥';
        font-size: 36px;
    }

    .btn-add {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--sage), #4d7c0f);
        color: white;
        border: none;
        border-radius: var(--radius);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .btn-add:hover {
        background: linear-gradient(135deg, #84cc16, var(--sage));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .animals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .animal-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 25px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .animal-card:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg), var(--glow);
    }

    .animal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .animal-name {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .animal-badge {
        padding: 4px 12px;
        background: rgba(217, 119, 6, 0.2);
        color: var(--accent);
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .animal-details {
        margin-top: 20px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .detail-label {
        color: var(--text-secondary);
        font-size: 14px;
    }

    .detail-value {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 15px;
    }

    .animal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-action {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg-hover);
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.3s ease;
    }

    .btn-action:hover {
        border-color: var(--accent);
        background: var(--bg-card);
    }

    .btn-danger {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        color: #fca5a5;
    }

    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: #ef4444;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 30px;
        width: 90%;
        max-width: 500px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: var(--glow);
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 30px;
    }

    .modal-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: var(--radius);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .modal-btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--earth));
        color: white;
    }

    .modal-btn-primary:hover {
        background: linear-gradient(135deg, var(--accent-hover), var(--accent));
        transform: translateY(-2px);
    }

    .modal-btn-secondary {
        background: var(--bg-hover);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }

    .modal-btn-secondary:hover {
        background: var(--border);
        border-color: var(--accent);
    }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 2px dashed var(--border);
    }

    .empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 22px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 10px;
    }

    .empty-description {
        color: var(--text-tertiary);
        font-size: 15px;
        max-width: 400px;
        margin: 0 auto 25px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">–ú–æ–∏ –ª–æ—à–∞–¥–∏</h1>
    <button id="addAnimalBtn" class="btn-add">
        <span>‚ûï</span>
        –î–æ–±–∞–≤–∏—Ç—å –ª–æ—à–∞–¥—å
    </button>
</div>

{% if animals %}
    <div class="animals-grid">
        {% for animal in animals %}
        <div class="animal-card" data-animal-id="{{ animal.animal_id }}">
            <div class="animal-header">
                <h3 class="animal-name">{{ animal.name|default:"–ë–µ–∑ –∏–º–µ–Ω–∏" }}</h3>
                {% if animal.sex %}
                <span class="animal-badge">
                    {% if animal.sex == 'M' %}‚ôÇÔ∏è –ñ–µ—Ä–µ–±–µ—Ü
                    {% elif animal.sex == 'F' %}‚ôÄÔ∏è –ö–æ–±—ã–ª–∞
                    {% else %}{{ animal.sex|title }}
                    {% endif %}
                </span>
                {% endif %}
            </div>

            <div class="animal-details">
                {% if animal.age %}
                <div class="detail-row">
                    <span class="detail-label">–í–æ–∑—Ä–∞—Å—Ç:</span>
                    <span class="detail-value">{{ animal.age }} –ª–µ—Ç</span>
                </div>
                {% endif %}

                {% if animal.estimated_weight %}
                <div class="detail-row">
                    <span class="detail-label">–í–µ—Å:</span>
                    <span class="detail-value">{{ animal.estimated_weight }} –∫–≥</span>
                </div>
                {% endif %}

                <div class="detail-row">
                    <span class="detail-label">–î–æ–±–∞–≤–ª–µ–Ω:</span>
                    <span class="detail-value">{{ animal.created_at|date:"d.m.Y" }}</span>
                </div>
            </div>

            <div class="animal-actions">
                <button class="btn-action" onclick="editAnimal({{ animal.animal_id }})">
                    <span>‚úèÔ∏è</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button class="btn-action btn-danger" onclick="deleteAnimal({{ animal.animal_id }})">
                    <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <div class="empty-icon">üê¥</div>
        <h3 class="empty-title">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ª–æ—à–∞–¥–µ–π</h3>
        <p class="empty-description">
            –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ª–æ—à–∞–¥—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–æ–π.
            –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ.
        </p>
        <button id="addAnimalEmptyBtn" class="btn-add">
            <span>‚ûï</span>
            –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –ª–æ—à–∞–¥—å
        </button>
    </div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div id="animalModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <span>üê¥</span>
                <span id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ª–æ—à–∞–¥—å</span>
            </h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>

        <form id="animalForm">
            {% csrf_token %}
            <input type="hidden" id="animalId" name="animal_id">
            
            <div class="form-group">
                <label class="form-label">–ò–º—è –ª–æ—à–∞–¥–∏ *</label>
                <input type="text" id="animalName" name="name" class="form-input" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—É—Ä–∞–Ω" required>
            </div>

            <div class="form-group">
                <label class="form-label">–ü–æ–ª</label>
                <select id="animalSex" name="sex" class="form-select">
                    <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                    <option value="M">‚ôÇÔ∏è –ñ–µ—Ä–µ–±–µ—Ü</option>
                    <option value="F">‚ôÄÔ∏è –ö–æ–±—ã–ª–∞</option>
                    <option value="G">üê¥ –ú–µ—Ä–∏–Ω</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)</label>
                <input type="number" id="animalAge" name="age" class="form-input" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5" min="0" max="40">
            </div>

            <div class="form-group">
                <label class="form-label">–í–µ—Å (–∫–≥)</label>
                <input type="number" id="animalWeight" name="weight" class="form-input" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 450" min="100" max="1000" step="0.1">
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" class="modal-btn modal-btn-primary" id="modalSubmitBtn">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ü—Ä–æ—Å—Ç—ã–µ —Ä–∞–±–æ—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
function openAddModal() {
    console.log('–û—Ç–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
    document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ª–æ—à–∞–¥—å';
    document.getElementById('animalId').value = '';
    document.getElementById('animalName').value = '';
    document.getElementById('animalSex').value = 'M';
    document.getElementById('animalAge').value = '';
    document.getElementById('animalWeight').value = '';
    document.getElementById('animalModal').style.display = 'flex';
}

function editAnimal(id) {
    console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ:', id);
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
    fetch(`/api/animals/${id}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ—à–∞–¥—å';
            document.getElementById('animalId').value = id;
            document.getElementById('animalName').value = data.name || '';
            document.getElementById('animalSex').value = data.sex || 'M';
            document.getElementById('animalAge').value = data.age || '';
            document.getElementById('animalWeight').value = data.estimated_weight || '';
            document.getElementById('animalModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        });
}

function deleteAnimal(id, name) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ª–æ—à–∞–¥—å "' + name + '"?')) return;
    
    fetch(`/api/animals/${id}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    });
}

function closeModal() {
    document.getElementById('animalModal').style.display = 'none';
}

function saveAnimal() {
    const animalId = document.getElementById('animalId').value;
    const name = document.getElementById('animalName').value.trim();
    const sex = document.getElementById('animalSex').value;
    const age = document.getElementById('animalAge').value;
    const weight = document.getElementById('animalWeight').value;
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–æ—à–∞–¥–∏');
        return;
    }
    
    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ:', {name, sex, age, weight, animalId});
    
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrfToken = getCSRFToken();
    
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è API
    const data = {
        name: name,
        sex: sex,
        age: age ? parseInt(age) : null,
        weight: weight ? parseFloat(weight) : null
    };
    
    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
    
    if (animalId) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
        fetch(`/api/animals/${animalId}/update/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (update):', data);
            if (data.success) {
                alert('‚úÖ ' + data.message);
                closeModal();
                location.reload();
            } else {
                alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
        });
    } else {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
        fetch('/api/animals/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (add):', data);
            if (data.success) {
                alert('‚úÖ ' + data.message);
                closeModal();
                location.reload();
            } else {
                alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ú–æ–∏ –ª–æ—à–∞–¥–∏" –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.getElementById('addAnimalBtn').addEventListener('click', openAddModal);
    
    const emptyBtn = document.getElementById('addAnimalEmptyBtn');
    if (emptyBtn) {
        emptyBtn.addEventListener('click', openAddModal);
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
    document.getElementById('animalModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã');
});

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
window.openAddModal = openAddModal;
window.closeModal = closeModal;
window.editAnimal = editAnimal;
window.deleteAnimal = deleteAnimal;
window.saveAnimal = saveAnimal;
</script></script>
{% endblock %}
