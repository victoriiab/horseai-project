{% extends 'frontend/base.html' %}

{% block title %}Super Admin - HorseAI{% endblock %}

{% block extra_css %}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è Super Admin –≤ –≤–∞—à–µ–π —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    
    .super-admin-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }
    
    .super-admin-title {
        font-size: 2.5em;
        background: linear-gradient(135deg, var(--accent-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }
    
    .super-admin-subtitle {
        color: var(--text-secondary);
        font-size: 1.1em;
    }
    
    /* –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .quick-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 25px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg), var(--glow);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--earth));
    }
    
    .stat-icon {
        font-size: 2em;
        margin-bottom: 15px;
        opacity: 0.9;
    }
    
    .stat-number {
        font-size: 2.8em;
        font-weight: 700;
        margin: 10px 0;
        color: var(--accent-light);
    }
    
    .stat-label {
        color: var(--text-secondary);
        font-size: 0.95em;
        margin-bottom: 5px;
    }
    
    .stat-detail {
        color: var(--text-tertiary);
        font-size: 0.85em;
    }
    
    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º */
    .tabs-container {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: 30px;
        overflow: hidden;
    }
    
    .tabs-nav {
        display: flex;
        background: var(--bg-darker);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
    }
    
    .tab-btn {
        padding: 15px 25px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        border-bottom: 3px solid transparent;
    }
    
    .tab-btn:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }
    
    .tab-btn.active {
        color: var(--accent-light);
        border-bottom-color: var(--accent);
        background: var(--bg-hover);
    }
    
    .tab-content {
        padding: 25px;
        display: none;
    }
    
    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* –¢–∞–±–ª–∏—Ü—ã */
    .admin-table-container {
        overflow-x: auto;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--bg-card);
    }
    
    .admin-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .admin-table th {
        background: var(--bg-darker);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border);
        white-space: nowrap;
    }
    
    .admin-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border);
        color: var(--text-secondary);
    }
    
    .admin-table tr:hover {
        background: var(--bg-hover);
    }
    
    .admin-table tr:last-child td {
        border-bottom: none;
    }
    
    /* –ë–µ–π–¥–∂–∏ */
    .role-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-block;
    }
    
    .role-admin { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .role-superadmin { background: rgba(217, 119, 6, 0.2); color: #fcd34d; }
    .role-veterinarian { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .role-owner { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    .role-user { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }
    
    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: var(--radius);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .action-btn-edit {
        background: rgba(59, 130, 246, 0.2);
        color: #93c5fd;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .action-btn-edit:hover {
        background: rgba(59, 130, 246, 0.3);
        color: #60a5fa;
        transform: translateY(-2px);
    }
    
    .action-btn-delete {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .action-btn-delete:hover {
        background: rgba(239, 68, 68, 0.3);
        color: #f87171;
        transform: translateY(-2px);
    }
    
    .action-btn-view {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .action-btn-view:hover {
        background: rgba(34, 197, 94, 0.3);
        color: #4ade80;
        transform: translateY(-2px);
    }
    
    .action-btn-block {
        background: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .action-btn-block:hover {
        background: rgba(245, 158, 11, 0.3);
        color: #fbbf24;
        transform: translateY(-2px);
    }
    
    /* –§–∏–ª—å—Ç—Ä—ã */
    .filters-bar {
        background: var(--bg-darker);
        padding: 20px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        border: 1px solid var(--border);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .filter-input {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 10px 15px;
        border-radius: var(--radius);
        font-size: 14px;
        min-width: 200px;
    }
    
    .filter-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
    }
    
    /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }
    
    .page-btn {
        padding: 8px 15px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .page-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }
    
    .page-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .modal-content {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
        font-size: 1.5em;
        color: var(--accent-light);
    }
    
    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5em;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    
    .modal-close:hover {
        color: var(--text-primary);
    }
    
    /* –°—Ç–∞—Ç—É—Å—ã –∞–Ω–∞–ª–∏–∑–∞ */
    .analysis-status {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-completed { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .status-processing { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
    .status-failed { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .status-pending { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }
    
    /* –•—Ä–æ–º–æ—Ç–∞ */
    .lameness-indicator {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
    }
    
    .lameness-yes { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .lameness-no { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    
    /* –ì—Ä–∞—Ñ–∏–∫–∏ */
    .chart-container {
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .quick-stats-grid {
            grid-template-columns: 1fr;
        }
        
        .tabs-nav {
            flex-wrap: wrap;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-input {
            min-width: 100%;
        }
        
        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="super-admin-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="super-admin-header">
        <h1 class="super-admin-title">‚ö° Super Admin Panel</h1>
        <p class="super-admin-subtitle">–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∏—Å—Ç–µ–º–æ–π HorseAI</p>
    </div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="users">
                <span>üë•</span>
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            </button>
            <button class="tab-btn" data-tab="animals">
                <span>üêé</span>
                <span>–ñ–∏–≤–æ—Ç–Ω—ã–µ</span>
            </button>
            <button class="tab-btn" data-tab="analyses">
                <span>üìä</span>
                <span>–ê–Ω–∞–ª–∏–∑—ã</span>
            </button>
            <button class="tab-btn" data-tab="system">
                <span>‚öôÔ∏è</span>
                <span>–°–∏—Å—Ç–µ–º–∞</span>
            </button>
        </div>
        
        <!-- –¢–∞–±: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div id="tab-users" class="tab-content active">
            <div class="filters-bar">
                <input type="text" class="filter-input" id="search-users" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
                <select class="filter-input" id="filter-role">
                    <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                    <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                </select>
                <button class="action-btn action-btn-view" onclick="loadUsers()">
                    <span>üîÑ</span>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                </button>
                <button class="action-btn action-btn-edit" onclick="showAddUserModal()">
                    <span>‚ûï</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                </button>
            </div>
            
            <div class="admin-table-container">
                <table class="admin-table" id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–õ–æ–≥–∏–Ω</th>
                            <th>Email</th>
                            <th>–†–æ–ª—å</th>
                            <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr><td colspan="7" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="users-pagination"></div>
        </div>
        
        <!-- –¢–∞–±: –ñ–∏–≤–æ—Ç–Ω—ã–µ -->
        <div id="tab-animals" class="tab-content">
            <div class="filters-bar">
                <input type="text" class="filter-input" id="search-animals" placeholder="–ü–æ–∏—Å–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö...">
                <button class="action-btn action-btn-view" onclick="loadAllAnimals()">
                    <span>üîÑ</span>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                </button>
                <button class="action-btn action-btn-edit" onclick="exportAnimalsCSV()">
                    <span>üì•</span>
                    <span>–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
                </button>
            </div>
            
            <div class="admin-table-container">
                <table class="admin-table" id="animals-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th>–ü–æ–ª</th>
                            <th>–í–æ–∑—Ä–∞—Å—Ç</th>
                            <th>–í–µ—Å</th>
                            <th>–ê–Ω–∞–ª–∏–∑–æ–≤</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="animals-table-body">
                        <tr><td colspan="8" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="animals-pagination"></div>
        </div>
        
        <!-- –¢–∞–±: –ê–Ω–∞–ª–∏–∑—ã -->
        <div id="tab-analyses" class="tab-content">
            <div class="filters-bar">
                <input type="text" class="filter-input" id="search-analyses" placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–∏–∞–≥–Ω–æ–∑—É...">
                <select class="filter-input" id="filter-status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                    <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                    <option value="failed">–û—à–∏–±–∫–∞</option>
                </select>
                <select class="filter-input" id="filter-lameness">
                    <option value="">–•—Ä–æ–º–æ—Ç–∞</option>
                    <option value="true">–° —Ö—Ä–æ–º–æ—Ç–æ–π</option>
                    <option value="false">–ë–µ–∑ —Ö—Ä–æ–º–æ—Ç—ã</option>
                </select>
                <button class="action-btn action-btn-view" onclick="loadAnalyses(1)">
                    <span>üîç</span>
                    <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
                </button>
                <button class="action-btn action-btn-edit" onclick="resetFilters()">
                    <span>üîÑ</span>
                    <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
                </button>
            </div>
            
            <div class="admin-table-container">
                <table class="admin-table" id="analyses-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ñ–∏–≤–æ—Ç–Ω–æ–µ</th>
                            <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th>–î–∏–∞–≥–Ω–æ–∑</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–•—Ä–æ–º–æ—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="analyses-table-body">
                        <tr><td colspan="8" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="analyses-pagination"></div>
        </div>
        
        <!-- –¢–∞–±: –°–∏—Å—Ç–µ–º–∞ -->
        <div id="tab-system" class="tab-content">
            <div class="chart-container">
                <h3 style="margin-top: 0; margin-bottom: 20px;">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">–ó–∞–≥—Ä—É–∑–∫–∞ CPU</div>
                        <div class="stat-number" id="cpu-load">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM</div>
                        <div class="stat-number" id="ram-usage">0 MB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ</div>
                        <div class="stat-number" id="disk-free">0 GB</div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="chart-container">
                    <h3 style="margin-top: 0; margin-bottom: 20px;">üß† ML –º–æ–¥–µ–ª—å</h3>
                    <p><strong>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:</strong> DeepLabCut + SuperAnimal</p>
                    <p><strong>–¢–æ—á–Ω–æ—Å—Ç—å:</strong> <span class="status-completed">92.5%</span></p>
                    <p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> 2025-12-01</p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="action-btn action-btn-block" onclick="testMLModel()">
                            <span>üß™</span>
                            <span>–¢–µ—Å—Ç –º–æ–¥–µ–ª–∏</span>
                        </button>
                        <button class="action-btn action-btn-view" onclick="viewMLLogs()">
                            <span>üìã</span>
                            <span>–õ–æ–≥–∏</span>
                        </button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 style="margin-top: 0; margin-bottom: 20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">
                            –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ (MB):
                        </label>
                        <input type="number" class="filter-input" id="max-video-size" value="500" style="width: 120px;">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="action-btn action-btn-edit" onclick="saveSettings()">
                            <span>üíæ</span>
                            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                        </button>
                        <button class="action-btn action-btn-view" onclick="backupDatabase()">
                            <span>üíæ</span>
                            <span>–ë—ç–∫–∞–ø –ë–î</span>
                        </button>
                        <button class="action-btn action-btn-delete" onclick="clearCache()">
                            <span>üóëÔ∏è</span>
                            <span>–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div class="modal-overlay" id="userModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
        </div>
        <div id="modal-content">
            <form id="addUserForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">–õ–æ–≥–∏–Ω:</label>
                    <input type="text" name="username" required class="filter-input" style="width: 100%;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" name="password" required class="filter-input" style="width: 100%;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">Email:</label>
                    <input type="email" name="email" required class="filter-input" style="width: 100%;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">–†–æ–ª—å:</label>
                    <select name="role" class="filter-input" style="width: 100%;">
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <button type="submit" class="action-btn action-btn-edit" style="width: 100%;">
                    <span>‚ûï</span>
                    <span>–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                </button>
            </form>
        </div>
    </div>
</div>

<div class="modal-overlay" id="analysisModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞</h3>
            <button class="modal-close" onclick="closeModal('analysisModal')">&times;</button>
        </div>
        <div id="analysis-modal-content">
            <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentTab = 'users';
let currentAnalysesPage = 1;
const analysesPerPage = 10;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    loadSuperAdminStats();
    loadUsers();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            switchTab(tabName);
        });
    });
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º
    document.getElementById('search-users').addEventListener('input', function() {
        clearTimeout(window.searchUsersTimeout);
        window.searchUsersTimeout = setTimeout(function() {
            loadUsers(1);
        }, 500);
    });
    document.getElementById('search-animals').addEventListener('input', function(event) {
    // event - —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è, –Ω–∞–º –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        debounce(loadAllAnimals, 500)();
    });
    document.getElementById('search-analyses').addEventListener('input', function() {
    clearTimeout(window.searchAnalysesTimeout);
    window.searchAnalysesTimeout = setTimeout(function() {
        loadAnalyses(1);
    }, 500);
});
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    setInterval(loadSuperAdminStats, 30000);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addUser();
    });
});

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
function switchTab(tabName) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
    
    currentTab = tabName;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞
    switch(tabName) {
        case 'users':
            loadUsers();
            break;
        case 'animals':
            loadAllAnimals();
            break;
        case 'analyses':
            loadAnalyses(1);
            break;
        case 'system':
            loadSystemStats();
            break;
    }
}

// –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø–æ–∏—Å–∫–∞
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}


// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è Super Admin
function loadSuperAdminStats() {
    fetch('/api/super-admin/stats/')
        .then(response => {
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Super Admin —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', data);

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
                document.getElementById('stat-total-users').textContent = data.total_users || 0;
                document.getElementById('stat-active-users').textContent = data.active_users || 0;
                document.getElementById('stat-total-animals').textContent = data.total_animals || 0;
                document.getElementById('stat-total-analyses').textContent = data.total_analyses || 0;
                document.getElementById('stat-total-videos').textContent = data.total_videos || 0;
                document.getElementById('stat-processed-videos').textContent = data.processed_videos || 0;

                // –ü—Ä–æ—Ü–µ–Ω—Ç —Ö—Ä–æ–º–æ—Ç—ã - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
                let lamePercentage = 0;
                if (data.total_analyses > 0) {
                    lamePercentage = Math.round((data.lame_count / data.total_analyses) * 100);
                }
                document.getElementById('stat-lame-percentage').textContent = lamePercentage + '%';
                document.getElementById('stat-lame-count').textContent = data.lame_count || 0;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º timestamp
                if (data.timestamp) {
                    console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', new Date(data.timestamp).toLocaleString());
                }
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        });
}


// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function loadUsers(page = 1) {
    const search = document.getElementById('search-users').value;
    const role = document.getElementById('filter-role').value;
    
    let url = `/api/super-admin/users/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (role) url += `&role=${role}`;
    
    showLoading('users-table-body');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderUsersTable(data.users);
                renderPagination('users-pagination', data.total_pages, page, loadUsers);
            } else {
                showError('users-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        })
        .catch(error => {
            showError('users-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderUsersTable(users) {
    const tbody = document.getElementById('users-table-body');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }
    
    let html = '';
    
    users.forEach(user => {
        html += `
            <tr>
                <td>${user.user_id}</td>
                <td><strong>${user.login}</strong></td>
                <td>${user.email}</td>
                <td><span class="role-badge role-${user.role_id}">${user.role_id}</span></td>
                <td>${user.is_active ? '‚úÖ' : '‚ùå'}</td>
                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : '–ù–∏–∫–æ–≥–¥–∞'}</td>
                <td>
                    <div class="action-buttons">
                        <button onclick="editUser(${user.user_id})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="toggleUserStatus(${user.user_id}, ${user.is_active})" class="action-btn ${user.is_active ? 'action-btn-block' : 'action-btn-view'}">
                            <span>${user.is_active ? 'üö´' : '‚úÖ'}</span>
                            <span>${user.is_active ? '–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}</span>
                        </button>
                        <button onclick="deleteUser(${user.user_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö
function loadAllAnimals(page = 1) {
    const search = document.getElementById('search-animals').value;
    
    let url = `/api/super-admin/animals/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    
    showLoading('animals-table-body');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderAllAnimalsTable(data.animals);
                renderPagination('animals-pagination', data.total_pages, page, loadAllAnimals);
            } else {
                showError('animals-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö');
            }
        })
        .catch(error => {
            showError('animals-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderAllAnimalsTable(animals) {
    const tbody = document.getElementById('animals-table-body');
    
    if (animals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }
    
    let html = '';
    
    animals.forEach(animal => {
        html += `
            <tr>
                <td>${animal.animal_id}</td>
                <td><strong>${animal.name}</strong></td>
                <td>${animal.owner_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${animal.sex || '-'}</td>
                <td>${animal.age || '-'}</td>
                <td>${animal.estimated_weight ? animal.estimated_weight + ' –∫–≥' : '-'}</td>
                <td><span class="analysis-status status-completed">${animal.analyses_count || 0}</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewAnimalAnalyses(${animal.animal_id})" class="action-btn action-btn-view">
                            <span>üëÅÔ∏è</span>
                            <span>–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </button>
                        <button onclick="editAnimal(${animal.animal_id})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤
function loadAnalyses(page = 1) {
    const search = document.getElementById('search-analyses').value;
    const status = document.getElementById('filter-status').value;
    const lameness = document.getElementById('filter-lameness').value;
    
    let url = `/api/super-admin/analyses/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (status) url += `&status=${status}`;
    if (lameness) url += `&lameness=${lameness}`;
    
    showLoading('analyses-table-body');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderAnalysesTable(data.analyses);
                renderPagination('analyses-pagination', data.total_pages, page, loadAnalyses);
                currentAnalysesPage = page;
            } else {
                showError('analyses-table-body', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–æ–≤');
            }
        })
        .catch(error => {
            showError('analyses-table-body', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderAnalysesTable(analyses) {
    const tbody = document.getElementById('analyses-table-body');
    
    if (analyses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }
    
    let html = '';
    
    analyses.forEach(analysis => {
        html += `
            <tr>
                <td>${analysis.analysis_id}</td>
                <td>${analysis.analysis_date ? new Date(analysis.analysis_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                <td>${analysis.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                <td>${analysis.owner_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>
                    <strong>${analysis.diagnosis || '–ù–µ—Ç –¥–∏–∞–≥–Ω–æ–∑–∞'}</strong>
                    ${analysis.diagnosis_note ? `<br><small style="color: var(--text-tertiary);">${analysis.diagnosis_note}</small>` : ''}
                </td>
                <td><span class="analysis-status status-completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span></td>
                <td>
                    <span class="lameness-indicator ${analysis.is_lame ? 'lameness-yes' : 'lameness-no'}">
                        ${analysis.is_lame ? '–•—Ä–æ–º–æ—Ç–∞' : '–ù–æ—Ä–º–∞'}
                        ${analysis.lameness_probability ? ` (${analysis.lameness_probability}%)` : ''}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button onclick="viewAnalysisDetails(${analysis.analysis_id})" class="action-btn action-btn-view">
                            <span>üëÅÔ∏è</span>
                            <span>–î–µ—Ç–∞–ª–∏</span>
                        </button>
                        <button onclick="editAnalysis(${analysis.analysis_id})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="deleteAnalysis(${analysis.analysis_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// –ü–∞–≥–∏–Ω–∞—Ü–∏—è
function renderPagination(containerId, totalPages, currentPage, callback) {
    const container = document.getElementById(containerId);
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    if (currentPage > 1) {
        html += `<button class="page-btn" onclick="${callback.name}(${currentPage - 1})">&laquo;</button>`;
    }
    
    // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            html += `<button class="page-btn active">${i}</button>`;
        } else {
            html += `<button class="page-btn" onclick="${callback.name}(${i})">${i}</button>`;
        }
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
    if (currentPage < totalPages) {
        html += `<button class="page-btn" onclick="${callback.name}(${currentPage + 1})">&raquo;</button>`;
    }
    
    container.innerHTML = html;
}

// –£—Ç–∏–ª–∏—Ç—ã
function showLoading(elementId) {
    const element = document.getElementById(elementId);
    element.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;"><div style="display: flex; justify-content: center; align-items: center; gap: 10px;"><span>üåÄ</span><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span></div></td></tr>';
}

function showError(elementId, message) {
    const element = document.getElementById(elementId);
    element.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px; color: #fca5a5;">${message}</td></tr>`;
}

// –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
function showAddUserModal() {
    document.getElementById('userModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// –î–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
function addUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    
    fetch('/api/super-admin/users/add/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!');
            closeModal('userModal');
            loadUsers();
            loadSuperAdminStats();
            form.reset();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'block' : 'activate';
    const message = isActive ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?';
    
    if (!confirm(message)) return;
    
    fetch(`/api/super-admin/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${isActive ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}!`);
            loadUsers();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    });
}

function deleteUser(userId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID ${userId}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;
    
    fetch(`/api/super-admin/users/${userId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!');
            loadUsers();
            loadSuperAdminStats();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    });
}

// –î–µ–π—Å—Ç–≤–∏—è —Å –∞–Ω–∞–ª–∏–∑–∞–º–∏
function viewAnalysisDetails(analysisId) {
    fetch(`/api/super-admin/analyses/${analysisId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const analysis = data.analysis;
                const modalContent = document.getElementById('analysis-modal-content');
                
                modalContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--accent-light); margin-bottom: 10px;">–ê–Ω–∞–ª–∏–∑ #${analysis.analysis_id}</h4>
                        <p><strong>–ñ–∏–≤–æ—Ç–Ω–æ–µ:</strong> ${analysis.animal_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${analysis.owner_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–î–∞—Ç–∞:</strong> ${analysis.analysis_date ? new Date(analysis.analysis_date).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–î–∏–∞–≥–Ω–æ–∑:</strong> ${analysis.diagnosis || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> ${analysis.diagnosis_note || '–ù–µ—Ç'}</p>
                        <p><strong>–•—Ä–æ–º–æ—Ç–∞:</strong> <span class="${analysis.is_lame ? 'lameness-yes' : 'lameness-no'}">${analysis.is_lame ? '–î–ê' : '–ù–ï–¢'}</span></p>
                        <p><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:</strong> ${analysis.lameness_probability || '0'}%</p>
                        <p><strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${analysis.confidence_score ? Math.round(analysis.confidence_score * 100) + '%' : '-'}</p>
                    </div>
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button onclick="exportAnalysisPDF(${analysis.analysis_id})" class="action-btn action-btn-view">
                            <span>üì•</span>
                            <span>–≠–∫—Å–ø–æ—Ä—Ç PDF</span>
                        </button>
                        <button onclick="editAnalysis(${analysis.analysis_id})" class="action-btn action-btn-edit">
                            <span>‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="deleteAnalysis(${analysis.analysis_id})" class="action-btn action-btn-delete">
                            <span>üóëÔ∏è</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                `;
                
                document.getElementById('analysisModal').classList.add('active');
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function deleteAnalysis(analysisId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–Ω–∞–ª–∏–∑ ID ${analysisId}?`)) return;
    
    fetch(`/api/super-admin/analyses/${analysisId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ê–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω!');
            closeModal('analysisModal');
            loadAnalyses(currentAnalysesPage);
            loadSuperAdminStats();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    });
}

function resetFilters() {
    document.getElementById('search-analyses').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-lameness').value = '';
    loadAnalyses(1);
}

// –£—Ç–∏–ª–∏—Ç—ã
function getCSRFToken() {
    const csrfCookie = document.cookie.match(/csrftoken=([^;]+)/);
    return csrfCookie ? csrfCookie[1] : '';
}

// –§–£–ù–ö–¶–ò–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
function editUser(userId) {
    console.log(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: ${userId}`);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    fetch(`/api/super-admin/users/${userId}/edit/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const modalContent = `
                    <h3 style="margin-top: 0; margin-bottom: 20px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                    <form id="editUserForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–õ–æ–≥–∏–Ω:</label>
                            <input type="text" value="${user.login}" class="filter-input" style="width: 100%;" disabled>
                            <small style="color: var(--text-tertiary);">–õ–æ–≥–∏–Ω –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</small>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Email:</label>
                            <input type="email" name="email" value="${user.email}" class="filter-input" style="width: 100%;" required>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
                            <input type="text" name="full_name" value="${user.full_name || ''}" class="filter-input" style="width: 100%;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">–†–æ–ª—å:</label>
                            <select name="role" class="filter-input" style="width: 100%;">
                                <option value="user" ${user.role_id === 'user' ? 'selected' : ''}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                <option value="admin" ${user.role_id === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                                <option value="superadmin" ${user.role_id === 'superadmin' ? 'selected' : ''}>–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" name="is_active" ${user.is_active ? 'checked' : ''}>
                                <span style="color: var(--text-secondary);">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            </label>
                        </div>
                        
                        <input type="hidden" name="user_id" value="${userId}">
                        
                        <button type="submit" class="action-btn action-btn-edit" style="width: 100%;">
                            <span>üíæ</span>
                            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                        </button>
                    </form>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                showEditModal(modalContent, userId);
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
        });
}

// –ü–û–ö–ê–ó–ê–¢–¨ –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
function showEditModal(content, userId) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'editUserModal';
    
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div>${content}</div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
    document.getElementById('editUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveUserChanges(userId);
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeEditModal();
        }
    });
}

// –°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
function saveUserChanges(userId) {
    const form = document.getElementById('editUserForm');
    const formData = new FormData(form);
    
    fetch(`/api/super-admin/users/${userId}/edit/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            closeEditModal();
            loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            loadSuperAdminStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
        }
    })
    .catch(error => {
        alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
    });
}

// –ó–ê–ö–†–´–¢–¨ –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û
function closeEditModal() {
    const modal = document.getElementById('editUserModal');
    if (modal) {
        modal.remove();
    }
}
function editAnimal(animalId) {
    alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ ID: ' + animalId + '\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function editAnalysis(analysisId) {
    alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ ID: ' + analysisId + '\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function viewAnimalAnalyses(animalId) {
    alert('–ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∞–ª–∏–∑–æ–≤ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ ID: ' + animalId + '\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function exportAnimalsCSV() {
    alert('–≠–∫—Å–ø–æ—Ä—Ç –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ CSV\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function exportAnalysisPDF(analysisId) {
    alert('–≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏–∑–∞ ID ' + analysisId + ' –≤ PDF\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function loadSystemStats() {
    document.getElementById('cpu-load').textContent = '25%';
    document.getElementById('ram-usage').textContent = '2.4 GB';
    document.getElementById('disk-free').textContent = '45.2 GB';
}

function testMLModel() {
    alert('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ML –º–æ–¥–µ–ª–∏\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function viewMLLogs() {
    alert('–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ ML –º–æ–¥–µ–ª–∏\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function saveSettings() {
    const maxSize = document.getElementById('max-video-size').value;
    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ: ' + maxSize + 'MB');
}

function backupDatabase() {
    alert('–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function clearCache() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —Å–∏—Å—Ç–µ–º—ã?')) {
        alert('–ö—ç—à –æ—á–∏—â–µ–Ω');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
window.onclick = function(event) {
    const userModal = document.getElementById('userModal');
    const analysisModal = document.getElementById('analysisModal');
    
    if (event.target === userModal) {
        closeModal('userModal');
    }
    if (event.target === analysisModal) {
        closeModal('analysisModal');
    }
};
</script>
{% endblock %}
