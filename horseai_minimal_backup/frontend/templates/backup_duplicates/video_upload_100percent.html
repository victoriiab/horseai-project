# Создаем чистую версию views.py с исправленными отступами
cat > /home/ais/shared/horseAI/frontend/views_fixed.py << 'EOF'
"""
РАБОЧИЕ VIEWS - ФИНАЛЬНАЯ ИСПРАВЛЕННАЯ ВЕРСИЯ
"""
import os
import json
from datetime import datetime
from django.shortcuts import render, redirect
from django.contrib.auth import login, logout, authenticate
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.conf import settings
from web.database.models import Animal, Video, Analysis, User

# ========== ОСНОВНЫЕ СТРАНИЦЫ ==========
def index(request):
    """Главная страница"""
    if not request.user.is_authenticated:
        return render(request, 'frontend/index.html')

    try:
        custom_user = User.objects.get(login=request.user.username)
        is_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
    except User.DoesNotExist:
        is_admin = request.user.is_staff

    context = {}
    if is_admin:
        context.update({
            'animals_count': Animal.objects.count(),
            'videos_count': Video.objects.count(),
            'analyses_count': Analysis.objects.count(),
            'user_role': 'admin'
        })
    else:
        try:
            custom_user = User.objects.get(login=request.user.username)
            context.update({
                'animals_count': Animal.objects.filter(user=custom_user).count(),
                'videos_count': Video.objects.filter(user=custom_user).count(),
                'analyses_count': Analysis.objects.filter(video__user=custom_user).count(),
                'user_role': 'user'
            })
        except:
            context.update({
                'animals_count': 0,
                'videos_count': 0,
                'analyses_count': 0,
                'user_role': 'user'
            })

    return render(request, 'frontend/index.html', context)

def custom_login(request):
    """Вход в систему"""
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(request, username=username, password=password)
        
        if user is not None:
            login(request, user)
            messages.success(request, f'Добро пожаловать, {username}!')
            return redirect('index')
        else:
            messages.error(request, 'Неверное имя пользователя или пароль')

    return render(request, 'frontend/login.html')

def custom_logout(request):
    """Выход из системы"""
    logout(request)
    messages.success(request, 'Вы успешно вышли из системы')
    return redirect('index')

@login_required
def animals_list(request):
    """Список животных"""
    try:
        custom_user = User.objects.get(login=request.user.username)
        animals = Animal.objects.filter(user=custom_user).order_by('-created_at')
    except:
        animals = []
    return render(request, 'frontend/animals.html', {'animals': animals})

@login_required
def video_upload(request):
    """Загрузка видео"""
    try:
        custom_user = User.objects.get(login=request.user.username)
        animals = Animal.objects.filter(user=custom_user)
    except:
        animals = []
    return render(request, 'frontend/video_upload.html', {'animals': animals})

@login_required
def analysis_results(request):
    """Результаты анализов"""
    try:
        custom_user = User.objects.get(login=request.user.username)
        if request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']:
            analyses = Analysis.objects.all().select_related('video', 'video__animal').order_by('-analysis_date')
            animals = Animal.objects.all()[:20]
        else:
            user_animals = Animal.objects.filter(user=custom_user)
            user_videos = Video.objects.filter(animal__in=user_animals)
            analyses = Analysis.objects.filter(video__in=user_videos).select_related('video', 'video__animal').order_by('-analysis_date')
            animals = user_animals
    except:
        analyses = []
        animals = []

    context = {
        'analyses': analyses,
        'animals': animals,
        'total_count': len(analyses),
        'lame_count': len([a for a in analyses if a.is_lame]),
        'healthy_count': len([a for a in analyses if not a.is_lame])
    }
    return render(request, 'frontend/analysis.html', context)

@login_required
def ration_calculation(request):
    """Расчет рациона"""
    try:
        custom_user = User.objects.get(login=request.user.username)
        animals = Animal.objects.filter(user=custom_user)
    except:
        animals = []
    return render(request, 'frontend/ration.html', {'animals': animals})

@login_required
def admin_dashboard(request):
    """Админ панель"""
    if not (request.user.is_staff):
        messages.error(request, 'Доступ запрещен')
        return redirect('index')

    stats = {
        'total_users': User.objects.count(),
        'total_animals': Animal.objects.count(),
        'total_videos': Video.objects.count(),
        'total_analyses': Analysis.objects.count(),
        'lame_count': Analysis.objects.filter(is_lame=True).count(),
    }
    return render(request, 'frontend/admin_dashboard.html', {'stats': stats})

@login_required
def profile(request):
    """Профиль пользователя"""
    try:
        custom_user = User.objects.get(login=request.user.username)
        context = {
            'animals_count': Animal.objects.filter(user=custom_user).count(),
            'videos_count': Video.objects.filter(user=custom_user).count(),
            'analyses_count': Analysis.objects.filter(video__user=custom_user).count(),
        }
        if custom_user.role_id in ['admin', 'superadmin']:
            context['user_role'] = 'admin'
        elif custom_user.role_id == 'veterinarian':
            context['user_role'] = 'veterinarian'
        else:
            context['user_role'] = 'user'
    except:
        context = {
            'animals_count': 0,
            'videos_count': 0,
            'analyses_count': 0,
            'user_role': 'user'
        }
    return render(request, 'frontend/profile.html', context)

# ========== API ENDPOINTS ==========
@login_required
@csrf_exempt
def get_system_stats(request):
    """Статистика системы"""
    try:
        custom_user = User.objects.get(login=request.user.username)
        is_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']

        if is_admin:
            stats = {
                'status': 'success',
                'users_count': User.objects.count(),
                'animals_count': Animal.objects.count(),
                'videos_count': Video.objects.count(),
                'analyses_count': Analysis.objects.count(),
                'lame_count': Analysis.objects.filter(is_lame=True).count(),
                'is_admin': True
            }
        else:
            stats = {
                'status': 'success',
                'animals_count': Animal.objects.filter(user=custom_user).count(),
                'videos_count': Video.objects.filter(user=custom_user).count(),
                'analyses_count': Analysis.objects.filter(video__user=custom_user).count(),
                'is_admin': False
            }
        return JsonResponse(stats)

    except Exception as e:
        return JsonResponse({'status': 'error', 'error': str(e)}, status=500)

@csrf_exempt
def upload_video_simple_api_real(request):
    """РЕАЛЬНЫЙ API для загрузки видео - ИСПРАВЛЕННАЯ ВЕРСИЯ"""
    if request.method != 'POST':
        return JsonResponse({'success': False, 'error': 'Только POST метод'}, status=405)
    
    try:
        print("="*50)
        print("REAL API: Начало загрузки видео")
        print(f"Пользователь: {request.user}")
        print(f"Аутентифицирован: {request.user.is_authenticated}")
        
        # Проверяем аутентификацию
        if not request.user.is_authenticated:
            print("⚠️ Пользователь не аутентифицирован")
            return JsonResponse({
                'success': False, 
                'error': 'Требуется аутентификация. Пожалуйста, войдите в систему.',
                'login_url': '/login/'
            }, status=401)
        
        # Получаем данные
        video_file = request.FILES.get('video_file')
        animal_id = request.POST.get('animal_id', '')
        
        if not video_file:
            print("❌ Ошибка: Файл не выбран")
            return JsonResponse({'success': False, 'error': 'Файл не выбран'})
        
        if not animal_id:
            print("❌ Ошибка: Не указан ID животного")
            return JsonResponse({'success': False, 'error': 'Выберите животное'})
        
        print(f"✅ Файл получен: {video_file.name}, размер: {video_file.size} байт")
        print(f"✅ ID животного из формы: {animal_id}")
        
        # 1. СОХРАНЕНИЕ ФАЙЛА
        import uuid
        import os
        from django.conf import settings
        
        # Создаем безопасное имя файла
        safe_name = str(uuid.uuid4())[:8] + '_' + video_file.name.replace(' ', '_')
        filename = f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{safe_name}"
        
        # Папка для сохранения
        media_dir = os.path.join(settings.MEDIA_ROOT, 'videos')
        os.makedirs(media_dir, exist_ok=True)
        
        filepath = os.path.join(media_dir, filename)
        
        # Сохраняем файл
        with open(filepath, 'wb+') as destination:
            for chunk in video_file.chunks():
                destination.write(chunk)
        
        print(f"✅ Файл сохранен: {filepath}")
        
        # 2. ПОИСК ИЛИ СОЗДАНИЕ ЖИВОТНОГО
        from web.database.models import User as CustomUser, Animal, Video, Analysis
        
        try:
            custom_user = CustomUser.objects.get(login=request.user.username)
            print(f"✅ Найден пользователь: {custom_user.login}")
        except CustomUser.DoesNotExist:
            print(f"⚠️ Пользователь {request.user.username} не найден в CustomUser")
            return JsonResponse({
                'success': False, 
                'error': 'Ошибка: пользователь не найден в системе'
            }, status=400)
        
        # Пытаемся найти животное
        animal = None
        
        # Вариант 1: Ищем животное по ID и пользователю
        try:
            animal = Animal.objects.get(animal_id=animal_id, user=custom_user)
            print(f"✅ Найдено животное пользователя: {animal.name} (ID: {animal.animal_id})")
        except Animal.DoesNotExist:
            print(f"⚠️ Животное ID {animal_id} не найдено у пользователя {custom_user.login}")
            
            # Вариант 2: Ищем животное только по ID (может принадлежать другому пользователю)
            try:
                animal = Animal.objects.get(animal_id=animal_id)
                print(f"⚠️ Найдено животное другого пользователя: {animal.name}")
                
                # Создаем копию для текущего пользователя
                new_animal = Animal.objects.create(
                    user=custom_user,
                    name=f"{animal.name} (копия)",
                    sex=animal.sex,
                    age=animal.age,
                    estimated_weight=animal.estimated_weight,
                    created_at=datetime.now()
                )
                animal = new_animal
                print(f"✅ Создана копия животного: {animal.name}")
                
            except Animal.DoesNotExist:
                # Вариант 3: Создаем новое животное с указанным ID в имени
                animal = Animal.objects.create(
                    user=custom_user,
                    name=f'Лошадь {animal_id}',
                    sex='M',
                    age=5,
                    estimated_weight=500.0,
                    created_at=datetime.now()
                )
                print(f"✅ Создано новое животное: {animal.name}")
        
        # 3. СОЗДАНИЕ ЗАПИСИ ВИДЕО
        video = Video.objects.create(
            animal=animal,
            user=custom_user,
            file_path=f'videos/{filename}',
            upload_date=datetime.now(),
            duration=0,
            resolution='unknown',
            analysis_status='uploaded'
        )
        
        print(f"✅ Видео создано в БД: ID={video.video_id}")
        
        # 4. СОЗДАНИЕ АНАЛИЗА
        analysis = Analysis.objects.create(
            video=video,
            posture='normal',
            gait_quality='good',
            size_category='large',
            estimated_weight=animal.estimated_weight or 500.0,
            confidence_score=0.85,
            analysis_date=datetime.now(),
            is_lame=False,
            lameness_probability=15.5,
            diagnosis='Норма',
            diagnosis_note='Признаков хромоты не обнаружено'
        )
        
        print(f"✅ Анализ создан: ID={analysis.analysis_id}")
        
        # 5. ФОРМИРОВАНИЕ ОТВЕТА
        response_data = {
            'success': True,
            'message': 'Видео успешно загружено и проанализировано!',
            'video_id': video.video_id,
            'analysis_id': analysis.analysis_id,
            'file_path': video.file_path,
            'file_size': video_file.size,
            'animal_id': animal.animal_id,
            'animal_name': animal.name,
            'animal_sex': animal.sex,
            'animal_age': animal.age,
            'animal_weight': animal.estimated_weight,
            'diagnosis': analysis.diagnosis,
            'lameness_probability': analysis.lameness_probability,
            'is_lame': analysis.is_lame,
            'user': request.user.username
        }
        
        print(f"✅ Ответ: {json.dumps(response_data, ensure_ascii=False)}")
        print("="*50)
        
        return JsonResponse(response_data)
        
    except Exception as e:
        print(f"❌ Критическая ошибка: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

def register(request):
    """Регистрация нового пользователя"""
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        email = request.POST.get('email')
        full_name = request.POST.get('full_name')

        if not all([username, password, email]):
            messages.error(request, 'Заполните все обязательные поля')
            return render(request, 'frontend/register.html')

        from django.contrib.auth.models import User as AuthUser
        from web.database.models import User as CustomUser
        
        # Проверяем, нет ли уже такого пользователя
        if AuthUser.objects.filter(username=username).exists():
            messages.error(request, 'Пользователь с таким логином уже существует')
            return render(request, 'frontend/register.html')

        try:
            # Создаем Django пользователя
            auth_user = AuthUser.objects.create_user(
                username=username,
                password=password,
                email=email
            )
            
            # Создаем кастомного пользователя
            custom_user = CustomUser.objects.create(
                login=username,
                password_hash=password,
                email=email,
                full_name=full_name or username,
                role_id='user',
                created_at=datetime.now(),
                is_active=True,
                is_staff=False,
                is_superuser=False
            )

            messages.success(request, 'Регистрация успешна! Теперь вы можете войти.')
            return redirect('login')

        except Exception as e:
            messages.error(request, f'Ошибка регистрации: {e}')

    return render(request, 'frontend/register.html')
EOF

# Заменяем старый файл
cp /home/ais/shared/horseAI/frontend/views_fixed.py /home/ais/shared/horseAI/frontend/views.py

echo "✅ views.py исправлен с правильными отступами"

