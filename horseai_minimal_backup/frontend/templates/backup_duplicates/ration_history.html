{% extends 'frontend/base.html' %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Ü–∏–æ–Ω–æ–≤ - HorseAI{% endblock %}

{% block extra_css %}
<style>
    .history-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }

    .page-title {
        font-size: 36px;
        font-weight: 700;
        color: #333;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }

    .page-title::before {
        content: 'üìã';
        font-size: 40px;
    }

    .page-subtitle {
        color: #666;
        font-size: 16px;
        max-width: 800px;
    }

    /* –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ */
    .filters-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        color: #555;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .filter-input, .filter-select {
        padding: 10px 12px;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 6px;
        color: #333;
        font-size: 15px;
    }

    .filter-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .stats-summary {
        display: flex;
        gap: 30px;
        color: #666;
        font-size: 14px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Ü–∏–æ–Ω–æ–≤ */
    .rations-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .rations-table {
        width: 100%;
        border-collapse: collapse;
    }

    .rations-table thead {
        background: linear-gradient(135deg, #4CAF50, #45a049);
    }

    .rations-table th {
        padding: 18px 16px;
        color: white;
        font-weight: 600;
        text-align: left;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .rations-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .rations-table tbody tr:hover {
        background: #f9f9f9;
    }

    .rations-table td {
        padding: 16px;
        color: #333;
        font-size: 14px;
    }

    /* –°—Ç–∞—Ç—É—Å —Ö—Ä–æ–º–æ—Ç—ã */
    .lameness-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .lameness-yes {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
        border: 1px solid rgba(244, 67, 54, 0.3);
    }

    .lameness-no {
        background: rgba(76, 175, 80, 0.1);
        color: #4CAF50;
        border: 1px solid rgba(76, 175, 80, 0.3);
    }

    /* –î–µ–π—Å—Ç–≤–∏—è */
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .action-btn.view {
        background: rgba(33, 150, 243, 0.1);
        color: #2196F3;
        border: 1px solid rgba(33, 150, 243, 0.3);
    }

    .action-btn.view:hover {
        background: rgba(33, 150, 243, 0.2);
    }

    .action-btn.delete {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
        border: 1px solid rgba(244, 67, 54, 0.3);
    }

    .action-btn.delete:hover {
        background: rgba(244, 67, 54, 0.2);
    }

    /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 25px;
        border-top: 1px solid #e0e0e0;
        background: #f9f9f9;
    }

    .page-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .page-btn:hover {
        border-color: #4CAF50;
        color: #4CAF50;
    }

    .page-btn.active {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    .loading-container {
        text-align: center;
        padding: 60px 20px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        padding: 25px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        border-radius: 12px 12px 0 0;
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 30px;
    }

    .detail-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .detail-item {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 15px;
    }

    .detail-label {
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .detail-value {
        color: #333;
        font-size: 16px;
        font-weight: 600;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .rations-table {
            display: block;
            overflow-x: auto;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-actions {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        
        .stats-summary {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .modal-content {
            max-height: 95vh;
        }
    }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-title {
        color: #666;
        font-size: 20px;
        margin-bottom: 10px;
    }

    .empty-subtitle {
        color: #888;
        font-size: 14px;
        margin-bottom: 25px;
    }
</style>
{% endblock %}

{% block content %}
<div class="history-container">
    <div class="page-header">
        <h1 class="page-title">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Ü–∏–æ–Ω–æ–≤</h1>
        <p class="page-subtitle">
            –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤—Å–µ–º–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ä–∞—Ü–∏–æ–Ω–∞–º–∏ –≤–∞—à–∏—Ö –ª–æ—à–∞–¥–µ–π
        </p>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
    <div class="filters-section">
        <div class="filters-grid">
            <div class="filter-group">
                <label class="filter-label">–õ–æ—à–∞–¥—å</label>
                <select id="animalFilter" class="filter-select">
                    <option value="">–í—Å–µ –ª–æ—à–∞–¥–∏</option>
                    {% for animal in animals %}
                    <option value="{{ animal.animal_id }}">{{ animal.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">–°—Ç–∞—Ç—É—Å —Ö—Ä–æ–º–æ—Ç—ã</label>
                <select id="lamenessFilter" class="filter-select">
                    <option value="">–í—Å–µ</option>
                    <option value="true">–° —Ö—Ä–æ–º–æ—Ç–æ–π</option>
                    <option value="false">–ë–µ–∑ —Ö—Ä–æ–º–æ—Ç—ã</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
                <select id="activityFilter" class="filter-select">
                    <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
                    <option value="none">–ë–µ–∑ —Ä–∞–±–æ—Ç—ã</option>
                    <option value="light">–õ–µ–≥–∫–∞—è</option>
                    <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                    <option value="heavy">–¢—è–∂–µ–ª–∞—è</option>
                    <option value="competition">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">–ü–µ—Ä–∏–æ–¥</label>
                <select id="periodFilter" class="filter-select">
                    <option value="all">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                    <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                    <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
                    <option value="quarter">–ó–∞ 3 –º–µ—Å—è—Ü–∞</option>
                </select>
            </div>
        </div>
        
        <div class="filter-actions">
            <div class="stats-summary">
                <div class="stat-item">
                    <span>üìã –í—Å–µ–≥–æ:</span>
                    <span id="totalCount">0</span>
                </div>
                <div class="stat-item">
                    <span>‚ö†Ô∏è –° —Ö—Ä–æ–º–æ—Ç–æ–π:</span>
                    <span id="lameCount">0</span>
                </div>
                <div class="stat-item">
                    <span>üí∞ –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                    <span id="avgCost">0 —Ä—É–±/–º–µ—Å</span>
                </div>
            </div>
            
            <div>
                <button class="wizard-btn primary" onclick="loadRations()">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Ü–∏–æ–Ω–æ–≤ -->
    <div class="rations-table-container">
        <div id="loadingContainer" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Ü–∏–æ–Ω–æ–≤...</p>
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">ü•ó</div>
            <h3 class="empty-title">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Ü–∏–æ–Ω–æ–≤ –ø—É—Å—Ç–∞</h3>
            <p class="empty-subtitle">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Ü–∏–æ–Ω–æ–≤</p>
            <a href="/ration/" class="wizard-btn primary">
                ü•ó –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Ü–∏–æ–Ω
            </a>
        </div>
        
        <table class="rations-table" id="rationsTable" style="display: none;">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–õ–æ—à–∞–¥—å</th>
                    <th>–í–µ—Å (–∫–≥)</th>
                    <th>–°—É—Ö–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞</th>
                    <th>–≠–Ω–µ—Ä–≥–∏—è</th>
                    <th>–•—Ä–æ–º–æ—Ç–∞</th>
                    <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (–º–µ—Å)</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="rationsTableBody">
                <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </tbody>
        </table>
        
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" onclick="changePage('prev')" id="prevPageBtn">‚Üê –ù–∞–∑–∞–¥</button>
            <span id="pageInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
            <button class="page-btn" onclick="changePage('next')" id="nextPageBtn">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —Ä–∞—Ü–∏–æ–Ω–∞ -->
<div class="modal-overlay" id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">ü•ó –î–µ—Ç–∞–ª–∏ —Ä–∞—Ü–∏–æ–Ω–∞</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentPage = 1;
let totalPages = 1;
let currentRationId = null;
let allRations = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Ü–∏–æ–Ω–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadRations();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('animalFilter').addEventListener('change', loadRations);
    document.getElementById('lamenessFilter').addEventListener('change', loadRations);
    document.getElementById('activityFilter').addEventListener('change', loadRations);
    document.getElementById('periodFilter').addEventListener('change', loadRations);
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–∞—Ü–∏–æ–Ω–æ–≤
async function loadRations() {
    const loading = document.getElementById('loadingContainer');
    const table = document.getElementById('rationsTable');
    const empty = document.getElementById('emptyState');
    const pagination = document.getElementById('pagination');
    
    loading.style.display = 'block';
    table.style.display = 'none';
    empty.style.display = 'none';
    pagination.style.display = 'none';
    
    try {
        // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const params = new URLSearchParams({
            animal_id: document.getElementById('animalFilter').value || '',
            has_lameness: document.getElementById('lamenessFilter').value || '',
            activity_level: document.getElementById('activityFilter').value || '',
            period: document.getElementById('periodFilter').value || 'all'
        });
        
        const response = await fetch(`/api/rations/history/?${params}`);
        const data = await response.json();
        
        if (data.success) {
            allRations = data.rations;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('totalCount').textContent = data.count;
            
            const lameCount = data.rations.filter(r => r.has_lameness).length;
            document.getElementById('lameCount').textContent = lameCount;
            
            const avgCost = data.rations.length > 0 
                ? Math.round(data.rations.reduce((sum, r) => sum + (r.total_day_cost || 0), 0) / data.rations.length * 30)
                : 0;
            document.getElementById('avgCost').textContent = avgCost + ' —Ä—É–±/–º–µ—Å';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (data.rations.length > 0) {
                renderTable(data.rations);
                table.style.display = 'table';
                empty.style.display = 'none';
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                setupPagination(data.rations);
            } else {
                table.style.display = 'none';
                empty.style.display = 'block';
                pagination.style.display = 'none';
            }
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    } finally {
        loading.style.display = 'none';
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
function renderTable(rations) {
    const tbody = document.getElementById('rationsTableBody');
    tbody.innerHTML = '';
    
    rations.forEach(ration => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${ration.created_at}</td>
            <td><strong>${ration.animal_name}</strong></td>
            <td>${ration.animal_weight || '‚Äî'}</td>
            <td>${ration.total_dmi ? ration.total_dmi.toFixed(2) + ' –∫–≥/–¥–µ–Ω—å' : '‚Äî'}</td>
            <td>${ration.energy_content ? ration.energy_content.toFixed(1) + ' –ú–∫–∞–ª' : '‚Äî'}</td>
            <td>
                <span class="lameness-badge ${ration.has_lameness ? 'lameness-yes' : 'lameness-no'}">
                    ${ration.has_lameness ? '–î–∞' : '–ù–µ—Ç'}
                </span>
            </td>
            <td>${getActivityLabel(ration.activity_level)}</td>
            <td><strong>${ration.total_day_cost ? Math.round(ration.total_day_cost * 30) : 0} —Ä—É–±</strong></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn view" onclick="viewRation(${ration.id})">
                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                    <button class="action-btn delete" onclick="deleteRation(${ration.id}, '${ration.animal_name}')">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
function getActivityLabel(activity) {
    const labels = {
        'none': '–ë–µ–∑ —Ä–∞–±–æ—Ç—ã',
        'light': '–õ–µ–≥–∫–∞—è',
        'medium': '–°—Ä–µ–¥–Ω—è—è',
        'heavy': '–¢—è–∂–µ–ª–∞—è',
        'competition': '–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è'
    };
    return labels[activity] || activity || '‚Äî';
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
function setupPagination(rations) {
    const itemsPerPage = 10;
    totalPages = Math.ceil(rations.length / itemsPerPage);
    
    if (totalPages > 1) {
        document.getElementById('pagination').style.display = 'flex';
        updatePagination();
    } else {
        document.getElementById('pagination').style.display = 'none';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
function updatePagination() {
    document.getElementById('pageInfo').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
    document.getElementById('prevPageBtn').disabled = currentPage === 1;
    document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const itemsPerPage = 10;
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageRations = allRations.slice(start, end);
    
    renderTable(pageRations);
}

// –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function changePage(direction) {
    if (direction === 'prev' && currentPage > 1) {
        currentPage--;
    } else if (direction === 'next' && currentPage < totalPages) {
        currentPage++;
    }
    updatePagination();
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π —Ä–∞—Ü–∏–æ–Ω–∞
async function viewRation(rationId) {
    try {
        const response = await fetch(`/api/rations/${rationId}/`);
        const data = await response.json();
        
        if (data.success) {
            currentRationId = rationId;
            showRationDetails(data.ration);
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–∞—Ü–∏–æ–Ω–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
function showRationDetails(ration) {
    const modalBody = document.getElementById('modalBody');
    
    let html = `
        <div class="detail-section">
            <h3 class="section-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">–õ–æ—à–∞–¥—å</div>
                    <div class="detail-value">${ration.animal.name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
                    <div class="detail-value">${ration.created_at}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–•—Ä–æ–º–æ—Ç–∞</div>
                    <div class="detail-value">
                        <span class="lameness-badge ${ration.parameters.has_lameness ? 'lameness-yes' : 'lameness-no'}">
                            ${ration.parameters.has_lameness ? '–î–∞' : '–ù–µ—Ç'}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–í–µ—Å –ª–æ—à–∞–¥–∏</div>
                    <div class="detail-value">${ration.animal.weight || '‚Äî'} –∫–≥</div>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <h3 class="section-title">‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                    <div class="detail-value">${getActivityLabel(ration.parameters.activity_level)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è</div>
                    <div class="detail-value">${ration.parameters.health_status || '‚Äî'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–¶–µ–ª—å –∫–æ—Ä–º–ª–µ–Ω–∏—è</div>
                    <div class="detail-value">${ration.parameters.goal || '‚Äî'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–¢–∏–ø –ø–æ—Ä–æ–¥—ã</div>
                    <div class="detail-value">${ration.parameters.breed_type || '‚Äî'}</div>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <h3 class="section-title">üìä –ü–∏—Ç–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">–°—É—Ö–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞</div>
                    <div class="detail-value">${ration.nutrition.total_dmi ? ration.nutrition.total_dmi.toFixed(2) + ' –∫–≥/–¥–µ–Ω—å' : '‚Äî'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–≠–Ω–µ—Ä–≥–∏—è</div>
                    <div class="detail-value">${ration.nutrition.energy_content ? ration.nutrition.energy_content.toFixed(1) + ' –ú–∫–∞–ª/–¥–µ–Ω—å' : '‚Äî'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–ë–µ–ª–æ–∫</div>
                    <div class="detail-value">${ration.nutrition.protein ? ration.nutrition.protein.toFixed(2) + ' –∫–≥/–¥–µ–Ω—å' : '‚Äî'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">–ö–ª–µ—Ç—á–∞—Ç–∫–∞</div>
                    <div class="detail-value">${ration.nutrition.fiber ? ration.nutrition.fiber.toFixed(2) + ' –∫–≥/–¥–µ–Ω—å' : '‚Äî'}</div>
                </div>
            </div>
        </div>
    `;
    
    // –°–æ—Å—Ç–∞–≤ —Ä–∞—Ü–∏–æ–Ω–∞
    if (ration.feed_amounts && Object.keys(ration.feed_amounts).length > 0) {
        html += `
            <div class="detail-section">
                <h3 class="section-title">ü•ó –°–æ—Å—Ç–∞–≤ —Ä–∞—Ü–∏–æ–Ω–∞</h3>
                <div style="background: #f9f9f9; border-radius: 8px; padding: 20px;">
        `;
        
        const feeds = {
            'hay': '–°–µ–Ω–æ –ª—É–≥–æ–≤–æ–µ',
            'grain': '–û–≤–µ—Å',
            'supplement': '–û—Ç—Ä—É–±–∏ –ø—à–µ–Ω–∏—á–Ω—ã–µ',
            'vegetable': '–ú–æ—Ä–∫–æ–≤—å',
            'premix': '–ü—Ä–µ–º–∏–∫—Å'
        };
        
        for (const [feedType, amount] of Object.entries(ration.feed_amounts)) {
            const feedName = feeds[feedType] || feedType;
            const price = ration.feed_prices?.[feedType] || 0;
            const dailyCost = amount * price;
            
            html += `
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
                    <div>
                        <strong>${feedName}</strong><br>
                        <small style="color: #666;">${price} —Ä—É–±/–∫–≥</small>
                    </div>
                    <div style="text-align: right;">
                        <strong>${amount.toFixed(2)} –∫–≥/–¥–µ–Ω—å</strong><br>
                        <small style="color: #4CAF50;">${dailyCost.toFixed(2)} —Ä—É–±/–¥–µ–Ω—å</small>
                    </div>
                </div>
            `;
        }
        
        html += `</div></div>`;
    }
    
    // –°—Ç–æ–∏–º–æ—Å—Ç—å
    if (ration.cost) {
        html += `
            <div class="detail-section">
                <h3 class="section-title">üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">–ó–∞ –¥–µ–Ω—å</div>
                        <div class="detail-value" style="color: #4CAF50;">${ration.cost.day.toFixed(2)} —Ä—É–±</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–ó–∞ –º–µ—Å—è—Ü (30 –¥–Ω–µ–π)</div>
                        <div class="detail-value" style="color: #4CAF50; font-size: 18px;">${ration.cost.month.toFixed(2)} —Ä—É–±</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    if (ration.recommendations && ration.recommendations.length > 0) {
        html += `
            <div class="detail-section">
                <h3 class="section-title">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <ul style="color: #333; line-height: 1.6; padding-left: 20px;">
                    ${ration.recommendations.map(r => `<li>${r}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    // –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
    if (ration.notes) {
        html += `
            <div class="detail-section">
                <h3 class="section-title">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è</h3>
                <p style="color: #666; font-style: italic;">${ration.notes}</p>
            </div>
        `;
    }
    
    // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    html += `
        <div class="detail-section">
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button class="wizard-btn" onclick="printRation(${rationId})">
                    üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å
                </button>
                <button class="wizard-btn primary" onclick="useThisRation(${rationId})">
                    üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
                <button class="wizard-btn delete" onclick="deleteRation(${rationId}, '${ration.animal.name}')">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    `;
    
    modalBody.innerHTML = html;
    document.getElementById('detailModal').style.display = 'flex';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeModal() {
    document.getElementById('detailModal').style.display = 'none';
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Ü–∏–æ–Ω–∞
async function deleteRation(rationId, animalName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞—Ü–∏–æ–Ω –¥–ª—è "${animalName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/rations/${rationId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('–†–∞—Ü–∏–æ–Ω —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
            closeModal();
            loadRations(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω —Å–Ω–æ–≤–∞
function useThisRation(rationId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Ü–∏–æ–Ω–∞
    alert('–§—É–Ω–∫—Ü–∏—è "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    closeModal();
}

// –ü–µ—á–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω–∞
function printRation(rationId) {
    window.print();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
