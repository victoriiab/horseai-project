<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    if (!form) {
        console.log('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }
    
    console.log('–§–æ—Ä–º–∞ –Ω–∞–π–¥–µ–Ω–∞, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...');
    
    const fileInput = document.getElementById('videoFile');
    const submitBtn = document.getElementById('submitBtn');
    const progressSection = document.getElementById('progressSection');
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
        
        const formData = new FormData(this);
        const animalId = formData.get('animal_id');
        
        if (!animalId || animalId === '') {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ');
            return;
        }
        
        if (!fileInput.files.length) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>‚è≥</span><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
        }
        if (progressSection) {
            progressSection.style.display = 'block';
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            if (progressBar) progressBar.style.width = '25%';
            if (progressPercent) progressPercent.textContent = '25%';
        }
        
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/upload/simple/');
            
            const response = await fetch('/api/upload/simple/', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                if (progressSection) {
                    const progressBar = document.getElementById('progressBar');
                    const progressPercent = document.getElementById('progressPercent');
                    if (progressBar) progressBar.style.width = '100%';
                    if (progressPercent) progressPercent.textContent = '100%';
                }
                
                alert('‚úÖ ' + data.message + '\nID –≤–∏–¥–µ–æ: ' + data.video_id);
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                setTimeout(() => {
                    window.location.href = '/analysis/results/';
                }, 1500);
                
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>üöÄ</span><span>–ó–∞–ø—É—Å—Ç–∏—Ç—å ML –∞–Ω–∞–ª–∏–∑</span>';
            }
            if (progressSection) {
                progressSection.style.display = 'none';
            }
        }
    });
    
    // Drag & Drop (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
    const dropZone = document.getElementById('dropZone');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileMeta = document.getElementById('fileMeta');
    
    if (dropZone && fileInput) {
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0 && fileInfo && fileName && fileMeta) {
                const file = this.files[0];
                const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                fileName.textContent = file.name;
                fileMeta.textContent = `${fileSize} MB`;
                fileInfo.style.display = 'block';
            }
        });
    }
    
    console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–∞');
});
</script>
