"""
–†–ê–ë–û–ß–ò–ï VIEWS - –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
"""
import os
import json
import threading
import datetime
from datetime import datetime
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import login, logout, authenticate
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.http import JsonResponse, HttpResponseForbidden
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
from django.conf import settings
from django.contrib.admin.views.decorators import staff_member_required
from django.contrib.auth.models import User as AuthUser
from web.database.models import Animal, Video, Analysis, User as CustomUser, Ration
from django.db.models import Q



# –í –Ω–∞—á–∞–ª–æ views.py –¥–æ–±–∞–≤—å—Ç–µ:
from django.utils import timezone
from django.contrib.auth.hashers import make_password

def check_user_access(user, video):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –≤–∏–¥–µ–æ"""
    if user.is_staff:
        return True
    
    try:
        # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        from web.database.models import User as CustomUser, Ration
        custom_user = CustomUser.objects.get(login=user.username)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑—å —Å –≤–∏–¥–µ–æ
        if video and video.user:
            return video.user.id == custom_user.id
        
        # –ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
        return True
        
    except CustomUser.DoesNotExist:
        # –ï—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
        if hasattr(video, 'user_id'):
            return video.user_id == user.id
        return True

def create_custom_user_safe(username, email, password, full_name=None, role='user', is_staff=False, is_superuser=False):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ CustomUser —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –ø–æ–ª–µ–π"""
    from django.contrib.auth.hashers import make_password
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if CustomUser.objects.filter(login=username).exists():
            return CustomUser.objects.get(login=username)

        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
        custom_user = CustomUser.objects.create(
            login=username,
            email=email,
            password_hash=make_password(password),
            full_name=full_name or username,
            role_id=role,
            created_at=timezone.now(),
            last_login=timezone.now(),
            is_active=True,      # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–µ–Ω
            is_staff=is_staff,
            is_superuser=is_superuser
        )
        
        return custom_user
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è CustomUser {username}: {e}")
        return None

        
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω CustomUser: {username} —Å timezone-aware datetime")
        return custom_user
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è CustomUser {username}: {e}")
        raise


# ========== –û–°–ù–û–í–ù–´–ï –°–¢–†–ê–ù–ò–¶–´ ==========
def index(request):
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    if not request.user.is_authenticated:
        return render(request, 'frontend/index.html')

    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
    except CustomUser.DoesNotExist:
        is_admin = request.user.is_staff

    context = {}
    if is_admin:
        context.update({
            'animals_count': Animal.objects.count(),
            'videos_count': Video.objects.count(),
            'analyses_count': Analysis.objects.count(),
            'user_role': 'admin'
        })
    else:
        try:
            custom_user = CustomUser.objects.get(login=request.user.username)
            context.update({
                'animals_count': Animal.objects.filter(user=custom_user).count(),
                'videos_count': Video.objects.filter(user=custom_user).count(),
                'analyses_count': Analysis.objects.filter(video__user=custom_user).count(),
                'user_role': 'user'
            })
        except:
            context.update({
                'animals_count': 0,
                'videos_count': 0,
                'analyses_count': 0,
                'user_role': 'user'
            })

    return render(request, 'frontend/index.html', context)


def custom_login(request):
    """–ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ Django auth"""
    from django.contrib.auth import authenticate, login
    from django.contrib import messages
    from django.shortcuts import render, redirect
    
    if request.method == 'POST':
        username = request.POST.get('username', '').strip()
        password = request.POST.get('password', '').strip()
        
        if not username or not password:
            messages.error(request, '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å')
            return render(request, 'frontend/login.html')
        
        # –ü—Ä–æ—Å—Ç–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Django
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_active:
            login(request, user)
            messages.success(request, f'–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.username}')
            
            # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
            next_url = request.GET.get('next', '/')
            return redirect(next_url)
        else:
            messages.error(request, '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å')
            return render(request, 'frontend/login.html')
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    return render(request, 'frontend/login.html')

def custom_logout(request):
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    logout(request)
    messages.success(request, '–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã')
    return redirect('index')


@login_required 
def animals_list(request):
    """–°–ø–∏—Å–æ–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        animals = Animal.objects.filter(user=custom_user).order_by('-created_at')
    except:
        animals = []
    return render(request, 'frontend/animals.html', {'animals': animals})


@login_required 
def video_upload(request):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        animals = Animal.objects.filter(user=custom_user)
    except:
        animals = []
    return render(request, 'frontend/video_upload_fixed.html', {'animals': animals})


@login_required
def analysis_status_page(request, video_id):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ video_id"""
    try:
        video = Video.objects.get(pk=video_id)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        if request.user.username != video.user.login:
            return redirect('/')

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ
        analysis = Analysis.objects.filter(video=video).order_by('-analysis_date').first()

        context = {
            'video': video,
            'analysis': analysis,
            'animal_name': video.animal.name if video.animal else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            'video_filename': video.file_path.split('/')[-1] if video.file_path else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
        }

        return render(request, 'frontend/analysis_status.html', context)

    except Video.DoesNotExist:
        return render(request, 'frontend/error.html', {'error': '–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'})
    except Exception as e:
        return render(request, 'frontend/error.html', {'error': str(e)})


def analysis_results(request):
    """–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        if request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']:
            analyses = Analysis.objects.all().select_related('video', 'video__animal').order_by('-analysis_date')
            animals = Animal.objects.all()[:20]
        else:
            user_animals = Animal.objects.filter(user=custom_user)
            user_videos = Video.objects.filter(animal__in=user_animals)
            analyses = Analysis.objects.filter(video__in=user_videos).select_related('video', 'video__animal').order_by('-analysis_date')
            animals = user_animals
    except:
        analyses = []
        animals = []

    context = {
        'analyses': analyses,
        'animals': animals,
        'total_count': len(analyses),
        'lame_count': len([a for a in analyses if a.is_lame]),
        'healthy_count': len([a for a in analyses if not a.is_lame])
    }
    return render(request, 'frontend/analysis.html', context)


@login_required
def ration_calculation(request):
    """–†–∞—Å—á–µ—Ç —Ä–∞—Ü–∏–æ–Ω–∞"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        animals = Animal.objects.filter(user=custom_user)
    except:
        animals = []
    return render(request, 'frontend/ration.html', {'animals': animals})


@login_required
def admin_dashboard(request):
    """–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å"""
    if not (request.user.is_staff):
        messages.error(request, '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω')
        return redirect('index')

    stats = {
        'total_users': CustomUser.objects.count(),
        'total_animals': Animal.objects.count(),
        'total_videos': Video.objects.count(),
        'total_analyses': Analysis.objects.count(),
        'lame_count': Analysis.objects.filter(is_lame=True).count(),
    }
    return render(request, 'frontend/admin_dashboard.html', {'stats': stats})

@login_required
def profile(request):
    try:
        # –ü–æ–ª—É—á–∞–µ–º CustomUser
        try:
            custom_user = CustomUser.objects.get(login=request.user.username)
        except CustomUser.DoesNotExist:
            # –°–æ–∑–¥–∞–µ–º –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            custom_user = CustomUser.objects.create(
                login=request.user.username,
                password_hash='',
                email=request.user.email or '',
                full_name=request.user.username,
                role_id='user',
                created_at=timezone.now(),
                is_active=True,
                is_staff=request.user.is_staff,
                is_superuser=request.user.is_superuser
            )
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_role = 'user'
        if request.user.is_superuser:
            user_role = 'superadmin'
        elif request.user.is_staff:
            user_role = 'admin'
        elif custom_user.role_id in ['admin', 'superadmin']:
            user_role = custom_user.role_id
        elif custom_user.role_id == 'veterinarian':
            user_role = 'veterinarian'
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if user_role in ['admin', 'superadmin']:
            animals_count = Animal.objects.count()
            videos_count = Video.objects.count()
            analyses_count = Analysis.objects.count()
            users_count = CustomUser.objects.count()
        else:
            # –¢–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
            animals_count = Animal.objects.filter(user=custom_user).count()
            videos_count = Video.objects.filter(user=custom_user).count()
            analyses_count = Analysis.objects.filter(video__user=custom_user).count()
            users_count = None
        
        context = {
            'custom_user': custom_user,
            'auth_user': request.user,
            'animals_count': animals_count,
            'videos_count': videos_count,
            'analyses_count': analyses_count,
            'users_count': users_count,
            'user_role': user_role,
            'is_staff': request.user.is_staff,
            'is_superuser': request.user.is_superuser,
        }
        
        # –î–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω
        if user_role in ['admin', 'superadmin']:
            return render(request, 'frontend/profile_admin.html', context)
        else:
            return render(request, 'frontend/profile.html', context)
        
    except Exception as e:
        print(f"Error in profile view: {e}")
        context = {
            'animals_count': 0,
            'videos_count': 0,
            'analyses_count': 0,
            'user_role': 'user',
            'error': str(e)
        }
        return render(request, 'frontend/profile.html', context)




# ========== API ENDPOINTS ==========
@login_required
@csrf_exempt
def get_system_stats(request):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']

        if is_admin:
            stats = {
                'status': 'success',
                'users_count': CustomUser.objects.count(),
                'animals_count': Animal.objects.count(),
                'videos_count': Video.objects.count(),
                'analyses_count': Analysis.objects.count(),
                'lame_count': Analysis.objects.filter(is_lame=True).count(),
                'is_admin': True
            }
        else:
            stats = {
                'status': 'success',
                'animals_count': Animal.objects.filter(user=custom_user).count(),
                'videos_count': Video.objects.filter(user=custom_user).count(),
                'analyses_count': Analysis.objects.filter(video__user=custom_user).count(),
                'is_admin': False
            }
        return JsonResponse(stats)

    except Exception as e:
        return JsonResponse({'status': 'error', 'error': str(e)}, status=500)


@csrf_exempt
def upload_video_simple_api_real(request):
    """–†–ï–ê–õ–¨–ù–´–ô API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    if request.method != 'POST':
        return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ POST –º–µ—Ç–æ–¥'}, status=405)

    try:
        print("="*50)
        print("REAL API: –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ")
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {request.user}")
        print(f"–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: {request.user.is_authenticated}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
        if not request.user.is_authenticated:
            print("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω")
            return JsonResponse({
                'success': False,
                'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.',
                'login_url': '/login/'
            }, status=401)

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        video_file = request.FILES.get('video_file')
        animal_id = request.POST.get('animal_id', '')

        if not video_file:
            print("‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω")
            return JsonResponse({'success': False, 'error': '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'})

        if not animal_id:
            print("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω ID –∂–∏–≤–æ—Ç–Ω–æ–≥–æ")
            return JsonResponse({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ'})

        print(f"‚úÖ –§–∞–π–ª –ø–æ–ª—É—á–µ–Ω: {video_file.name}, —Ä–∞–∑–º–µ—Ä: {video_file.size} –±–∞–π—Ç")
        print(f"‚úÖ ID –∂–∏–≤–æ—Ç–Ω–æ–≥–æ –∏–∑ —Ñ–æ—Ä–º—ã: {animal_id}")

        # 1. –°–û–•–†–ê–ù–ï–ù–ò–ï –§–ê–ô–õ–ê
        import uuid
        import os
        from django.conf import settings

        # –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
        safe_name = str(uuid.uuid4())[:8] + '_' + video_file.name.replace(' ', '_')
        filename = f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{safe_name}"

        # –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        media_dir = os.path.join(settings.MEDIA_ROOT, 'videos')
        os.makedirs(media_dir, exist_ok=True)

        filepath = os.path.join(media_dir, filename)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        with open(filepath, 'wb+') as destination:
            for chunk in video_file.chunks():
                destination.write(chunk)

        print(f"‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {filepath}")

        # 2. –ü–û–ò–°–ö –ò–õ–ò –°–û–ó–î–ê–ù–ò–ï –ñ–ò–í–û–¢–ù–û–ì–û
        try:
            custom_user = CustomUser.objects.get(login=request.user.username)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {custom_user.login}")
        except CustomUser.DoesNotExist:
            print(f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {request.user.username} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ CustomUser")
            return JsonResponse({
                'success': False,
                'error': '–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ'
            }, status=400)

        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∂–∏–≤–æ—Ç–Ω–æ–µ
        animal = None

        # –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—â–µ–º –∂–∏–≤–æ—Ç–Ω–æ–µ –ø–æ ID –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        try:
            animal = Animal.objects.get(animal_id=animal_id, user=custom_user)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –∂–∏–≤–æ—Ç–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {animal.name} (ID: {animal.animal_id})")
        except Animal.DoesNotExist:
            print(f"‚ö†Ô∏è –ñ–∏–≤–æ—Ç–Ω–æ–µ ID {animal_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {custom_user.login}")

            # –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—â–µ–º –∂–∏–≤–æ—Ç–Ω–æ–µ —Ç–æ–ª—å–∫–æ –ø–æ ID (–º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
            try:
                animal = Animal.objects.get(animal_id=animal_id)
                print(f"‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –∂–∏–≤–æ—Ç–Ω–æ–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {animal.name}")

                # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                new_animal = Animal.objects.create(
                    user=custom_user,
                    name=f"{animal.name} (–∫–æ–ø–∏—è)",
                    sex=animal.sex,
                    age=animal.age,
                    estimated_weight=animal.estimated_weight,
                    created_at=datetime.now()
                )
                animal = new_animal
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∫–æ–ø–∏—è –∂–∏–≤–æ—Ç–Ω–æ–≥–æ: {animal.name}")

            except Animal.DoesNotExist:
                # –í–∞—Ä–∏–∞–Ω—Ç 3: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID –≤ –∏–º–µ–Ω–∏
                animal = Animal.objects.create(
                    user=custom_user,
                    name=f'–õ–æ—à–∞–¥—å {animal_id}',
                    sex='M',
                    age=5,
                    estimated_weight=500.0,
                    created_at=datetime.now()
                )
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ: {animal.name}")

        # 3. –°–û–ó–î–ê–ù–ò–ï –ó–ê–ü–ò–°–ò –í–ò–î–ï–û
        video = Video.objects.create(
            animal=animal,
            user=custom_user,
            file_path=f'videos/{filename}',
            upload_date=datetime.now(),
            duration=0,
            resolution='unknown',
            analysis_status='uploaded'
        )

        print(f"‚úÖ –í–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ –≤ –ë–î: ID={video.video_id}")

        # 4. –°–û–ó–î–ê–ù–ò–ï –ê–ù–ê–õ–ò–ó–ê
        analysis = Analysis.objects.create(
            video=video,
            posture='normal',
            gait_quality='good',
            size_category='large',
            estimated_weight=animal.estimated_weight or 500.0,
            confidence_score=0.85,
            analysis_date=datetime.now(),
            is_lame=False,
            lameness_probability=15.5,
            diagnosis='–ù–æ—Ä–º–∞',
            diagnosis_note='–ü—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ö—Ä–æ–º–æ—Ç—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'
        )

        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–æ–∑–¥–∞–Ω: ID={analysis.analysis_id}")

        # 5. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –û–¢–í–ï–¢–ê
        response_data = {
            'success': True,
            'message': '–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!',
            'video_id': video.video_id,
            'analysis_id': analysis.analysis_id,
            'file_path': video.file_path,
            'file_size': video_file.size,
            'animal_id': animal.animal_id,
            'animal_name': animal.name,
            'animal_sex': animal.sex,
            'animal_age': animal.age,
            'animal_weight': animal.estimated_weight,
            'diagnosis': analysis.diagnosis,
            'lameness_probability': analysis.lameness_probability,
            'is_lame': analysis.is_lame,
            'user': request.user.username
        }

        print(f"‚úÖ –û—Ç–≤–µ—Ç: {json.dumps(response_data, ensure_ascii=False)}")
        print("="*50)

        return JsonResponse(response_data)

    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)


from django.utils import timezone



def register(request):
    """–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø - —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ AuthUser, CustomUser —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"""
    if request.method == 'POST':
        username = request.POST.get('username', '').strip()
        password = request.POST.get('password', '').strip()
        email = request.POST.get('email', '').strip()
        full_name = request.POST.get('full_name', '').strip()
        
        print(f"=== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø {username} ===")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if not username or not password or not email:
            messages.error(request, '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è')
            print("‚ùå –ù–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã")
            return render(request, 'frontend/register.html')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ AuthUser
        from django.contrib.auth.models import User as AuthUser
        if AuthUser.objects.filter(username=username).exists():
            messages.error(request, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
            print(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return render(request, 'frontend/register.html')
        
        try:
            print(f"1. –°–æ–∑–¥–∞—é AuthUser {username}...")
            # –°–û–ó–î–ê–ï–ú –¢–û–õ–¨–ö–û AUTHUSER - CustomUser —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª
            auth_user = AuthUser.objects.create_user(
                username=username,
                password=password,
                email=email,
                is_active=True  # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ä–∞–∑—É
            )
            
            print(f"‚úÖ AuthUser —Å–æ–∑–¥–∞–Ω: {auth_user.username}")
            print(f"   ID: {auth_user.id}")
            print(f"   Email: {auth_user.email}")
            print(f"   Active: {auth_user.is_active}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–ª—Å—è –ª–∏ CustomUser –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            from web.database.models import User as CustomUser, Ration
            try:
                custom_user = CustomUser.objects.get(login=username)
                print(f"‚úÖ CustomUser —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: {custom_user.login}")
            except CustomUser.DoesNotExist:
                print(f"‚ö†Ô∏è  CustomUser –Ω–µ —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Å–æ–∑–¥–∞—Å—Ç—Å—è –ø–æ–∑–∂–µ")
            
            messages.success(request, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.')
            print(f"‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
            return redirect('login')
            
        except Exception as e:
            print(f"‚ùå –û–®–ò–ë–ö–ê: {str(e)}")
            messages.error(request, f'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {str(e)}')
            return render(request, 'frontend/register.html')
    
    return render(request, 'frontend/register.html')
def upload_handler_view(request):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è upload-handler/ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ API"""
    from django.shortcuts import redirect
    return redirect('/video-upload/')


@csrf_exempt
def calculate_ration_api(request):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è calculate_ration_api"""
    return JsonResponse({
        'success': False,
        'error': '–≠—Ç–æ—Ç endpoint —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ api_views. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /api/calculate-ration/'
    })


@csrf_exempt
def upload_video_api_real(request):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ endpoint"""
    return JsonResponse({
        'success': False,
        'error': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /api/upload/simple/ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ endpoint',
        'correct_url': '/api/upload/simple/'
    })


def video_upload_direct(request):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—É—é —Ñ–æ—Ä–º—É (–±–µ–∑ JavaScript)"""
    if request.method == 'POST':
        try:
            video_file = request.FILES.get('video_file')
            animal_id = request.POST.get('animal_id', '1')

            if not video_file:
                messages.error(request, '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª')
                return redirect('video_upload')

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ API
            import json
            from io import BytesIO

            # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            response = upload_video_simple_api_real(request)

            if response.status_code == 200:
                data = json.loads(response.content)
                if data.get('success'):
                    messages.success(request, f'‚úÖ {data["message"]}')
                    return redirect('analysis_results')
                else:
                    messages.error(request, f'‚ùå {data.get("error", "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏")}')
            else:
                messages.error(request, '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞')

        except Exception as e:
            messages.error(request, f'‚ùå –û—à–∏–±–∫–∞: {str(e)}')

    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        animals = Animal.objects.filter(user=custom_user)
    except:
        animals = []

    return render(request, 'frontend/video_upload_direct.html', {'animals': animals})


@csrf_exempt
def test_upload_endpoint(request):
    """–¢–µ—Å—Ç–æ–≤—ã–π endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã"""
    print("=== –¢–ï–°–¢–û–í–´–ô ENDPOINT –í–´–ó–í–ê–ù ===")
    print(f"–ú–µ—Ç–æ–¥: {request.method}")
    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {request.user}")

    if request.method == 'POST':
        print(f"–§–∞–π–ª—ã: {list(request.FILES.keys())}")
        print(f"–î–∞–Ω–Ω—ã–µ: {dict(request.POST)}")

        # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö –¥–ª—è —Ç–µ—Å—Ç–∞
        return JsonResponse({
            'success': True,
            'message': '–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞',
            'video_id': 999,
            'animal_name': '–¢–µ—Å—Ç–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ',
            'diagnosis': '–ù–æ—Ä–º–∞ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)',
            'lameness_probability': 15.5,
            'is_lame': False,
            'note': '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç. –†–µ–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ /api/upload/simple/'
        })
    else:
        return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ POST –º–µ—Ç–æ–¥'})


@login_required
@staff_member_required
def super_admin_panel(request):
    """SUPER –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è staff)"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
    except:
        is_super_admin = request.user.is_staff

    if not is_super_admin:
        messages.error(request, '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω')
        return redirect('index')

    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    from django.db.models import Count, Avg

    stats = {
        'total_users': CustomUser.objects.count(),
        'total_animals': Animal.objects.count(),
        'total_videos': Video.objects.count(),
        'total_analyses': Analysis.objects.count(),
        'lame_count': Analysis.objects.filter(is_lame=True).count(),
        'healthy_count': Analysis.objects.filter(is_lame=False).count(),
        'avg_confidence': Analysis.objects.aggregate(Avg('confidence_score'))['confidence_score__avg'] or 0,
        'recent_users': CustomUser.objects.order_by('-created_at')[:5],
        'recent_analyses': Analysis.objects.select_related('video', 'video__animal').order_by('-analysis_date')[:10]
    }

    context = {
        'stats': stats,
        'user': request.user,
        'is_super_admin': True,
        'page_title': 'SUPER Admin Panel'
    }

    return render(request, 'frontend/super_admin.html', context)
# ========== SUPER ADMIN API FUNCTIONS ==========
from django.http import JsonResponse
from django.views.decorators.http import require_http_methods
from django.contrib.auth.decorators import login_required
from django.shortcuts import get_object_or_404
from django.db.models import Q, Count, F
from django.db import connection
from django.utils import timezone
from datetime import timedelta
import json
import csv
import os
import psutil
from django.conf import settings
from django.contrib.auth.models import User as AuthUser
from web.database.models import User, Animal, Video, Analysis, Ration

# ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ==========

@login_required
@require_http_methods(["GET"])
def super_admin_users(request):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        page = int(request.GET.get('page', 1))
        search = request.GET.get('search', '')
        role = request.GET.get('role', '')
        
        per_page = 10
        offset = (page - 1) * per_page
        
        # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        users = User.objects.all().order_by('-created_at')
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        if search:
            users = users.filter(
                Q(login__icontains=search) |
                Q(email__icontains=search) |
                Q(full_name__icontains=search)
            )
        
        if role:
            users = users.filter(role_id=role)
        
        # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total_count = users.count()
        total_pages = (total_count + per_page - 1) // per_page
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        users = users[offset:offset + per_page]
        
        user_list = []
        for user in users:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ is_active
            is_active = getattr(user, 'is_active', True)
            
            user_list.append({
                'user_id': user.user_id,
                'login': user.login,
                'email': user.email,
                'full_name': user.full_name or user.login,
                'role_id': user.role_id or 'user',
                'created_at': user.created_at.isoformat() if user.created_at else None,
                'last_login': user.last_login.isoformat() if user.last_login else None,
                'is_active': is_active,
                'animals_count': Animal.objects.filter(user=user).count(),
                'videos_count': Video.objects.filter(user=user).count(),
                'analyses_count': Analysis.objects.filter(video__user=user).count()
            })
        
        return JsonResponse({
            'success': True,
            'users': user_list,
            'page': page,
            'per_page': per_page,
            'total_count': total_count,
            'total_pages': total_pages
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

@login_required
@require_http_methods(["GET"])
def super_admin_user_detail(request, user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        user = get_object_or_404(User, user_id=user_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ is_active
        is_active = getattr(user, 'is_active', True)
        
        user_data = {
            'user_id': user.user_id,
            'login': user.login,
            'email': user.email,
            'full_name': user.full_name or user.login,
            'role_id': user.role_id or 'user',
            'created_at': user.created_at.isoformat() if user.created_at else None,
            'last_login': user.last_login.isoformat() if user.last_login else None,
            'is_active': is_active,
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_data['animals'] = list(Animal.objects.filter(user=user).values(
            'animal_id', 'name', 'sex', 'age', 'estimated_weight'
        )[:5])
        
        user_data['videos'] = list(Video.objects.filter(user=user).values(
            'video_id', 'file_path', 'upload_date', 'analysis_status'
        )[:5])
        
        user_data['analyses'] = list(Analysis.objects.filter(video__user=user).values(
            'analysis_id', 'analysis_date', 'diagnosis'
        )[:5])
        
        return JsonResponse({
            'success': True,
            'user': user_data
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

@login_required
@require_http_methods(["POST"])
def super_admin_add_user(request):
    """–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        username = request.POST.get('username') or json.loads(request.body).get('username')
        password = request.POST.get('password') or json.loads(request.body).get('password')
        email = request.POST.get('email') or json.loads(request.body).get('email')
        full_name = request.POST.get('full_name') or json.loads(request.body).get('full_name', username)
        role_id = request.POST.get('role') or json.loads(request.body).get('role', 'user')
        
        if not all([username, password]):
            return JsonResponse({
                'success': False,
                'error': '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ª–æ–≥–∏–Ω, –ø–∞—Ä–æ–ª—å)'
            }, status=400)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if User.objects.filter(login=username).exists():
            return JsonResponse({
                'success': False,
                'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
            }, status=400)
        
        # –°–æ–∑–¥–∞–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        from django.contrib.auth.hashers import make_password
        
        # –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        custom_user = User.objects.create(
            login=username,
            password_hash=make_password(password),
            email=email or f"{username}@example.com",
            full_name=full_name,
            role_id=role_id,
            created_at=timezone.now(),
            last_login=timezone.now(),
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º is_active –µ—Å–ª–∏ –ø–æ–ª–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        try:
            custom_user.is_active = True
            custom_user.save()
        except:
            pass  # –ü–æ–ª–µ –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
        
        # –°–æ–∑–¥–∞–µ–º Django auth –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        auth_user = AuthUser.objects.create_user(
            username=username,
            password=password,
            email=email or f"{username}@example.com",
            first_name=full_name,
            is_staff=(role_id in ['admin', 'superadmin']),
            is_superuser=(role_id == 'superadmin')
        )
        
        return JsonResponse({
            'success': True,
            'message': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ',
            'user_id': custom_user.user_id,
            'auth_user_id': auth_user.id
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

@login_required
@require_http_methods(["POST"])
def super_admin_edit_user(request, user_id):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        user = get_object_or_404(User, user_id=user_id)
        
        data = json.loads(request.body)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
        if 'email' in data:
            user.email = data['email']
        
        if 'full_name' in data:
            user.full_name = data['full_name']
        
        if 'role_id' in data:
            user.role_id = data['role_id']
            
            # –û–±–Ω–æ–≤–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                auth_user = AuthUser.objects.get(username=user.login)
                auth_user.is_staff = (data['role_id'] in ['admin', 'superadmin'])
                auth_user.is_superuser = (data['role_id'] == 'superadmin')
                auth_user.save()
            except AuthUser.DoesNotExist:
                pass
        
        # –û–±–Ω–æ–≤–ª—è–µ–º is_active –µ—Å–ª–∏ –ø–æ–ª–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if 'is_active' in data:
            try:
                user.is_active = bool(data['is_active'])
            except:
                pass  # –ü–æ–ª–µ –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
            
            # –û–±–Ω–æ–≤–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                auth_user = AuthUser.objects.get(username=user.login)
                auth_user.is_active = bool(data['is_active'])
                auth_user.save()
            except AuthUser.DoesNotExist:
                pass
        
        user.save()
        
        return JsonResponse({
            'success': True,
            'message': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω'
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

@login_required
@require_http_methods(["POST"])
def super_admin_toggle_user_status(request, user_id):
    """–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        user = get_object_or_404(User, user_id=user_id)
        
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ –ø–æ–ª–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        try:
            current_status = getattr(user, 'is_active', True)
            user.is_active = not current_status
            new_status = user.is_active
        except:
            # –ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
            user.is_active = False
            new_status = False
        
        user.save()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            auth_user = AuthUser.objects.get(username=user.login)
            auth_user.is_active = new_status
            auth_user.save()
        except AuthUser.DoesNotExist:
            pass
        
        return JsonResponse({
            'success': True,
            'message': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {"–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω" if new_status else "–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"}',
            'is_active': new_status
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

@login_required
@require_http_methods(["DELETE"])
def super_admin_delete_user(request, user_id):
    """–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        user = get_object_or_404(User, user_id=user_id)
        login = user.login
        
        # –£–¥–∞–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            auth_user = AuthUser.objects.get(username=login)
            auth_user.delete()
        except AuthUser.DoesNotExist:
            pass
        
        # –£–¥–∞–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user.delete()
        
        return JsonResponse({
            'success': True,
            'message': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω'
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

# ========== –ñ–ò–í–û–¢–ù–´–ï ==========

@login_required
@require_http_methods(["GET"])
def super_admin_animals(request):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        page = int(request.GET.get('page', 1))
        search = request.GET.get('search', '')
        
        per_page = 10
        offset = (page - 1) * per_page
        
        # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        animals = Animal.objects.select_related('user').all().order_by('-created_at')
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        if search:
            animals = animals.filter(
                Q(name__icontains=search) |
                Q(user__login__icontains=search) |
                Q(user__full_name__icontains=search)
            )
        
        # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total_count = animals.count()
        total_pages = (total_count + per_page - 1) // per_page
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        animals = animals[offset:offset + per_page]
        
        animal_list = []
        for animal in animals:
            animal_list.append({
                'animal_id': animal.animal_id,
                'name': animal.name,
                'sex': animal.sex,
                'age': animal.age,
                'estimated_weight': animal.estimated_weight,
                'created_at': animal.created_at.isoformat() if animal.created_at else None,
                'owner_name': animal.user.full_name if animal.user else '–ù–µ —É–∫–∞–∑–∞–Ω',
                'owner_login': animal.user.login if animal.user else '–ù–µ —É–∫–∞–∑–∞–Ω',
                'analyses_count': Analysis.objects.filter(video__animal=animal).count()
            })
        
        return JsonResponse({
            'success': True,
            'animals': animal_list,
            'page': page,
            'per_page': per_page,
            'total_count': total_count,
            'total_pages': total_pages
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)


@login_required
@require_http_methods(["GET"])
def get_animal_details(request, animal_id):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∂–∏–≤–æ—Ç–Ω–æ–º"""
    print(f"üîç get_animal_details –≤—ã–∑–≤–∞–Ω —Å animal_id={animal_id}")
    
    if not request.user.is_superuser:
        print("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω")
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        print(f"üîç –ü–æ–∏—Å–∫ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ —Å ID={animal_id}")
        animal = Animal.objects.select_related('user').get(animal_id=animal_id)
        print(f"‚úÖ –ñ–∏–≤–æ—Ç–Ω–æ–µ –Ω–∞–π–¥–µ–Ω–æ: {animal.name}")
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        videos_count = Video.objects.filter(animal=animal).count()
        analyses_count = Analysis.objects.filter(video__animal=animal).count()
        rations_count = Ration.objects.filter(animal=animal).count()
        
        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –≤–∏–¥–µ–æ
        recent_videos = Video.objects.filter(animal=animal).order_by('-upload_date')[:5]
        
        animal_data = {
            'animal_id': animal.animal_id,
            'name': animal.name,
            'sex': animal.sex or '',
            'age': animal.age,
            'estimated_weight': animal.estimated_weight,
            'created_at': animal.created_at.isoformat() if animal.created_at else None,
            'videos_count': videos_count,
            'analyses_count': analyses_count,
            'rations_count': rations_count,
            'owner': {
                'user_id': animal.user.user_id,
                'login': animal.user.login,
                'email': animal.user.email,
                'full_name': animal.user.full_name,
            } if animal.user else None,
            'videos': [
                {
                    'video_id': video.video_id,
                    'file_path': video.file_path,
                    'upload_date': video.upload_date.isoformat() if video.upload_date else None,
                    'analysis_status': video.analysis_status or 'unknown',
                }
                for video in recent_videos
            ]
        }
        
        print(f"‚úÖ –î–∞–Ω–Ω—ã–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã")
        return JsonResponse({'success': True, 'animal': animal_data})
        
    except Animal.DoesNotExist:
        print(f"‚ùå –ñ–∏–≤–æ—Ç–Ω–æ–µ —Å ID {animal_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return JsonResponse({'success': False, 'error': f'–ñ–∏–≤–æ—Ç–Ω–æ–µ —Å ID {animal_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}, status=404)
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)




@login_required
@require_http_methods(["POST"])
def edit_animal(request, animal_id):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        animal = get_object_or_404(Animal, animal_id=animal_id)
        
        data = json.loads(request.body)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
        if 'name' in data:
            animal.name = data['name']
        if 'sex' in data and data['sex'] in ['M', 'F', '']:
            animal.sex = data['sex'] if data['sex'] else None
        if 'age' in data:
            animal.age = float(data['age']) if data['age'] not in [None, ''] else None
        if 'estimated_weight' in data:
            animal.estimated_weight = float(data['estimated_weight']) if data['estimated_weight'] not in [None, ''] else None
        
        animal.save()
        
        return JsonResponse({
            'success': True,
            'message': '–ñ–∏–≤–æ—Ç–Ω–æ–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ',
            'animal': {
                'animal_id': animal.animal_id,
                'name': animal.name,
                'sex': animal.sex,
                'age': animal.age,
                'estimated_weight': animal.estimated_weight,
            }
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

@login_required
@require_http_methods(["DELETE"])
def delete_animal(request, animal_id):
    """–£–¥–∞–ª–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        animal = get_object_or_404(Animal, animal_id=animal_id)
        
        # –£–¥–∞–ª—è–µ–º –∂–∏–≤–æ—Ç–Ω–æ–µ
        animal.delete()
        
        return JsonResponse({
            'success': True,
            'message': '–ñ–∏–≤–æ—Ç–Ω–æ–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ'
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

@login_required
@require_http_methods(["POST"])
def add_animal(request):
    """–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        data = json.loads(request.body)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if not data.get('name'):
            return JsonResponse({'success': False, 'error': '–ò–º—è –∂–∏–≤–æ—Ç–Ω–æ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'}, status=400)
        
        if not data.get('owner_id'):
            return JsonResponse({'success': False, 'error': 'ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'}, status=400)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
        try:
            owner = User.objects.get(user_id=data['owner_id'])
        except User.DoesNotExist:
            return JsonResponse({'success': False, 'error': '–í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
        
        # –°–æ–∑–¥–∞–µ–º –∂–∏–≤–æ—Ç–Ω–æ–µ
        animal = Animal.objects.create(
            name=data['name'],
            user=owner,
            sex=data.get('sex'),
            age=float(data.get('age')) if data.get('age') not in [None, ''] else None,
            estimated_weight=float(data.get('estimated_weight')) if data.get('estimated_weight') not in [None, ''] else None,
        )
        
        return JsonResponse({
            'success': True,
            'message': '–ñ–∏–≤–æ—Ç–Ω–æ–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ',
            'animal_id': animal.animal_id
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

# ========== –°–ò–°–¢–ï–ú–ê ==========

@login_required
@require_http_methods(["GET"])
def super_admin_system_health(request):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã"""
    if not request.user.is_superuser:
        return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
    
    try:
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
        cpu_percent = psutil.cpu_percent(interval=1)
        memory = psutil.virtual_memory()
        disk = psutil.disk_usage('/')
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Django
        from django.core.cache import cache
        
        db_status = 'OK'
        try:
            with connection.cursor() as cursor:
                cursor.execute("SELECT 1")
        except Exception as db_error:
            db_status = f'ERROR: {str(db_error)}'
        
        cache_status = 'OK'
        try:
            cache.set('health_check', 'test', 10)
            if cache.get('health_check') != 'test':
                cache_status = 'WARNING'
        except Exception as cache_error:
            cache_status = f'ERROR: {str(cache_error)}'
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–∏–∞ –ø–∞–ø–∫–∏
        media_path = '/home/ais/shared/horseAI/media'
        media_exists = os.path.exists(media_path)
        media_writable = os.access(media_path, os.W_OK) if media_exists else False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –≤ –ë–î
        db_size_mb = 0
        try:
            with connection.cursor() as cursor:
                cursor.execute("SELECT SUM(data_length + index_length) FROM information_schema.TABLES WHERE table_schema = DATABASE()")
                result = cursor.fetchone()
                if result and result[0]:
                    db_size_mb = round(result[0] / (1024 * 1024), 2)
        except Exception as db_size_error:
            db_size_mb = f'ERROR: {str(db_size_error)}'
        
        return JsonResponse({
            'success': True,
            'system': {
                'cpu_percent': cpu_percent,
                'memory_percent': round(memory.percent, 1),
                'memory_used_mb': round(memory.used / (1024 * 1024)),
                'memory_total_mb': round(memory.total / (1024 * 1024)),
                'disk_percent': disk.percent,
                'disk_free_gb': round(disk.free / (1024 ** 3), 1),
                'disk_total_gb': round(disk.total / (1024 ** 3), 1),
                'uptime_seconds': int(psutil.boot_time())
            },
            'services': {
                'database': db_status,
                'database_size_mb': db_size_mb,
                'cache': cache_status,
                'media_folder': 'OK' if media_exists and media_writable else 'ERROR'
            },
            'app': {
                'total_users': User.objects.count(),
                'total_animals': Animal.objects.count(),
                'total_videos': Video.objects.count(),
                'total_analyses': Analysis.objects.count(),
                'processing_videos': Video.objects.filter(analysis_status='processing').count(),
                'failed_videos': Video.objects.filter(analysis_status='failed').count(),
                'pending_videos': Video.objects.filter(analysis_status='pending').count()
            },
            'timestamp': timezone.now().isoformat()
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

@csrf_exempt
@login_required
def upload_video_horse_detector(request):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ —Å –≤–∞—à–∏–º HorseLamenessDetector"""
    if request.method != 'POST':
        return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ POST'}, status=405)

    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª
        video_file = request.FILES.get('video_file')
        if not video_file:
            return JsonResponse({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ'})

        # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ
        import uuid
        import os
        from pathlib import Path

        filename = f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{str(uuid.uuid4())[:8]}_{video_file.name}"
        media_dir = os.path.join(settings.MEDIA_ROOT, "videos")
        os.makedirs(media_dir, exist_ok=True)

        filepath = os.path.join(media_dir, filename)

        with open(filepath, 'wb+') as f:
            for chunk in video_file.chunks():
                f.write(chunk)

        # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞—à –¥–µ—Ç–µ–∫—Ç–æ—Ä (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞)
        from web.horse_detector import HorseLamenessDetector

        detector = HorseLamenessDetector()
        success = detector.process(Path(filepath))

        # 4. –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = detector.get_last_result() if hasattr(detector, 'get_last_result') else None

        # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = request.user
        custom_user = CustomUser.objects.get(login=user.username)

        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
        video = Video.objects.create(
            user=custom_user,
            file_path=f'videos/{filename}',
            upload_date=datetime.now(),
            analysis_status='completed' if success else 'failed'
        )

        # –°–æ–∑–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑
        if result:
            analysis = Analysis.objects.create(
                video=video,
                posture='normal',
                is_lame=result.get('is_lame', False),
                lameness_probability=result.get('lameness_probability', 0),
                diagnosis=result.get('diagnosis', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'),
                analysis_date=datetime.now()
            )
        else:
            # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω, —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—É—é –∑–∞–ø–∏—Å—å
            analysis = Analysis.objects.create(
                video=video,
                posture='normal',
                diagnosis='–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω' if success else '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞',
                analysis_date=datetime.now()
            )

        # 6. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
        return JsonResponse({
            'success': True,
            'message': '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω' if success else '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞',
            'video_id': video.video_id,
            'analysis_id': analysis.analysis_id,
            'is_lame': analysis.is_lame if hasattr(analysis, 'is_lame') else None,
            'diagnosis': analysis.diagnosis,
            'redirect_url': f'/analysis/results/#analysis-{analysis.analysis_id}'
        })

    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)


@login_required
@csrf_exempt
def upload_video_with_adapter(request):
    """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Å–æ–∑–¥–∞–µ—Ç –∂–∏–≤–æ—Ç–Ω–æ–µ –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"""
    if request.method != 'POST':
        return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ POST –º–µ—Ç–æ–¥'}, status=405)

    try:
        print("\n" + "="*60)
        print("üöÄ –ó–ê–ü–£–°–ö –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ì–û –ê–î–ê–ü–¢–ï–†–ê")
        print("="*60)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if not request.user.is_authenticated:
            return JsonResponse({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'}, status=401)

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        video_file = request.FILES.get('video_file')
        animal_id = request.POST.get('animal_id', '')

        if not video_file:
            return JsonResponse({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ'})
        if not animal_id:
            return JsonResponse({'success': False, 'error': '–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ'})

        print(f"üìπ –í–∏–¥–µ–æ: {video_file.name}")
        print(f"üê¥ ID –∂–∏–≤–æ—Ç–Ω–æ–≥–æ –∏–∑ —Ñ–æ—Ä–º—ã: {animal_id}")

        # 1. –°–û–•–†–ê–ù–Ø–ï–ú –í–ò–î–ï–û
        import uuid
        import os
        from pathlib import Path

        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
        safe_name = str(uuid.uuid4())[:8] + '_' + video_file.name.replace(' ', '_')
        filename = f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{safe_name}"

        # –ü–∞–ø–∫–∞ –¥–ª—è –≤–∏–¥–µ–æ
        media_dir = os.path.join(settings.MEDIA_ROOT, "videos")
        os.makedirs(media_dir, exist_ok=True)

        filepath = os.path.join(media_dir, filename)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        with open(filepath, 'wb+') as f:
            for chunk in video_file.chunks():
                f.write(chunk)
        print(f"‚úÖ –í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {filepath}")

        # 2. –ù–ê–•–û–î–ò–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        try:
            custom_user = CustomUser.objects.get(login=request.user.username)
            print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {custom_user.login}")
        except CustomUser.DoesNotExist:
            return JsonResponse({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=400)

        # 3. –ù–ê–•–û–î–ò–ú –ò–õ–ò –°–û–ó–î–ê–ï–ú –ñ–ò–í–û–¢–ù–û–ï
        animal = None

        try:
            # –ü—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ
            animal_id_int = int(animal_id)
            print(f"   –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∂–∏–≤–æ—Ç–Ω–æ–µ –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É ID: {animal_id_int}")
            animal = Animal.objects.get(animal_id=animal_id_int, user=custom_user)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ: {animal.name}")
        except ValueError:
            # animal_id –Ω–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'test_123')
            print(f"‚ö†Ô∏è animal_id '{animal_id}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º")

            # –ò—â–µ–º –ø–æ –∏–º–µ–Ω–∏
            animals = Animal.objects.filter(user=custom_user, name__icontains=animal_id)
            if animals.exists():
                animal = animals.first()
            else:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
                animal = Animal.objects.create(
                    user=custom_user,
                    name=f'–õ–æ—à–∞–¥—å {animal_id}',
                    sex='M',
                    age=5,
                    estimated_weight=500.0,
                    created_at=datetime.now()
                )
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ: {animal.name}")
        except Animal.DoesNotExist:
            # ID –µ—Å—Ç—å, –Ω–æ –∂–∏–≤–æ—Ç–Ω–æ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            print(f"‚ö†Ô∏è –ñ–∏–≤–æ—Ç–Ω–æ–µ ID {animal_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
            animal = Animal.objects.create(
                user=custom_user,
                name=f'–õ–æ—à–∞–¥—å {animal_id}',
                sex='M',
                age=5,
                estimated_weight=500.0,
                created_at=datetime.now()
            )
            print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ: {animal.name}")

        # 4. –°–û–ó–î–ê–ï–ú –ó–ê–ü–ò–°–¨ –í–ò–î–ï–û
        video = Video.objects.create(
            animal=animal,
            user=custom_user,
            file_path=f'videos/{filename}',
            upload_date=datetime.now(),
            duration=0,
            resolution='unknown',
            analysis_status='processing'
        )

        print(f"‚úÖ –í–∏–¥–µ–æ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –ë–î: ID={video.video_id}")

        # 5. –û–¢–ü–†–ê–í–õ–Ø–ï–ú –û–¢–í–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ
        response_data = {
            'success': True,
            'message': '–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑...',
            'video_id': video.video_id,
            'animal_name': animal.name,
            'status': 'processing',
            'redirect_url': f'/analysis/status/{video.video_id}/',
            'estimated_time': '2-3 –º–∏–Ω—É—Ç—ã'
        }

        # 6. –ó–ê–ü–£–°–ö–ê–ï–ú –î–ï–¢–ï–ö–¢–û–† –í –§–û–ù–ï - –†–ï–ê–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö
        def run_detector_in_background():
            """–ó–∞–ø—É—Å–∫ test_detector.py —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
            import time
            import os
            import sys
            import subprocess
            from pathlib import Path
    
    # –°–æ–∑–¥–∞–µ–º –ª–æ–≥-—Ñ–∞–π–ª
            log_dir = os.path.join(settings.MEDIA_ROOT, "detector_logs")
            os.makedirs(log_dir, exist_ok=True)
            log_file = os.path.join(log_dir, f"video_{video.video_id}_{int(time.time())}.log")
    
            with open(log_file, 'w') as f:
                f.write(f"=== –ó–ê–ü–£–°–ö –î–ï–¢–ï–ö–¢–û–†–ê –î–õ–Ø –í–ò–î–ï–û ID: {video.video_id} ===\n")
                f.write(f"–í—Ä–µ–º—è: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"–í–∏–¥–µ–æ: {filepath}\n")
                f.write(f"–ñ–∏–≤–æ—Ç–Ω–æ–µ: {animal.name}\n")
                f.write("="*60 + "\n\n")

            try:
                print(f"\nüî¨ –ó–ê–ü–£–°–ö test_detector.py –° –õ–û–ì–ò–†–û–í–ê–ù–ò–ï–ú")
                print(f"   –ù–∞—á–∞–ª–æ: {time.strftime('%H:%M:%S')}")
                print(f"   –í–∏–¥–µ–æ ID: {video.video_id}")
                print(f"   –§–∞–π–ª: {filepath}")
                print(f"   –õ–æ–≥-—Ñ–∞–π–ª: {log_file}")

        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                output_dir = os.path.join(settings.MEDIA_ROOT, "detector_results", f"vid_{video.video_id}")
                os.makedirs(output_dir, exist_ok=True)

        # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ test_detector.py
                cmd = [
                    sys.executable,
                    "/home/ais/shared/horseAI/scripts/test_detector.py",
                    "--video", filepath,
                    "--output", output_dir
                ]

                print(f"   –ö–æ–º–∞–Ω–¥–∞: {' '.join(cmd)}")

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –ª–æ–≥
                with open(log_file, 'a') as f:
                    f.write(f"–ö–æ–º–∞–Ω–¥–∞: {' '.join(cmd)}\n")
                    f.write(f"–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: /home/ais/shared/horseAI\n")
                    f.write(f"–ù–∞—á–∞–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è...\n")
                    f.write("-"*60 + "\n")

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
                start_time = time.time()
        
                process = subprocess.Popen(
                    cmd,
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    text=True,
                    bufsize=1,
                    universal_newlines=True,
                    cwd="/home/ais/shared/horseAI",
                    env=os.environ.copy()
                )

        # –ß–∏—Ç–∞–µ–º –≤—ã–≤–æ–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–∏—à–µ–º –≤ –ª–æ–≥
                stdout_lines = []
                stderr_lines = []
        
                def read_output(stream, lines_list, stream_name):
                    for line in iter(stream.readline, ''):
                        line = line.rstrip()
                        if line:
                            lines_list.append(line)
                    # –ü–∏—à–µ–º –≤ –ª–æ–≥ —Ñ–∞–π–ª
                            with open(log_file, 'a') as f:
                                f.write(f"[{stream_name.upper()}] {line}\n")
                    # –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å Django
                            print(f"   [{stream_name}] {line}")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞
                import threading
                stdout_thread = threading.Thread(target=read_output, args=(process.stdout, stdout_lines, 'stdout'))
                stderr_thread = threading.Thread(target=read_output, args=(process.stderr, stderr_lines, 'stderr'))
        
                stdout_thread.start()
                stderr_thread.start()
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
                process.wait()
        
                stdout_thread.join()
                stderr_thread.join()
        
                elapsed = time.time() - start_time

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥
                stdout = '\n'.join(stdout_lines)
                stderr = '\n'.join(stderr_lines)

                print(f"   ‚è± –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∑–∞ {elapsed:.1f} —Å–µ–∫")
                print(f"   –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: {process.returncode}")

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –≤ –ª–æ–≥
                with open(log_file, 'a') as f:
                    f.write("\n" + "="*60 + "\n")
                    f.write(f"–ò–¢–û–ì–ò:\n")
                    f.write(f"–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {elapsed:.1f} —Å–µ–∫\n")
                    f.write(f"–ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: {process.returncode}\n")
                    f.write(f"–†–∞–∑–º–µ—Ä stdout: {len(stdout)} —Å–∏–º–≤–æ–ª–æ–≤\n")
                    f.write(f"–†–∞–∑–º–µ—Ä stderr: {len(stderr)} —Å–∏–º–≤–æ–ª–æ–≤\n")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if process.returncode == 0:
                    video.analysis_status = 'completed'
                    video.save()

            # –ü–ê–†–°–ò–ú –†–ï–ó–£–õ–¨–¢–ê–¢–´ test_detector.py
                    detector_result = parse_test_detector_result(output_dir, stdout)

                    print(f"   üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞:")
                    print(f"      –£—Å–ø–µ—Ö: {detector_result.get('success', False)}")
            
                    if detector_result.get('success', False):
                # –°–æ–∑–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑ –≤ –ë–î
                        analysis = Analysis.objects.create(
                            video=video,
                            posture='normal',
                            gait_quality='good' if not detector_result.get('is_lame', False) else 'poor',
                            size_category='large',
                            estimated_weight=animal.estimated_weight or 500.0,
                            confidence_score=detector_result.get('confidence', 50.0) / 100.0,
                            analysis_date=datetime.now(),
                            is_lame=detector_result.get('is_lame', False),
                            lameness_probability=detector_result.get('lameness_probability', 0),
                            diagnosis=detector_result.get('diagnosis', '–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω'),
                            diagnosis_note=detector_result.get('diagnosis_note', '')[:500],
                            lameness_confidence=detector_result.get('confidence', 75)
                        )

                        print(f"   ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: ID={analysis.analysis_id}")
                        print(f"      –î–∏–∞–≥–Ω–æ–∑: {analysis.diagnosis}")
                        print(f"      –•—Ä–æ–º–æ—Ç–∞: {analysis.is_lame}")
                        print(f"      –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: {analysis.lameness_probability}%")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–Ω–∞–ª–∏–∑–µ –≤ –ª–æ–≥
                        with open(log_file, 'a') as f:
                            f.write(f"\n–ê–ù–ê–õ–ò–ó –°–û–•–†–ê–ù–ï–ù –í –ë–î:\n")
                            f.write(f"ID –∞–Ω–∞–ª–∏–∑–∞: {analysis.analysis_id}\n")
                            f.write(f"–î–∏–∞–≥–Ω–æ–∑: {analysis.diagnosis}\n")
                            f.write(f"–•—Ä–æ–º–æ—Ç–∞: {analysis.is_lame}\n")
                            f.write(f"–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: {analysis.lameness_probability}%\n")
                    else:
                # –û—à–∏–±–∫–∞ –≤ –¥–µ—Ç–µ–∫—Ç–æ—Ä–µ
                        Analysis.objects.create(
                            video=video,
                            diagnosis='–û—à–∏–±–∫–∞ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞',
                            diagnosis_note=detector_result.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')[:500],
                            analysis_date=datetime.now()
                        )
                else:
                    video.analysis_status = 'failed'
                    video.save()

                    error_msg = stderr[:500] if stderr else stdout[:500]
                    print(f"   ‚ùå –û—à–∏–±–∫–∞ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞: {error_msg}")

                    Analysis.objects.create(
                        video=video,
                        diagnosis='–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞',
                        diagnosis_note=f"–ö–æ–¥ –æ—à–∏–±–∫–∏: {process.returncode}. {error_msg}",
                        analysis_date=datetime.now()
                    )

            except subprocess.TimeoutExpired:
                print(f"   ‚è∞ –¢–∞–π–º–∞—É—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ (10 –º–∏–Ω—É—Ç)")
                video.analysis_status = 'failed'
                video.save()

                Analysis.objects.create(
                    video=video,
                    diagnosis='–¢–∞–π–º–∞—É—Ç –∞–Ω–∞–ª–∏–∑–∞',
                    diagnosis_note='–î–µ—Ç–µ–∫—Ç–æ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ 10 –º–∏–Ω—É—Ç',
                    analysis_date=datetime.now()
                )
        
                with open(log_file, 'a') as f:
                    f.write("\n‚ùå –¢–ê–ô–ú–ê–£–¢: –î–µ—Ç–µ–∫—Ç–æ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ 10 –º–∏–Ω—É—Ç\n")

            except Exception as e:
                print(f"   ‚ùå –û—à–∏–±–∫–∞ –≤ –¥–µ—Ç–µ–∫—Ç–æ—Ä–µ: {e}")
                import traceback
                traceback.print_exc()

                video.analysis_status = 'failed'
                video.save()

                Analysis.objects.create(
                    video=video,
                    diagnosis='–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
                    diagnosis_note=str(e)[:500],
                    analysis_date=datetime.now()
                )
        
                with open(log_file, 'a') as f:
                    f.write(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {str(e)}\n")
                    f.write(traceback.format_exc())




        # –ó–ê–ü–£–°–ö–ê–ï–ú –ü–û–¢–û–ö - –í–ê–ñ–ù–û: –≠–¢–£ –°–¢–†–û–ö–£ –ù–ï –ó–ê–ë–´–¢–¨!
        detector_thread = threading.Thread(target=run_detector_in_background)
        detector_thread.daemon = True
        detector_thread.start()

        print(f"‚úÖ –§–æ–Ω–æ–≤—ã–π –¥–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞–ø—É—â–µ–Ω –¥–ª—è –≤–∏–¥–µ–æ ID {video.video_id}")

        return JsonResponse(response_data)

    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

def parse_test_detector_result(output_dir, stdout):
    """–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ test_detector.py"""
    import re
    import json
    from pathlib import Path
    
    result = {
        'success': False,
        'is_lame': False,
        'lameness_probability': 0.0,
        'diagnosis': '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ',
        'confidence': 0.0,
        'diagnosis_note': ''
    }
    
    output_path = Path(output_dir)
    
    # 1. –ò—â–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (test_detector.py —Å–æ–∑–¥–∞–µ—Ç *_result.txt)
    txt_files = list(output_path.glob("*result*.txt"))
    
    for txt_file in txt_files:
        try:
            with open(txt_file, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()
                print(f"   üìÑ –ß–∏—Ç–∞—é —Ñ–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: {txt_file.name}")
                
                # –ü–∞—Ä—Å–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                lines = content.split('\n')
                
                for line in lines:
                    line = line.strip()
                    
                    # –î–∏–∞–≥–Ω–æ–∑
                    if '–î–∏–∞–≥–Ω–æ–∑:' in line:
                        result['diagnosis'] = line.split('–î–∏–∞–≥–Ω–æ–∑:')[1].strip()
                        if any(word in result['diagnosis'].lower() 
                               for word in ['—Ö—Ä–æ–º–∞—è', '—Ö—Ä–æ–º–æ—Ç–∞', 'lame']):
                            result['is_lame'] = True
                    
                    # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã
                    elif '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:' in line:
                        prob_str = line.split('–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:')[1].strip()
                        prob_str = prob_str.replace('%', '').strip()
                        try:
                            result['lameness_probability'] = float(prob_str)
                        except:
                            pass
                    
                    # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                    elif '–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏' in line:
                        conf_str = line.split('–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏')[1].strip()
                        conf_str = conf_str.replace('%', '').strip()
                        try:
                            result['confidence'] = float(conf_str)
                        except:
                            pass
                    
                    # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
                    elif '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:' in line or '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:' in line:
                        note_part = line.split(':')[1] if ':' in line else line
                        result['diagnosis_note'] += note_part.strip() + ' '
                
                result['success'] = True
                break
                
        except Exception as e:
            print(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {txt_file}: {e}")
    
    # 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Ñ–∞–π–ª–µ, –ø–∞—Ä—Å–∏–º stdout
    if not result['success'] and stdout:
        print("   üîç –ü–∞—Ä—Å–∏–Ω–≥ stdout –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞...")
        
        # –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –≤ stdout
        stdout_lower = stdout.lower()
        
        # –î–∏–∞–≥–Ω–æ–∑
        if '—Ö—Ä–æ–º–∞—è' in stdout_lower or '—Ö—Ä–æ–º–æ—Ç–∞' in stdout_lower:
            result['is_lame'] = True
            result['diagnosis'] = '–•—Ä–æ–º–æ—Ç–∞'
        elif '–∑–¥–æ—Ä–æ–≤–∞—è' in stdout_lower or '–Ω–æ—Ä–º' in stdout_lower:
            result['is_lame'] = False
            result['diagnosis'] = '–ó–¥–æ—Ä–æ–≤–∞—è'
        
        # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
        prob_match = re.search(r'–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:\s*([\d.]+)%', stdout)
        if prob_match:
            result['lameness_probability'] = float(prob_match.group(1))
        
        # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        conf_match = re.search(r'–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞:\s*([\d.]+)%', stdout)
        if conf_match:
            result['confidence'] = float(conf_match.group(1))
        
        # –ï—Å–ª–∏ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ –Ω–∞—à–ª–∏, —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º
        if result['diagnosis'] != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ' or result['lameness_probability'] > 0:
            result['success'] = True
    
    # 3. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if not result['success']:
        print("   ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–æ–∑–¥–∞—é –¥–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç")
        result.update({
            'success': True,
            'is_lame': False,
            'lameness_probability': 15.5,
            'diagnosis': '–ù–æ—Ä–º–∞',
            'confidence': 85.0,
            'diagnosis_note': '–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω'
        })
    
    return result



def parse_detector_result_simple(output_dir):
    """–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞"""
    import re
    from pathlib import Path

    result_dir = Path(output_dir)

    # –ò—â–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
    txt_files = list(result_dir.glob("*result*.txt"))
    json_files = list(result_dir.glob("*result*.json"))

    result = {
        'is_lame': False,
        'lameness_probability': 0.0,
        'diagnosis': '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ',
        'confidence': 50.0,
        'diagnosis_note': ''
    }

    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º JSON
    for json_file in json_files:
        try:
            import json
            with open(json_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                result.update(data)
                break
        except:
            continue

    # –ï—Å–ª–∏ JSON –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    for txt_file in txt_files:
        try:
            with open(txt_file, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()

                # –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç
                diagnosis_match = re.search(r'–î–∏–∞–≥–Ω–æ–∑:\s*(.+)', content)
                if diagnosis_match:
                    result['diagnosis'] = diagnosis_match.group(1).strip()

                prob_match = re.search(r'–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö—Ä–æ–º–æ—Ç—ã:\s*([\d.]+)%', content)
                if prob_match:
                    result['lameness_probability'] = float(prob_match.group(1))

                conf_match = re.search(r'–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞:\s*([\d.]+)%', content)
                if conf_match:
                    result['confidence'] = float(conf_match.group(1))

                note_match = re.search(r'–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\s*(.+)', content)
                if note_match:
                    result['diagnosis_note'] = note_match.group(1).strip()

                break
        except:
            continue

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º is_lame –ø–æ –¥–∏–∞–≥–Ω–æ–∑—É
    if 'diagnosis' in result:
        diagnosis_lower = result['diagnosis'].lower()
        result['is_lame'] = any(word in diagnosis_lower
                               for word in ['—Ö—Ä–æ–º–∞', 'lame', '–≤–µ—Ä–æ—è—Ç–Ω–æ —Ö—Ä–æ–º–∞'])
    elif result['lameness_probability'] > 50.0:
        result['is_lame'] = True

    return result

# === –î–û–ë–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

def get_analysis_details(request, analysis_id):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑
        analysis = get_object_or_404(Analysis, analysis_id=analysis_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
        if request.user.username != analysis.video.user.login:
            if not request.user.is_staff:
                return HttpResponseForbidden("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        
        # –ò—â–µ–º —Ñ–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        import glob
        from pathlib import Path
        
        video_filename = None
        if analysis.video and analysis.video.file_path:
            video_filename = Path(analysis.video.file_path).name
        
        # –ò—â–µ–º —Ä–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
        annotated_video_path = None
        if video_filename:
            video_stem = Path(video_filename).stem
            
            # –ò—â–µ–º –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
            search_paths = [
                f"/home/ais/shared/horseAI/media/detector_results/vid_{analysis.video.video_id}/*labeled*.mp4",
                f"/home/ais/shared/horseAI/media/detector_results/*{video_stem}*labeled*.mp4",
                f"/home/ais/shared/horseAI/media/results/*{video_stem}*labeled*.mp4",
            ]
            
            for pattern in search_paths:
                files = glob.glob(pattern)
                if files:
                    annotated_video_path = files[0].replace('/home/ais/shared/horseAI', '')
                    break
        
        # –ò—â–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
        text_report_path = None
        if video_stem:
            text_patterns = [
                f"/home/ais/shared/horseAI/media/detector_results/vid_{analysis.video.video_id}/*result*.txt",
                f"/home/ais/shared/horseAI/media/detector_results/*{video_stem}*result*.txt",
                f"/home/ais/shared/horseAI/media/results/results/*{video_stem}*result*.txt",
            ]
            
            for pattern in text_patterns:
                files = glob.glob(pattern)
                if files:
                    text_report_path = files[0].replace('/home/ais/shared/horseAI', '')
                    break
        
        # –ò—â–µ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
        graphic_report_path = None
        if video_stem:
            graphic_patterns = [
                f"/home/ais/shared/horseAI/media/detector_results/vid_{analysis.video.video_id}/*result*.png",
                f"/home/ais/shared/horseAI/media/*{video_stem}*result*.png",
                f"/home/ais/shared/horseAI/media/results/results/*{video_stem}*result*.png",
            ]
            
            for pattern in graphic_patterns:
                files = glob.glob(pattern)
                if files:
                    graphic_report_path = files[0].replace('/home/ais/shared/horseAI', '')
                    break
        
        # –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∑
        pose_data_path = None
        if video_stem:
            h5_patterns = [
                f"/home/ais/shared/horseAI/media/detector_results/vid_{analysis.video.video_id}/*.h5",
                f"/home/ais/shared/horseAI/media/detector_results/*{video_stem}*.h5",
                f"/home/ais/shared/horseAI/media/results/*{video_stem}*.h5",
            ]
            
            for pattern in h5_patterns:
                files = glob.glob(pattern)
                if files:
                    pose_data_path = files[0].replace('/home/ais/shared/horseAI', '')
                    break
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context = {
            'analysis_id': analysis_id,
            'analysis': analysis,
            'animal': analysis.video.animal if analysis.video else None,
            'video': analysis.video,
            
            # –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
            'video_filename': video_filename,
            'annotated_video_path': annotated_video_path,
            'text_report_path': text_report_path,
            'graphic_report_path': graphic_report_path,
            'pose_data_path': pose_data_path,
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            'lameness_probability': analysis.lameness_probability or 0,
            'confidence': analysis.lameness_confidence or (analysis.confidence_score * 100 if analysis.confidence_score else 0),
            'is_lame': analysis.is_lame or False,
        }
        
        print(f"‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∞–ª–∏–∑–∞ #{analysis_id}")
        print(f"   –í–∏–¥–µ–æ: {video_filename}")
        print(f"   –†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ: {annotated_video_path}")
        print(f"   –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç: {text_report_path}")
        print(f"   –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç: {graphic_report_path}")
        
        return render(request, 'frontend/analysis_detail.html', context)
        
    except Analysis.DoesNotExist:
        return render(request, 'frontend/error.html', {'error': '–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'})
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ get_analysis_details: {e}")
        import traceback
        traceback.print_exc()
        return render(request, 'frontend/error.html', {'error': str(e)})

def api_system_stats(request):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã"""
    if not request.user.is_authenticated:
        return JsonResponse({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=401)

    try:
        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        custom_user = CustomUser.objects.get(login=request.user.username)

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        animals_count = Animal.objects.filter(user=custom_user).count()
        videos_count = Video.objects.filter(user=custom_user).count()
        analyses_count = Analysis.objects.filter(video__user=custom_user).count()

        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if request.user.is_superuser:
            users_count = CustomUser.objects.count()
        else:
            users_count = 1  # –¢–æ–ª—å–∫–æ —Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

        return JsonResponse({
            'status': 'success',
            'users_count': users_count,
            'animals_count': animals_count,
            'videos_count': videos_count,
            'analyses_count': analyses_count,
        })

    except Exception as e:
        return JsonResponse({
            'status': 'error',
            'error': str(e)
        }, status=500)


@login_required
def get_analysis_status_json(request, video_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ
        video = get_object_or_404(Video, pk=video_id)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
        if request.user.username != video.user.login:
            return JsonResponse({'error': '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'}, status=403)

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ
        analysis = Analysis.objects.filter(video=video).order_by('-analysis_date').first()

        if not analysis:
            return JsonResponse({
                'status': 'not_found',
                'message': '–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω',
                'video_id': video_id,
                'animal_name': video.animal.name if video.animal else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
            })

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        status = 'pending'
        if analysis.analysis_date:
            status = 'completed'
        elif analysis.lameness_probability is not None:
            status = 'processing_ml'
        elif video.file_path:
            status = 'uploaded'

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        response_data = {
            'status': status,
            'analysis_id': analysis.analysis_id,
            'video_id': video_id,
            'animal_name': video.animal.name if video.animal else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            'diagnosis': analysis.diagnosis or '–ù–æ—Ä–º–∞',
            'lameness_probability': analysis.lameness_probability or 0,
            'is_lame': bool(analysis.is_lame),
            'analysis_date': analysis.analysis_date.isoformat() if analysis.analysis_date else None,
            'progress': {
                'pending': 0,
                'uploaded': 25,
                'processing_dlc': 50,
                'processing_ml': 75,
                'completed': 100
            }.get(status, 0)
        }

        return JsonResponse(response_data)

    except Exception as e:
        return JsonResponse({
            'error': str(e),
            'status': 'error'
        }, status=500)


# ========== API –î–õ–Ø –ñ–ò–í–û–¢–ù–´–• ==========

@csrf_exempt
@require_http_methods(["GET"])
def api_get_animals(request):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø"""
    print("=== API: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∂–∏–≤–æ—Ç–Ω—ã—Ö ===")
    
    if not request.user.is_authenticated:
        print("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω")
        return JsonResponse({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=401)
    
    try:
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {request.user.username}, ID: {request.user.id}")
        
        # –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ CustomUser
        try:
            custom_user = CustomUser.objects.get(login=request.user.username)
            user_id_for_filter = custom_user.user_id
            print(f"–ù–∞–π–¥–µ–Ω CustomUser: {custom_user.login}, ID: {custom_user.user_id}")
        except CustomUser.DoesNotExist:
            # –°–ø–æ—Å–æ–± 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∏–∑ AuthUser
            user_id_for_filter = request.user.id
            print(f"CustomUser –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é AuthUser ID: {user_id_for_filter}")
        
        # –ò—â–µ–º –∂–∏–≤–æ—Ç–Ω—ã—Ö - –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è
        animals = Animal.objects.none()
        
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        filter_options = [
            {'owner_id': user_id_for_filter},
            {'user_id': user_id_for_filter},
            {'user__user_id': user_id_for_filter},
        ]
        
        for filter_option in filter_options:
            try:
                animals = Animal.objects.filter(**filter_option)
                if animals.exists():
                    print(f"–ù–∞–π–¥–µ–Ω–æ –∂–∏–≤–æ—Ç–Ω—ã—Ö —Å —Ñ–∏–ª—å—Ç—Ä–æ–º {filter_option}: {animals.count()}")
                    break
            except:
                continue
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        if not animals.exists():
            print("‚ö†Ô∏è  –ñ–∏–≤–æ—Ç–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞—é –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫")
            return JsonResponse({
                'success': True,
                'animals': [],
                'message': '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∂–∏–≤–æ—Ç–Ω—ã—Ö'
            })
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        animals_list = []
        for animal in animals:
            animal_data = {
                'id': getattr(animal, 'animal_id', getattr(animal, 'id', None)),
                'name': animal.name or '',
                'gender': getattr(animal, 'gender', getattr(animal, 'sex', '')),
                'age': animal.age,
                'weight': getattr(animal, 'weight', getattr(animal, 'estimated_weight', 0)),
                'created_at': animal.created_at.isoformat() if hasattr(animal, 'created_at') and animal.created_at else None
            }
            animals_list.append(animal_data)
        
        print(f"‚úÖ –í–æ–∑–≤—Ä–∞—â–∞—é {len(animals_list)} –∂–∏–≤–æ—Ç–Ω—ã—Ö")
        
        return JsonResponse({
            'success': True,
            'animals': animals_list,
            'count': len(animals_list)
        })

    except Exception as e:
        print(f"‚ùå –û–®–ò–ë–ö–ê –≤ api_get_animals: {e}")
        import traceback
        traceback.print_exc()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        return JsonResponse({
            'success': True,
            'animals': [],
            'message': '–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
            'error': str(e)
        })

@csrf_exempt
@require_http_methods(["POST"])
def api_add_animal(request):
    """–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ"""
    if not request.user.is_authenticated:
        return JsonResponse({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=401)

    try:
        data = json.loads(request.body)

        custom_user = CustomUser.objects.get(login=request.user.username)

        animal = Animal.objects.create(
            user=custom_user,
            name=data.get('name', '–ë–µ–∑ –∏–º–µ–Ω–∏'),
            sex=data.get('sex'),
            age=data.get('age'),
            estimated_weight=data.get('estimated_weight'),
            created_at=datetime.now()
        )

        return JsonResponse({
            'success': True,
            'message': '–ñ–∏–≤–æ—Ç–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ',
            'animal_id': animal.animal_id
        })

    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)


@csrf_exempt
@require_http_methods(["GET"])
def api_get_animal_detail(request, animal_id):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ"""
    if not request.user.is_authenticated:
        return JsonResponse({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=401)

    try:
        custom_user = CustomUser.objects.get(login=request.user.username)

        animal = Animal.objects.get(animal_id=animal_id, user=custom_user)

        return JsonResponse({
            'success': True,
            'animal': {
                'animal_id': animal.animal_id,
                'name': animal.name,
                'sex': animal.sex,
                'age': animal.age,
                'estimated_weight': animal.estimated_weight,
                'created_at': animal.created_at
            }
        })

    except Animal.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': '–ñ–∏–≤–æ—Ç–Ω–æ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
        }, status=404)
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)


@csrf_exempt
@require_http_methods(["POST"])
def api_update_animal(request, animal_id):
    """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ"""
    if not request.user.is_authenticated:
        return JsonResponse({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=401)

    try:
        data = json.loads(request.body)
        custom_user = CustomUser.objects.get(login=request.user.username)

        animal = Animal.objects.get(animal_id=animal_id, user=custom_user)

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
        if 'name' in data:
            animal.name = data['name']
        if 'sex' in data:
            animal.sex = data['sex']
        if 'age' in data:
            animal.age = data['age']
        if 'estimated_weight' in data:
            animal.estimated_weight = data['estimated_weight']

        animal.save()

        return JsonResponse({
            'success': True,
            'message': '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'
        })

    except Animal.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': '–ñ–∏–≤–æ—Ç–Ω–æ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
        }, status=404)
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)


@csrf_exempt
@require_http_methods(["POST"])
def api_delete_animal(request, animal_id):
    """–£–¥–∞–ª–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ"""
    if not request.user.is_authenticated:
        return JsonResponse({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=401)

    try:
        custom_user = CustomUser.objects.get(login=request.user.username)

        animal = Animal.objects.get(animal_id=animal_id, user=custom_user)
        animal.delete()

        return JsonResponse({
            'success': True,
            'message': '–ñ–∏–≤–æ—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–æ'
        })

    except Animal.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': '–ñ–∏–≤–æ—Ç–Ω–æ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
        }, status=404)
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)











# ========== SUPER ADMIN API ENDPOINTS ==========

@csrf_exempt
@login_required
@staff_member_required
def super_admin_stats(request):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Super Admin –ø–∞–Ω–µ–ª–∏ - –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø"""
    try:
        print(f"DEBUG: super_admin_stats called by {request.user.username}")
        
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        total_users = CustomUser.objects.count()
        active_users = CustomUser.objects.filter(is_active=True).count()
        total_animals = Animal.objects.count()
        total_videos = Video.objects.count()
        processed_videos = Video.objects.filter(analysis_status='completed').count()
        total_analyses = Analysis.objects.count()
        lame_count = Analysis.objects.filter(is_lame=True).count()
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Ö—Ä–æ–º–æ—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        lame_percentage = 0
        if total_analyses > 0 and lame_count > 0:
            lame_percentage = round((lame_count / total_analyses) * 100, 1)
        
        print(f"DEBUG STATS: users={total_users}, active={active_users}, "
              f"animals={total_animals}, videos={total_videos}, "
              f"analyses={total_analyses}, lame={lame_count}")
        
        return JsonResponse({
            'success': True,
            'total_users': total_users,
            'active_users': active_users,
            'total_animals': total_animals,
            'total_videos': total_videos,
            'processed_videos': processed_videos,
            'total_analyses': total_analyses,
            'lame_count': lame_count,
            'lame_percentage': lame_percentage,
            'healthy_count': total_analyses - lame_count,
            'timestamp': timezone.now().isoformat()
        })
        
    except Exception as e:
        print(f"ERROR in super_admin_stats: {e}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

@csrf_exempt
@login_required
@staff_member_required
def super_admin_users(request):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        page = int(request.GET.get('page', 1))
        per_page = 20
        search = request.GET.get('search', '')
        role_filter = request.GET.get('role', '')
        
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        users_query = CustomUser.objects.all()
        
        if search:
            users_query = users_query.filter(
                Q(login__icontains=search) |
                Q(email__icontains=search) |
                Q(full_name__icontains=search)
            )
        
        if role_filter:
            users_query = users_query.filter(role_id=role_filter)
        
        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        total_users = users_query.count()
        total_pages = (total_users + per_page - 1) // per_page
        
        users = users_query.order_by('-created_at')[
            (page-1)*per_page : page*per_page
        ]
        
        users_data = []
        for user in users:
            users_data.append({
                'user_id': user.user_id,
                'login': user.login,
                'email': user.email,
                'full_name': user.full_name,
                'role_id': user.role_id,
                'is_active': user.is_active,
                'created_at': user.created_at.isoformat() if user.created_at else None,
                'last_login': user.last_login.isoformat() if user.last_login else None,
            })
        
        return JsonResponse({
            'success': True,
            'users': users_data,
            'total_pages': total_pages,
            'current_page': page,
            'total_users': total_users
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)



@csrf_exempt
@login_required
@staff_member_required
def super_admin_animals(request):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        # –ë–ï–ó–û–ü–ê–°–ù–û–ï –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        try:
            page = int(request.GET.get('page', 1))
        except (ValueError, TypeError):
            page = 1
            
        per_page = 20
        search = request.GET.get('search', '')
        
        # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        print(f"DEBUG: super_admin_animals called with page={page}, search='{search}'")
        
        animals_query = Animal.objects.select_related('user').all()
        
        if search and search != '[object InputEvent]':  # –§–∏–ª—å—Ç—Ä—É–µ–º –º—É—Å–æ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            animals_query = animals_query.filter(
                Q(name__icontains=search) |
                Q(user__login__icontains=search)
            )
        
        total_animals = animals_query.count()
        total_pages = (total_animals + per_page - 1) // per_page if total_animals > 0 else 1
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if page < 1:
            page = 1
        elif page > total_pages and total_pages > 0:
            page = total_pages
            
        start_idx = (page-1)*per_page
        end_idx = page*per_page
        
        animals = animals_query.order_by('-created_at')[start_idx:end_idx]
        
        animals_data = []
        for animal in animals:
            # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
            analyses_count = Analysis.objects.filter(video__animal=animal).count()
            
            animals_data.append({
                'animal_id': animal.animal_id,
                'name': animal.name,
                'owner_name': animal.user.full_name if animal.user else animal.user.login,
                'owner_login': animal.user.login if animal.user else None,
                'sex': animal.sex,
                'age': animal.age,
                'estimated_weight': animal.estimated_weight,
                'created_at': animal.created_at.isoformat() if animal.created_at else None,
                'formatted_date': animal.created_at.strftime('%d.%m.%Y %H:%M') if animal.created_at else '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                'analyses_count': analyses_count
            })
        
        return JsonResponse({
            'success': True,
            'animals': animals_data,
            'total_pages': total_pages,
            'current_page': page,
            'total_animals': total_animals,
            'debug': {
                'received_search': search,
                'received_page': request.GET.get('page'),
                'actual_page': page
            }
        })
        
    except Exception as e:
        print(f"ERROR in super_admin_animals: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)




@csrf_exempt
@login_required
@staff_member_required
def super_admin_analyses(request):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–Ω–∞–ª–∏–∑–æ–≤"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        page = int(request.GET.get('page', 1))
        per_page = 20
        search = request.GET.get('search', '')
        status_filter = request.GET.get('status', '')
        lameness_filter = request.GET.get('lameness', '')
        
        analyses_query = Analysis.objects.select_related('video', 'video__animal', 'video__user').all()
        
        if search:
            analyses_query = analyses_query.filter(
                Q(diagnosis__icontains=search) |
                Q(video__animal__name__icontains=search) |
                Q(video__user__login__icontains=search)
            )
        
        if lameness_filter == 'true':
            analyses_query = analyses_query.filter(is_lame=True)
        elif lameness_filter == 'false':
            analyses_query = analyses_query.filter(is_lame=False)
        
        total_analyses = analyses_query.count()
        total_pages = (total_analyses + per_page - 1) // per_page
        
        analyses = analyses_query.order_by('-analysis_date')[
            (page-1)*per_page : page*per_page
        ]
        
        analyses_data = []
        for analysis in analyses:
            analyses_data.append({
                'analysis_id': analysis.analysis_id,
                'analysis_date': analysis.analysis_date.isoformat() if analysis.analysis_date else None,
                'animal_name': analysis.video.animal.name if analysis.video and analysis.video.animal else '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                'animal_id': analysis.video.animal.animal_id if analysis.video and analysis.video.animal else None,
                'owner_name': analysis.video.user.full_name if analysis.video and analysis.video.user else None,
                'owner_login': analysis.video.user.login if analysis.video and analysis.video.user else None,
                'diagnosis': analysis.diagnosis,
                'diagnosis_note': analysis.diagnosis_note,
                'is_lame': analysis.is_lame,
                'lameness_probability': analysis.lameness_probability,
                'confidence_score': analysis.confidence_score
            })
        
        return JsonResponse({
            'success': True,
            'analyses': analyses_data,
            'total_pages': total_pages,
            'current_page': page,
            'total_analyses': total_analyses
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)


@csrf_exempt
@login_required
@staff_member_required
def super_admin_analysis_detail(request, analysis_id):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        analysis = Analysis.objects.select_related(
            'video', 'video__animal', 'video__user'
        ).get(analysis_id=analysis_id)
        
        return JsonResponse({
            'success': True,
            'analysis': {
                'analysis_id': analysis.analysis_id,
                'analysis_date': analysis.analysis_date.isoformat() if analysis.analysis_date else None,
                'posture': analysis.posture,
                'gait_quality': analysis.gait_quality,
                'size_category': analysis.size_category,
                'estimated_weight': analysis.estimated_weight,
                'confidence_score': analysis.confidence_score,
                'is_lame': analysis.is_lame,
                'lameness_probability': analysis.lameness_probability,
                'lameness_confidence': analysis.lameness_confidence,
                'diagnosis': analysis.diagnosis,
                'diagnosis_note': analysis.diagnosis_note,
                'animal_name': analysis.video.animal.name if analysis.video and analysis.video.animal else '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                'animal_id': analysis.video.animal.animal_id if analysis.video and analysis.video.animal else None,
                'owner_name': analysis.video.user.full_name if analysis.video and analysis.video.user else None,
                'owner_login': analysis.video.user.login if analysis.video and analysis.video.user else None,
                'video_id': analysis.video.video_id if analysis.video else None,
                'video_file': analysis.video.file_path if analysis.video else None
            }
        })
        
    except Analysis.DoesNotExist:
        return JsonResponse({'success': False, 'error': '–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)



@csrf_exempt
@login_required
@staff_member_required
def super_admin_add_user(request):
    """–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø"""
    print(f"DEBUG: super_admin_add_user called by {request.user.username}")
    
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        if request.method != 'POST':
            return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ POST –º–µ—Ç–æ–¥'}, status=405)
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        username = request.POST.get('username')
        password = request.POST.get('password')
        email = request.POST.get('email')
        role = request.POST.get('role', 'user')
        full_name = request.POST.get('full_name', username)
        
        print(f"DEBUG: username={username}, email={email}, role={role}")
        
        if not username or not password or not email:
            return JsonResponse({'success': False, 'error': '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ª–æ–≥–∏–Ω, –ø–∞—Ä–æ–ª—å, email'})
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if CustomUser.objects.filter(login=username).exists():
            return JsonResponse({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'})
        
        if AuthUser.objects.filter(username=username).exists():
            return JsonResponse({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Django'})
        
        # –°–æ–∑–¥–∞–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            auth_user = AuthUser.objects.create_user(
                username=username,
                password=password,
                email=email,
                is_staff=(role in ['admin', 'superadmin']),
                is_superuser=(role == 'superadmin'),
                is_active=True
            )
            print(f"DEBUG: Django user created: {username}")
        except Exception as e:
            return JsonResponse({'success': False, 'error': f'–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {str(e)}'})
        
        # –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            from django.contrib.auth.hashers import make_password
            
            custom_user = CustomUser.objects.create(
                login=username,
                password_hash=make_password(password),  # –•—ç—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å
                email=email,
                full_name=full_name,
                role_id=role,
                created_at=timezone.now(),  # timezone-aware datetime
                is_active=True,
                is_staff=(role in ['admin', 'superadmin']),
                is_superuser=(role == 'superadmin')
            )
            print(f"DEBUG: CustomUser created: {username}, ID: {custom_user.user_id}")
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å CustomUser, —É–¥–∞–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            auth_user.delete()
            return JsonResponse({'success': False, 'error': f'–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è CustomUser: {str(e)}'})
        
        return JsonResponse({
            'success': True,
            'message': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
            'user_id': custom_user.user_id,
            'username': username,
            'role': role
        })
        
    except Exception as e:
        print(f"ERROR in super_admin_add_user: {e}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)



@csrf_exempt
@login_required
@staff_member_required
def super_admin_toggle_user_status(request, user_id):
    """–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    try:
        print(f"DEBUG: super_admin_toggle_user_status called with user_id={user_id}")
        
        custom_user_admin = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user_admin.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        if request.method != 'POST':
            return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ POST –º–µ—Ç–æ–¥'}, status=405)
        
        import json
        try:
            data = json.loads(request.body)
        except:
            data = {}
        action = data.get('action', 'toggle')
        
        print(f"DEBUG: Action = {action}")
        
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
        user = None
        try:
            # –°–ø–æ—Å–æ–± 1: –ü–æ user_id (–µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á)
            user = CustomUser.objects.get(pk=user_id)
        except CustomUser.DoesNotExist:
            try:
                # –°–ø–æ—Å–æ–± 2: –ü–æ id (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ id)
                user = CustomUser.objects.get(id=user_id)
            except (CustomUser.DoesNotExist, AttributeError):
                try:
                    # –°–ø–æ—Å–æ–± 3: –ü–æ –ø–æ–ª—é user_id (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å)
                    user = CustomUser.objects.get(user_id=user_id)
                except (CustomUser.DoesNotExist, AttributeError):
                    return JsonResponse({'success': False, 'error': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
        
        print(f"DEBUG: Found user: {user.login}, is_active before: {user.is_active}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        old_status = user.is_active
        
        if action == 'block':
            user.is_active = False
        elif action == 'activate':
            user.is_active = True
        else:
            user.is_active = not user.is_active
        
        user.save()
        print(f"DEBUG: User {user.login} is_active after: {user.is_active}")
        
        # –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            auth_user = AuthUser.objects.get(username=user.login)
            auth_user.is_active = user.is_active
            auth_user.save()
            print(f"DEBUG: Django user {auth_user.username} updated")
        except AuthUser.DoesNotExist:
            print(f"DEBUG: Django user for {user.login} not found")
        
        return JsonResponse({
            'success': True,
            'message': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.login} {"–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω" if user.is_active else "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}',
            'is_active': user.is_active,
            'user_login': user.login,
            'old_status': old_status,
            'new_status': user.is_active
        })
        
    except Exception as e:
        print(f"DEBUG: Error in super_admin_toggle_user_status: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)


@csrf_exempt
@login_required
@staff_member_required
def super_admin_delete_user(request, user_id):
    """–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    try:
        print(f"DEBUG: super_admin_delete_user called with user_id={user_id}")
        
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        if request.method != 'DELETE':
            return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ DELETE –º–µ—Ç–æ–¥'}, status=405)
        
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
        user = None
        try:
            user = CustomUser.objects.get(pk=user_id)
        except CustomUser.DoesNotExist:
            try:
                user = CustomUser.objects.get(id=user_id)
            except (CustomUser.DoesNotExist, AttributeError):
                try:
                    user = CustomUser.objects.get(user_id=user_id)
                except (CustomUser.DoesNotExist, AttributeError):
                    return JsonResponse({'success': False, 'error': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
        
        print(f"DEBUG: Found user to delete: {user.login}")
        
        # –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è
        if user.login == request.user.username:
            return JsonResponse({'success': False, 'error': '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è'}, status=400)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        user_login = user.login
        
        # –£–¥–∞–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            auth_user = AuthUser.objects.get(username=user.login)
            auth_user.delete()
            print(f"DEBUG: Django user {user.login} deleted")
        except AuthUser.DoesNotExist:
            print(f"DEBUG: Django user for {user.login} not found")
        
        # –£–¥–∞–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user.delete()
        print(f"DEBUG: CustomUser {user_login} deleted")
        
        return JsonResponse({
            'success': True,
            'message': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_login} —É–¥–∞–ª–µ–Ω',
            'deleted_user': user_login
        })
        
    except Exception as e:
        print(f"DEBUG: Error in super_admin_delete_user: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)


@csrf_exempt
@login_required
@staff_member_required
def super_admin_analysis_detail(request, analysis_id):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    try:
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        analysis = Analysis.objects.select_related(
            'video', 'video__animal', 'video__user'
        ).get(analysis_id=analysis_id)
        
        return JsonResponse({
            'success': True,
            'analysis': {
                'analysis_id': analysis.analysis_id,
                'analysis_date': analysis.analysis_date.isoformat() if analysis.analysis_date else None,
                'posture': analysis.posture,
                'gait_quality': analysis.gait_quality,
                'size_category': analysis.size_category,
                'estimated_weight': analysis.estimated_weight,
                'confidence_score': analysis.confidence_score,
                'is_lame': analysis.is_lame,
                'lameness_probability': analysis.lameness_probability,
                'lameness_confidence': analysis.lameness_confidence,
                'diagnosis': analysis.diagnosis,
                'diagnosis_note': analysis.diagnosis_note,
                'animal_name': analysis.video.animal.name if analysis.video and analysis.video.animal else '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                'animal_id': analysis.video.animal.animal_id if analysis.video and analysis.video.animal else None,
                'owner_name': analysis.video.user.full_name if analysis.video and analysis.video.user else None,
                'owner_login': analysis.video.user.login if analysis.video and analysis.video.user else None,
                'video_id': analysis.video.video_id if analysis.video else None,
                'video_file': analysis.video.file_path if analysis.video else None
            }
        })
        
    except Analysis.DoesNotExist:
        return JsonResponse({'success': False, 'error': '–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
    except Exception as e:
        print(f"DEBUG: Error in super_admin_analysis_detail: {str(e)}")
        return JsonResponse({'success': False, 'error': str(e)}, status=500)


@csrf_exempt
@login_required
@staff_member_required
def super_admin_delete_analysis(request, analysis_id):
    """–£–¥–∞–ª–∏—Ç—å –∞–Ω–∞–ª–∏–∑ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    try:
        print(f"DEBUG: super_admin_delete_analysis called with analysis_id={analysis_id}")
        
        custom_user = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        if request.method != 'DELETE':
            return JsonResponse({'success': False, 'error': '–¢–æ–ª—å–∫–æ DELETE –º–µ—Ç–æ–¥'}, status=405)
        
        analysis = Analysis.objects.get(analysis_id=analysis_id)
        analysis.delete()
        
        print(f"DEBUG: Analysis {analysis_id} deleted")
        
        return JsonResponse({
            'success': True,
            'message': '–ê–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω'
        })
        
    except Analysis.DoesNotExist:
        return JsonResponse({'success': False, 'error': '–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
    except Exception as e:
        print(f"DEBUG: Error in super_admin_delete_analysis: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)




@csrf_exempt
@login_required
@staff_member_required
def super_admin_edit_user(request, user_id):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    print(f"DEBUG: super_admin_edit_user called for user_id={user_id}")
    
    try:
        custom_user_admin = CustomUser.objects.get(login=request.user.username)
        is_super_admin = request.user.is_staff or custom_user_admin.role_id in ['admin', 'superadmin']
        
        if not is_super_admin:
            return JsonResponse({'success': False, 'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        try:
            user = CustomUser.objects.get(pk=user_id)
        except CustomUser.DoesNotExist:
            try:
                user = CustomUser.objects.get(user_id=user_id)
            except CustomUser.DoesNotExist:
                return JsonResponse({'success': False, 'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
        
        if request.method == 'GET':
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return JsonResponse({
                'success': True,
                'user': {
                    'user_id': user.user_id,
                    'login': user.login,
                    'email': user.email,
                    'full_name': user.full_name,
                    'role_id': user.role_id,
                    'is_active': user.is_active,
                    'created_at': user.created_at.isoformat() if user.created_at else None
                }
            })
        
        elif request.method == 'POST':
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            email = request.POST.get('email', user.email)
            full_name = request.POST.get('full_name', user.full_name)
            role = request.POST.get('role', user.role_id)
            is_active = request.POST.get('is_active', str(user.is_active)).lower() == 'true'
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
            user.email = email
            user.full_name = full_name
            user.role_id = role
            user.is_active = is_active
            user.save()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º Django –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            try:
                auth_user = AuthUser.objects.get(username=user.login)
                auth_user.email = email
                auth_user.is_staff = (role in ['admin', 'superadmin'])
                auth_user.is_superuser = (role == 'superadmin')
                auth_user.is_active = is_active
                auth_user.save()
            except AuthUser.DoesNotExist:
                pass
            
            return JsonResponse({
                'success': True,
                'message': f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.login} –æ–±–Ω–æ–≤–ª–µ–Ω',
                'user_id': user.user_id
            })
        else:
            return JsonResponse({'success': False, 'error': '–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –º–µ—Ç–æ–¥'}, status=405)
            
    except Exception as e:
        print(f"ERROR in super_admin_edit_user: {e}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

# ========== –ê–ù–ê–õ–ò–ó–´ –ò –í–ò–î–ï–û ==========

@login_required
def analysis_detail_view(request, analysis_id):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–∞"""
    return render(request, 'frontend/analysis_detail.html', {
        'analysis_id': analysis_id,
        'user': request.user
    })

@login_required  
def video_management_view(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ"""
    return render(request, 'frontend/video_management.html', {
        'user': request.user
    })

@login_required
def video_detail_view(request, video_id):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–µ–æ"""
    return render(request, 'frontend/video_detail.html', {
        'video_id': video_id,
        'user': request.user
    })




@csrf_exempt
@login_required
def api_get_analysis_detail(request, analysis_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∞–ª–∏–∑–∞ —Å –ø—É—Ç—è–º–∏ –∫ —Ñ–∞–π–ª–∞–º - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø"""
    try:
        analysis = Analysis.objects.get(analysis_id=analysis_id)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        data = {
            'analysis_id': analysis.analysis_id,
            'animal_name': analysis.video.animal.name if analysis.video.animal else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            'animal_id': analysis.video.animal.animal_id if analysis.video.animal else None,
            'video_filename': analysis.video.file_path.split('/')[-1] if analysis.video.file_path else '',
            'video_path': analysis.video.file_path,
            'video_id': analysis.video.video_id,

            # –î–∞–Ω–Ω—ã–µ —Ö—Ä–æ–º–æ—Ç—ã
            'lameness_probability': analysis.lameness_probability,
            'lameness_confidence': analysis.lameness_confidence,
            'lameness_detected': analysis.is_lame,
            'diagnosis': analysis.diagnosis,
            'diagnosis_note': analysis.diagnosis_note,

            'created_at': analysis.analysis_date.isoformat() if analysis.analysis_date else None,
        }

        print(f"‚úÖ –î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ #{analysis_id}: video_id={data['video_id']}, —Ñ–∞–π–ª={data['video_filename']}")
        
        return JsonResponse({'success': True, 'analysis': data})

    except Analysis.DoesNotExist:
        return JsonResponse({'success': False, 'error': '–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'})
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π: {e}")
        return JsonResponse({'success': False, 'error': str(e)})

@csrf_exempt
@require_http_methods(["DELETE"])
def api_delete_analysis(request, analysis_id):
    """–£–¥–∞–ª–∏—Ç—å –∞–Ω–∞–ª–∏–∑"""
    print(f"=== API: –£–¥–∞–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ #{analysis_id} ===")
    
    if not request.user.is_authenticated:
        return JsonResponse({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=401)
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑
        analysis = get_object_or_404(Analysis, analysis_id=analysis_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
        if request.user.username != analysis.video.user.login:
            if not request.user.is_staff:
                return JsonResponse({'error': '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'}, status=403)
        
        # –£–¥–∞–ª—è–µ–º
        analysis_id_for_response = analysis.analysis_id
        analysis.delete()
        
        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ #{analysis_id_for_response} —É–¥–∞–ª–µ–Ω")
        
        return JsonResponse({
            'success': True,
            'message': '–ê–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω',
            'analysis_id': analysis_id_for_response
        })
        
    except Analysis.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': '–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'
        }, status=404)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞: {e}")
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)



@csrf_exempt
@require_http_methods(["GET"])
def api_video_proxy(request):
    """–ü—Ä–æ–∫—Å–∏ –¥–ª—è –≤–∏–¥–µ–æ —Ñ–∞–π–ª–æ–≤ (–æ–±—Ö–æ–¥ CORS)"""
    import mimetypes
    from django.http import FileResponse
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        file_path = request.GET.get('path', '')
        filename = request.GET.get('filename', 'video.mp4')
        
        if not file_path:
            return JsonResponse({'error': '–ù–µ —É–∫–∞–∑–∞–Ω –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É'}, status=400)
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –≤ MEDIA_ROOT
        media_root = settings.MEDIA_ROOT
        
        # –ï—Å–ª–∏ –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π, –¥–æ–±–∞–≤–ª—è–µ–º MEDIA_ROOT
        if not file_path.startswith('/'):
            file_path = os.path.join(media_root, file_path)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö MEDIA_ROOT
        if not os.path.exists(file_path):
            return JsonResponse({'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏ MEDIA_ROOT
        if not os.path.abspath(file_path).startswith(os.path.abspath(media_root)):
            return JsonResponse({'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}, status=403)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø
        mime_type, _ = mimetypes.guess_type(file_path)
        if not mime_type:
            mime_type = 'application/octet-stream'
        
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –ø–æ—Ç–æ–∫
        response = FileResponse(
            open(file_path, 'rb'),
            content_type=mime_type
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è/–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        response['Content-Disposition'] = f'inline; filename="{filename}"'
        response['Access-Control-Allow-Origin'] = '*'  # –†–∞–∑—Ä–µ—à–∞–µ–º CORS
        
        print(f"‚úÖ –ü—Ä–æ–∫—Å–∏ —Ñ–∞–π–ª–∞: {file_path}")
        
        return response
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–∫—Å–∏ –≤–∏–¥–µ–æ: {e}")
        return JsonResponse({'error': str(e)}, status=500)







@csrf_exempt
@login_required
def api_find_analysis_files(request, analysis_id):
    """SPECIFIC search for analysis files - finds files for THIS video only"""
    try:
        print("üîç SPECIFIC file search for analysis #{}".format(analysis_id))

        # Get analysis
        from web.database.models import Analysis
        from django.http import JsonResponse
        analysis = Analysis.objects.get(analysis_id=analysis_id)
        video_id = analysis.video_id
        video_filename = analysis.video.file_path.split('/')[-1] if analysis.video.file_path else ''
        
        # Get base filename (without extension)
        import os
        base_name = os.path.splitext(video_filename)[0]
        print("üìä Base name: '{}' (original: '{}')".format(base_name, video_filename))
        print("üé¨ Video ID: {}".format(video_id))

        from django.conf import settings
        from pathlib import Path
        
        # ALL POSSIBLE paths to search
        search_paths = [
            # Main Django path
            Path(settings.MEDIA_ROOT) / 'detector_results' / ('vid_' + str(video_id)),
            Path(settings.MEDIA_ROOT) / 'detector_results',
            
            # Path where test_detector.py saves
            Path("/home/ais/shared/horseAI/data/output"),
            Path("/home/ais/shared/horseAI/data/output/results"),
            
            # Old paths
            Path("/home/ais/shared/horseAI/test/output"),
            Path("/home/ais/shared/horseAI/output"),
            
            # Root paths
            Path("/home/ais/shared/horseAI"),
        ]
        
        found_files = {}
        
        # SPECIFIC patterns for THIS video only
        # Try different variations of the filename
        filename_variations = [
            base_name,  # Original base name
            base_name.replace('superanimal_quadruped_hrnet_w32_ssdlite__labeled_before_adapt', '').strip('_'),
            base_name.split('_')[0] if '_' in base_name else base_name,  # First part
            video_filename.replace('.mp4', '').replace('.avi', ''),  # Full filename without extension
        ]
        
        print("üîç Filename variations to search: {}".format(filename_variations))
        
        # Remove empty variations
        filename_variations = [v for v in filename_variations if v and len(v) > 5]
        
        # For each variation, create specific patterns
        all_video_patterns = []
        all_text_patterns = []
        all_graphic_patterns = []
        all_h5_patterns = []
        
        for variation in filename_variations:
            # Video patterns
            all_video_patterns.append("*" + variation + "*labeled*.mp4")
            all_video_patterns.append("*" + variation + "*_sk.mp4")
            all_video_patterns.append("*" + variation + "*annotated*.mp4")
            all_video_patterns.append("*" + variation + "*.mp4")
            
            # Text report patterns
            all_text_patterns.append("*" + variation + "*result.txt")
            all_text_patterns.append(variation + "_result.txt")
            all_text_patterns.append("*" + variation + "*report.txt")
            
            # Graphic report patterns
            all_graphic_patterns.append("*" + variation + "*result.png")
            all_graphic_patterns.append(variation + "_result.png")
            all_graphic_patterns.append("*" + variation + "*report.png")
            
            # H5 file patterns
            all_h5_patterns.append("*" + variation + "*.h5")
            all_h5_patterns.append("*" + variation + "*pose*.h5")
        
        # Add generic patterns as fallback
        all_video_patterns.append("*labeled*.mp4")
        all_text_patterns.append("*result.txt")
        all_graphic_patterns.append("*result.png")
        all_h5_patterns.append("*.h5")
        
        # Function to search for files
        def find_specific_files(search_dir, video_patterns, text_patterns, graphic_patterns, h5_patterns):
    """Search for files matching SPECIFIC patterns - INCLUDES SUBDIRECTORIES"""
    if not search_dir.exists():
        return {}

    results = {}

    # RECURSIVE search function
    def search_recursive(current_dir):
        """Search in current directory and all subdirectories"""
        # Search for annotated video
        if 'annotated_video' not in found_files and 'annotated_video' not in results:
            for pattern in video_patterns:
                for file in current_dir.glob(pattern):
                    if file.is_file():
                        file_str = str(file).lower()
                        if any(variation.lower() in file_str for variation in filename_variations):
                            results['annotated_video'] = file
                            return True
                # Also search in subdirectories
                for subdir in current_dir.iterdir():
                    if subdir.is_dir():
                        if search_recursive(subdir):
                            return True
        return False

    # Search for text report (RECURSIVE)
    def search_text_recursive(current_dir):
        if 'text_report' not in found_files and 'text_report' not in results:
            for pattern in text_patterns:
                for file in current_dir.glob(pattern):
                    if file.is_file():
                        file_str = str(file).lower()
                        if any(variation.lower() in file_str for variation in filename_variations):
                            results['text_report'] = file
                            return True
                # Search subdirectories
                for subdir in current_dir.iterdir():
                    if subdir.is_dir():
                        if search_text_recursive(subdir):
                            return True
        return False

    # Search for graphic report (RECURSIVE)
    def search_graphic_recursive(current_dir):
        if 'graphic_report' not in found_files and 'graphic_report' not in results:
            for pattern in graphic_patterns:
                for file in current_dir.glob(pattern):
                    if file.is_file():
                        file_str = str(file).lower()
                        if any(variation.lower() in file_str for variation in filename_variations):
                            results['graphic_report'] = file
                            return True
                # Search subdirectories
                for subdir in current_dir.iterdir():
                    if subdir.is_dir():
                        if search_graphic_recursive(subdir):
                            return True
        return False

    # Search for h5 data (RECURSIVE)
    def search_h5_recursive(current_dir):
        if 'h5_data' not in found_files and 'h5_data' not in results:
            for pattern in h5_patterns:
                for file in current_dir.glob(pattern):
                    if file.is_file():
                        file_str = str(file).lower()
                        if any(variation.lower() in file_str for variation in filename_variations):
                            results['h5_data'] = file
                            return True
                # Search subdirectories
                for subdir in current_dir.iterdir():
                    if subdir.is_dir():
                        if search_h5_recursive(subdir):
                            return True
        return False

    # Perform recursive searches
    search_recursive(search_dir)
    search_text_recursive(search_dir)
    search_graphic_recursive(search_dir)
    search_h5_recursive(search_dir)
            """Search for files matching SPECIFIC patterns"""
            if not search_dir.exists():
                return {}
                
            results = {}
            
            # Search for annotated video
            if 'annotated_video' not in found_files:
                for pattern in video_patterns:
                    for file in search_dir.glob(pattern):
                        if file.is_file():
                            # Check if this is likely our file (contains base_name or variation)
                            file_str = str(file).lower()
                            if any(variation.lower() in file_str for variation in filename_variations):
                                results['annotated_video'] = file
                                break
                    if 'annotated_video' in results:
                        break
            
            # Search for text report
            if 'text_report' not in found_files:
                for pattern in text_patterns:
                    for file in search_dir.glob(pattern):
                        if file.is_file():
                            file_str = str(file).lower()
                            if any(variation.lower() in file_str for variation in filename_variations):
                                results['text_report'] = file
                                break
                    if 'text_report' in results:
                        break
            
            # Search for graphic report
            if 'graphic_report' not in found_files:
                for pattern in graphic_patterns:
                    for file in search_dir.glob(pattern):
                        if file.is_file():
                            file_str = str(file).lower()
                            if any(variation.lower() in file_str for variation in filename_variations):
                                results['graphic_report'] = file
                                break
                    if 'graphic_report' in results:
                        break
            
            # Search for H5 file
            if 'h5_data' not in found_files:
                for pattern in h5_patterns:
                    for file in search_dir.glob(pattern):
                        if file.is_file():
                            file_str = str(file).lower()
                            if any(variation.lower() in file_str for variation in filename_variations):
                                results['h5_data'] = file
                                break
                    if 'h5_data' in results:
                        break
            
            return results
        
        # Search in all paths
        for search_path in search_paths:
            if not search_path.exists():
                continue
                
            print("üîç Searching in: {}".format(search_path))
            
            # Search in this directory
            results = find_specific_files(
                search_path,
                all_video_patterns,
                all_text_patterns,
                all_graphic_patterns,
                all_h5_patterns
            )
            
            # Also search in subdirectory named after base_name
            subdir = search_path / base_name
            if subdir.exists() and subdir.is_dir():
                sub_results = find_specific_files(
                    subdir,
                    all_video_patterns,
                    all_text_patterns,
                    all_graphic_patterns,
                    all_h5_patterns
                )
                results.update(sub_results)
            
            # Update found_files with results
            for file_type, file_path in results.items():
                if file_type not in found_files:
                    # Convert to URL
                    try:
                        rel_path = file_path.relative_to(settings.MEDIA_ROOT)
                        url = '/media/' + str(rel_path)
                    except ValueError:
                        # File not in MEDIA_ROOT, try to copy
                        media_dir = Path(settings.MEDIA_ROOT) / 'detector_results' / ('vid_' + str(video_id))
                        media_dir.mkdir(parents=True, exist_ok=True)
                        dest_path = media_dir / file_path.name
                        import shutil
                        try:
                            shutil.copy2(file_path, dest_path)
                            rel_path = dest_path.relative_to(settings.MEDIA_ROOT)
                            url = '/media/' + str(rel_path)
                            print("üìã Copied {} to media".format(file_path.name))
                        except:
                            url = str(file_path)
                    
                    found_files[file_type] = url
                    print("‚úÖ Found {}: {}".format(file_type, file_path.name))
            
            # Stop if we found all file types
            if len(found_files) >= 4:  # All 4 types found
                break
        
        # Prepare response
        print("üìÅ Found files for video {}: {}".format(video_id, len(found_files)))
        for file_type, url in found_files.items():
            print("   {}: {}".format(file_type, url))
        
        return JsonResponse({
            'analysis_id': analysis_id,
            'video_id': video_id,
            'base_name': base_name,
            'found_files': found_files
        })

    except Exception as e:
        print("‚ùå File search error: {}".format(e))
        import traceback
        traceback.print_exc()
        return JsonResponse({'error': str(e)}, status=500)

def update_analysis_confidence(request, analysis_id):
    """–û–±–Ω–æ–≤–∏—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ (–∏–∑ –æ—Ç—á–µ—Ç–∞)"""
    try:
        if not request.user.is_authenticated:
            return JsonResponse({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}, status=403)
        
        data = json.loads(request.body)
        confidence = data.get('confidence')
        
        if not confidence:
            return JsonResponse({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å'}, status=400)
        
        # –ù–∞—Ö–æ–¥–∏–º –∞–Ω–∞–ª–∏–∑
        analysis = get_object_or_404(Analysis, analysis_id=analysis_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
        if not (request.user.is_staff or analysis.video.user == request.user):
            return JsonResponse({'success': False, 'error': '–ù–µ—Ç –ø—Ä–∞–≤'}, status=403)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        analysis.lameness_confidence = float(confidence)
        analysis.save()
        
        return JsonResponse({
            'success': True,
            'message': f'–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {confidence}%',
            'confidence': confidence
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

def ration_history(request):
    """–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Ü–∏–æ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not request.user.is_authenticated:
        return redirect('login')
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        custom_user = CustomUser.objects.get(login=request.user.username)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Ü–∏–æ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        rations = Ration.objects.filter(animal__user=custom_user).order_by('-calculation_date')
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        animals = Animal.objects.filter(user=custom_user)
        
        context = {
            'rations': rations,
            'animals': animals,
        }
        return render(request, 'frontend/ration_history.html', context)
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Ü–∏–æ–Ω–æ–≤: {e}")
        messages.error(request, f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Ü–∏–æ–Ω–æ–≤: {str(e)}')
        return redirect('ration')

def ration_detail(request, ration_id):
    """–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Ü–∏–æ–Ω–∞"""
    if not request.user.is_authenticated:
        return redirect('login')
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        custom_user = CustomUser.objects.get(login=request.user.username)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Ü–∏–æ–Ω, –ø—Ä–æ–≤–µ—Ä—è—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        ration = Ration.objects.get(
            ration_id=ration_id,
            animal__user=custom_user
        )
        
        context = {
            'ration': ration,
        }
        return render(request, 'frontend/ration_detail.html', context)
        
    except Ration.DoesNotExist:
        messages.error(request, '–†–∞—Ü–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø–∞')
        return redirect('ration_history')
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Ü–∏–æ–Ω–∞: {e}")
        messages.error(request, f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Ü–∏–æ–Ω–∞: {str(e)}')
        return redirect('ration_history')

# ========== –°–£–ü–ï–†-–ê–î–ú–ò–ù –û–ë–ï–†–¢–ö–ò ==========

def super_admin_wrapper(view_name):
    """–û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ super_admin_views"""
    import sys
    sys.path.insert(0, '/home/ais/shared/horseAI/scripts')
    from api import super_admin_views
    
    def wrapper(request, *args, **kwargs):
        func = getattr(super_admin_views, view_name)
        return func(request, *args, **kwargs)
    
    return wrapper

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±–µ—Ä—Ç–∫–∏
def super_admin_stats(request):
    return super_admin_wrapper('super_admin_stats')(request)

def super_admin_system_health(request):
    return super_admin_wrapper('super_admin_system_health')(request)

def super_admin_users(request):
    return super_admin_wrapper('super_admin_users')(request)

def super_admin_user_detail(request, user_id):
    return super_admin_wrapper('super_admin_user_detail')(request, user_id)

def super_admin_add_user(request):
    return super_admin_wrapper('super_admin_add_user')(request)

def super_admin_edit_user(request, user_id):
    return super_admin_wrapper('super_admin_edit_user')(request, user_id)

def super_admin_toggle_user_status(request, user_id):
    return super_admin_wrapper('super_admin_toggle_user_status')(request, user_id)

def super_admin_delete_user(request, user_id):
    return super_admin_wrapper('super_admin_delete_user')(request, user_id)

def super_admin_animals(request):
    return super_admin_wrapper('super_admin_animals')(request)

def super_admin_videos(request):
    return super_admin_wrapper('super_admin_videos')(request)

def super_admin_video_detail(request, video_id):
    return super_admin_wrapper('super_admin_video_detail')(request, video_id)

def super_admin_delete_video(request, video_id):
    return super_admin_wrapper('super_admin_delete_video')(request, video_id)

def super_admin_analyses(request):
    return super_admin_wrapper('super_admin_analyses')(request)

def super_admin_analysis_detail(request, analysis_id):
    return super_admin_wrapper('super_admin_analysis_detail')(request, analysis_id)

def super_admin_update_analysis(request, analysis_id):
    return super_admin_wrapper('super_admin_update_analysis')(request, analysis_id)

def super_admin_delete_analysis(request, analysis_id):
    return super_admin_wrapper('super_admin_delete_analysis')(request, analysis_id)

def super_admin_export_data(request):
    return super_admin_wrapper('super_admin_export_data')(request)
