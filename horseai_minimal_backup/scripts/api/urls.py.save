from django.urls import path
from django.http import JsonResponse
from rest_framework.routers import DefaultRouter
import sys
import os

# Добавьте путь к scripts/api в sys.path
scripts_api_path = '/home/ais/shared/horseAI/scripts/api'
if scripts_api_path not in sys.path:
    sys.path.insert(0, scripts_api_path)

# Импортируем ИСПРАВЛЕННЫЕ простые API функции
try:
    from .api_animals_simple_fixed import (
        simple_animal_list, simple_animal_create, simple_animal_detail,
        simple_animal_update, simple_animal_delete, animal_stats
    )
    HAS_API_FUNCTIONS = True
except ImportError as e:
    print(f"⚠️ Ошибка импорта API функций: {e}")
    HAS_API_FUNCTIONS = False

urlpatterns = []

if HAS_API_FUNCTIONS:
    # Исправленные API endpoints (гарантированно работающие)
    urlpatterns += [
        path('simple-v2/animals/', simple_animal_list, name='simple_v2_animal_list'),
        path('simple-v2/animals/add/', simple_animal_create, name='simple_v2_animal_create'),
        path('simple-v2/animals/<int:animal_id>/', simple_animal_detail, name='simple_v2_animal_detail'),
        path('simple-v2/animals/<int:animal_id>/update/', simple_animal_update, name='simple_v2_animal_update'),
        path('simple-v2/animals/<int:animal_id>/delete/', simple_animal_delete, name='simple_v2_animal_delete'),
        path('simple-v2/animals/<int:animal_id>/stats/', animal_stats, name='simple_v2_animal_stats'),
    ]

# Добавим проверочный endpoint для тестирования
def check_api_status(request):
    return JsonResponse({
        'status': 'ok',
        'api_available': HAS_API_FUNCTIONS,
        'endpoints': [
            {'path': '/api/simple-v2/animals/', 'method': 'GET'},
            {'path': '/api/simple-v2/animals/add/', 'method': 'POST'},
            {'path': '/api/simple-v2/animals/<id>/', 'method': 'GET'},
            {'path': '/api/simple-v2/animals/<id>/update/', 'method': 'POST'},
            {'path': '/api/simple-v2/animals/<id>/delete/', 'method': 'DELETE'},
        ]
    })

urlpatterns.append(path('simple-v2/status/', check_api_status, name='api_simple_v2_status'))

# Добавим простой fallback API если основные не работают
def simple_api_fallback(request):
    return JsonResponse({
        'status': 'fallback',
        'message': 'Используется fallback API',
        'endpoints': ['/api/simple-v2/status/']
    })

urlpatterns.append(path('', simple_api_fallback, name='api_root'))

# Анализы
from .analysis_views import analysis_detail, analysis_delete, user_analyses
from .file_views import check_file_exists
from .ration_views import api_save_ration, api_delete_ration, api_get_user_rations

# Добавляем все API endpoints
urlpatterns += [
    # Анализы
    path('analysis/<int:analysis_id>/detail/', analysis_detail, name='api_analysis_detail'),
    path('analysis/<int:analysis_id>/delete/', analysis_delete, name='api_analysis_delete'),
    path('analysis/user/', user_analyses, name='api_user_analyses'),
    
    # Файлы
    path('files/check/', check_file_exists, name='check_file_exists'),
    
    # Рационы
    path('rations/', api_save_ration, name='api_save_ration'),
    path('rations/<int:ration_id>/', api_delete_ration, name='api_delete_ration'),
    path('rations/user/', api_get_user_rations, name='api_get_user_rations'),
]
